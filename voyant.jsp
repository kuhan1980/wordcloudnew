/* This file created by JSCacher. Last modified: Sat May 28 22:30:46 EDT 2016 */
function Bubblelines(a){this.container=a.container;this.externalClickHandler=a.clickHandler;this.INTERVAL=50;this.DISMISS_DELAY=2500;this.UNIFORM_LINE_LENGTH=!0;this.SEPARATE_LINES_FOR_TERMS=!1;this.MAX_LINE_WIDTH=this.MAX_LABEL_WIDTH=0;this.DRAW_TITLES=!0;this.DRAW_SHORT_TITLES=!1;this.graphSeparation=this.MIN_GRAPH_SEPARATION=50;this.yIndex=0;this.mouseOver=!1;this.clearToolTipId=this.intervalId=null;this.overBubbles=[];this.lastClickedBubbles={};this.ctx=this.canvas=this.dragInfo=null;this.maxDocLength=
2;this.maxFreq={term:null,value:0};this.maxRadius=0;this.cache=new Ext.util.MixedCollection;this.currentTerms={};this.termsFilter=[];this.bubbleSpacing=50;this.initialized=!1}
Bubblelines.prototype={constructor:Bubblelines,initializeCanvas:function(){var a=this.container,b=a.getHeight(),c=a.getWidth();this.DRAW_SHORT_TITLES=500>c;var d=Ext.id("bubblelines");a.add({xtype:"container",width:c,height:b,html:'\x3ccanvas id\x3d"'+d+'" width\x3d"'+c+'" height\x3d"'+b+'"\x3e\x3c/canvas\x3e',border:!1,listeners:{afterrender:{fn:function(a){this.canvas=document.getElementById(d);this.ctx=this.canvas.getContext("2d");this.canvas.addEventListener("click",this.clickHandler.bind(this),
!1);this.canvas.addEventListener("mousedown",this.mouseDownHandler.bind(this),!1);this.canvas.addEventListener("mouseup",this.mouseUpHandler.bind(this),!1);this.canvas.addEventListener("mousemove",this.moveHandler.bind(this),!1);this.canvas.addEventListener("mouseenter",this.mouseEnterHandler.bind(this),!1);this.canvas.addEventListener("mouseleave",this.mouseLeaveHandler.bind(this),!1)},single:!0,scope:this}}});a.updateLayout();this.initialized=!0},doBubblelinesLayout:function(){if(this.initialized){var a=
this.container.getWidth();this.DRAW_SHORT_TITLES=500>a;this.setTitleWidthsAndMaxTitleWidth();for(var b=Ext.DomQuery.jsSelect("div:not(div[class*\x3dterm])",this.container.el.dom),c=0;c<b.length;c++)Ext.fly(b[c]).setWidth(a);this.canvas.width=a;b=75;this.DRAW_SHORT_TITLES&&(b=50);this.setMaxLineWidth(a-this.MAX_LABEL_WIDTH-b);this.setLineLengths();this.recache();this.setCanvasHeight();this.drawGraph()}},addDocToCache:function(a){this.cacheBubbles(a);this.calculateBubbleRadii(a);a.lineLength=600;a.freqCounts=
{};!1===this.cache.containsKey(a.id)?this.cache.add(a):this.cache.replace(a.id,a);this.cache.sort("index","ASC")},addTermsToDoc:function(a,b){var c,d;for(d in a)c=d;this.currentTerms[c]=!0;c=this.cache.get(b);Ext.apply(c.terms,a);this.cacheBubbles(c)?this.recache():this.calculateBubbleRadii(c)},cacheBubbles:function(a){var b=!1,c;for(c in a.terms){for(var d=a.terms[c],e=d.distributions.length,f=a.lineLength/e,g=[],h=0,k=0,m=0,l=0;l<e;l++){var n=d.distributions[l];n>k&&(k=n);g.push({id:Ext.id(null,
"bub"),x:m,freq:n,radius:0,bin:l,tokenPositions:d.positions.slice(h,h+=n)});m+=f}a.terms[c].maxDistribution=k;a.terms[c].pos=g;k>this.maxFreq.value&&(b=!0,this.setMaxFreq({term:c,value:k}))}return b},calculateBubbleRadii:function(a,b){var c=Math.log(this.maxFreq.value),d=Math.log(2)/2,e;for(e in a.terms){var f=a.terms[e];if(f&&(null==b||e==b))for(var g=0;g<f.pos.length;g++){var h=f.pos[g];if(0<h.freq){var k=Math.max(Math.log(h.freq),d)/c*this.maxRadius;h.radius=k}else h.radius=0}}},recache:function(){this.cache.each(function(a){this.cacheBubbles(a);
this.calculateBubbleRadii(a)},this)},getTotalHeight:function(){var a=this.maxRadius;this.cache.each(function(b,c,d){a+=b.height},this);return a},setCanvasHeight:function(){this.calculateGraphHeights();var a=this.getTotalHeight(),b=this.container.dom;if(void 0!==b)for(var b=Ext.DomQuery.jsSelect("div",b),c=0;c<b.length;c++)Ext.fly(b[c]).setHeight(a);this.canvas&&(this.canvas.height=a)},setMaxLineWidth:function(a){this.maxRadius=a/30;this.MAX_LINE_WIDTH=a-this.maxRadius/2},calculateGraphHeights:function(){var a=
.5*this.maxRadius;if(this.SEPARATE_LINES_FOR_TERMS){var b=this.termsFilter;this.cache.each(function(c,e,f){e=this.maxRadius*b.length;for(f=0;f<b.length;f++)c.terms[b[f]]||(e-=this.maxRadius);0==e&&(e=this.maxRadius);c.height=e+a},this)}else{var c=Math.max(this.maxRadius,this.MIN_GRAPH_SEPARATION);this.cache.each(function(b,e,f){b.height=c+a},this)}},findLongestDocument:function(a){a=a.getTotalWordTokens();a>this.maxDocLength&&(this.maxDocLength=a)},getTitleWidth:function(a){var b=a.title;this.DRAW_SHORT_TITLES&&
(b=this.cache.indexOf(a)+1+")");this.ctx.textBaseline="top";this.ctx.font="bold 12px Verdana";return this.ctx.measureText(b).width},setTitleWidthsAndMaxTitleWidth:function(){this.cache.each(function(a,b){var c=this.getTitleWidth(a);a.titleWidth=c;c>this.MAX_LABEL_WIDTH&&(this.MAX_LABEL_WIDTH=c)},this)},setLineLengths:function(){this.cache.each(function(a,b){var c;c=this.UNIFORM_LINE_LENGTH?this.MAX_LINE_WIDTH:Math.log(a.getTotalWordTokens())/Math.log(this.maxDocLength)*this.MAX_LINE_WIDTH;a.lineLength=
c},this)},drawGraph:function(a){null!=this.intervalId&&clearInterval(this.intervalId);this.mouseOver?this.intervalId=setInterval(this.doDraw.bind(this,[a]),this.INTERVAL):setTimeout(this.doDraw.bind(this,[a]),5)},doDraw:function(a){this.clearCanvas();this.yIndex=this.maxRadius;!0===a&&(this.yIndex+=30);this.cache.each(this.drawDocument,this);!0===a?this.drawLegend():this.drawToolTip();this.doDrag()},drawDocument:function(a,b,c){if(!a.hidden){var d=a.lineLength,e=this.MAX_LABEL_WIDTH-a.titleWidth,
f=5;this.ctx.textBaseline="top";this.ctx.font="bold 12px Verdana";if(null!=this.dragInfo&&this.dragInfo.oldIndex==b)this.ctx.fillStyle="rgba(128, 128, 128, 0.5)",f+=e,this.ctx.fillText(a.title,f,this.yIndex),this.SEPARATE_LINES_FOR_TERMS&&(this.yIndex+=a.height);else{c=function(){f=g.MAX_LABEL_WIDTH+g.maxRadius;g.ctx.strokeStyle="rgba(128, 128, 128, 1.0)";g.ctx.fillStyle="rgba(128, 128, 128, 1.0)";g.ctx.lineWidth=.25;g.ctx.beginPath();g.ctx.moveTo(f,g.yIndex-6);g.ctx.lineTo(f,g.yIndex+6);g.ctx.stroke();
g.ctx.beginPath();g.ctx.moveTo(f,g.yIndex);g.ctx.lineTo(f+d,g.yIndex);g.ctx.stroke();g.ctx.beginPath();g.ctx.moveTo(f+d,g.yIndex-6);g.ctx.lineTo(f+d,g.yIndex+6);g.ctx.stroke()};this.DRAW_TITLES&&(f+=e,this.ctx.fillStyle="rgba(128, 128, 128, 1.0)",e=a.title,this.DRAW_SHORT_TITLES&&(e=b+1+")"),this.ctx.fillText(e,f,this.yIndex));this.yIndex+=4;var g=this;this.SEPARATE_LINES_FOR_TERMS?null!=this.termsFilter&&0!==this.termsFilter.length||c():c();var e=2*Math.PI,h=0;a.freqCounts={};var k=a.terms,m=null!=
this.lastClickedBubbles[b],l=0,n;for(n in k)if(-1!==this.termsFilter.indexOf(n)){var q=k[n];if(q){l++;this.SEPARATE_LINES_FOR_TERMS&&c();var s=0,p=q.color.join(",");this.ctx.strokeStyle="rgba("+p+", 1)";this.ctx.fillStyle="rgba("+p+", 0.35)";this.ctx.lineWidth=.25;for(var h=h+q.rawFreq,s=s+q.rawFreq,r=m&&this.lastClickedBubbles[b][n],C=0;C<q.pos.length;C++){var F=q.pos[C];if(0<F.radius){var D=!1;r&&this.lastClickedBubbles[b][n]==F.id&&(this.ctx.strokeStyle="rgba(0, 0, 0, 0.75)",this.ctx.fillStyle=
"rgba("+p+", 0.5)",this.ctx.lineWidth=1,D=!0);this.ctx.beginPath();this.ctx.arc(F.x+f,this.yIndex,F.radius,0,e,!0);this.ctx.closePath();this.ctx.fill();this.ctx.stroke();D&&(this.ctx.strokeStyle="rgba("+p+", 1)",this.ctx.fillStyle="rgba("+p+", 0.35)",this.ctx.lineWidth=.25)}}a.freqCounts[n]=s;this.SEPARATE_LINES_FOR_TERMS&&(this.ctx.fillStyle="rgba(0, 0, 0, 1.0)",this.ctx.font="10px Verdana",this.ctx.fillText(s,f+d+5,this.yIndex-4),this.yIndex+=this.maxRadius)}}this.SEPARATE_LINES_FOR_TERMS&&0==l&&
(c(),this.ctx.fillStyle="rgba(0, 0, 0, 1.0)",this.ctx.font="10px Verdana",this.ctx.fillText(0,f+d+5,this.yIndex-4),this.yIndex+=this.maxRadius);f+=d;this.SEPARATE_LINES_FOR_TERMS||(this.ctx.fillStyle="rgba(0, 0, 0, 1.0)",this.ctx.font="10px Verdana",this.ctx.fillText(h,f+5,this.yIndex-4))}this.yIndex=this.SEPARATE_LINES_FOR_TERMS?this.yIndex+.5*this.maxRadius:this.yIndex+a.height;this.yIndex-=4}},drawLegend:function(){var a=this.MAX_LABEL_WIDTH+this.maxRadius;this.ctx.textBaseline="top";this.ctx.font=
"16px serif";this.typeStore&&this.typeStore.each(function(b){var c=b.get("color").join(",");this.ctx.fillStyle="rgb("+c+")";b=b.get("type");this.ctx.fillText(b,a,5);b=this.ctx.measureText(b).width;a+=b+8},this)},drawToolTip:function(){if(0<this.overBubbles.length){this.ctx.lineWidth=.5;this.ctx.fillStyle="rgba(224, 224, 224, 0.8)";this.ctx.strokeStyle="rgba(0, 0, 0, 0.8)";var a=this.overBubbles[0].x,b=this.overBubbles[0].y;a+110>this.canvas.width&&(a-=110);var c;if(null==this.overBubbles[0].label){var d=
this.cache.get(this.overBubbles[0].docIndex);c=1;for(var e in d.freqCounts)c++;c*=16;b+c>this.canvas.height&&(b-=c);this.ctx.fillRect(a,b,110,c);this.ctx.strokeRect(a,b,110,c);a+=10;b+=10;this.ctx.fillStyle="rgba(0, 0, 0, 0.8)";this.ctx.font="10px Verdana";for(e in d.freqCounts)this.ctx.fillText(e+": "+d.freqCounts[e],a,b,90),b+=16}else for(c=16*this.overBubbles.length+10,b+c>this.canvas.height&&(b-=c),this.ctx.fillRect(a,b,110,c),this.ctx.strokeRect(a,b,110,c),a+=10,b+=10,this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",
this.ctx.font="10px Verdana",d=0;d<this.overBubbles.length;d++)e=this.overBubbles[d],this.ctx.fillText(e.label+": "+e.freq,a,b,90),b+=16;null==this.clearToolTipId&&(this.clearToolTipId=setTimeout(this.clearToolTip.bind(this),this.DISMISS_DELAY))}},clearToolTip:function(){this.overBubbles=[];clearTimeout(this.clearToolTipId);this.clearToolTipId=null},mouseEnterHandler:function(a){this.mouseOver=!0;this.drawGraph()},mouseLeaveHandler:function(a){this.mouseOver=!1;null!=this.intervalId&&clearInterval(this.intervalId);
this.overBubbles=[];this.drawGraph()},moveHandler:function(a){this.clearToolTip();this.overBubbles=[];var b=a.layerX-this.MAX_LABEL_WIDTH,c=a.layerY,d=.25*this.maxRadius,e=-1;this.cache.each(function(a,b,f){if(c<d)return!1;d+=a.height;if(c<d)return e=b,!1},this);if(null!=this.dragInfo)this.dragInfo.x=a.layerX,this.dragInfo.y=c,e>=this.cache.getCount()?e=this.cache.getCount()-1:0>e&&(e=c+this.maxRadius>this.canvas.height?this.cache.getCount()-1:0),this.dragInfo.newIndex=e,document.body.style.cursor=
"move";else if(0<=e&&e<this.cache.getCount())if(0<=b){var f=!1,b=b-this.maxRadius,g=this.cache.get(e);if(b>=g.lineLength)this.overBubbles=[{docIndex:e,x:a.layerX+10,y:a.layerY+10}];else{var b=Math.round(b/(g.lineLength/this.bubbleSpacing)),h=this.maxRadius;0<e&&(h=d-(this.cache.get(e).height-.75*this.maxRadius));var h=Math.round((c-h)/this.maxRadius),k=0,m;for(m in g.terms)if(-1!==this.termsFilter.indexOf(m)){var l=g.terms[m];l?(this.SEPARATE_LINES_FOR_TERMS&&k==h||!this.SEPARATE_LINES_FOR_TERMS)&&
l.pos[b]&&0<l.pos[b].radius&&(f=!0,this.overBubbles.push({label:m,type:l,docId:g.id,docIndex:e,xIndex:b,yIndex:h,freq:l.pos[b].freq,id:l.pos[b].id,tokenPositions:l.pos[b].tokenPositions,x:a.layerX+10,y:a.layerY+10})):this.SEPARATE_LINES_FOR_TERMS&&k--;k++}}document.body.style.cursor=f?"pointer":"auto"}else document.body.style.cursor="move";else document.body.style.cursor="auto"},mouseDownHandler:function(a){var b=a.layerX,c=a.layerY;if(b<this.MAX_LABEL_WIDTH){var d=.25*this.maxRadius,e=-1;this.cache.each(function(a,
b,h){if(c<d)return!1;d+=a.height;if(c<d)return e=b,!1},this);0<=e&&e<this.cache.getCount()&&(this.dragInfo={oldIndex:e,newIndex:e,xOffset:b-5,yOffset:5,x:b,y:c})}},mouseUpHandler:function(a){this.dragInfo=null},doDrag:function(){if(null!=this.dragInfo){for(var a={},b=0;b<this.cache.getCount();b++)b<this.dragInfo.oldIndex&&b<this.dragInfo.newIndex?a[b]=b:b<this.dragInfo.oldIndex&&b>=this.dragInfo.newIndex?a[b]=b+1:b==this.dragInfo.oldIndex?a[b]=this.dragInfo.newIndex:b>this.dragInfo.oldIndex&&b>this.dragInfo.newIndex?
a[b]=b:b>this.dragInfo.oldIndex&&b<=this.dragInfo.newIndex&&(a[b]=b-1);this.dragInfo.oldIndex=this.dragInfo.newIndex;this.cache.reorder(a);a=this.cache.get(this.dragInfo.oldIndex);this.ctx.fillStyle="rgba(128, 128, 128, 1)";this.ctx.textBaseline="top";this.ctx.font="bold 12px Verdana";this.ctx.fillText(a.title,this.dragInfo.x-this.dragInfo.xOffset,this.dragInfo.y-this.dragInfo.yOffset)}},clickHandler:function(a){this.lastClickedBubbles={};if(0<this.overBubbles.length&&this.overBubbles[0].label){a=
[];for(var b=[],c=[],d=0;d<this.overBubbles.length;d++){var e=this.overBubbles[d];c.push({term:e.label,docIndex:e.docIndex,docId:e.docId,tokenPositions:e.tokenPositions});null==this.lastClickedBubbles[e.docIndex]&&(this.lastClickedBubbles[e.docIndex]={});this.lastClickedBubbles[e.docIndex][e.label]=e.id;a.push(e.docId+":"+e.label);b.push(e.tokenPositions)}b=Ext.flatten(b);b.sort();void 0!==this.externalClickHandler&&this.externalClickHandler(c)}this.overBubbles=[]},setMaxFreq:function(a){null==a&&
(a=this.findMaxFreq());this.maxFreq=a},findMaxFreq:function(){var a={term:"",value:0};this.cache.each(function(b){for(var c in b.terms){var d=b.terms[c].maxDistribution;d>a.value&&(a={term:c,value:d})}},this);return a},getNewColor:function(){for(var a=null,b=0;b<this.colors.length&&(a=this.colors[b],-1!=this.typeStore.findExact("color",a));b++)a=null;null==a&&(a=[128,128,128]);return a},removeAllTerms:function(){this.cache.each(function(a){a.terms={}},this);this.currentTerms={};this.termsFilter=[]},
removeTerm:function(a){delete this.currentTerms[a];var b=!1;this.cache.each(function(c){for(var d in c.terms)d==a&&(this.maxFreq.term==a&&(this.maxFreq={term:null,value:0},b=!0),delete c.terms[d])},this);for(var c in this.lastClickedBubbles){var d=this.lastClickedBubbles[c],e;for(e in d)e==a&&delete this.lastClickedBubbles[c][e]}b&&(this.setMaxFreq(),this.calculateBubbleRadii(),this.drawGraph())},clearCanvas:function(){this.canvas.width=this.canvas.width}};function Knots(a){this.container=a.container;this.externalClickHandler=a.clickHandler;this.MAX_LINE_LENGTH=0;this.LINE_SIZE=2.5;this.progressiveDraw=!0;this.progDrawDone=!1;this.drawStep=0;this.mouseOver=!1;this.refreshInterval=100;this.forceRedraw=!1;this.lastDrawTime=(new Date).getTime();this.intervalId=null;this.startAngle=315;this.angleIncrement=15;this.currentDoc=this.ctx=this.canvas=null;this.maxDocLength=0;this.offset={x:0,y:0};this.termsFilter=[];this.initialized=!1;this.audio=a.audio}
Knots.prototype={constructor:Knots,initializeCanvas:function(){var a=this.container,b=a.getHeight()-5,c=a.getWidth();this.MAX_LINE_LENGTH=Math.sqrt(c*c+b*b);var d=Ext.id("knots");a.add({xtype:"container",width:c,height:b,html:'\x3ccanvas id\x3d"'+d+'" width\x3d"'+c+'" height\x3d"'+b+'"\x3e\x3c/canvas\x3e',border:!1,listeners:{afterrender:{fn:function(a){this.canvas=document.getElementById(d);this.ctx=this.canvas.getContext("2d");this.canvas.addEventListener("click",this.clickHandler.bind(this),!1);
this.canvas.addEventListener("mousedown",this.mouseDownHandler.bind(this),!1);this.canvas.addEventListener("mouseup",this.mouseUpHandler.bind(this),!1);this.canvas.addEventListener("mousemove",this.moveHandler.bind(this),!1)},single:!0,scope:this}}});a.updateLayout();this.initialized=!0},doLayout:function(){if(this.initialized){var a=this.container.getWidth(),b=this.container.getHeight()-5;this.canvas.width=a;this.canvas.height=b;this.recache();this.buildGraph()}},buildGraph:function(a){null!=this.intervalId&&
(this.progDrawDone=!1,clearInterval(this.intervalId));this.forceRedraw=!0;this.drawStep=a||0;for(var b in this.currentDoc.terms)this.currentDoc.terms[b].done=!1;this.progressiveDraw?this.intervalId=setInterval(this.doDraw.createDelegate(this,[!1]),50):this.doDraw(!1)},drawGraph:function(a){null!=this.intervalId&&(this.progDrawDone=!1,clearInterval(this.intervalId));this.forceRedraw=!0;this.progressiveDraw?this.intervalId=setInterval(this.doDraw.createDelegate(this,[a]),50):this.doDraw(!1,a)},doDraw:function(a){var b=
(new Date).getTime();if(this.forceRedraw||b-this.lastDrawTime>=this.refreshInterval)if(this.forceRedraw=!1,this.clearCanvas(),this.ctx.save(),this.ctx.translate(this.offset.x,this.offset.y),this.drawDocument(this.currentDoc),this.originOpacity=.5,this.originColor="128,128,128",this.ctx.lineWidth=15*Math.abs(this.originOpacity-1),this.ctx.fillStyle="rgba("+this.originColor+",1.0)",this.ctx.strokeStyle="rgba("+this.originColor+","+this.originOpacity+")",this.ctx.beginPath(),this.ctx.arc(0,0,2*this.LINE_SIZE,
0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.fill(),a||this.ctx.stroke(),this.ctx.restore(),this.ctx.lineWidth=1,!0===a&&this.drawLegend(),this.lastDrawTime=(new Date).getTime(),this.progressiveDraw){a=!0;for(var c in this.currentDoc.terms)a=a&&this.currentDoc.terms[c].done;(this.progDrawDone=a)?(clearInterval(this.intervalId),this.intervalId=null,this.muteTerms()):this.drawStep++}},setAudio:function(a){(this.audio=a)||this.muteTerms()},muteTerms:function(){for(t in this.currentDoc.terms)this.currentDoc.terms[t].audio&&
(this.currentDoc.terms[t].audio.gainNode.gain.value=0)},drawDocument:function(a){var b=a.terms,c;for(c in b)if(-1!=this.termsFilter.indexOf(c)){a=b[c];var d=[[0,0],[0,0]];if(this.progressiveDraw){var e=this.drawStep+1;a.pos.length<=this.drawStep?(a.done=!0,e=a.pos.length,b[c].audio&&(b[c].audio.gainNode.gain.value=0)):(this.audio&&b[c].audio&&(b[c].audio.gainNode.gain.value=.1),setTimeout(function(){b[c]&&(b[c].audio.gainNode.gain.value=0)},.75*this.refreshInterval),a.done=!1);for(var f=0;f<e;f++){var g=
a.pos[f];this.drawPolygon(g,d,a.color);d=[[g.polygon[0][3],g.polygon[1][3]],[g.polygon[0][2],g.polygon[1][2]]]}}else for(f=0;f<a.pos.length;f++)g=a.pos[f],this.drawPolygon(g,d,a.color),d=[[g.polygon[0][3],g.polygon[1][3]],[g.polygon[0][2],g.polygon[1][2]]]}},drawPolygon:function(a,b,c){var d=a.polygon[0],e=a.polygon[1];this.ctx.beginPath();this.ctx.moveTo(b[0][0],b[0][1]);this.ctx.lineTo(d[0],e[0]);this.ctx.lineTo(d[1],e[1]);this.ctx.lineTo(b[1][0],b[1][1]);this.ctx.closePath();this.ctx.fillStyle=
"rgba("+c+", 0.6)";this.ctx.fill();this.ctx.beginPath();this.ctx.moveTo(d[0],e[0]);this.ctx.lineTo(d[1],e[1]);this.ctx.lineTo(d[2],e[2]);this.ctx.lineTo(d[3],e[3]);this.ctx.closePath();a.over&&(this.ctx.fillStyle="rgba("+c+", 1.0)");this.ctx.fill()},drawLegend:function(){var a=5;this.ctx.textBaseline="top";this.ctx.font="16px serif";this.termStore.each(function(b){var c=b.get("color");this.ctx.fillStyle="rgb("+c+")";b=b.get("term");this.ctx.fillText(b,a,5);b=this.ctx.measureText(b).width;a+=b+8},
this)},setCurrentDoc:function(a){this.currentDoc=a;this.cacheDocument(a)},addTerms:function(a){Ext.apply(this.currentDoc.terms,a);this.recache()},removeTerm:function(a){this.currentDoc.terms[a].audio&&this.currentDoc.terms[a].audio.oscillator.stop();delete this.currentDoc.terms[a];this.recache()},removeAllTerms:function(){for(term in this.currentDoc.terms)this.currentDoc.terms[term].audio&&this.currentDoc.terms[term].audio.oscillator.stop();this.currentDoc.terms={};this.recache()},recache:function(){this.MAX_LINE_LENGTH=
Math.sqrt(this.canvas.width*this.canvas.width+this.canvas.height*this.canvas.height);this.cacheDocument(this.currentDoc);this.determineGraphSizeAndPosition()},cacheDocument:function(a){a=this.MAX_LINE_LENGTH;this.currentDoc.lineLength=a;var b=new (window.AudioContext||window.webkitAudioContext),c;for(c in this.currentDoc.terms){if(b&&!this.currentDoc.terms[c].audio){var d=b.createOscillator(),e=b.createGain();d.connect(e);e.connect(b.destination);d.frequency.value=500*Math.random()+150;d.start();
e.gain.value=0;this.currentDoc.terms[c].audio={oscillator:d,gainNode:e}}this.cacheTurns(this.currentDoc.terms[c],a)}},cacheTurns:function(a,b){if(0<a.rawFreq){for(var c=this.currentDoc,d=a.term,e=[],f=a.positions,g=f[f.length-1],h=this.startAngle,k=this.angleIncrement,m=0,l=0,n=0,q=0,s=m=0;s<f.length;s++){var p=f[s],r=p/g*b,C=r-m,m=n,l=q,q=this.findEndPoint([n,q],C,h),n=q[0],q=q[1],m=this.getPolygonFromLine([m,l],[n,q],h,this.LINE_SIZE);e.push({tokenId:p,polygon:m,over:!1});m=r;h+=k}c.terms[d].pos=
e;c.terms[d].done=!1}},findEndPoint:function(a,b,c){var d=this.degreesToRadians(c);c=a[0]+b*Math.cos(d);a=a[1]+b*Math.sin(d);return[c,a]},determineGraphSizeAndPosition:function(){var a=this.findBoundingBoxForGraph(),b=a.maxX-a.minX,c=a.maxY-a.minY,d=Math.min(this.canvas.width/b,this.canvas.height/c),d=d-.05,c=c*d;this.offset.x=Math.abs(a.minX*d-(this.canvas.width/2-b*d/2));this.offset.y=Math.abs(a.minY*d-(this.canvas.height/2-c/2));this.MAX_LINE_LENGTH=Math.sqrt(this.canvas.width*this.canvas.width+
this.canvas.height*this.canvas.height)*d;this.cacheDocument(this.currentDoc)},findBoundingBoxForGraph:function(){var a=null,b=null,c=null,d=null,e;for(e in this.currentDoc.terms)for(var f=this.currentDoc.terms[e].pos,g=0;g<f.length;g++){var h=f[g].polygon,h=this.getBoundingBox(h[0],h[1]);if(null==a||h[0]<a)a=h[0];if(null==b||h[2]>b)b=h[2];if(null==c||h[1]<c)c=h[1];if(null==d||h[3]>d)d=h[3]}return{minX:a,minY:c,maxX:b,maxY:d}},getBoundingBox:function(a,b){var c=Math.min(a[0],a[2]),d=Math.max(a[0],
a[2]),e=Math.min(b[0],b[2]),f=Math.max(b[0],b[2]);return[c,e,d,f]},degreesToRadians:function(a){return Math.PI/180*a},clickHandler:function(a){var b=a.layerX-this.offset.x;a=a.layerY-this.offset.y;var c=null,d=0,e;for(e in this.currentDoc.terms)if(-1!=this.termsFilter.indexOf(e))for(var f=this.currentDoc.terms[e].pos,g=0;g<f.length;g++){var h=f[g].polygon;if(this.isPointInPolygon(h[0],h[1],b,a)){c=e;d=f[g].tokenId;break}}c&&void 0!==this.externalClickHandler&&this.externalClickHandler({term:c,tokenId:d})},
moveHandler:function(a){var b=a.layerX-this.offset.x,c=a.layerY-this.offset.y;if(null!=this.dragInfo)document.body.style.cursor="move",this.dragInfo.lastX=this.dragInfo.x,this.dragInfo.lastY=this.dragInfo.y,this.dragInfo.x=a.layerX,this.dragInfo.y=a.layerY,b=this.dragInfo.y-this.dragInfo.lastY,this.offset.x+=this.dragInfo.x-this.dragInfo.lastX,this.offset.y+=b;else{this.mouseOver=!1;for(var d in this.currentDoc.terms)if(-1!=this.termsFilter.indexOf(d)){a=this.currentDoc.terms[d].pos;for(var e=0;e<
a.length;e++)if(this.mouseOver)this.currentDoc.terms[d].pos[e].over=!1;else{var f=a[e].polygon;this.isPointInPolygon(f[0],f[1],b,c)?this.mouseOver=this.currentDoc.terms[d].pos[e].over=!0:this.currentDoc.terms[d].pos[e].over=!1}}if(this.mouseOver){if(document.body.style.cursor="pointer",!this.progressiveDraw||this.progressiveDraw&&this.progDrawDone)clearInterval(this.intervalId),this.intervalId=setInterval(this.doDraw.createDelegate(this,[!1]),50)}else if(document.body.style.cursor="auto",!this.progressiveDraw||
this.progressiveDraw&&this.progDrawDone)clearInterval(this.intervalId),this.doDraw(!1)}},mouseDownHandler:function(a){var b=a.layerX;a=a.layerY;this.dragInfo={lastX:b,lastY:a,x:b,y:a}},mouseUpHandler:function(a){this.dragInfo=null},getPolygonFromLine:function(a,b,c,d){var e=c+90,f=c-90;c=this.findEndPoint(a,d,e);a=this.findEndPoint(a,d,f);f=this.findEndPoint(b,d,f);b=this.findEndPoint(b,d,e);return[[c[0],a[0],f[0],b[0]],[c[1],a[1],f[1],b[1]]]},isPointInPolygon:function(a,b,c,d){for(var e=0,f=3,g=
!1,e=0;4>e;e++)(b[e]<d&&b[f]>=d||b[f]<d&&b[e]>=d)&&a[e]+(d-b[e])/(b[f]-b[e])*(a[f]-a[e])<c&&(g=!g),f=e;return g},clearCanvas:function(){this.canvas.width=this.canvas.width}};function Cirrus(a){function b(a){a="#"==a.charAt(0)?a.substring(1,7):a;var b=[];b.push(parseInt(a.substring(0,2),16));b.push(parseInt(a.substring(2,4),16));b.push(parseInt(a.substring(4,6),16));return b}function c(){if(0==$("#"+d.config.containerId).length)alert("You must provide a valid container ID!");else{d.canvas=document.createElement("canvas");d.canvas.setAttribute("id",e);d.canvas.setAttribute("tabIndex",1);d.setCanvasDimensions();$(f).append(d.canvas);e="#"+e;d.context=d.canvas.getContext("2d");
d.wordData=[];d.useFadeEffect=!0;d.colors=[[116,116,181],[139,163,83],[189,157,60],[171,75,75],[174,61,155]];g=new WordController(d);for(var a in d.config){"words"==a&&(d.wordData=d.config[a]);"layout"==a&&("circle"==d.config[a]?g.layout=g.CIRCLE:"square"==d.config[a]&&(g.layout=g.SQUARE));if("colors"==a&&$.isArray(d.config[a])&&0<d.config[a].length){d.colors=[];for(var c in d.config[a])d.colors.push(b(d.config[a][c]))}"background"==a&&$(e).css("background-color",d.config[a]);"fade"==a&&("true"==
d.config[a]?d.useFadeEffect=!0:"false"==d.config[a]&&(d.useFadeEffect=!1));"smoothness"==a&&(g.wordsToArrange=Math.max(1,Math.min(20,parseInt(d.config[a]))))}0<d.wordData.length&&(d.clear(),g.addWords(d.wordData),g.arrangeWords());$(window).resize(function(){null!=h&&clearTimeout(h);h=setTimeout(d.resizeWords,1E3)});$(e).keypress(function(a){114==a.which&&g.arrangeWords()});$(e).click(function(a){a=g.handleWordClick(a);void 0!==a&&d.config.clickHandler&&d.config.clickHandler({term:a.text,value:a.value})});
$(e).mouseover(function(a){g.startUpdates()});$(e).mouseout(function(a){g.stopUpdates()});$(e).mousemove(function(a){g.handleMouseMove(a)})}}var d=this;this.config=a;var e=Ext.id(null,"cirrusCanvas");if(null==this.config.containerId)alert("You must provide a valid container ID!");else{var f="#"+this.config.containerId,g=null,h=null;this.clear=function(){this.canvas.width=this.canvas.width};this.addWords=function(a){g.addWords(a)};this.arrangeWords=function(){g.arrangeWords()};this.clearAll=function(){g.setWords([]);
g.grid=[];this.clear()};this.resizeWords=function(){d.setCanvasDimensions();g.resetWordCoordinates();g.calculateSizeAdjustment();g.resizeWords();g.arrangeWords();h=null};this.setCanvasDimensions=function(){var a=$(f)[0],b=Math.max(a.offsetWidth,a.clientWidth),a=Math.max(a.offsetHeight,a.clientHeight);this.canvas.width=b;this.canvas.height=a};$(document).ready(c)}};function Word(a,b,c,d,e){this.relativeSize=this.rotation=this.width=this.height=0;this.mask=null;this.size=0;this.text=a;this.color=c;this.origSize=b;this.rolloverText=d;this.value=e||0;this.ty=this.tx=this.y=this.x=0;this.fontFamily="Arial";this.fontSize=12;this.alpha=1;this.isOver=this.live=!1;this.draw=function(a){a.save();a.fillStyle="rgba("+this.color[0]+","+this.color[1]+","+this.color[2]+","+this.alpha+")";a.textBaseline="alphabetic";a.font=this.fontSize+"px "+this.fontFamily;a.translate(this.x+
this.tx,this.y+this.ty);a.rotate(this.rotation);a.fillText(this.text,0,0);a.restore()}};function WordController(a){function b(a){for(var b=Math.log(10*a.relativeSize)*Math.LOG10E,c=(b+a.relativeSize)/2,d=0,e=0;e<a.text.length;e++)var f=a.text.charAt(e),d="f"==f||"i"==f||"j"==f||"l"==f||"r"==f||"t"==f?d+b/3:"m"==f||"w"==f?d+b/(4/3):d+b/1.9;return c*d}function c(){p.sort(function(a,b){return a.origSize>b.origSize?-1:a.origSize<b.origSize?1:0})}function d(){for(var a=0;a<p.length;a++){var c=p[a],d;d=c;var e=f.sizeAdjustment,e=b(d)*e;d=(Math.sqrt(6)*Math.sqrt(6*Math.pow(d.text.length,2)+
e*d.text.length)-6*d.text.length)/(2*d.text.length);c.fontSize=d>f.minFontSize?d:f.minFontSize;c.fontFamily="Impact";d=c;g.context.save();g.context.textBaseline="alphabetic";g.context.font=d.fontSize+"px "+d.fontFamily;d.width=g.context.measureText(d.text).width;d.height=Math.ceil(1.15*g.context.measureText("m").width);g.context.restore();c.tx=0;c.ty=c.height;d=0;f.getWordOrientation()===f.MIXED&&null==c.text.match(/\s/)&&.66<Math.random()&&(d=c.height,c.height=c.width,c.width=d,0==Math.round(Math.random())?
(d=90,c.ty=0):(d=-90,c.ty=c.height,c.tx=c.width));c.size=Math.max(c.height,c.width);c.rotation=Math.PI/180*d;g.context.fillStyle=g.canvas.style.backgroundColor;g.context.fillRect(0,0,g.canvas.width,g.canvas.height);c.draw(g.context);d=g.context.getImageData(c.x,c.y,c.width,c.height);for(var e=[],h=0;h<c.width;h++){var k=Math.floor(h/f.COARSENESS)*f.COARSENESS;null==e[k]&&(e[k]={});for(var m=0;m<c.height;m++){var l=Math.floor(m/f.COARSENESS)*f.COARSENESS,r;r=4*(h+m*d.width);r=[d.data[r],d.data[r+1],
d.data[r+2],d.data[r+3]];"rgb("+r[0]+", "+r[1]+", "+r[2]+")"!=g.canvas.style.backgroundColor&&(e[k][l]=!0);e[k][l]&&(m=l+f.COARSENESS)}}c.mask=e}}function e(){g.clear();for(var a=p.length;a--;){var b=p[a];b.alpha=1;b.live&&b.draw(g.context)}a=$(g.canvas);if(null!=n){a.css("cursor","pointer");g.context.save();g.context.textBaseline="alphabetic";g.context.font="12px Arial";var b=g.context.measureText(n.text).width,c=g.context.measureText(n.value).width,b=(b>c?b:c)+20,c=q+15,d=s+25,e=a.width(),a=a.height();
c+b>=e&&(c-=b);d+40>=a&&(d-=40);g.context.fillStyle="rgba(255,255,255,0.9)";g.context.strokeStyle="rgba(100,100,100,0.9)";g.context.translate(c,d);g.context.fillRect(0,0,b,40);g.context.strokeRect(0,0,b,40);g.context.fillStyle="rgba(0,0,0,0.9)";g.context.fillText(n.text+":",8,18);g.context.fillText(n.value,8,30);g.context.restore()}else a.css("cursor","default")}var f=this,g=a;this.CIRCLE=0;this.ratio=1;var h=this.CIRCLE;this.getLayout=function(){return h};this.setLayout=function(a){h=a};this.HORIZONTAL=
0;var k=this.MIXED=1;this.getWordOrientation=function(){return k};this.setWordOrientation=function(a){k=a};this.UPDATE_RATE=25;this.COARSENESS=5;this.grid=[];var m=0,l;this.doingArrange=!1;this.wordsToArrange=5;var n=null,q=0,s=0,p=[];this.getWords=function(){return p};this.setWords=function(a){p=a};this.sizeAdjustment=100;this.minFontSize=12;this.largestWordSize=0;this.smallestWordSize=1E4;var r={};this.addWords=function(a){for(var b=!1,e=0;e<a.length;e++){var h=a[e],k;k=void 0==typeof h.color||
null==h.color||""==h.color?g.colors[Math.floor(Math.random()*g.colors.length)]:h.color;var m;m=void 0==typeof h.size||null==h.size||""==h.size?Math.floor(40*Math.random()):parseFloat(h.size);var l=h.word,n=h.label,q=h.value,h=!1;null==r[l]&&(r[l]=!0,m>f.largestWordSize&&(f.largestWordSize=m,h=!0),m<f.smallestWordSize&&(f.smallestWordSize=.8*m,h=!0),l=new Word(l,m,k,n,q),p.push(l));b=h||b}c();this.setRelativeSizes();this.calculateSizeAdjustment();b?this.resizeWords():d()};this.resetWordCoordinates=
function(){g.clear();clearTimeout(l);for(var a=0;a<p.length;a++){var b=p[a];b.x=0;b.y=0;b.tx=0;b.ty=0}};this.calculateSizeAdjustment=function(){this.ratio=g.canvas.width/g.canvas.height;var a=g.canvas.width*g.canvas.height;this.minFontSize=1E5>a?8:12;for(var c=0,d=0;d<p.length;d++)var e=b(p[d]),c=c+e;this.sizeAdjustment=a/c};this.setRelativeSizes=function(){for(var a=0;a<p.length;a++){var b=p[a],c=this.smallestWordSize;b.relativeSize=.1+(b.origSize-c)/(this.largestWordSize-c)*.9}};this.resizeWords=
function(){g.clear();d();c()};this.arrangeWords=function(){clearTimeout(l);g.clear();this.toggleLoadingText();if(0<p.length){var a=function(a,b,c){for(var d=0;d<c.width;d+=this.COARSENESS)for(var e=0;e<c.height;e+=this.COARSENESS)c.mask[d]&&c.mask[d][e]&&(this.grid[d+a]||(this.grid[d+a]=[]),this.grid[d+a][e+b]=c)},b=function(a){a.alpha+=.25;a.draw(g.context)},c=function(b,c,d,e){a(b,c,d);d.x=b;d.y=c;d.live=!0;e&&d.draw(g.context)},d=function(a,b,c,d,e){for(var f=0;f<=d;f+=this.COARSENESS)for(var g=
0;g<=c;g+=this.COARSENESS)if(e[f]&&e[f][g]&&null!=this.grid[f+a]&&null!=this.grid[f+a][g+b])return!0;return!1},f;this.grid=[];m=0;f=function(){var a,f,h,k,r=this.wordsToArrange-1,n=g.canvas.width,q=g.canvas.height,C=.5*n,s=.5*q;do{h=p[m];if(void 0!==h){for(var H=Math.random()*Math.PI,w=.25*Math.random()*h.size,u=.5*(Math.random()-.5),v=.5*h.width,M=.5*h.height;;){a=Math.floor((C+Math.cos(H)*w*this.ratio-v)/this.COARSENESS)*this.COARSENESS;f=Math.floor((s+Math.sin(H)*w-M)/this.COARSENESS)*this.COARSENESS;
k=a+v>=n||f+M>=q?!0:d(a,f,h.height,h.width,h.mask);if(!k)break;H+=u;w+=.05}c(a,f,h);if(g.useFadeEffect)for(a=h.alpha=0;a<m;a++)f=p[a],1>f.alpha&&b(f);else h.alpha=1,h.draw(g.context)}m++;if(m>=p.length){clearTimeout(l);this.doingArrange=!1;this.toggleLoadingText(!1);e();break}}while(r--)}.createDelegate(this);d=d.createDelegate(this);c=c.createDelegate(this);b=b.createDelegate(this);a=a.createDelegate(this);this.doingArrange=!0;l=setInterval(f,50)}else alert("Error: There are no words to arrange.")};
this.toggleLoadingText=function(a){g.context.save();g.context.fillStyle=a?"black":g.canvas.style.backgroundColor;g.context.textBaseline="top";g.context.font="10px Arial";a=g.context.measureText("Loading").width+10;g.context.fillText("Loading",g.canvas.width-a,10);g.context.restore()};this.startUpdates=function(){l=setInterval(e,f.UPDATE_RATE)};this.stopUpdates=function(){null!=n&&(n=null,e());clearTimeout(l)};this.handleMouseMove=function(a){if(!this.doingArrange){for(var b=p.length;b--;)p[b].isOver=
!1;var c=$(g.canvas).offset(),d=(a.pageX-c.left)%this.COARSENESS,b=a.pageX-c.left-d,d=(a.pageY-c.top)%this.COARSENESS;a=a.pageY-c.top-d;n=this.findWordByCoords(b,a);null!=n&&(n.isOver=!0,q=b,s=a)}};this.handleWordClick=function(a){var b=$(g.canvas).offset(),c=(a.pageX-b.left)%this.COARSENESS,d=a.pageX-b.left-c,c=(a.pageY-b.top)%this.COARSENESS;a=this.findWordByCoords(d,a.pageY-b.top-c);if(null!=a)return{text:a.text,value:a.value}};this.findWordByCoords=function(a,b){var c=null;null!=this.grid[a]&&
(null!=this.grid[a][b]?c=this.grid[a][b]:null!=this.grid[a][b+this.COARSENESS]&&(c=this.grid[a][b+this.COARSENESS]));null==c&&null!=this.grid[a+this.COARSENESS]&&(null!=this.grid[a+this.COARSENESS][b]?c=this.grid[a+this.COARSENESS][b]:null!=this.grid[a+this.COARSENESS][b+this.COARSENESS]&&(c=this.grid[a+this.COARSENESS][b+this.COARSENESS]));return c}}
Function.prototype.createDelegate=function(a,b,c){var d=this;return function(){var e=b||arguments;if(!0===c)e=Array.prototype.slice.call(arguments,0),e=e.concat(b);else if("number"==typeof c){var e=Array.prototype.slice.call(arguments,0),f=[c,0].concat(b);Array.prototype.splice.apply(e,f)}return d.apply(a||window,e)}};var doubletree={};
(function(){function a(d,f,g){if(d.children){g&&(d.info.origIDs?(d.info.ids={},c(d.info.ids,d.info.origIDs),d.info.count=Object.keys(d.info.ids).length):(d.info.origIDs={},c(d.info.origIDs,d.info.ids),d.info.origCount=Object.keys(d.info.origIDs).length));var h=Object.keys(f);g=0;for(var k=h.length;g<k;g++)delete d.info.ids[h[g]];d.info.count=Object.keys(d.info.ids).length;k=d.children.length;for(g=0;g<k;g++)h=d.children[g],b(h.info.ids,f)?d.children[g]=null:a(h,f,!1);d.children=d.children.filter(function(a){return null!=
a});d.info.continuations=d.children.length;f=d3.max(d.children.map(function(a){return a.maxChildren}));d.maxChildren=Math.max(d.children.length,f)}}function b(a,b){if(!a||!b)return!1;for(var c in a)if(!(c in b))return!1;return!0}function c(a,b){for(var c in b)a[c]=b[c]}function d(){}doubletree.DoubleTree=function(){function b(a){a.each(function(a,b){f.push(this[b])})}var f=[],g=600,h=400,k=!1,m={left:[],right:[]},l={alt:d,shift:d,click:d},n=!0,q=!0,s=doubletree.sortByStrFld("token"),p=doubletree.tokenText,
r=function(a){return doubletree.fieldText(a,"POS")},C=function(a){return"rgba(255,255,255,1)"},F=function(a){return"rgba(255,255,255,1)"},D=function(a){return"red"},G={node:{fill:"white",stroke:"steelblue","stroke-width":"1.5px"},branch:{stroke:"#aaa","stroke-width":"1.5px"}},H=!1,L=d3.dispatch("idsUpdated");L.on("idsUpdated",function(){this==A?(B.setIds(A.continuationIDs),B.updateContinuations()):this==B&&(A.setIds(B.continuationIDs),A.updateContinuations())});var z,E,A,B,K,I;b.init=function(a){d3.select(d3.selectAll(a)).call(this);
return b};b.redraw=function(){b.setupFromTries(z,E);return b};b.setupFromTries=function(d,k){z=d.getUniqRoot();E=k.getUniqRoot();var x=z.toTree(m.left),w=E.toTree(m.right),u=!0;0<Object.keys(w.pruned).length&&(a(w,w.pruned,u),a(x,w.pruned,u),u=!1);0<Object.keys(x.pruned).length&&(a(x,x.pruned,u),a(w,x.pruned,u));var u={},v;for(v in w.info)"continuations"!=v&&"ids"!=v&&"count"!=v&&(u[v]=w.info[v]);u["right continuations"]=w.info.continuations;u["left continuations"]=x.info.continuations;u.ids={};c(u.ids,
w.info.ids);c(u.ids,x.info.ids);u.count=Object.keys(u.ids).length;K=Object.keys(u.ids);if(w.info.origIDs||x.info.origIDs)u.origIDs={},c(u.origIDs,w.info.origIDs),c(u.origIDs,x.info.origIDs),u.origCount=Object.keys(u.origIDs).length;w.info=u;x.info=u;v=Math.max(x.maxChildren,w.maxChildren);if(isNaN(v)||0==v)return H=!1,b;q?I=d3.scale.log().range([8,14]):(I=function(){return 14},I.domain=function(){});v=Math.min(x.minCount,w.minCount);I.domain([v,x.info.count]);var M=g-20-20,N=h-20-20;f[0].forEach(function(a,
b){function c(){var a=d3.event.scale,b=d3.event.translate;d3.select(d).select("svg \x3e g").attr("transform","translate("+b+") scale("+a+")")}var d=a,e;e=d3.select(d).select("svg");null==e[0][0]?(e=d3.select(d).append("svg").attr("width",M+20+20).attr("height",N+20+20).attr("cursor","move").call(d3.behavior.zoom().scaleExtent([1,1]).on("zoom",c)),e.append("g")):(e.attr("width",M+20+20).attr("height",N+20+20),e.selectAll("g *").remove());A=new doubletree.Tree(e.select("g"),g,h,x,!0,s,L,I,n,p,r,C,F,
D,G);B=new doubletree.Tree(e.select("g"),g,h,w,!1,s,L,I,n,p,r,C,F,D,G)});A.handleAltPress=l.alt;B.handleAltPress=l.alt;A.handleShiftPress=l.shift;B.handleShiftPress=l.shift;A.handleClick=l.click;B.handleClick=l.click;H=!0;return b};b.setupFromArrays=function(a,c,d,f,g,h,l,m){void 0==g&&z&&(g=z.caseSensitive());void 0==h&&z&&(h=z.fieldNames());void 0==l&&z&&(l=z.fieldDelim());void 0==m&&z&&(m=z.distinguishingFieldsArray());z=new doubletree.Trie(g,h,l,m);E=new doubletree.Trie(g,h,l,m);g=c.length;for(h=
0;h<g;h++){l=f?f[h]:h;m=c[h];var r=a[h].slice(),n=d[h].slice();r.push(m);r.reverse();n.unshift(m);k?(E.addNgram(r,l),z.addNgram(n,l)):(z.addNgram(r,l),E.addNgram(n,l))}b.setupFromTries(z,E);return b};b.filteredIDs=function(){return K};b.search=function(a){A.search(a);B.search(a);a=d3.select(f[0][0]);var b=a.selectAll("text.foundText");if(b.empty())return 0;b=b[0].length;null!=a.selectAll("text.rtNdText.foundText")[0][0]&&b--;return b};b.clearSearch=function(){A.clearSearch();B.clearSearch();return b};
b.updateTokenExtras=function(){A.showTokenExtras(n);B.showTokenExtras(n);var a=d3.select(f[0][0]).select('.tokenExtra[display\x3d"inline"]');a.empty()||"0px"==a.style("height")&&b.redraw();return b};b.visWidth=function(a){if(!arguments.length)return g;g=a;return b};b.visHeight=function(a){if(!arguments.length)return h;h=a;return b};b.prefixesOnRight=function(a){if(!arguments.length)return k;k=a;return b};b.filters=function(a){if(!arguments.length)return m;m=a;return b};b.handlers=function(a){if(!arguments.length)return l;
l=a;return b};b.showTokenExtra=function(a){if(!arguments.length)return n;n=a;return b};b.scaleLabels=function(a){if(!arguments.length)return q;q=a;return b};b.succeeded=function(){return H};b.sortFun=function(a){if(!arguments.length)return s;s=a;return b};b.nodeText=function(a){if(!arguments.length)return p;p=a;return b};b.tokenExtraText=function(a){if(!arguments.length)return r;r=a;return b};b.rectColor=function(a){if(!arguments.length)return C;C=a;return b};b.rectBorderColor=function(a){if(!arguments.length)return F;
F=a;return b};b.continuationColor=function(a){if(!arguments.length)return D;D=a;return b};b.basicStyles=function(a){if(!arguments.length)return G;Object.keys(G).forEach(function(b){b in a&&Object.keys(G[b]).forEach(function(c){c in a[b]&&(G[b][c]=a[b][c])})});return b};return b};doubletree.Tree=function(a,b,c,d,k,m,l,n,q,s,p,r,C,F,D){function G(a){a.children&&(a._children=a.children,a._children.forEach(G),a.children=null)}function H(a){a.parent&&a.parent.children.forEach(function(b){b!=a&&G(b)})}
function L(a,b){d3.event.altKey?v.handleAltPress(a,b):d3.event.shiftKey?v.handleShiftPress(a,b):(v.handleClick(a,b),a.parent&&(v.continuationIDs!=a.info.ids&&(v.setIds(a.info.ids),v.clickedNode=a.id,l.idsUpdated.apply(v)),H(a),z(a,!0)))}function z(a,b){a.children?(a.children&&1==a.children.length&&z(a.children[0],!0),a._children=a.children,a.children=null):(a.children=a._children,a._children=null,a.children&&1==a.children.length&&z(a.children[0],!1));b&&v.update(a)}function E(a){return k?K/2-a:K/
2+a}var A=q,B=r,K=b-20-20,I=c-20-20,O=0,J,x;m||(m=doubletree.sortByStrFld("token"));var w=d3.layout.tree().nodeSize([40,40]).sort(m),u=d3.svg.diagonal().projection(function(a){return[E(a.y),a.x-x]});a=a.append("g").attr("transform","translate(20,20)");this.readJSONTree=function(a){J=a;J.x0=I/2;J.y0=K/2;J.children.forEach(G);this.update(J)};var v=this;this.update=function(b){b||(b=J);var c=w.nodes(J).reverse();x=J.x-I/2;c.forEach(function(a){for(var b=0,c=a.parent;null!=c;)b+=Ext.draw.TextMeasurer.measureText(c.name,
"arial").width,c=c.parent;a.y=25*a.depth+b});var d=a.selectAll("g.node_"+k).data(c,function(a){return a.id||(a.id=++O)}),f=d.enter().append("g").attr("class","node node_"+k).attr("cursor","pointer").attr("transform",function(a){return"translate("+E(b.y0)+","+(b.x0-x)+")"}).on("click",L);f.append("title").text(function(a){return doubletree.infoToText(a.info)});f.append("circle").attr("r",1E-6).style("fill",function(a){return a._children?"#fff":D.node.fill}).style("stroke",function(a){return D.node.stroke});
f=f.append("text").attr("class",function(a){return 0==a.depth?"rtNdText":""}).attr("x",function(a){return a.children||a._children?0:k?10:-10}).attr("text-anchor",function(a){return a.parent?a.children||a._children?k?"end":"start":k?"start":"end":"middle"}).style("font-size",function(a){return n(a.info.count)+"pt"});f.append("tspan").attr("dy",".35em").attr("class","tokenText").text(function(a){return s(a.info,1>a.depth)}).style("fill-opacity",1E-6);f.append("tspan").attr("dx",".35em").attr("class",
"tokenExtra").text(function(a){return p(a.info,1>a.depth)}).style("fill-opacity",1E-6);this.drawRects=function(){var b=A?"inline":"none";a.selectAll(".tokenExtra").attr("display",b);d.selectAll("rect").remove();d.insert("rect","text").attr("class","nodeRect").attr("height",function(){return this.parentElement.getBBox().height-6}).attr("y",function(a){return a.parent?-.5*this.parentElement.getBBox().height/2:-.5*this.parentElement.getBBox().height/2-2}).attr("width",function(){return this.parentElement.getBBox().width}).attr("x",
function(a){var b=this.parentElement.getBBox().width;return a.parent?k?-.5*b:0:-.33333*b}).style("stroke-opacity",1).style("stroke-width",1).style("stroke",function(a){return C(a.info)}).style("fill",function(a){return B(a.info)}).style("fill-opacity",function(a){return 1})};try{this.drawRects()}catch(g){}f=d.transition().duration(200).attr("transform",function(a){return"translate("+E(a.y)+","+(a.x-x)+")"});f.select("circle").attr("r",function(a){return a.children||a._children?1E-6:4.5}).style("fill",
function(a){return a._children?"#fff":D.node.fill}).style("stroke-width",D.node["stroke-width"]);f.selectAll("tspan").style("fill-opacity",1);f=d.exit().transition().duration(200).attr("transform",function(a){return"translate("+E(b.y)+","+(b.x-x)+")"}).remove();f.select("circle").attr("r",1E-6);f.selectAll("tspan").style("fill-opacity",1E-6);f=a.selectAll("path.link_"+k).data(w.links(c),function(a){return a.target.id});f.enter().insert("path","g").attr("class","link link_"+k).attr("d",function(a){a=
{x:b.x0,y:b.y0};return u({source:a,target:a})}).style("fill","none").style("stroke",D.branch.stroke).style("stroke-width",D.branch["stroke-width"]);f.transition().duration(200).attr("d",u);f.exit().transition().duration(200).attr("d",function(a){a={x:b.x,y:b.y};return u({source:a,target:a})}).remove();c.forEach(function(a){a.x0=a.x;a.y0=a.y});this.updateContinuations()};this.setIds=function(a){v.continuationIDs=a};this.updateContinuations=function(){a.selectAll("g.node_"+k+" text").classed("continuation",
function(a){var b;a:{a=a.info.ids;var c=v.continuationIDs||{};for(b in a)if(b in c){b=!0;break a}b=!1}return b}).style("fill",function(a){return d3.select(this).classed("continuation")?F(a.info):"#444"})};this.search=function(b){a.selectAll("g.node text").classed("foundText",function(a){return b.test(s(a.info))})};this.clearSearch=function(){a.selectAll("g.node text").classed("foundText",!1)};this.showTokenExtras=function(a){if(0==arguments.length)return A;A=a;this.drawRects();return this};this.setRectColor=
function(a){if(0==arguments.length)return B;B=a;this.drawRects();return this};this.handleAltPress=function(){};this.handleShifttPress=function(){};this.handleClick=function(){};this.readJSONTree(d);return this};doubletree.sortByStrFld=function(a){return function(b,c){var d=void 0==b.info[a],k=void 0==c.info[a];if(d&&k)return 0;if(d)return-1;if(k)return 1;d=b.info[a].join(" ").toLowerCase();k=c.info[a].join(" ").toLowerCase();return d<k?-1:d>k?1:0}};doubletree.sortByCount=function(){return function(a,
b){return b.info.count-a.info.count}};doubletree.sortByContinuations=function(){return function(a,b){return b.info.continuations-a.info.continuations}};doubletree.filterByMinCount=function(a){return function(b){return b.count>=a}};doubletree.filterByMaxCount=function(a){return function(b){return b.count<=a}};doubletree.filterByPOS=function(a){var b=new RegExp(a);return function(a){return a.POS&&0<a.POS.filter(function(a){return-1<a.search(b)}).length}};doubletree.fieldText=function(a,b){return a[b]};
doubletree.tokenText=function(a){var b="";void 0!==a.token&&(b=a.token);return b};doubletree.infoToText=function(a){var b="",c;for(c in a)b="ids"==c||"origIDs"==c?b+(c+"\t:\t"+Object.keys(a[c]).join(",")+"\n"):b+(c+"\t:\t"+a[c]+"\n");return b}})();doubletree=doubletree||{};
(function(){doubletree.Trie=function(a,b,c,d,e){function f(a,b,c){this.id=b;this.count=c;this.info={count:c,ids:{}};if(null==a)this.item=k;else{this.item=a;this.info.ids={};this.info.ids[b]=!0;a=a.split(n);for(var d in a)this.info[l[d]]=[a[d]]}this.nodes={};this.addNgram=function(a,b,c){c||(c=1);var d,e;if(0<a.length){d=a.shift();var g=d.split(n);e=s&&this.item==k?"":g.filter(function(a,b){return-1<q.indexOf(l[b])}).map(function(a){return m?a.toLocaleLowerCase():a}).join(n)}else e=d=h;var r;if(e in
this.nodes&&this.nodes[e]instanceof f){r=this.nodes[e];r.info.count+=c;r.info.ids[b]=!0;for(var p in g)e=g[p],-1==r.info[l[p]].indexOf(e)&&r.info[l[p]].push(e)}else r=new f(d,b,c),this.nodes[e]=r;d!=h&&r.addNgram(a,b,c)};this.getUniqRoot=function(){if(this.item==k){var a=Object.keys(this.nodes);if(1==a.length)return this.nodes[a[0]]}return this};this.toTree=function(a){function b(a,c,d){var e={children:[]};e.name=d.item;e.info={};for(var f in d.info)if("Object"===typeof d.info[f]){e.info[f]={};for(var h in d.info[f])e.info[f][h]=
this.info[f][h]}else e.info[f]=d.info[f];e.pruned={};for(var k in d.nodes)f=d.nodes[k],h=a[c],!h||h&&h(f.info)?(e.children.push(b(a,c+1,f)),f.pruned!={}&&g(e.pruned,f.pruned)):g(e.pruned,f.info.ids);e.info.continuations=e.children.length;0==e.children.length?(e.children=null,e.maxChildren=0,e.maxLen=e.name?e.name.length:0,e.minCount=e.info.count):(a=d3.max(e.children.map(function(a){return a.maxChildren})),e.maxChildren=Math.max(e.children.length,a),a=d3.max(e.children.map(function(a){return a.maxLen})),
e.maxLen=Math.max(a,e.name.length),e.minCount=d3.min(e.children.map(function(a){return a.minCount})));return e}a||(a=[]);var c=JSON.parse(JSON.stringify(this));return b(a,0,c)}}function g(a,b){for(var c in b)a[c]=b[c]}var h=" ",k="_root_",m=!a&&!0;b||(b=["item"]);var l=b;n||(n="\t");var n=c;q||(q=[l[0]]);var q=d,s=e;void 0==s&&(s=!0);var p=new f(k,-1,0);this.addNgram=function(a,b,c){p.addNgram(a,b,c)};this.getUniqRoot=function(){var a=new doubletree.Trie(!m,l,n,q);a.trie(p.getUniqRoot());return a};
this.toTree=function(a,b){return p.toTree(a,b)};this.serialize=function(){return JSON.stringify(this)};this.deserialize=function(a){a=JSON.parse(a);h=a.endNG();k=a.rootName();m=a.caseSensitive();l=a.fieldNames();n=a.fieldDelim();q=a.distinguishingFieldsArray();p=a.trie()};this.endNG=function(){return h};this.rootName=function(){return k};this.trie=function(a){0<arguments.length&&(p=a);return p};this.caseSensitive=function(){return!m};this.fieldNames=function(){return l};this.fieldDelim=function(){return n};
this.distinguishingFieldsArray=function(){return q}}})();Ext.define("Voyant.util.Api",{constructor:function(a){a=[];if(!this.isApplication){var b=this.getApplication?this.getApplication():Voyant.application;if(this.mixins)for(d in this.mixins){var c=Ext.ClassManager.get(d);c&&c.api&&a.splice(0,0,c.api)}this.addParentApi(a,Ext.ClassManager.getClass(b));b.getApiParams&&a.push(b.getApiParams())}this.addParentApi(a,Ext.ClassManager.getClass(this));this.api={};a.forEach(function(a){for(d in a)this.api[d]={initial:a[d],value:a[d]}},this);a=Ext.Object.fromQueryString(document.location.search);
for(var d in a)this.api[d]&&this.setApiParam(d,a[d])},addParentApi:function(a,b){b.api&&a.splice(0,0,b.api);b.superclass&&this.addParentApi(a,b.superclass.self)},getApiParam:function(a,b){return void 0!==this.api[a]?this.api[a].value:b},getApiParams:function(a,b){a=a||Object.keys(this.api);var c={};Ext.isString(a)&&(a=[a]);a.forEach(function(a){var e=this.getApiParam(a);if(b||!Ext.isEmpty(e))c[a]=e},this);return c},getModifiedApiParams:function(){var a={},b;for(b in this.api)this.api[b].initial!=
this.api[b].value&&(a[b]=this.api[b].value);return a},setApiParams:function(a){for(var b in a)this.setApiParam(b,a[b])},setApiParam:function(a,b){this.api&&this.api[a]&&(this.api[a].value=b)}});Ext.define("Voyant.util.Localization",{statics:{DEFAULT_LANGUAGE:"en",LANGUAGE:"en"},languageStore:Ext.create("Ext.data.ArrayStore",{fields:["code","language"],data:[["en","English"]]}),getLanguage:function(a){var b=this.languageStore.findRecord(2==a.length?"code":"language",a);if(b)return b.get(2==a.length?"language":"code")},localize:function(a,b){return this._localizeObject(this,a,b)},_localizeObject:function(a,b,c){var d=this._localizeClass(Ext.ClassManager.getClass(a),b,c);if(d)return d;if(a.mixins)for(mixin in a.mixins)if(d=
this._localizeClass(Ext.ClassManager.getClass(a.mixins[mixin]),b,c))return d;return a.superclass&&(d=this._localizeObject(a.superclass,b,c))?d:c&&void 0!=c["default"]?c["default"]:"["+b+"]"},_localizeClass:function(a,b,c){if(a&&a.i18n&&a.i18n[b]){var d=!1;a.i18n[b]&&(d=a.i18n[b]);return d?d.isTemplate?d.apply(c):d:c&&void 0!=c["default"]?c["default"]:"["+b+"]"}return!1}});Ext.define("Voyant.util.Deferrable",{deferredStack:[],releaseAllDeferred:function(){this.deferredStack=[]},getDeferredCount:function(){return this.deferredStack.length},getDeferred:function(a){var b=new Ext.Deferred;a&&a.transfer&&a.transfer(a,b.promise);!b.promise.show&&window.show&&(b.promise.show=show);this.deferredStack.push(b);var c=this;b.promise.always(function(){c.deferredStack.pop()});return b},getPromiseFromDeferred:function(a){return"object"===typeof a.promise?a.promise:a.promise()},getDeferredNestedPromise:function(a,
b,c){var d=arguments.callee.caller,e=Voyant.application.getDeferred(c);a.then(function(a){e.resolve(d.apply(a,b))});return e.promise}});Ext.define("Voyant.util.DetailedError",{extend:"Ext.Error",mixins:["Voyant.util.Localization"],config:{msg:void 0,error:void 0,details:void 0},statics:{i18n:{}},constructor:function(a){this.setMsg(a.msg);this.setError(a.error);this.setDetails(a.details);this.callParent(arguments)},show:function(a){window.showError?showError.call(this):this.showMsg(a)},showMsg:function(a){a=a||{};Ext.applyIf(a,{message:this.getMsg()+"\x3cp class\x3d'error'\x3e\n"+this.getError()+"\u2026 \x3ca href\x3d'#' onclick\x3d\"window.open('').document.write(unescape('\x3cpre\x3e"+
escape(this.getDetails())+"\x3c/pre\x3e')); return false;\"\x3emore\x3c/a\x3e\x3c/p\x3e",title:this.localize("error"),buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR,autoScroll:!0});Ext.Msg.show(a)}});Ext.define("Voyant.util.ResponseError",{extend:"Voyant.util.DetailedError",config:{response:void 0},constructor:function(a){this.setResponse(a.response);Ext.applyIf(a,{msg:a.response.statusText,error:a.response.responseText.split(/(\r\n|\r|\n)/).shift(),details:a.response.responseText});this.callParent(arguments)}});Ext.define("Voyant.util.SparkLine",{getSparkLine:function(a,b){if(2>a.length)return"";for(var c=Number.MAX_VALUE,d=Number.MIN_VALUE,e=!1,f=0;f<a.length;f++)a[f]<c&&(c=a[f]),a[f]>d&&(d=a[f]),!e&&-1<a[f].toString().indexOf(".")&&(e=!0);var g=(d-c).toString(),h=1,h=1,k=[];if(e){h=100;for(f=g.indexOf(".")+1;f<g.length;f++)if("0"==g.charAt(f))h*=10;else break;for(f=0;f<a.length;f++)k[f]=parseInt(a[f]*h);d=parseInt(d*h);c=parseInt(c*h)}else{h=1;for(f=g.length-1;-1<f;f--)if("0"==g.charAt(f))h*=10;else break;
if(1!=h){for(f=0;f<a.length;f++)k[f]=a[f]/h;d/=h;c/=h}else k=a}var e=Math.floor(1800/((d.toString().length>c.toString().length?d.toString().length:c.toString().length)+1)),c="http://chart.apis.google.com/chart?cht\x3dls\x26amp;chco\x3d0077CC\x26amp;chls\x3d1,0,0\x26amp;chds\x3d"+c+","+d,d=Math.ceil(a.length/e),g=0,h="",m;m=5>a.length?5:10>a.length?4:20>a.length?3:50>a.length?2:1;for(f=0;f<d;f++){var l=k.slice(g,g+=e),h=h+("\x3cimg style\x3d'margin: 0; padding: 0;' border\x3d'0' src\x3d'"+c+"\x26amp;chs\x3d"+
m*l.length+"x15\x26amp;chd\x3dt:"+l.join(",")+"' alt\x3d'' class\x3d'chart-");1==d?h+="full":0<f&&f+1<d?h+"middle":h=0==f?h+"left":h+"right";h+="' /\x3e"}return h}});Ext.define("Voyant.util.Toolable",{requires:["Voyant.util.Localization"],statics:{i18n:{}},constructor:function(a){a=a||{};var b=void 0,c=this.up("component");a.moreTools?(b=[],a.moreTools.forEach(function(a){a&&a!=this.xtype&&b.push(this.getMenuItemFromXtype(a))},this)):c&&c.getInitialConfig("moreTools")&&(b=[],c.getInitialConfig("moreTools").forEach(function(a){a&&a!=this.xtype&&b.push(this.getMenuItemFromXtype(a))},this));b&&this.getApplication().getMoreTools&&b.push({xtype:"menuseparator"});if(this.getApplication().getMoreTools){var b=
b||[],d=this.getApplication(),c=d.getMoreTools();c.forEach(function(a){var c=[];a.items.forEach(function(a){c.push(this.getMenuItemFromXtype(a))},this);b.push({text:d.localize(a.i18n),glyph:a.glyph,menu:{items:c}})},this)}var e={save:{glyph:"xf08e@FontAwesome",fn:this.exportToolClick,items:void 0},plus:b?{glyph:"xf17a@FontAwesome",items:b}:void 0,gear:this.showOptionsClick||this.getOptions?{glyph:"xf205@FontAwesome",fn:this.showOptionsClick?this.showOptionsClick:function(a){a.isXType("voyanttabpanel")&&
(a=a.getActiveTab());Ext.create("Ext.window.Window",{title:a.localize("optionsTitle"),modal:!0,panel:a,items:{xtype:"form",items:a.getOptions(),listeners:{afterrender:function(b){var c=a.getApiParams(b.getForm().getFields().collect("name"));b.getForm().setValues(c)}},buttons:[{text:a.localize("reset"),glyph:"xf0e2@FontAwesome",flex:1,panel:a,ui:"default-toolbar",handler:function(a){this.mixins&&this.mixins["Voyant.util.Api"]&&(this.mixins["Voyant.util.Api"].constructor.apply(this),this.getCorpus&&
this.getCorpus()&&this.fireEvent("loadedCorpus",this,this.getCorpus()));a.up("window").close()},scope:a},{xtype:"tbfill"},{text:a.localize("cancelTitle"),ui:"default-toolbar",glyph:"xf00d@FontAwesome",flex:1,handler:function(a){a.up("window").close()}},{text:a.localize("confirmTitle"),glyph:"xf00c@FontAwesome",flex:1,panel:a,handler:function(a){var b=a.up("form").getValues();this.setApiParams(b);var c=this.getApplication(),d=c.getCorpus();if(void 0!=b.stopList&&void 0!=b.stopListGlobal&&b.stopListGlobal){c.setApiParams&&
c.setApiParams({stopList:b.stopList});for(var e=c.getViewport().query("panel,chart"),f=0;f<e.length;f++)e[f].setApiParams&&e[f].setApiParams({stopList:b.stopList});d&&(c.dispatchEvent("loadedCorpus",this,d),this.fireEvent("loadedCorpus",this,d))}d&&this.fireEvent("loadedCorpus",this,d);a.up("window").close()},scope:a}]},bodyPadding:5}).show()}}:void 0,help:{glyph:"xf128@FontAwesome",fn:this.helpToolClick}},c=[];if(a.includeTools)for(var f in a.includeTools)"object"==typeof a.includeTools[f]&&c.push(a.includeTools[f]);
for(f in e)a.includeTools&&!a.includeTools[f]||!e[f]||c.push({type:f,tooltip:this.localize(f+"Tip"),callback:e[f].fn,xtype:"toolmenu",glyph:e[f].glyph,items:e[f].items});Ext.apply(this,{tools:c});this.on("afterrender",function(){var a=this.getHeader();if(a&&"Desktop"==Ext.os.deviceType){var b=a.getEl();b.on("mouseover",function(){this.getHeader().getTools().forEach(function(a){a.show()})},this);b.on("mouseout",function(){this.getHeader().getTools().forEach(function(a){"help"!=a.type&&-1==a.type.indexOf("collapse")&&
a.hide()})},this);a.getTools().forEach(function(a,b){"help"!=a.type&&a.hide()})}},this)},getMenuItemFromXtype:function(a){var b=this.getApplication().getToolConfigFromToolXtype(a);b&&b.tooltip&&delete b.tooltip;return Ext.apply(Ext.clone(b),{xtype:"menuitem",text:b.title,textAlign:"left",handler:function(){this.replacePanel(b.xtype)},scope:this})},maximizeToolClick:function(a){var b=Ext.getClass(a).getName().split(".");url=a.getBaseUrl()+"tool/"+b[b.length-1]+"/";params=a.getModifiedApiParams();!params.corpus&&
a.getCorpus&&a.getCorpus()&&(params.corpus=a.getCorpus().getId());params&&(url+="?"+Ext.Object.toQueryString(params));a.openUrl(url)},exportToolClick:function(a){a.isXType("voyanttabpanel")&&(a=a.getActiveTab());var b="beta.voyant-tools.org"==window.location.hostname?[{html:"\x3cp class\x3d'keyword' style\x3d'text-align: center; font-weight: bold; padding: 4px;'\x3ePlease note that this is the beta server and you should not count on corpora persisting (for bookmarks, embedding, etc.)."}]:[];b.push({xtype:"radio",
name:"export",inputValue:"url",boxLabel:"\x3ca href\x3d'"+a.getExportUrl.call(a)+"' target\x3d'_blank'\x3e"+a.localize("exportViewUrl")+"\x3c/a\x3e",checked:!0,listeners:{afterrender:function(){this.boxLabelEl.on("click",function(){this.up("window").close()},this)}}},{xtype:"fieldset",collapsible:!0,collapsed:!0,title:a.localize("exportViewFieldset"),items:[{xtype:"radio",name:"export",inputValue:"embed",boxLabel:a.localize("exportViewHtmlEmbed")},{xtype:"radio",name:"export",inputValue:"biblio",
boxLabel:a.localize("exportViewBiblio")}]});a.isXType("grid")&&b.push({xtype:"fieldset",collapsible:!0,collapsed:!0,title:a.localize("exportGridCurrent"),items:[{xtype:"radio",name:"export",inputValue:"gridCurrentHtml",boxLabel:a.localize("exportGridCurrentHtml")},{xtype:"radio",name:"export",inputValue:"gridCurrentTsv",boxLabel:a.localize("exportGridCurrentTsv")},{xtype:"radio",name:"export",inputValue:"gridCurrentJson",boxLabel:a.localize("exportGridCurrentJson")}]});if((!a.getExportVisualization||
a.getExportVisualization())&&(a.down("chart")||a.getTargetEl().dom.querySelector("canvas")||a.getTargetEl().dom.querySelector("svg"))){var c=[{xtype:"radio",name:"export",inputValue:"png",boxLabel:a.localize("exportPng")}];a.getTargetEl().dom.querySelector("svg")&&c.push({xtype:"radio",name:"export",inputValue:"svg",boxLabel:a.localize("exportSvg")});b.push({xtype:"fieldset",collapsible:!0,collapsed:!0,title:a.localize("exportVizTitle"),items:c})}Ext.create("Ext.window.Window",{title:a.localize("exportTitle"),
modal:!0,items:{xtype:"form",items:b,buttons:[{text:a.localize("exportTitle"),glyph:"xf08e@FontAwesome",flex:1,panel:a,handler:function(b){var c=b.up("form"),f="export"+Ext.String.capitalize(c.getValues()["export"]);Ext.isFunction(a[f])?a[f].call(a,a,c):Ext.Msg.show({title:a.localize("exportError"),message:a.localize("exportNoFunction"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR});b.up("window").close()},scope:a},{text:a.localize("cancelTitle"),glyph:"xf00d@FontAwesome",flex:1,handler:function(a){a.up("window").close()}}]},
bodyPadding:5}).show()},exportSvg:function(a){if(a=this.getTargetEl().dom.querySelector("svg"))a=d3.select(a).attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").node().parentNode.innerHTML,Ext.Msg.show({title:this.localize("exportSvgTitle"),message:'\x3cimg src\x3d"data:image/svg+xml;base64,'+btoa(a)+'" style\x3d"float: right; max-width: 200px; max-height: 200px; border: thin dotted #ccc;"/\x3e'+this.localize("exportSvgMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,prompt:!0,multiline:!0,
value:a})},exportPngData:function(a){Ext.Msg.show({title:this.localize("exportPngTitle"),message:'\x3cimg src\x3d"'+a+'" style\x3d"float: right; max-width: 200px; max-height: 200px; border: thin dotted #ccc;"/\x3e'+this.localize("exportPngMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,prompt:!0,multiline:!0,value:'\x3cimg src\x3d"'+a+'" /\x3e'})},exportPng:function(){var a,b=this.down("draw");if(b)return this.exportPngData(b.getImage().data);if(this.down("chart"))return this.exportPngData(this.down("chart").getImage().data);
var c=this.getTargetEl().dom.querySelector("canvas");if(c)return this.exportPngData(c.toDataURL("image/png"));if(b=this.getTargetEl().dom.querySelector("svg")){var d=d3.select(b).attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").node().parentNode.innerHTML;a="data:image/svg+xml;base64,"+btoa(d);var c=Ext.DomHelper.createDom({tag:"canvas",width:b.offsetWidth,height:b.offsetHeight}),e=c.getContext("2d"),f=new Image;f.src=a;f.panel=this;f.onload=function(){e.drawImage(f,0,0);a=c.toDataURL("image/png");
return this.panel.exportPngData.call(this.panel,a)}}},exportUrl:function(){this.openUrl(this.getExportUrl())},exportEmbed:function(){Ext.Msg.show({title:this.localize("exportViewEmbedTitle"),message:this.localize("exportViewEmbedMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,prompt:!0,multiline:!0,value:"\x3c!--\tExported from Voyant Tools: http://voyant-tools.org/.\nPlease note that this is an early version and the API may change.\nFeel free to change the height and width values below: --\x3e\n\x3ciframe style\x3d'width: 100%; height: 800px' src\x3d'"+
this.getExportUrl()+"'\x3e\x3c/iframe\x3e"})},exportBiblio:function(){var a=new Date;Ext.Msg.show({title:this.localize("exportBiblioTitle"),message:"\x3cfieldset\x3e\x3clegend\x3eMLA\x3c/legend\x3eSinclair, St\u00e9fan and Geoffrey Rockwell. "+(this.isXType("voyantheader")?"":'"'+this.localize("title")+'." ')+"\x3ci\x3eVoyant Tools\x3c/i\x3e. "+Ext.Date.format(a,"Y")+". Web. "+Ext.Date.format(a,"j M Y")+". \x26lt;http://voyant-tools.org\x26gt;.\x3c/fieldset\x3e\x3cbr \x3e\x3cfieldset\x3e\x3clegend\x3eChicago\x3c/legend\x3eSt\u00e9fan Sinclair and Geoffrey Rockwell, "+
(this.isXType("voyantheader")?"":'"'+this.localize("title")+'", ')+"\x3ci\x3eVoyant Tools\x3c/i\x3e, accessed "+Ext.Date.format(a,"F j, Y")+", http://voyant-tools.org.\x3c/fieldset\x3e\x3cbr \x3e\x3cfieldset\x3e\x3clegend\x3eAPA\x3c/legend\x3eSinclair, S. \x26amp; G. Rockwell. ("+Ext.Date.format(a,"Y")+"). "+(this.isXType("voyantheader")?"":this.localize("title")+". ")+"\x3ci\x3eVoyant Tools\x3c/i\x3e. Retrieved "+Ext.Date.format(a,"F j, Y")+", from http://voyant-tools.org\x3c/fieldset\x3e",buttons:Ext.Msg.OK,
icon:Ext.Msg.INFO})},exportGridCurrentJson:function(a,b){function c(a){var b={};e.forEach(function(c){b[c.text]=a.get(c.dataIndex)});values.push(b)}var d=a.getStore();d.getFields();var e=a.getColumnManager().headerCt.getVisibleGridColumns();values=[];d.buffered?d.data.forEach(c):d.each(c);Ext.Msg.show({title:this.localize("exportDataTitle"),message:this.localize("exportDataJsonMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,prompt:!0,multiline:!0,value:Ext.encode(values)})},exportGridCurrentTsv:function(a,
b){function c(a){cells=[];f.forEach(function(b){b=a.get(b.dataIndex);Ext.isString(b)&&(b=b.replace(/\s+/g," "));cells.push(b)});g+=cells.join("\t")+"\n"}var d=a.getStore(),e=d.getFields(),f=a.getColumnManager().headerCt.getVisibleGridColumns(),e=[];f.forEach(function(a){e.push(a.text)});var g=e.join("\t")+"\n";d.buffered?d.data.forEach(c):d.each(c);Ext.Msg.show({title:this.localize("exportDataTitle"),message:this.localize("exportDataTsvMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,prompt:!0,multiline:!0,
value:g})},exportGridCurrentHtml:function(a,b){function c(a){e+="\t\t\x3ctr\x3e\n";f.forEach(function(b){b=a.get(b.dataIndex);Ext.isString(b)&&(b=b.replace(/&/g,"\x26amp;").replace(/</g,"\x26lt;").replace(/>/g,"\x26lg;"));e+="\t\t\t\x3ctd\x3e"+b+"\x3c/td\x3e\n"});e+="\t\t\x3c/tr\x3e\n"}var d=a.getStore();d.getFields();var e="\x3ctable\x3e\n\t\x3cthead\x3e\n\t\t\x3ctr\x3e\n",f=a.getColumnManager().headerCt.getVisibleGridColumns();f.forEach(function(a){e+="\t\t\t\x3ctd\x3e"+a.text+"\x3c/td\x3e\n"});
e+="\t\t\x3c/tr\x3e\n\t\x3c/thead\x3e\n\t\x3ctbody\x3e\n";d.buffered?d.data.forEach(c):d.each(c);e+="\t\x3c/tbody\x3e\n\x3c/table\x3e";Ext.Msg.show({title:this.localize("exportDataTitle"),message:this.localize("exportDataHtmlMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,prompt:!0,multiline:!0,value:e})},getExportUrl:function(){var a=this.isXType("voyantheader")?this.getApplication().getModifiedApiParams():this.getModifiedApiParams();this.isXType("voyantheader")||(a.view=Ext.getClassName(this).split(".").pop());
a.corpus||(a.corpus=this.getApplication().getCorpus().getAliasOrId());return this.getApplication().getBaseUrl()+"?"+Ext.Object.toQueryString(a)},helpToolClick:function(a){a.isXType("voyanttabpanel")&&(a=a.getActiveTab());var b=a.localize("help",{"default":!1})||a.localize("helpTip");b==a._localizeClass(Ext.ClassManager.get("Voyant.util.Toolable"),"helpTip")?a.openUrl(a.getBaseUrl()+"docs/#!/guide/"+a.getXType()):Ext.Msg.alert(a.localize("title"),b+"\x3cp\x3e\x3ca href\x3d'"+a.getBaseUrl()+"docs/"+
(a.isXType("voyantheader")?"":"#!/guide/"+a.getXType())+"' target\x3d'voyantdocs'\x3e"+a.localize("moreHelp")+"\x3c/a\x3e\x3c/p\x3e")},replacePanel:function(a){var b=this.getApplication().getCorpus();this.getInitialConfig();var c;if(this.isXType("voyantheader")&&this.getApplication().getViewComponent){c=this.getApplication().getViewComponent();c.removeAll(!0);var d=c.add({xtype:a});b&&this.getApplication().dispatchEvent("loadedCorpus",c,b);c=Ext.Object.fromQueryString(document.location.search);var d=
this.getApplication().getBaseUrl(),d=d+("?corpus\x3d"+b.getAliasOrId()),d=d+("\x26view\x3d"+a),e;for(e in c)"corpus"!==e&&"view"!==e&&(d+="\x26"+e+"\x3d"+c[e]);window.history.pushState({corpus:b.getAliasOrId(),view:a},"",d)}else c=this.isXType("voyantheader")&&this.getApplication().getViewComponent?this.getApplication().getViewComponent():this.up("component"),c.remove(this,!0),d=c.add({xtype:a}),c.isXType("voyanttabpanel")&&c.setActiveTab(d),b&&d.fireEvent("loadedCorpus",d,b);this.getApplication().dispatchEvent("panelChange",
this)}});
Ext.define("Voyant.util.ToolMenu",{extend:"Ext.panel.Tool",alias:"widget.toolmenu",renderTpl:['\x3cdiv class\x3d"x-menu-tool-hover"\x3e\x3c/div\x3e\x3ctpl if\x3d"glyph"\x3e\x3cspan id\x3d"{id}-toolEl" class\x3d"{baseCls}-glyph {childElCls}" role\x3d"presentation" style\x3d"font-family: {glyphFontFamily}; \x3ctpl if\x3d"Ext.isSafari || (Ext.isWebKit \x26\x26 Ext.os.name\x3d\x3d\'iOS\')"\x3emargin-right: 15px; \x3c/tpl\x3e"\x3e\x26#{glyph}\x3c/span\x3e\x3ctpl else\x3e\x3cimg id\x3d"{id}-toolEl" src\x3d"{blank}" class\x3d"{baseCls}-img {baseCls}-{type}{childElCls}" role\x3d"presentation"/\x3e\x3c/tpl\x3e'],privates:{onClick:function(){var a=
this.callParent(arguments);a&&this.items&&(this.toolMenu||(this.toolMenu=new Ext.menu.Menu({items:this.items})),this.toolMenu.showAt(0,0),this.toolMenu.showAt(this.getX()+this.getWidth()-this.toolMenu.getWidth(),this.getY()+this.getHeight()+10));return a},onDestroy:function(){Ext.destroyMembers(this,"toolMenu");this.callParent()}},initComponent:function(){this.callParent(arguments);var a,b;a=this.glyph||"xf12e@FontAwesome";"string"===typeof a?(b=a.split("@"),a=b[0],b=b[1]):b="FontAwesome";Ext.applyIf(this.renderData,
{baseCls:this.baseCls,blank:Ext.BLANK_IMAGE_URL,type:this.type,glyph:a,glyphFontFamily:b})}});Ext.define("Voyant.util.Transferable",{transferable:["transfer"],transfer:function(a,b){if(a.transferable)for(var c=0;c<a.transferable.length;c++){var d=a.transferable[c];b[d]=Ext.bind(a[d],b)}if(a.mixins)for(mixin in a.mixins)this.transfer(a.mixins[mixin],b)}});Ext.define("Voyant.util.Variants",{extend:"Ext.Base",constructor:function(a){this.variants=a;this.map={};this.variants.forEach(function(a,c){a.forEach(function(a){this.map[a]=c},this)},this)},getVariants:function(a){var b=[];Ext.isString(a)&&(a=[a]);Ext.isArray(a)&&a.forEach(function(a){void 0!=this.map[a]&&b.push.apply(b,this.variants[this.map[a]])},this);return b}});Ext.define("Voyant.util.Downloadable",{mixins:["Voyant.util.Localization"],statics:{i18n:{}},downloadFromCorpusId:function(a){var b=this;Ext.create("Ext.window.Window",{title:this.localize("exportTitle"),modal:!0,items:{xtype:"form",items:{xtype:"downloadoptions"},listeners:{afterrender:function(a){a.getForm().setValues(b.getApiParams(["documentFilename","documentFormat"]))}},buttons:[{text:this.localize("cancelButton"),glyph:"xf00d@FontAwesome",flex:1,ui:"default-toolbar",handler:function(a){a.up("window").close()}},
{text:this.localize("downloadButton"),glyph:"xf00c@FontAwesome",flex:1,handler:function(c){var d=c.up("form").getValues();b.setApiParams(d);b.openDownloadCorpus(a);c.up("window").close()},scope:this}]},bodyPadding:5}).show()},openDownloadCorpus:function(a){a=this.getTromboneUrl()+"?corpus\x3d"+a+"\x26tool\x3dcorpus.CorpusExporter\x26outputFormat\x3dzip\x26zipFilename\x3dDownloadedVoyantCorpus-"+a+".zip"+(this.getApiParam("documentFormat")?"\x26documentFormat\x3d"+this.getApiParam("documentFormat"):
"")+(this.getApiParam("documentFilename")?"\x26documentFilename\x3d"+this.getApiParam("documentFilename"):"");this.openUrl(a)}});Ext.define("Voyant.notebook.util.Show",{transferable:["show"],show:function(){show.apply(this,arguments)},statics:{show:function(a){this.then?this.then(function(a){show.apply(a,arguments)}):(a=a.getString?a.getString():a.toString(),0==Voyant.notebook.util.Show.SINGLE_LINE_MODE&&(a="\x3cdiv class\x3d'"+Voyant.notebook.util.Show.MODE+"'\x3e"+a+"\x3c/div\x3e"),Voyant.notebook.util.Show.TARGET.insertHtml("beforeEnd",a))},showError:function(a,b){debugger;var c=Voyant.notebook.util.Show.MODE;Voyant.notebook.util.Show.MODE=
"error";this instanceof Voyant.util.ResponseError&&(a=this);a instanceof Voyant.util.ResponseError?(console&&console.error(a.getResponse()),b=a.getResponse().responseText,a=a.getMsg()):(a.stack&&!b&&(b=a.stack),b&&!1===Ext.isString(b)&&(b=b.toString()));console&&console.error(a);b&&(console&&console.error(b),a="\x3ch3\x3e"+a.toString()+"\x3c/h3\x3e\x3cpre\x3e"+Ext.String.htmlEncode(b)+"\x3c/pre\x3e");show(a);Voyant.notebook.util.Show.MODE=c},TARGET:null,MODE:"info",SINGLE_LINE_MODE:!1}});
var show=Voyant.notebook.util.Show.show,showError=Voyant.notebook.util.Show.showError;Ext.define("Voyant.notebook.util.Embed",{transferable:["embed"],embed:function(){embed.apply(this,arguments)},statics:{i18n:{},embed:function(a,b){if(this.then)this.then(function(c){embed.call(c,a,b)});else if(Ext.isArray(a)){Voyant.notebook.util.Show.SINGLE_LINE_MODE=!0;show("\x3ctable\x3e\x3ctr\x3e");for(var c=0;c<arguments.length;c++){var d=arguments[c];show("\x3ctd\x3e");d[0].embed.call(d[0],d[1],d[2]);show("\x3c/td\x3e")}show("\x3c/tr\x3e\x3c/table\x3e");Voyant.notebook.util.Show.SINGLE_LINE_MODE=
!1}else if(!this.embeddable||a&&!Ext.isObject(a)||(Ext.isObject(a)&&(b=a),a=this.embeddable[0]),Ext.isString(a)&&(a=Ext.ClassManager.getByAlias("widget."+a)||Ext.ClassManager.get(a)),Ext.isFunction(a)){var e=a.getName();if(this.embeddable&&Ext.Array.each(this.embeddable,function(a){return a!=e},this))Voyant.notebook.util.Embed.showWidgetNotRecognized.call(this);else{b=b||{};c={};for(key in Ext.ClassManager.get(Ext.getClassName(a)).api)key in b&&(c[key]=b[key]);c.corpus||("Voyant.data.model.Corpus"==
Ext.getClassName(this)?c.corpus=this.getId():this.getCorpus&&(c.corpus=this.getCorpus().getId()));Ext.applyIf(b,{style:"width: "+(b.width||"90%")+(Ext.isNumber(b.width)?"px":"")+"; height: "+(b.height||"400px")+(Ext.isNumber(b.height)?"px":"")});delete b.width;delete b.height;-1<document.location.search.indexOf("debug\x3dtrue")&&(c.debug=!0);var c=Ext.Object.toQueryString(c),f=new Ext.XTemplate('\x3ciframe style\x3d"'+b.style+'" src\x3d"'+Voyant.application.getBaseUrl()+"tool/"+e.substring(e.lastIndexOf(".")+
1)+'/?{0}"\x3e\x3c/iframe\x3e');1950>c.length?show(f.apply(["minimal\x3dtrue\x26"+c])):Ext.Ajax.request({url:Voyant.application.getTromboneUrl(),params:{tool:"resource.StoredResource",storeResource:c}}).then(function(a){a=Ext.util.JSON.decode(a.responseText);show(f.apply(["minimal\x3dtrue\x26embeddedConfig\x3d"+a.storedResource.id]))}).otherwise(function(a){showError(a)})}}else Voyant.notebook.util.Embed.showWidgetNotRecognized.call(this)},showWidgetNotRecognized:function(){var a=Voyant.notebook.util.Embed.i18n.widgetNotRecognized;
this.embeddable&&(a+=Voyant.notebook.util.Embed.i18n.tryWidget+"\x3cul\x3e"+this.embeddable.map(function(a){a=a.substring(a.lastIndexOf(".")+1).toLowerCase();return"\"\x3ca href\x3d'"+Voyant.application.getBaseUrl()+"/docs/#!/guide/"+a+"' target\x3d'voyantdocs'\x3e"+a+'\x3c/a\x3e"'}).join(", ")+"\x3c/ul\x3e");showError(a)}}});embed=Voyant.notebook.util.Embed.embed;Ext.define("Voyant.data.model.AnalysisToken",{extend:"Ext.data.Model",idProperty:"term",fields:[{name:"term"},{name:"rawFreq",type:"int"},{name:"relativeFreq",type:"number"},{name:"cluster",type:"int"},{name:"clusterCenter",type:"boolean"},{name:"vector"}]});Ext.define("Voyant.data.model.Context",{extend:"Ext.data.Model",fields:[{name:"id"},{name:"docIndex",type:"int"},{name:"docId"},{name:"left"},{name:"keyword"},{name:"term"},{name:"right"}],getDocIndex:function(){return this.get("docIndex")},getLeft:function(){return this.get("left")},getMiddle:function(){return this.get("middle")},getHighlightedMiddle:function(){return"\x3cspan class\x3d'keyword'\x3e"+this.getMiddle()+"\x3c/span\x3e"},getRight:function(){return this.get("right")},getHighlightedContext:function(){return this.getLeft()+
this.getHighlightedMiddle()+this.getRight()}});Ext.define("Voyant.data.model.CorpusFacet",{extend:"Ext.data.Model",fields:[{name:"facet"},{name:"label"},{name:"inDocumentsCount",type:"int"}],getLabel:function(){return this.get("label")},getFacet:function(){return this.get("facet")},getInDocumentsCount:function(){return this.get("inDocumentsCount")}});Ext.define("Voyant.data.model.CorpusCollocate",{extend:"Ext.data.Model",fields:[{name:"term"},{name:"rawFreq",type:"int"},{name:"contextTerm"},{name:"contextTermRawFreq",type:"int"}],getTerm:function(){return this.getKeyword()},getRawFreq:function(){return this.getKeywordRawFreq()},getKeyword:function(){return this.get("term")},getKeywordRawFreq:function(){return this.get("rawFreq")},getContextTerm:function(){return this.get("contextTerm")},getContextTermRawFreq:function(){return this.get("contextTermRawFreq")}});Ext.define("Voyant.data.model.CorpusTerm",{extend:"Ext.data.Model",fields:[{name:"id"},{name:"rawFreq",type:"int"},{name:"inDocumentsCount",type:"int"},{name:"relativeFreq",type:"float"},{name:"relativePeakedness",type:"float"},{name:"relativeSkewness",type:"float"},{name:"distributions"},{name:"typeTokenRatio-lexical",type:"float",calculate:function(a){return a["typesCount-lexical"]/a["tokensCount-lexical"]}}],getTerm:function(){return this.get("term")},getRawFreq:function(){return parseInt(this.get("rawFreq"))},
getInDocumentsCount:function(){return parseInt(this.get("inDocumentsCount"))},getDistributions:function(){return this.get("distributions")},show:function(a){show(this.getString(a))},getString:function(){return this.getTerm()+": "+this.getRawFreq()}});Ext.define("Voyant.data.model.CorpusNgram",{extend:"Ext.data.Model",fields:[{name:"term"},{name:"length",type:"int"},{name:"rawFreq",type:"int"},{name:"distributions"}],getTerm:function(){return this.get("term")}});Ext.define("Voyant.data.model.Dimension",{extend:"Ext.data.Model",fields:[{name:"percentage",type:"number"}]});Ext.define("Voyant.data.model.Document",{extend:"Ext.data.Model",fields:[{name:"corpus"},{name:"id"},{name:"index",type:"int"},{name:"tokensCount-lexical",type:"int"},{name:"typesCount-lexical",type:"int"},{name:"typeTokenRatio-lexical",type:"float",calculate:function(a){return a["typesCount-lexical"]/a["tokensCount-lexical"]}},{name:"lastTokenStartOffset-lexical",type:"int"},{name:"title"},{name:"language",convert:function(a){return Ext.isEmpty(a)?"":a}}],getLexicalTokensCount:function(){return this.get("tokensCount-lexical")},
getLexicalTypeTokenRatio:function(){return this.get("typeTokenRatio-lexical")},loadDocumentTerms:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);var b=Voyant.application.getDeferred(this);a=a||{};Ext.isNumber(a)&&(a={limit:a});Ext.applyIf(a,{limit:0});var c=this.getDocumentTerms();c.load({params:a,callback:function(a,e,f){f?b.resolve(c):b.reject(e)}});return b.promise},loadTokens:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,
arguments);var b=Voyant.application.getDeferred(this);a=a||{};Ext.isNumber(a)&&(a={limit:a});Ext.applyIf(a,{limit:0});var c=this.getTokens(a);c.load({params:a,callback:function(a,e,f){f?b.resolve(c):b.reject(e)}});return b.promise},getTokens:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);a=a||{};Ext.applyIf(a,{proxy:{}});Ext.applyIf(a.proxy,{extraParams:{}});Ext.applyIf(a.proxy.extraParams,{docIndex:this.get("index")});Ext.apply(a,{docId:this.get("id")});
return this.get("corpus").getTokens(a)},getDocumentTerms:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);a=a||{};Ext.applyIf(a,{proxy:{}});Ext.applyIf(a.proxy,{extraParams:{}});Ext.applyIf(a.proxy.extraParams,{docIndex:this.get("index")});return a.corpus?a.corpus.getDocumentTerms(a):this.get("corpus").getDocumentTerms(a)},getIndex:function(){return this.get("index")},getId:function(){return this.get("id")},getFullLabel:function(){var a=this.getAuthor();
return this.getTitle()+(a?"("+a+")":"")},getTitle:function(){var a=this.get("title");void 0===a&&(a="");a=Ext.isArray(a)?a.join("; "):a;return a=a.trim().replace(/\s+/g," ")},getTruncated:function(a,b){if(a.length>b){var c=a.lastIndexOf("/");-1<c&&(a=a.substr(c+1));if(a.length>b){c=a.indexOf(" ",b-5);if(0>c||c>b)c=b;a=a.substring(0,c)+"\u2026"}}return a},getShortTitle:function(){var a=this.getTitle(),a=a.replace(/\.(html?|txt|xml|docx?|pdf|rtf|\/)$/,""),a=a.replace(/^(the|a|le|l'|un|une)\s/,"");return this.getTruncated(a,
25)},getTinyTitle:function(){return this.getTruncated(this.getShortTitle(),10)},getShortLabel:function(){return parseInt(this.getIndex())+1+") "+this.getShortTitle()},getTinyLabel:function(){return parseInt(this.getIndex())+1+") "+this.getTinyTitle()},getAuthor:function(){var a=this.get("author")||"",a=Ext.isArray(a)?a.join("; "):a;return a=a.trim().replace(/\s+/g," ")},getCorpusId:function(){return this.get("corpus")},isPlainText:function(){return this.get("extra.Content-Type")&&/plain/i.test(this.get("extra.Content-Type"))?
!0:!1},show:function(){show(this.getFullLabel())}});Ext.define("Voyant.data.model.DocumentQueryMatch",{extend:"Ext.data.Model",fields:[{name:"id"},{name:"count",type:"int"},{name:"query"},{name:"distributions"}],getCount:function(){return this.get("count")},getDistributions:function(){return this.get("distributions")},getDocIds:function(){return this.get("docIds")}});Ext.define("Voyant.data.model.DocumentTerm",{extend:"Ext.data.Model",fields:[{name:"id"},{name:"term"},{name:"docIndex",type:"int"},{name:"docId"},{name:"rawFreq",type:"int"},{name:"relativeFreq",type:"float"},{name:"tfidf",type:"float"},{name:"zscore",type:"float"},{name:"zscoreRatio",type:"float"},{name:"distributions"}],getTerm:function(){return this.get("term")},getDocIndex:function(){return this.get("docIndex")},getRawFreq:function(){return this.get("rawFreq")},getDistributions:function(){return this.get("distributions")}});Ext.define("Voyant.data.model.PrincipalComponent",{extend:"Ext.data.Model",fields:[{name:"eigenValue",type:"number"},{name:"eigenVectors"}]});Ext.define("Voyant.data.model.StatisticalAnalysis",{extend:"Ext.data.Model",requires:["Voyant.data.model.PrincipalComponent","Voyant.data.model.Dimension","Voyant.data.model.AnalysisToken"],fields:[{name:"id"}],getPrincipalComponents:function(){var a=[];this.data.principalComponents.forEach(function(b){a.push(Ext.create("Voyant.data.model.PrincipalComponent",b))});return a},getDimensions:function(){var a=[];this.data.dimensions.forEach(function(b){a.push(Ext.create("Voyant.data.model.Dimension",b))});
return a},getTokens:function(){var a=[];this.data.tokens.forEach(function(b){a.push(Ext.create("Voyant.data.model.AnalysisToken",b))});return a}});Ext.define("Voyant.data.model.Token",{extend:"Ext.data.Model",fields:[{name:"id"},{name:"docId"},{name:"docIndex",type:"int"},{name:"token"},{name:"rawFreq"},{name:"tokenType"},{name:"position",type:"int"},{name:"startOffset",type:"int"},{name:"endOffset",type:"int"}],statics:{getInfoFromElement:function(a){if(a&&a.getId)return a=a.getId().split("_"),{docIndex:parseInt(a[1]),position:parseInt(a[2])}}},isWord:function(){return"lexical"==this.getTokenType()},isStopword:function(){return"true"==this.get("stopword")},
getTokenType:function(){return this.get("tokenType")},getId:function(){return["",this.getDocIndex(),this.getPosition()].join("_")},getDocIndex:function(){return this.get("docIndex")},getDocId:function(){return this.get("docId")},getTerm:function(){return this.get("term")},getTermWithLineSpacing:function(a){var b=this.getTerm().replace(/<\/?\w+\b.*?>/g,"\x3cbr /\x3e\x3cbr /\x3e").replace(/>\s+</g,"\x3e\x3c").replace(/<br \/><br \/>(<br \/>)+/g,"\x3cbr /\x3e\x3cbr /\x3e");a&&(b=b.replace(/(\r\n|\r|\n)\s*/g,
"\x3cbr /\x3e"));return b},getPosition:function(){return this.get("position")},getDocumentRawFreq:function(){return this.get("rawFreq")}});Ext.define("Voyant.data.store.VoyantStore",{mixins:["Voyant.util.Localization"],config:{corpus:void 0,parentPanel:void 0},constructor:function(a,b){var c=this;a=a||{};Ext.applyIf(a,{remoteSort:!0,autoLoad:!1,pagePurgeCount:0,pageSize:100,leadingBufferZone:200});a.proxy=a.proxy||{};Ext.applyIf(a.proxy,{type:"ajax",url:Voyant.application.getTromboneUrl(),actionMethods:{read:"POST"},reader:{type:"json",rootProperty:b["proxy.reader.rootProperty"],totalProperty:b["proxy.reader.totalProperty"],metaProperty:b["proxy.reader.metaProperty"]||
"metaData"},simpleSortMode:!0,listeners:{exception:function(a,b,f){c.parentPanel&&c.parentPanel.showError&&c.parentPanel.showError(new Voyant.util.ResponseError({response:b}))}}});a.proxy.extraParams=a.proxy.extraParams||{};Ext.applyIf(a.proxy.extraParams,{tool:b["proxy.extraParams.tool"]});void 0!==a.parentPanel&&(Ext.applyIf(a.proxy.extraParams,{forTool:a.parentPanel.xtype}),this.setParentPanel(a.parentPanel),a.parentPanel.on("loadedCorpus",function(a,b){this.setCorpus(b)},this),a.listeners=a.listeners||
{},a.listeners.beforeload={fn:function(a,b){var c=this.getParentPanel(),g=a.getProxy();if(void 0!==c){c=c.getApiParams();b=b?1===b?{}:b:{};b.params=b.params||{};for(var h in c)g&&g.setExtraParam(h,c[h]),b.params[h]=c[h]}},scope:this});Ext.apply(this,a)},setCorpus:function(a){a&&this.getProxy&&this.getProxy()&&this.getProxy().setExtraParam("corpus",Ext.isString(a)?a:a.getId());this.callParent(arguments)}});Ext.define("Voyant.data.store.CAAnalysis",{extend:"Ext.data.Store",model:"Voyant.data.model.StatisticalAnalysis",config:{corpus:void 0},constructor:function(a){a=a||{};Ext.apply(a,{proxy:{type:"ajax",url:Voyant.application.getTromboneUrl(),extraParams:{tool:"corpus.CA",corpus:a&&a.corpus?Ext.isString(a.corpus)?a.corpus:a.corpus.getId():void 0,withDistributions:!0},reader:{type:"json",rootProperty:"correspondenceAnalysis",totalProperty:"correspondenceAnalysis.totalTerms"},simpleSortMode:!0}});this.callParent([a])},
setCorpus:function(a){a&&this.getProxy().setExtraParam("corpus",Ext.isString(a)?a:a.getId());this.callParent(arguments)}});Ext.define("Voyant.data.store.ContextsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.Context",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.DocumentContexts","proxy.reader.rootProperty":"documentContexts.contexts","proxy.reader.totalProperty":"documentContexts.total"}])}});
Ext.define("Voyant.data.store.Contexts",{extend:"Ext.data.Store",mixins:["Voyant.data.store.ContextsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.ContextsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.ContextsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.ContextsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.ContextsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.CorpusCollocatesMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.CorpusCollocate",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.CorpusCollocates","proxy.reader.rootProperty":"corpusCollocates.collocates","proxy.reader.totalProperty":"corpusCollocates.total"}])}});
Ext.define("Voyant.data.store.CorpusCollocates",{extend:"Ext.data.Store",mixins:["Voyant.data.store.CorpusCollocatesMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusCollocatesMixin"].constructor.apply(this,[a]);this.callParent([a])}});
Ext.define("Voyant.data.store.CorpusCollocatesBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.CorpusCollocatesMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusCollocatesMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.CorpusFacetsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:Voyant.data.model.CorpusFacet,constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.CorpusFacets","proxy.reader.rootProperty":"corpusFacets.facets","proxy.reader.totalProperty":"corpusFacets.total"}])}});
Ext.define("Voyant.data.store.CorpusFacets",{extend:"Ext.data.Store",mixins:["Voyant.data.store.CorpusFacetsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusFacetsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.CorpusFacetsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.CorpusFacetsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusFacetsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.CorpusTermsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:Voyant.data.model.CorpusTerm,constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.CorpusTerms","proxy.reader.rootProperty":"corpusTerms.terms","proxy.reader.totalProperty":"corpusTerms.total"}])},show:function(a){show(this.getString(a))}});
Ext.define("Voyant.data.store.CorpusTerms",{extend:"Ext.data.Store",mixins:["Voyant.data.store.CorpusTermsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusTermsMixin"].constructor.apply(this,[a]);this.callParent([a])},getString:function(a){return(new Ext.XTemplate(this.localize("getString"))).apply([this.getCount(),this.sum("rawFreq")])}});
Ext.define("Voyant.data.store.CorpusTermsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.CorpusTermsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusTermsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.DocumentQueryMatchesMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.DocumentQueryMatch",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.DocumentsFinder","proxy.reader.rootProperty":"documentsFinder.queries","proxy.reader.totalProperty":void 0,"proxy.reader.metaProperty":"documentsFinder.corpus"}])}});
Ext.define("Voyant.data.store.DocumentQueryMatches",{extend:"Ext.data.Store",mixins:["Voyant.data.store.DocumentQueryMatchesMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocumentQueryMatchesMixin"].constructor.apply(this,[a]);this.callParent([a])}});
Ext.define("Voyant.data.store.DocumentQueryMatchesBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.DocumentQueryMatchesMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocumentQueryMatchesMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.DocumentTermsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.DocumentTerm",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.DocumentTerms","proxy.reader.rootProperty":"documentTerms.terms","proxy.reader.totalProperty":"documentTerms.total"}])}});
Ext.define("Voyant.data.store.DocumentTerms",{extend:"Ext.data.Store",mixins:["Voyant.data.store.DocumentTermsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocumentTermsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.DocumentTermsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.DocumentTermsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocumentTermsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.DocumentsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.Document",statics:{i18n:{}},sorters:{property:"index",direction:"ASC"},remoteSort:!0,constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.DocumentsMetadata","proxy.reader.rootProperty":"documentsMetadata.documents","proxy.reader.totalProperty":"documentsMetadata.total"}])},listeners:{load:function(a,b,c,d){if(c){var e=
a.getCorpus();b.forEach(function(a){a.set("corpus",e)})}}},getDocument:function(a){return Ext.isNumber(a)?this.getAt(a):this.getById(a)}});Ext.define("Voyant.data.store.Documents",{extend:"Ext.data.Store",mixins:["Voyant.data.store.DocumentsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocumentsMixin"].constructor.apply(this,[a]);this.callParent([a])}});
Ext.define("Voyant.data.store.DocumentsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.DocumentsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocumentsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.PCAAnalysisMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.StatisticalAnalysis",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.PCA","proxy.reader.rootProperty":"pcaAnalysis","proxy.reader.totalProperty":"pcaAnalysis.totalTerms"}]);a.proxy.extraParams.withDistributions=!0}});
Ext.define("Voyant.data.store.PCAAnalysis",{extend:"Ext.data.Store",mixins:["Voyant.data.store.PCAAnalysisMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.PCAAnalysisMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.PCAAnalysisBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.PCAAnalysisMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.PCAAnalysisMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.DocSimAnalysisMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.StatisticalAnalysis",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.DocumentSimilarity","proxy.reader.rootProperty":"documentSimilarity","proxy.reader.totalProperty":"documentSimilarity.total"}]);a.proxy.extraParams.withDistributions=!0}});
Ext.define("Voyant.data.store.DocSimAnalysis",{extend:"Ext.data.Store",mixins:["Voyant.data.store.DocSimAnalysisMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocSimAnalysisMixin"].constructor.apply(this,[a]);this.callParent([a])}});
Ext.define("Voyant.data.store.DocSimAnalysisBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.DocSimAnalysisMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocSimAnalysisMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.CorpusNgramsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.CorpusNgram",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.CorpusNgrams","proxy.reader.rootProperty":"corpusNgrams.ngrams","proxy.reader.totalProperty":"corpusNgrams.total"}])}});
Ext.define("Voyant.data.store.CorpusNgrams",{extend:"Ext.data.Store",mixins:["Voyant.data.store.CorpusNgramsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusNgramsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.CorpusNgramsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.CorpusNgramsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusNgramsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.TokensMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.Token",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.DocumentTokens","proxy.reader.rootProperty":"documentTokens.tokens","proxy.reader.totalProperty":"documentTokens.total"}])}});
Ext.define("Voyant.data.store.Tokens",{extend:"Ext.data.Store",mixins:["Voyant.data.store.TokensMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.TokensMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.TokensBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.TokensMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.TokensMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.table.Table",{alternateClassName:["VoyantTable"],mixins:["Voyant.notebook.util.Embed"],embeddable:["Voyant.widget.VoyantChart"],config:{rows:[],headers:[],rowKey:void 0,model:void 0},constructor:function(a){a=a||{};this.rows=Ext.Array.from(Ext.isArray(a)?a:a.rows);this.headers=Ext.Array.from(a.headers);this.rowKey=a.rowKey;a.isStore&&(this.model=a.getModel(),0<a.getCount()&&(this.headers=Object.keys(a.getAt(0).data)),a.each(function(a){this.addRow(a.data)},this));this.callParent()},
addRow:function(a){Ext.isObject(a)?this.rows.push(this.headers.map(function(b){return a[b]})):Ext.isArray(a)&&this.rows.push(a)},eachRecord:function(a,b){for(var c,d=0,e=this.rows.length;d<e&&(c=this.getRecord(d),!1!==a.call(b||c,c,d,e));d++);},eachRow:function(a,b,c){for(var d,e=0,f=this.rows.length;e<f&&(d=this.getRow(e,b),!1!==a.call(c||d,d,e,f));e++);},getRow:function(a,b){if(b){var c={};Ext.Array.from(this.rows[a]).forEach(function(a,b){c[this.headers[b]||b]=a},this);return c}return this.rows[a]},
getRecord:function(a){if(this.model)return new this.model(this.getRow(a,!0))},mapRows:function(a,b,c){var d=[];this.eachRow(function(b,f){d.push(a.call(c||this,b,f))},b,this);return d},updateCell:function(a,b,c,d){void 0===this.rows[a]&&(this.rows[a]=[]);this.rows[a][b]=void 0===this.rows[a][b]||d?c:this.rows[a][b]+c},embed:function(a,b){Ext.isObject(a)&&!b&&(b=a,a=this.embeddabled[0]);b=b||{};chart={};var c=this.mapRows(function(a,b){return void 0===this.rowKey?Ext.apply(a,{"row-index":b}):a},!0,
this),d=Ext.Array.merge(void 0===this.rowKey?["row-index"]:[],this.headers);if(0==this.headers.length)for(var e=Ext.Array.max(this.mapRows(function(a){return a?a.length:0})),f=0;f<e;f++)d.push(d.length);Ext.apply(chart,{store:{fields:d,data:c}});if(b.axes){Ext.apply(chart,{axes:b.axes});var g=["left","bottom"];chart.axes.forEach(function(a,b){Ext.applyIf(a,{type:"numeric",position:g[b]})});delete b.axes}else Ext.apply(chart,{axes:[{type:"numeric",position:"left"},{type:"category",position:"bottom"}]});
if(b.series)Ext.apply(chart,{series:b.series}),chart.series.forEach(function(a,b){Ext.applyIf(a,{type:"line",xField:void 0===this.rowKey?"row-index":this.rowKey,yField:b})}),delete b.series;else{c=[];f=0;for(d=d.length;f<d;f++)f===this.rowKey||void 0==this.rowKey&&f+1==d||c.push({type:"line",xField:void 0===this.rowKey?"row-index":this.rowKey,yField:f});Ext.apply(chart,{series:c})}b.title&&(chart.title=b.title);console.warn(chart);Ext.apply(b,{chartJson:JSON.stringify(chart)});embed(a,b)}});Ext.define("Voyant.data.table.CorpusTerms",{extend:"Voyant.data.table.Table",eachCorpusTerm:function(){this.eachRecord.apply(this,arguments)}});Ext.define("Voyant.data.model.Corpus",{alternateClassName:["Corpus"],mixins:["Voyant.notebook.util.Embed","Voyant.notebook.util.Show","Voyant.util.Transferable","Voyant.util.Localization"],transferable:["loadCorpusTerms","loadTokens"],embeddable:["Voyant.panel.Summary","Voyant.panel.Cirrus","Voyant.panel.Documents","Voyant.panel.CorpusTerms"],requires:["Voyant.util.ResponseError","Voyant.data.store.CorpusTerms","Voyant.data.store.Documents"],extend:"Ext.data.Model",config:{documentsStore:void 0},
statics:{i18n:{}},fields:[{name:"documentsCount",type:"int"},{name:"lexicalTokensCount",type:"int"},{name:"lexicalTypesCount",type:"int"},{name:"createdTime",type:"int"},{name:"createdDate",type:"date",dateFormat:"c"}],constructor:function(a){a=a||{};this.callParent([]);if(a){if(Ext.isString(a)||Ext.isArray(a))a=Ext.isString(a)&&0==/\s/.test(a)&&-1==a.indexOf(":")?{corpus:a}:{input:a};Ext.apply(a,{tool:"corpus.CorpusMetadata"});var b=Voyant.application.getDeferred(this),c=this;Ext.Ajax.request({url:Voyant.application.getTromboneUrl(),
params:a}).then(function(a){c.set(Ext.JSON.decode(a.responseText).corpus.metadata);return c}).otherwise(function(a){Voyant.application.showResponseError(c.localize("failedCreateCorpus"),a)}).then(function(d){!("docsLimit"in a)||!1!==a.docsLimit&&0<a.docsLimit?c.getDocuments().load({params:{limit:"docsLimit"in a?a.docsLimit:c.getDocumentsCount()},callback:function(a,f,g){g?(c.setDocumentsStore(this),b.resolve(d)):b.reject(f)}}):b.resolve(d)});return b.promise}},getId:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,
arguments):this.get("id")},getAliasOrId:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("alias")||this.get("id")},loadCorpusTerms:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);var b=Voyant.application.getDeferred(this);a=a||{};Ext.isNumber(a)&&(a={limit:a});Ext.applyIf(a,{limit:0});var c=this.getCorpusTerms();c.load({params:a,callback:function(a,e,f){f?b.resolve(c):b.reject(e)}});return b.promise},loadTokens:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,
arguments);var b=Voyant.application.getDeferred(this);a=a||{};Ext.isNumber(a)&&(a={limit:a});Ext.applyIf(a,{limit:0});var c=this.getTokens();c.load({params:a,callback:function(a,e,f){f?b.resolve(c):b.reject(e)}});return b.promise},getCorpusTerms:function(a){return Ext.create("Voyant.data.store.CorpusTerms",Ext.apply(a||{},{corpus:this}))},getTokens:function(a){return Ext.create("Voyant.data.store.Tokens",Ext.apply(a||{},{corpus:this}))},each:function(a){debugger;this.getDocuments().each.call(this,
arguments)},getCorpusCollocates:function(a){return Ext.create("Voyant.data.store.CorpusCollocates",Ext.apply(a||{},{corpus:this}))},getDocumentQueryMatches:function(a){return Ext.create("Voyant.data.store.DocumentQueryMatches",Ext.apply(a||{},{corpus:this}))},getDocumentTerms:function(a){return Ext.create("Voyant.data.store.DocumentTerms",Ext.apply(a||{},{corpus:this}))},getContexts:function(a){return Ext.create("Voyant.data.store.Contexts",Ext.apply(a||{},{corpus:this}))},getDocuments:function(a){return this.getDocumentsStore()?
this.getDocumentsStore():Ext.create("Voyant.data.store.Documents",Ext.apply(a||{},{corpus:this}))},getDocument:function(a){if(this.getDocumentsStore()){if(a instanceof Voyant.data.model.Document)return a;if(Ext.isNumeric(a))return this.getDocumentsStore().getAt(parseInt(a));if(Ext.isString(a))return this.getDocumentsStore().getById(a)}return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.getDocumentsStore().getDocument(a)},getDocumentsCount:function(){return this.then?
Voyant.application.getDeferredNestedPromise(this,arguments):this.get("documentsCount")},getWordTokensCount:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("lexicalTokensCount")},getWordTypesCount:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("lexicalTypesCount")},getCreatedTime:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("createdTime")},requiresPassword:function(){var a=
this.getNoPasswordAccess();return"NONE"==a||"NONCONSUMPTIVE"==a},getNoPasswordAccess:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("noPasswordAccess")},show:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);show(this.getString(a))},getString:function(a){var b=this.getDocumentsCount(),c=this.localize("thisCorpus");if(0==b)c+=" "+this.localize("isEmpty")+".";else{var c=c+" ",c=1<b?c+(new Ext.XTemplate(this.localize("hasNdocuments"))).apply({count:Ext.util.Format.number(b,
"0,000")}):c+this.localize("has1document"),c=c+(" "+(new Ext.XTemplate(this.localize("widthNwordsAndNTypes"))).apply({words:Ext.util.Format.number(this.getWordTokensCount(),"0,000"),types:Ext.util.Format.number(this.getWordTypesCount(),"0,000")})+"."),c=c+" Created ",d=this.get("createdDate"),e=new Date;!0===Ext.Array.each([["year",Ext.Date.YEAR],["month",Ext.Date.MONTH],["day",Ext.Date.DAY],["hour",Ext.Date.HOUR],["minute",Ext.Date.MINUTE],["second",Ext.Date.SECOND]],function(a){if(Ext.Date.diff(d,
e,a[1])>("second"==a[0]?1:0)){var b=Ext.Date.diff(d,e,a[1]);c+="\x3cspan class\x3d'info-tip' data-qtip\x3d'"+Ext.Date.format(d,"Y-m-d, H:i:s")+"'\x3e";c=1==b?c+(new Ext.XTemplate(this.localize(a[0]+"Ago"))).apply({count:b,date:d}):c+(new Ext.XTemplate(this.localize(a[0]+"sAgo"))).apply({count:b,date:d});c+="\x3c/span\x3e";return!1}},this)&&(c+=this.localize("now"));c+=".";c+=""}!0===a&&(c+=" ("+this.getId()+")");return c}});Ext.define("Voyant.widget.CorpusSelector",{extend:"Ext.form.field.ComboBox",mixins:["Voyant.util.Localization"],alias:"widget.corpusselector",statics:{i18n:{}},config:{labelWidth:150,labelAlign:"right",name:"corpus",queryMode:"local",store:[["shakespeare","Shakespeare's Plays"],["austen","Austen's Novels"]]},initComponent:function(a){Ext.applyIf(this,{fieldLabel:this.localize("chooseCorpus")});this.callParent(arguments)}});Ext.define("Voyant.widget.StopListOption",{extend:"Ext.container.Container",mixins:["Voyant.util.Localization"],alias:"widget.stoplistoption",layout:"hbox",statics:{i18n:{}},initComponent:function(a){var b=this.up("window").panel.getApiParam("stopList"),c=[];"ar:stop.ar.arabic-lucene.txt bg:stop.bu.bulgarian-lucene.txt br:stop.br.breton-lucene.txt ca:stop.ca.catalan-lucene.txt ckb:stop.ckb-turkish-lucene.txt cn:stop.cn.chinese-lawrence.txt cz:stop.cz.czech-lucene.txt de:stop.de.german.txt el:stop.el.greek-lucene.txt en:stop.en.taporware.txt es:stop.es.spanish.txt eu:stop.eu.basque-lucene.txt fa:stop.fa.farsi-lucene.txt fr:stop.fr.veronis.txt ga:stop.ga-irish-lucene.txt gl:stop.ga.galician-lucene.txt hi:stop.hi.hindi-lucene.txt hu:stop.hu.hungarian.txt hy:stop.hy.armenian-lucene.txt id:stop.id.indonesian-lucene.txt it:stop.it.italian.txt ja:stop.ja.japanese-lucene.txt lv:stop.lv.latvian-lucene.txt lt:stop.lt.lithuanian-lucene.txt mu:stop.mu.multi.txt nl:stop.nl.dutch.txt no:stop.no.norwegian.txt ro:stop.ro.romanian-lucene.txt se:stop.se.swedish-long.txt th:stop.th.thai-lucene.txt tr:stop.tr.turkish-lucene.txt".split(" ").forEach(function(a){a=
a.split(":");c.push({name:this.localize(a[0]),value:a[1]})},this);c.sort(function(a,b){return a.name<b.name?-1:1});c.splice(0,0,{name:this.localize("auto"),value:"auto"},{name:this.localize("none"),value:""},{name:this.localize("new"),value:"new"});Ext.apply(this,{items:[{xtype:"combo",queryMode:"local",value:b,triggerAction:"all",editable:!0,fieldLabel:this.localize("label"),labelAlign:"right",name:"stopList",displayField:"name",valueField:"value",store:{fields:["name","value"],data:c}},{width:10},
{xtype:"tbspacer"},{xtype:"button",text:this.localize("editList"),ui:"default-toolbar",handler:this.editList,scope:this},{width:10},{xtype:"checkbox",name:"stopListGlobal",checked:!0,boxLabel:this.localize("applyGlobally")}]});this.callParent(arguments)},editList:function(){var a=this.up("window").panel,b=this.down("combo").getValue(),c=a.getApplication&&a.getApplication().getCorpus?a.getApplication().getCorpus().getId():void 0;"auto"!=b||c?Ext.Ajax.request({url:a.getTromboneUrl(),params:{tool:"resource.KeywordsManager",
stopList:b,corpus:c},success:function(b){b=Ext.util.JSON.decode(b.responseText).keywords.keywords.sort().join("\n");Ext.Msg.show({title:this.localize("editStopListTitle"),message:this.localize("editStopListMessage"),buttons:Ext.Msg.OKCANCEL,buttonText:{ok:this.localize("ok"),cancel:this.localize("cancel")},icon:Ext.Msg.INFO,prompt:!0,multiline:!0,value:b,original:b,fn:function(b,d,g){"ok"==b&&g.original!=d&&(b=this.down("combo"),0==Ext.String.trim(d).length?b.setValue("empty"):Ext.Ajax.request({url:a.getTromboneUrl(),
params:{tool:"resource.StoredResource",storeResource:d,corpus:c},combo:b,success:function(a,b){var c=Ext.util.JSON.decode(a.responseText),d=b.combo.getStore(),c="keywords-"+c.storedResource.id;d.add({name:c,value:c});b.combo.setValue(c);b.combo.updateLayout()},scope:this}))},scope:this})},scope:this}):Ext.Msg.show({title:this.localize("noEditAutoTitle"),message:this.localize("noEditAutoMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}});Ext.define("Voyant.widget.QuerySearchField",{extend:"Ext.form.field.Tag",mixins:["Voyant.util.Localization"],alias:"widget.querysearchfield",statics:{i18n:{}},config:{corpus:void 0,tokenType:"lexical",isDocsMode:!1,inDocumentsCountOnly:void 0,stopList:void 0,showAggregateInDocumentsCount:!1},constructor:function(a){a=a||{};Ext.applyIf(a,{minWidth:100,maxWidth:200,matchFieldWidth:!1,minChars:2,displayField:"term",valueField:"term",filterPickList:!0,createNewOnEnter:!0,createNewOnBlur:!1,autoSelect:!1,
tpl:Ext.create("Ext.XTemplate",'\x3cul class\x3d"x-list-plain"\x3e\x3ctpl for\x3d"."\x3e','\x3cli role\x3d"option" class\x3d"x-boundlist-item" style\x3d"white-space: nowrap;"\x3e'+(a.itemTpl?a.itemTpl:"{term} ({"+(a.inDocumentsCountOnly?"inDocumentsCount":"rawFreq")+"})")+"\x3c/li\x3e","\x3c/tpl\x3e\x3c/ul\x3e"),triggers:{help:{weight:2,cls:"fa-trigger form-fa-help-trigger",handler:function(){Ext.Msg.show({title:this.localize("querySearch"),message:this.getIsDocsMode()?this.localize("querySearchDocsModeTip"):
this.localize("querySearchTip"),buttons:Ext.OK,icon:Ext.Msg.INFO})},scope:"this"}}});a.showAggregateInDocumentsCount&&(a.triggers.count={cls:"fa-trigger",handler:"onHelpClick",scope:"this",hidden:!0});this.callParent(arguments)},initComponent:function(a){var b=this;b.on("beforequery",function(a){if(a.query){a.query=a.query.trim();"^"==a.query.charAt(0)&&(a.query=a.query.substring(1),a.cancel=0==a.query.length);"*"==a.query.charAt(0)&&(a.query="."+a.query);"*"==a.query.charAt(a.query.length-1)&&(a.query=
a.query.substring(0,a.query.length-1),a.cancel=0==a.query.length);"."==a.query.charAt(0)&&(a.cancel=a.query.length<(/\W/.test(a.query.charAt(1))?5:4));try{new RegExp(a.query)}catch(b){a.cancel=!0}-1<a.query.indexOf('"')&&(-1==a.query.indexOf(" ")&&(a.cancel=!0),2!=(a.query.match(/"/)||[]).length&&(a.cancel=!0));-1<a.query.indexOf("*")?-1==a.query.indexOf(" ")&&(a.query+=",^"+a.query):a.query=a.query+"*"+(-1==a.query.indexOf(" ")?",^"+a.query+"*":"")}},b);b.on("change",function(a,d){d=d.map(function(a){return a.replace(/^(\^?)\*/,
"$1.*")});b.up("panel").fireEvent("query",b,d);b.triggers.count&&(b.triggers.count.show(),b.triggers.count.getEl().setHtml("0"),0<d.length?b.getCorpus().getCorpusTerms().load({params:{query:d.map(function(a){return"("+a+")"}).join("|"),tokenType:b.getTokenType(),stopList:b.getStopList(),inDocumentsCountOnly:!0},callback:function(a,c,d){d&&a&&1==a.length&&b.triggers.count.getEl().setHtml(a[0].getInDocumentsCount())}}):b.triggers.count.hide())});b.up("panel").on("loadedCorpus",function(a,d){b.setCorpus(d);
if(void 0==b.getStopList())if(this.getApiParam)b.setStopList(this.getApiParam("stopList"));else{var e=this.up("panel");e&&e.getApiParam&&b.setStopList(e.getApiParam("stopList"))}b.setStore(d.getCorpusTerms({corpus:d,proxy:{extraParams:{limit:10,tokenType:b.tokenType,stopList:b.getStopList(),inDocumentsCountOnly:b.getInDocumentsCountOnly()}}}))});b.on("afterrender",function(a){a.triggers&&a.triggers.help&&Ext.tip.QuickTipManager.register({target:a.triggers.help.getEl(),text:a.getIsDocsMode()?a.localize("querySearchDocsModeTip"):
a.localize("querySearchTip")});a.triggers&&a.triggers.count&&Ext.tip.QuickTipManager.register({target:a.triggers.count.getEl(),text:a.localize("aggregateInDocumentsCount")})},b);b.callParent(arguments)}});Ext.define("Voyant.widget.TotalPropertyStatus",{extend:"Ext.Component",mixins:["Voyant.util.Localization"],alias:"widget.totalpropertystatus",statics:{i18n:{}},initComponent:function(){Ext.applyIf(this,{tpl:this.localize("totalPropertyStatus"),itemId:"totalpropertystatus",style:"margin-right:5px",listeners:{afterrender:function(a){var b=a.up("grid");if(b){var c=b.getStore();a.updateStatus(c.getTotalCount());b.getStore().on("totalcountchange",a.updateStatus,a)}}}});this.callParent(arguments)},updateStatus:function(a){this.update({count:a})}});Ext.define("Voyant.widget.DocumentSelector",{mixins:["Voyant.util.Localization"],alias:"widget.documentselector",glyph:"xf10c@FontAwesome",statics:{i18n:{}},config:{docs:void 0,corpus:void 0,singleSelect:!1},initComponent:function(){this.setSingleSelect(void 0==this.config.singleSelect?this.getSingleSelect():this.config.singleSelect);Ext.apply(this,{text:this.localize("documents"),menu:{width:250,fbar:[{xtype:"checkbox",hidden:this.getSingleSelect(),boxLabel:this.localize("all"),listeners:{change:{fn:function(a,
b){this.getMenu().items.each(function(a){a.setChecked(b)})},scope:this}}},{xtype:"tbfill"},{xtype:"button",text:this.localize("ok"),hidden:this.getSingleSelect(),scale:"small",handler:function(a,b){var c=[];this.getMenu().items.each(function(a){a.checked&&c.push(a.docId)},this);var d=a.findParentBy(function(a){return a.mixins["Voyant.panel.Panel"]});d&&d.fireEvent("documentsSelected",a,c);a.findParentBy(function(a){return a.isXType("button")&&a.hasVisibleMenu()?(a.hideMenu(),!0):!1})},scope:this},
{xtype:"button",text:this.localize("cancel"),scale:"small",handler:function(a,b){this.findParentBy(function(a){return a.isXType("button")&&a.hasVisibleMenu()?(a.hideMenu(),!0):!1},this);this.hideMenu()},scope:this}]},listeners:{afterrender:function(a){a.on("loadedCorpus",function(b,d){this.setCorpus(d);1==d.getDocumentsCount()?this.hide():a.populate(d.getDocumentsStore().getRange(),!0)},a);var b=a.findParentBy(function(a){return a.mixins["Voyant.panel.Panel"]});b&&(b.on("loadedCorpus",function(b,
d){a.fireEvent("loadedCorpus",b,d)},a),b.getCorpus&&b.getCorpus()?a.fireEvent("loadedCorpus",a,b.getCorpus()):b.getStore&&b.getStore()&&b.getStore().getCorpus&&b.getStore().getCorpus()&&a.fireEvent("loadedCorpus",a,b.getStore().getCorpus()))}}})},populate:function(a,b){this.setDocs(a);var c=this.getMenu();b&&c.removeAll();var d=this.getSingleSelect(),e="docGroup"+Ext.id();a.forEach(function(a,b){c.add({xtype:"menucheckitem",text:a.getShortTitle(),docId:a.get("id"),checked:d&&0==b||!d,group:d?e:void 0,
checkHandler:function(b,c){if(this.getSingleSelect()&&c){var d=this.findParentBy(function(a){return a.mixins["Voyant.panel.Panel"]});d&&d.fireEvent("documentSelected",this,a)}},scope:this})},this)}});Ext.define("Voyant.widget.DocumentSelectorButton",{extend:"Ext.button.Button",alias:"widget.documentselectorbutton",mixins:["Voyant.widget.DocumentSelector"],initComponent:function(){this.mixins["Voyant.widget.DocumentSelector"].initComponent.apply(this,arguments);this.callParent()}});
Ext.define("Voyant.widget.DocumentSelectorMenuItem",{extend:"Ext.menu.Item",alias:"widget.documentselectormenuitem",mixins:["Voyant.widget.DocumentSelector"],initComponent:function(){this.mixins["Voyant.widget.DocumentSelector"].initComponent.apply(this,arguments);this.callParent()}});Ext.define("Voyant.widget.CorpusDocumentSelector",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.corpusdocumentselector",statics:{i18n:{}},config:{corpus:void 0,singleSelect:!1},initComponent:function(){this.setSingleSelect(void 0==this.config.singleSelect?this.getSingleSelect():this.config.singleSelect);Ext.apply(this,{text:this.localize("scale"),glyph:"xf059@FontAwesome",menu:{items:[{text:this.localize("corpus"),glyph:"xf111@FontAwesome",handler:function(a){var b=
this.findParentBy(function(a){return a.mixins["Voyant.panel.Panel"]});b&&(a.nextSibling().menu.items.each(function(a){a.setChecked(!1,!0)}),b.fireEvent("corpusSelected",this,this.getCorpus()))},scope:this},{xtype:"documentselectormenuitem",singleSelect:this.getSingleSelect()}]},listeners:{afterrender:function(a){a.on("loadedCorpus",function(a,b){this.setCorpus(b);1==b.getDocumentsCount()&&this.hide()},a);var b=a.findParentBy(function(a){return a.mixins["Voyant.panel.Panel"]});b&&(b.on("loadedCorpus",
function(b,d){a.fireEvent("loadedCorpus",b,d)},a),b.getCorpus&&b.getCorpus()?a.fireEvent("loadedCorpus",a,b.getCorpus()):b.getStore&&b.getStore()&&b.getStore().getCorpus&&b.getStore().getCorpus()&&a.fireEvent("loadedCorpus",a,b.getStore().getCorpus()))}}});this.callParent(arguments)}});Ext.define("Voyant.widget.DownloadFilenameBuilder",{extend:"Ext.form.FieldContainer",mixins:["Voyant.util.Localization","Ext.form.field.Field"],alias:"widget.downloadfilenamebuilder",statics:{i18n:{}},config:{name:"documentFilename",itemId:"documentFilename",fields:["pubDate","title","author"],value:["pubDate","title"],width:400},initComponent:function(a){a=a||{};this.initField();this.on("afterrender",function(){this.items.eachKey(function(a){new Ext.dd.DropZone(this.items.get(a).getTargetEl(),{ddGroup:"downloadfilename",
getTargetFromEvent:function(a){a=a.getTarget();return a.className&&-1<a.className.indexOf("dragsource")?a.parentNode:a},onNodeDrop:function(a,b,e,f){a.appendChild(b.el.dom);return!0}})},this);this.getFields().map(function(a){a=Ext.isString(a)?{tag:"span",html:this.localize(a+"Label"),value:a}:a;var c=this.queryById(Ext.Array.contains(this.getValue(),a.value)?"enabled":"available");a=Ext.dom.Helper.append(c.getTargetEl(),Ext.apply(a,{cls:"dragsource"}));Ext.create("Ext.dd.DragSource",a,{ddGroup:"downloadfilename"})},
this)},this);this.callParent(arguments)},defaults:{xtype:"container",width:"100%"},items:[{itemId:"enabled",cls:"dropzone dropzone-enabled"},{itemId:"available",cls:"dropzone dropzone-disabled"}],getValue:function(){return this.rendered?this.getTargetEl().query(".dropzone-enabled .dragsource").map(function(a){return a.getAttribute("value")}):this.value},setValue:function(a){this.rendered?this.getTargetEl().query(".dragsource",!1).forEach(function(a){var c=Ext.Array.contains(this.value,a.getAttribute("value"));
c&&a.parent().hasCls("dropzone-disabled")?this.queryById("enabled").getTargetEl().appendChild(a.dom):!c&&a.parent().hasCls("dropzone-enabled")&&this.queryById("available").getTargetEl().appendChild(a.dom)},this):this.value=a}});Ext.define("Voyant.widget.DownloadFileFormat",{extend:"Ext.form.CheckboxGroup",mixins:["Voyant.util.Localization"],alias:"widget.downloadfileformat",statics:{i18n:{}},initComponent:function(a){a=a||{};Ext.apply(this,{labelAlign:a.labelAlign?a.labelAlign:"right"});Ext.applyIf(this,{fieldLabel:this.localize("fieldLabel"),items:[{boxLabel:this.localize("original"),name:"documentFormat",inputValue:"SOURCE"},{boxLabel:this.localize("voyantXml"),name:"documentFormat",inputValue:"VOYANT"},{boxLabel:this.localize("plainText"),
name:"documentFormat",inputValue:"TXT"}],width:450});this.on("afterrender",function(){this.query("checkbox").forEach(function(a){var c=this.localize(a.inputValue+"Tip");-1==c.indexOf(a.inputValue+"Tip")&&Ext.tip.QuickTipManager.register({target:a.getEl(),text:c})},this)},this);this.callParent(arguments)}});Ext.define("Voyant.widget.DownloadOptions",{extend:"Ext.form.FieldSet",mixins:["Voyant.util.Localization"],requires:["Voyant.widget.DownloadFileFormat","Voyant.widget.DownloadFilenameBuilder"],alias:"widget.downloadoptions",statics:{i18n:{}},config:{items:[{xtype:"downloadfileformat"},{xtype:"downloadfilenamebuilder"}]},initComponent:function(a){a=a||{};Ext.apply(this,{title:a.title?a.title:this.localize("title")});this.callParent(arguments)}});Ext.define("Voyant.widget.VoyantChart",{extend:"Ext.chart.CartesianChart",mixins:["Voyant.util.Localization","Voyant.util.Api"],alias:"widget.voyantchart",statics:{i18n:{},api:{chartJson:void 0}},constructor:function(a){a=a||{};this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);if(this.getApiParam("chartJson")){var b=JSON.parse(this.getApiParam("chartJson"));Ext.apply(a,b)}this.callParent(arguments)},initComponent:function(a){this.callParent(arguments)}});Ext.define("Voyant.panel.Panel",{mixins:["Voyant.util.Localization","Voyant.util.Api","Voyant.util.Toolable","Voyant.util.DetailedError"],requires:["Voyant.widget.QuerySearchField","Voyant.widget.StopListOption","Voyant.widget.TotalPropertyStatus"],alias:"widget.voyantpanel",statics:{i18n:{},config:{corpusValidated:!1},api:{corpus:void 0,input:void 0,inputFormat:void 0,subtitle:void 0}},constructor:function(a){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.mixins["Voyant.util.Toolable"].constructor.apply(this,
arguments);this.glyph||(this.glyph=Ext.ClassManager.getClass(this).glyph);this.on("afterrender",function(){this.getApiParam("subtitle")&&this.getTitle()&&this.setTitle(this.getTitle()+" \x3ci style\x3d'font-size: smaller;'\x3e"+this.getApiParam("subtitle")+"\x3c/i\x3e")},this)},getApplication:function(){return Voyant.application},getBaseUrl:function(){return this.getApplication().getBaseUrl()},openUrl:function(a){this.getApplication().openUrl.apply(this,arguments)},getTromboneUrl:function(){return this.getApplication().getTromboneUrl()},
dispatchEvent:function(){var a=this.getApplication();a.dispatchEvent.apply(a,arguments)},showError:function(a){this.getApplication().showError.apply(this,arguments)},toastError:function(a){Ext.isString(a)&&(a={html:a});Ext.applyIf(a,{glyph:"xf071@FontAwesome",title:this.localize("error")});this.toast(a)},toastInfo:function(a){Ext.isString(a)&&(a={html:a});Ext.applyIf(a,{glyph:"xf05a@FontAwesome",title:this.localize("info")});this.toast(a)},toast:function(a){Ext.isString(a)&&(a={html:a});Ext.applyIf(a,
{slideInDuration:500,shadow:!0,align:"b",anchor:this.getTargetEl()});Ext.toast(a)}});Ext.define("Voyant.panel.VoyantTabPanel",{extend:"Ext.tab.Panel",alias:"widget.voyanttabpanel",mixins:["Voyant.panel.Panel"],statics:{i18n:{}},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){this.callParent(arguments)},listeners:{tabchange:function(a,b){this.tools=[];this.getHeader().tools=[];this.query("toolmenu").forEach(function(a){a.destroy()});this.addTool(b.tools);this.getApplication().dispatchEvent("panelChange",
this)},afterrender:function(a){this.fireEvent("tabchange",this,this.getActiveTab())}},showOptionsClick:function(a){var b=a.getActiveTab();b.showOptionsClick&&b.showOptionsClick.apply(b,arguments)}});Ext.define("Voyant.widget.Facet",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.facet",statics:{i18n:{},api:{stopList:"auto",query:void 0}},config:{corpus:void 0},constructor:function(a){this.callParent(arguments);Ext.applyIf(a||{},{includeTools:[],rowLines:!1,columnLines:!1});this.mixins["Voyant.panel.Panel"].constructor.apply(this,[a])},rowLines:!1,initComponent:function(){var a=this;this.store||(this.store=new Ext.create("Voyant.data.store.CorpusFacets",{proxy:{extraParams:{facet:this.facet}},
parentPanel:this}),this.store.getProxy().on("exception",function(b,c,d,e){a.showError(Ext.create("Voyant.util.ResponseError",{response:c}))}));Ext.applyIf(this,{emptyText:this.localize("emptyText"),hideHeaders:!0,selType:"checkboxmodel",columns:[{renderer:function(a,c,d){return"("+d.getInDocumentsCount()+") "+d.getLabel()},flex:1}]});this.callParent();this.corpus&&this.setCorpus(this.corpus);this.on("query",function(a,c){this.setApiParam("query",c);this.store.load({params:this.getApiParams()})})},
setCorpus:function(a){this.callParent(arguments);this.getStore()&&(this.getStore().setCorpus(a),this.getStore().load())}});Ext.define("Voyant.panel.Bubbles",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.bubbles",statics:{i18n:{},api:{stopList:"auto",docIndex:0,limit:100,audio:!1,speed:30},glyph:"xf06e@FontAwesome"},config:{corpus:void 0,options:{xtype:"stoplistoption"},audio:!1},constructor:function(){this.mixins["Voyant.util.Localization"].constructor.apply(this,arguments);Ext.apply(this,{title:this.localize("title"),html:'\x3ccanvas style\x3d"width: 100%; height: 100%"\x3e\x3c/canvas\x3e',dockedItems:[{dock:"bottom",
xtype:"toolbar",enableOverflow:!0,items:[{xtype:"documentselectorbutton",singleSelect:!0},{xtype:"slider",fieldLabel:this.localize("speed"),labelAlign:"right",labelWidth:40,width:100,increment:1,minValue:1,maxValue:60,value:30,listeners:{render:function(a){a.setValue(parseInt(this.getApiParam("speed")));this.bubbles&&this.bubbles.frameRate(a.getValue());this.setAudio(a.getValue());Ext.tip.QuickTipManager.register({target:a.getEl(),text:this.localize("speedTip")})},changecomplete:function(a,b){this.setApiParam("speed",
b);this.bubbles&&this.bubbles.frameRate(b)},scope:this}},{xtype:"checkbox",boxLabel:this.localize("sound"),listeners:{render:function(a){a.setValue(!0===this.getApiParam("audio")||"true"==this.getApiParam("audio"));this.setAudio(a.getValue());Ext.tip.QuickTipManager.register({target:a.getEl(),text:this.localize("soundTip")})},change:function(a,b){this.setApiParam("audio",b);this.setAudio(b)},scope:this}},{xtype:"tbfill"},{xtype:"tbtext",html:this.localize("adaptation")}]}]});this.callParent(arguments);
this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,b){this.setCorpus(b);this.getTargetEl().dom.querySelector("canvas");var c=this;Ext.Ajax.request({url:this.getBaseUrl()+"resources/voyant/current/bubbles/bubbles.pjs"}).then(function(a){var b=c.getTargetEl().dom.querySelector("canvas");c.bubbles=new Processing(b,a.responseText);c.bubbles.size(c.getTargetEl().getWidth(),c.getTargetEl().getHeight());c.bubbles.frameRate(c.getApiParam("speed"));c.bubbles.bindJavascript(c);
c.bubbles.noLoop();c.loadDocument()})},this);this.on("resize",function(){this.bubbles&&this.bubbles.size(this.body.getWidth(),this.body.getHeight())});this.on("documentselected",function(a,b){this.setApiParam("docIndex",this.getCorpus().getDocument(b).getIndex());this.loadDocument()})},setAudio:function(a){this.gainNode&&(this.gainNode.gain.value=a?1:0);this.callParent(arguments)},handleCurrentTerm:function(a){this.oscillator&&(this.oscillator.frequency.value=this.terms[a]?parseInt(2E3*(this.terms[a]-
this.minFreq)/(this.maxFreq-this.minFreq)):0)},handleDocFinished:function(){this.gainNode&&(this.gainNode.gain.value=0);var a=parseInt(this.getApiParam("docIndex"));a+1<this.getCorpus().getDocumentsCount()&&(this.setApiParam("docIndex",a+1),this.loadDocument())},loadDocument:function(){var a=this,b=this.getCorpus().getDocument(parseInt(this.getApiParam("docIndex")));this.setTitle(this.localize("title")+" \x3cspan class\x3d'subtitle'\x3e"+b.getFullLabel()+"\x3c/span\x3e");b.loadDocumentTerms(Ext.apply(this.getApiParams(["stopList"]),
{limit:100})).then(function(c){a.terms={};c.each(function(b){a.terms[b.getTerm()]=b.getRawFreq()});c=Object.keys(a.terms).map(function(b){return a.terms[b]});a.minFreq=Ext.Array.min(c);a.maxFreq=Ext.Array.max(c);a.getCorpus().loadTokens({whitelist:Object.keys(a.terms),noOthers:!0,limit:0,docIndex:a.getApiParam("docIndex")}).then(function(c){var e=[];c.each(function(a){e.push(a.getTerm().toLowerCase())});a.bubbles.setLines([b.getTitle(),e.join(" ")]);a.bubbles.loop();a.oscillator.frequency.value=150;
a.gainNode.gain.value=a.getAudio()?1:0})})},initComponent:function(){Ext.Loader.loadScript(this.getBaseUrl()+"resources/processingjs/processing.min.js");var a=new (window.AudioContext||window.webkitAudioContext);this.oscillator=a.createOscillator();this.gainNode=a.createGain();this.oscillator.connect(this.gainNode);this.gainNode.connect(a.destination);this.oscillator.frequency.value=0;this.oscillator.start();this.gainNode.gain.value=0;this.callParent(arguments)}});Ext.define("Voyant.panel.Bubblelines",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.bubblelines",statics:{i18n:{},api:{bins:50,query:null,stopList:"auto",docId:void 0,docIndex:void 0,maxDocs:50},glyph:"xf06e@FontAwesome"},config:{corpus:void 0,docTermStore:void 0,docStore:void 0,options:{xtype:"stoplistoption"}},selectedDocs:void 0,processedDocs:new Ext.util.MixedCollection,bubblelines:null,termTpl:new Ext.XTemplate('\x3ctpl for\x3d"."\x3e','\x3cdiv class\x3d"term" style\x3d"color: rgb({color});float: left;padding: 3px;margin: 2px;"\x3e{term}\x3c/div\x3e',
"\x3c/tpl\x3e"),termStore:new Ext.data.ArrayStore({fields:["term","color"],listeners:{load:function(a,b,c,d){a=this.down("#termsView");for(c=0;c<b.length;c++)a.select(b[c],!0)},scope:this}}),constructor:function(){Ext.apply(this,{title:this.localize("title")});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,b){this.setCorpus(b);this.getDocStore().getProxy().setExtraParam("corpus",b.getId());this.isVisible()&&this.getDocStore().load();
this.getDocTermStore().getProxy().setExtraParam("corpus",b.getId())},this);this.on("activate",function(){this.getCorpus()&&Ext.Function.defer(function(){this.getDocStore().load()},100,this)},this);this.on("query",function(a,b){void 0!==b&&""!=b&&this.getDocTermsFromQuery(b)},this);this.on("documentsSelected",function(a,b){this.setApiParam("docId",b);this.bubblelines.cache.each(function(a){a.hidden=-1===b.indexOf(a.id)});this.bubblelines.drawGraph()},this);this.on("termsClicked",function(a,b){if(a!==
this){var c=[];b.forEach(function(a){Ext.isString(a)?c.push(a):a.term?c.push(a.term):a.getTerm&&c.push(a.getTerm())});this.getDocTermsFromQuery(c)}},this);this.on("documentTermsClicked",function(a,b){var c=[];b.forEach(function(a){a.getTerm()&&c.push(a.getTerm())});this.getDocTermsFromQuery(c)},this);this.down("#granularity").setValue(parseInt(this.getApiParam("bins")))},initComponent:function(){var a=Ext.create("Ext.data.Store",{model:"Voyant.data.model.Document",autoLoad:!1,remoteSort:!1,proxy:{type:"ajax",
url:Voyant.application.getTromboneUrl(),extraParams:{tool:"corpus.DocumentsMetadata"},reader:{type:"json",rootProperty:"documentsMetadata.documents",totalProperty:"documentsMetadata.total"},simpleSortMode:!0},listeners:{load:function(a,c,d,e){this.processDocuments(c);this.processedDocs.each(function(a){this.bubblelines.addDocToCache(a)},this);this.loadFromCorpusTerms(this.getCorpus().getCorpusTerms({autoload:!1}))},scope:this}});this.setDocStore(a);a=Ext.create("Ext.data.Store",{model:"Voyant.data.model.DocumentTerm",
asynchronousLoad:!1,autoLoad:!1,remoteSort:!1,proxy:{type:"ajax",url:Voyant.application.getTromboneUrl(),extraParams:{tool:"corpus.DocumentTerms",withDistributions:"raw",withPositions:!0},reader:{type:"json",rootProperty:"documentTerms.terms",totalProperty:"documentTerms.total"},simpleSortMode:!0},listeners:{load:function(a,c,d,e){c.forEach(function(a){var b=this.processTerms(a),c=a.get("docId");a=a.get("term");var d={};d[a]=b;this.bubblelines.addTermsToDoc(d,c)},this);this.bubblelines.doBubblelinesLayout()},
scope:this}});this.setDocTermStore(a);Ext.apply(this,{dockedItems:[{dock:"bottom",xtype:"toolbar",enableOverflow:!0,items:[{xtype:"querysearchfield"},{text:this.localize("clearTerms"),glyph:"xf014@FontAwesome",handler:function(){this.down("#termsView").getSelectionModel().deselectAll(!0);this.termStore.removeAll();this.setApiParams({query:null});this.bubblelines.removeAllTerms();this.bubblelines.drawGraph()},scope:this},{xtype:"documentselectorbutton"},{xtype:"slider",itemId:"granularity",fieldLabel:this.localize("granularity"),
labelAlign:"right",labelWidth:70,width:150,increment:10,minValue:10,maxValue:300,listeners:{changecomplete:function(a,c){this.setApiParams({bins:c});this.bubblelines.bubbleSpacing=c;this.reloadTermsData()},scope:this}},{xtype:"checkbox",boxLabel:this.localize("separateLines"),boxLabelAlign:"before",checked:!1,handler:function(a,c){this.bubblelines.SEPARATE_LINES_FOR_TERMS=c;this.bubblelines.lastClickedBubbles={};this.bubblelines.setCanvasHeight();this.bubblelines.drawGraph()},scope:this}]}],border:!1,
layout:"fit",items:{layout:{type:"vbox",align:"stretch"},defaults:{border:!1},items:[{height:30,itemId:"termsView",xtype:"dataview",store:this.termStore,tpl:this.termTpl,itemSelector:"div.term",overItemCls:"over",selectedItemCls:"selected",selectionModel:{mode:"SIMPLE"},focusCls:"",listeners:{beforeitemclick:function(a,c,d,e,f,g){f.preventDefault();f.stopPropagation();a.fireEvent("itemcontextmenu",a,c,d,e,f,g);return!1},beforecontainerclick:function(){event.preventDefault();event.stopPropagation();
return!1},selectionchange:function(a,c){var d=this.down("#termsView"),e=[];d.getStore().each(function(a){-1!==c.indexOf(a)?(e.push(a.get("term")),Ext.fly(d.getNodeByRecord(a)).removeCls("unselected").addCls("selected")):Ext.fly(d.getNodeByRecord(a)).removeCls("selected").addCls("unselected")});for(var f in this.bubblelines.lastClickedBubbles){var g=this.bubblelines.lastClickedBubbles[f],h;for(h in g)-1==e.indexOf(h)&&delete this.bubblelines.lastClickedBubbles[f][h]}this.bubblelines.termsFilter=e;
this.bubblelines.setCanvasHeight();this.bubblelines.drawGraph()},itemcontextmenu:function(a,c,d,e,f){f.preventDefault();f.stopPropagation();var g=a.isSelected(d);(new Ext.menu.Menu({floating:!0,items:[{text:g?this.localize("hideTerm"):this.localize("showTerm"),handler:function(){g?a.deselect(e):a.select(e,!0)},scope:this},{text:this.localize("removeTerm"),handler:function(){a.deselect(e);var c=this.termStore.getAt(e).get("term");this.termStore.removeAt(e);a.refresh();this.bubblelines.removeTerm(c);
this.bubblelines.setCanvasHeight();this.bubblelines.drawGraph()},scope:this}]})).showAt(f.getXY())},scope:this}},{flex:1,xtype:"container",autoEl:"div",itemId:"canvasParent",layout:"fit",overflowY:"auto",overflowX:"hidden"}],listeners:{render:function(a){a=this.down("#canvasParent");this.bubblelines=new Bubblelines({container:a,clickHandler:this.bubbleClickHandler.bind(this)});this.bubblelines.bubbleSpacing=parseInt(this.getApiParam("bins"))},afterlayout:function(a){!1===this.bubblelines.initialized&&
this.bubblelines.initializeCanvas()},resize:function(a,c,d){this.bubblelines.doBubblelinesLayout()},scope:this}}});this.callParent(arguments)},loadFromCorpusTerms:function(a){this.bubblelines&&(this.bubblelines.removeAllTerms(),this.termStore.removeAll(!0));a.load({callback:function(a,c,d){var e=[];"string"==typeof e&&(e=[e]);a.forEach(function(a,b){e.push(a.get("term"))},this);this.getDocTermsFromQuery(e)},scope:this,params:{limit:5,stopList:this.getApiParams("stopList")}})},getDocTermsFromQuery:function(a){a&&
this.setApiParam("query",a);if(this.getCorpus()&&this.isVisible())for(var b=this.getCorpus().getDocuments(),c=b.getCount(),d=0;d<c;d++){var e=b.getAt(d);this.setApiParams({query:a,docIndex:void 0,docId:e.getId()});this.getDocTermStore().load({params:this.getApiParams()})}},reloadTermsData:function(){var a=[],b;for(b in this.bubblelines.currentTerms)a.push(b);this.getDocTermsFromQuery(a)},filterDocuments:function(){var a=this.getApiParam("docId");""==a&&(a=[],this.getCorpus().getDocuments().each(function(b,
c){a.push(b.getId())}),this.setApiParams({docId:a}));"string"==typeof a&&(a=[a]);if(null==a){this.selectedDocs=this.getCorpus().getDocuments().clone();var b=this.selectedDocs.getCount();if(10<b)for(var c=10;c<b;c++)this.selectedDocs.removeAt(10);a=[];this.selectedDocs.eachKey(function(b,c){a.push(b)},this);this.setApiParams({docId:a})}else this.selectedDocs=this.getCorpus().getDocuments().filterBy(function(b,c){return-1!=a.indexOf(c)},this)},processDocuments:function(a){a.forEach(this.processDocument,
this)},processDocument:function(a){var b=a.getId();if(!this.processedDocs.containsKey(b)){var c=a.getShortTitle(),c=c.replace("\x26hellip;","..."),d=a.get("index");a=a.get("tokensCount-lexical");this.processedDocs.add(b,{id:b,index:d,title:c,totalTokens:a,terms:{}})}},processTerms:function(a){var b,c=a.get("term");b=a.get("rawFreq");var d=a.get("positions");if(0<b){var e=this.getApplication().getColorForTerm(c);-1===this.termStore.find("term",c)&&(this.termStore.loadData([[c,e]],!0),c=this.termStore.find("term",
c),this.down("#termsView").select(c,!0));a=a.get("distributions");b={positions:d,distributions:a,rawFreq:b,color:e}}else b=!1;return b},bubbleClickHandler:function(a){this.getApplication().dispatchEvent("termsClicked",this,a)}});Ext.define("Voyant.panel.Catalogue",{extend:"Ext.panel.Panel",requires:["Voyant.widget.Facet"],mixins:["Voyant.panel.Panel"],alias:"widget.catalogue",statics:{i18n:{},api:{config:void 0,stopList:"auto",facet:["facet.title","facet.author","facet.language"]},glyph:"xf1ea@FontAwesome"},config:{corpus:void 0,facets:{},matchingDocIds:[],customResultsHtml:void 0},constructor:function(a){a=a||{};Ext.apply(this,{title:this.localize("title"),layout:"hbox",items:[{layout:"vbox",height:"100%",align:"stretch",
itemId:"facets",defaults:{width:250,flex:1,xtype:"facet",margin:5,border:!0,frame:!0,includeTools:{close:{type:"close",tooltip:this.localize("closeFacetTip"),callback:function(a){delete this.facets[a.facet];a.destroy();this.updateResults()},scope:this},add:{type:"plus",tooltip:this.localize("plusFacetTip"),callback:function(){this.addFacet()},scope:this}}},items:[]},{xtype:"panel",html:a.customResultsHtml||"",flex:1,itemId:"results",height:"100%",align:"stretch",scrollable:!0,margin:5,getCorpus:function(){return this.findParentByType("panel").getCorpus()},
listeners:{query:function(a,c){this.findParentByType("panel").updateResults(Ext.isString(c)?[c]:c)}},bbar:[{itemId:"export",text:this.localize("export"),tooltip:this.localize("exportTip"),disabled:!0,handler:function(){this.mask(this.localize("exportInProgress"));var a=this;Ext.Ajax.request({url:this.getApplication().getTromboneUrl(),params:{corpus:this.getCorpus().getId(),tool:"corpus.CorpusManager",keepDocuments:!0,docId:this.getMatchingDocIds()},success:function(c,d){a.unmask();var e=Ext.JSON.decode(c.responseText),
e=a.getBaseUrl()+"?corpus\x3d"+e.corpus.id;if(!window.open(e)){var f=Ext.create("Ext.window.MessageBox",{makeButton:function(c){return new Ext.button.Button({handler:this.btnCallback,scope:this,text:a.localize("cancel"),ui:"default-toolbar",minWidth:75})}}).show({title:a.localize("export"),buttons:Ext.MessageBox.CANCEL,icon:Ext.MessageBox.INFO,message:(new Ext.XTemplate(a.localize("clickToOpenCorpus"))).apply([e])}),e=f.getTargetEl().dom.querySelector("a");e.addEventListener("click",function(){f.close()});
Ext.get(e).frame().frame()}},failure:function(c,d){a.unmask();me.showError(c)}})},scope:this},{xtype:"querysearchfield",width:200,flex:1},{itemId:"status",xtype:"tbtext"}]}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,c){this.setCorpus(c);this.queryById("status").update((new Ext.XTemplate(this.localize("noMatches"))).apply([c.getDocumentsCount()]));this.query("facet").forEach(function(a){a.setCorpus(c)});this.getCustomResultsHtml()||
(this.setCustomResultsHtml((new Ext.XTemplate(this.localize("noMatches"))).apply([c.getDocumentsCount()])),this.updateResults(),Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",verifyResourceId:"customhtml-"+c.getAliasOrId()},success:function(a,b){var f=Ext.util.JSON.decode(a.responseText);f&&f.storedResource&&f.storedResource.id&&Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",retrieveResourceId:"customhtml-"+c.getAliasOrId()},
success:function(a,b){var c=Ext.util.JSON.decode(a.responseText);c&&c.storedResource&&c.storedResource.resource&&(this.setCustomResultsHtml(c.storedResource.resource),this.updateResults())},scope:this})},scope:this}))});this.on("afterrender",function(a){var c=this.queryById("facets");this.addFacet({facet:"lexical",includeTools:{add:{type:"plus",tooltip:this.localize("plusFacetTip"),callback:function(){this.addFacet()},scope:this}},store:new Voyant.data.store.CorpusTerms({parentPanel:this,proxy:{extraParams:{stopList:this.getApiParam("stopList")}}})},
c);a=this.getApiParam("facet");Ext.isString(a)&&(a=a.split(","));a.forEach(function(a){this.addFacet({facet:a},c)},this)})},addFacet:function(a,b){if(!a)return this.selectFacet(function(a){this.addFacet({facet:a})});b=b||this.queryById("facets");var c=a.facet,d='\x3cspan style\x3d"font-size: smaller;"\x3e(\x3cspan class\x3d"info-tip" data-qtip\x3d"'+this.localize("matchingDocuments")+'"\x3e{inDocumentsCount}\x3c/span\x3e)\x3c/span\x3e {term}\x3cspan style\x3d"font-size: smaller;"\x3e (\x3cspan class\x3d"info-tip" data-qtip\x3d"'+
this.localize("rawFreqs")+'"\x3e{rawFreq}\x3c/span\x3e)\x3c/span\x3e',e=this.localize(c+"Title");e=="["+c+"Title]"&&(e=c.replace(/^facet\./,"").replace(/^extra./,""));this.localize("matchingDocuments");Ext.applyIf(a,{title:e,collapsible:!0,facet:c,columns:[{renderer:function(a,b,c){return'\x3cspan style\x3d"font-size: smaller;"\x3e(\x3cspan class\x3d"info-tip" data-qtip\x3d"'+this.localize("matchingDocuments")+'"\x3e'+c.getInDocumentsCount()+"\x3c/span\x3e) \x3c/span\x3e"+(c.getLabel?c.getLabel():
c.getTerm()+'\x3cspan style\x3d"font-size: smaller;"\x3e (\x3cspan class\x3d"info-tip" data-qtip\x3d"'+this.localize("rawFreqs")+'"\x3e'+c.getRawFreq()+"\x3c/span\x3e)\x3c/span\x3e")},flex:1}],bbar:[{xtype:"querysearchfield",width:"100%",tokenType:c.replace("facet.",""),itemTpl:d}],corpus:this.getCorpus()});var f=b.add(a);f.getSelectionModel().on("selectionchange",function(a,b){var d=[];b.forEach(function(a){d.push({facet:f.facet,label:a.getLabel?a.getLabel():a.getTerm()})});this.getFacets()[c]=d;
this.updateResults()},this);f.on("query",function(a,b){this.getFacets()[f.facet]=[];this.updateResults()},this);return f},updateResults:function(a){var b=this.getFacets();if(!a){a=[];for(facet in b)b[facet].forEach(function(b){a.push(b.facet+":"+b.label)});if(a)return this.updateResults(a)}var c=this.queryById("results").getTargetEl();c.update(this.getCustomResultsHtml()?this.getCustomResultsHtml():(new Ext.XTemplate(this.localize("noMatches"))).apply([this.getCorpus().getDocumentsCount()]));this.queryById("status").update((new Ext.XTemplate(this.localize("noMatches"))).apply([this.getCorpus().getDocumentsCount()]));
this.queryById("export").setDisabled(!0);if(a&&0<a.length){this.mask(this.localize("loading"));var d=this.getCorpus().getDocumentQueryMatches();d.load({params:{query:a,includeDocIds:!0},callback:function(a,f,g){this.unmask();if(a&&0<a.length){this.queryById("status").setHtml(a.length);var h="\x3cul\x3e",k=[];a.forEach(function(a){a.getDocIds().forEach(function(a){k.push(a);var e=d.getCorpus().getDocument(a);a="\x3cli id\x3d'"+c.getId()+"_"+a+"' class\x3d'cataloguedoc'\x3e";a+="\x3ci\x3e"+e.getTitle()+
"\x3c/i\x3e";for(facet in b)if(0!=b[facet].length){var f="";if("facet.title"!=facet){var g=facet.replace(/^.+?\./,""),m=e.get(g);if(m){var r=Ext.isArray(m);r?f+="\x3cli\x3e"+g+"\x3cul\x3e":m=[m];m.forEach(function(a){var c=!1;b[facet].forEach(function(b){b.label==a?c=!0:-1==b.facet.indexOf("facet")&&b.label.split(/\W+/).forEach(function(b){0<b.trim().length&&-1<a.toLowerCase().indexOf(b.toLowerCase())&&(c=!0)})});f+="\x3cli\x3e"+(r?"":g.replace("extra.","")+": ")+(c?'\x3cspan class\x3d"keyword"\x3e'+
a+"\x3c/span\x3e":a)+"\x3c/li\x3e"});r&&(f+="\x3c/ul\x3e\x3c/li\x3e")}}f&&(a+="\x3cul\x3e"+f+"\x3c/ul\x3e")}h+=a+"\x3c/li\x3e"})});h+="\x3c/ul\x3e";c.update(h);this.queryById("status").update((new Ext.XTemplate(this.localize("queryMatches"))).apply([k.length,this.getCorpus().getDocumentsCount()]));this.setMatchingDocIds(Ext.Array.clone(k));0<k.length&&this.queryById("export").setDisabled(!1);b.lexical&&(a=k.splice(0,5),this.loadSnippets(a,c.first().first()),k&&0<k.length&&this.loadSnippets(k))}},
scope:this})}},loadSnippets:function(a,b){var c=this.queryById("results").getTargetEl(),d=this.getFacets();if(d.lexical){var d=d.lexical.map(function(a){return a.facet+":"+a.label}),e=this.getCorpus().getContexts({buffered:!1});b&&b.mask(this.localize("loadingSnippets"));e.load({method:"POST",params:{stripTags:"all",query:d,docId:a,perDocLimit:3,limit:100,accurateTotalNotNeeded:!0},scope:this,callback:function(a,d,e){b&&b.unmask();if(e&&Ext.isArray(a)&&0<a.length){var k={};a.forEach(function(a){k[a.getDocIndex()]||
(k[a.getDocIndex()]=[]);k[a.getDocIndex()].push(a)});for(docIndex in k)d=this.getCorpus().getDocument(docIndex).getId(),a='\x3cli style\x3d"list-style-type: none; font-size: smaller;"\x3e'+k[docIndex].map(function(a){return a.getHighlightedContext()}).join(" \u2026 ")+"\x3c/li\x3e",d=c.down("#"+c.getId()+"_"+d),d.query("ul")&&(a="\x3cul\x3e"+a+"\x3c/ul\x3e"),d.insertHtml("beforeEnd",a)}}})}},selectFacet:function(a){if(!this.facetsSelectionStore){var b={};this.getCorpus().getDocuments().each(function(a){for(var c in a.getData())"corpus"!=
c&&0!==c.indexOf("parent")&&"-1"==c.indexOf("-lexical")&&(b[c]=!0)});b=Object.keys(b);b.sort();this.facetsSelectionStore=Ext.create("Ext.data.ArrayStore",{fields:["text"],data:b.map(function(a){return[a]})})}var c={};this.queryById("facets").items.each(function(a){c[a.facet]=!0});this.facetsSelectionStore.filterBy(function(a){return!("facet."+a.get("text")in c)});Ext.create("Ext.window.Window",{title:this.localize("selectFacet"),modal:!0,items:{xtype:"form",width:300,items:{xtype:"combo",store:this.facetsSelectionStore,
forceSelection:!0,width:300},buttons:[{text:this.localize("cancel"),ui:"default-toolbar",glyph:"xf00d@FontAwesome",flex:1,handler:function(a){a.up("window").close()}},{text:this.localize("select"),glyph:"xf00c@FontAwesome",flex:1,handler:function(b){var c=b.up("window").down("combo").getValue();if(c)a.call(this,"facet."+c),b.up("window").close();else return this.showError(this.localize("selectValidFacet"))},scope:this}]},bodyPadding:5}).show()}});Ext.define("Voyant.panel.Cirrus",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.cirrus",statics:{i18n:{},api:{stopList:"auto",limit:500,visible:50,terms:void 0,docId:void 0,docIndex:void 0,cirrusForceFlash:!1,background:"0xffffff",fade:!0,smoothness:2,diagonals:"none"},glyph:"xf06e@FontAwesome"},config:{mode:void 0,options:[{xtype:"stoplistoption"},{xtype:"numberfield",name:"label",fieldLabel:"Max words",labelAlign:"right",value:500,minValue:50,step:50,listeners:{afterrender:function(a){var b=
a.up("window");b&&b.panel&&a.setFieldLabel(b.panel.localize("maxTerms"))}}}],corpus:void 0,records:void 0,terms:void 0,visLayout:void 0,vis:void 0,sizeAdjustment:100,minFontSize:12,largestWordSize:0,smallestWordSize:1E6},MODE_CORPUS:"corpus",MODE_DOCUMENT:"mode_document",layout:"fit",constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(a){Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",
xtype:"toolbar",enableOverflow:!0,items:[{xtype:"corpusdocumentselector",singleSelect:!0},{fieldLabel:this.localize("visibleTerms"),labelWidth:40,width:120,xtype:"slider",increment:25,minValue:25,maxValue:500,listeners:{afterrender:function(a){a.maxValue=this.getApiParam("limit");a.increment=parseInt(a.maxValue/50);a.setValue(this.getApiParam("visible"))},changecomplete:function(a,c){this.setApiParams({visible:c});this.loadFromTermsRecords()},scope:this}}]}]});this.callParent(arguments)},listeners:{resize:function(a,
b,c){this.getVisLayout()&&this.getCorpus()&&(this.setAdjustedSizes(),a=this.getLayout().getRenderTarget(),b=a.getWidth(),c=a.getHeight(),a.down("svg").set({width:b,height:c}),this.getTerms()&&this.getVisLayout().size([b,c]).stop().words(this.getTerms()).start())},loadedCorpus:function(a,b){this.loadFromCorpus(b)},corpusSelected:function(a,b){this.loadFromCorpus(b)},documentSelected:function(a,b){if(b){var c=this.getCorpus();b=c.getDocument(b);this.setApiParam("docId",b.getId());c=b.getDocumentTerms({autoload:!1,
corpus:c,pageSize:this.getApiParam("maxVisible"),parentPanel:this});this.loadFromDocumentTerms(c)}},ensureCorpusView:function(a,b){this.getMode()!=this.MODE_CORPUS&&this.loadFromCorpus(b)},boxready:function(){this.initVisLayout()}},loadFromCorpus:function(a){this.setCorpus(a);this.setApiParams({docId:void 0,docIndex:void 0});this.loadFromCorpusTerms(a.getCorpusTerms({autoload:!1,pageSize:this.getApiParam("maxVisible"),parentPanel:this}))},loadFromDocumentTerms:function(a){a.load({callback:function(a,
c,d){this.setMode(this.MODE_DOCUMENT);this.setRecords(c.getRecords());this.loadFromTermsRecords()},scope:this,params:this.getApiParams()})},loadFromCorpusTerms:function(a){a.load({callback:function(a,c,d){this.setMode(this.MODE_CORPUS);this.setRecords(c.getRecords());this.loadFromTermsRecords()},scope:this,params:this.getApiParams()})},loadFromTermsRecords:function(){var a=this.getRecords(),b=this.getApiParam("visible");b>a.length&&(b=a.length);for(var c=[],d=0;d<b;d++)c.push({text:a[d].get("term"),
rawFreq:a[d].get("rawFreq")});this.setTerms(c);this.buildFromTerms()},initVisLayout:function(){if(void 0==this.getVisLayout())if("true"==this.getApiParam("cirrusForceFlash")){this.setApiParam("cirrusForceFlash",!0);for(var a=this.id.replace(/-/g,"_")+"_cirrus",b={id:a},c=["background","fade","smoothness","diagonals"],d=0;d<c.length;d++)b[c[d]]=this.getApiParam(c[d]);c='\x3cscript type\x3d"text/javascript" src\x3d"'+this.getApplication().getBaseUrl()+'resources/swfobject/swfobject.js"\x3e\x3c/script\x3e';
this.update(c+('\x3cscript type\x3d"text/javascript"\x3efunction cirrusClickHandler'+a+'(word, value) {if (window.console \x26\x26 console.info) console.info(word, value);var cirrusTool \x3d Ext.getCmp("'+this.id+'");cirrusTool.cirrusClickHandler(word, value);}function cirrusLoaded'+a+'() {if (window.console \x26\x26 console.info) console.info("cirrus flash loaded");}function cirrusPNGHandler'+a+'(base64String) {var cirrusTool \x3d Ext.getCmp("'+this.id+'");cirrusTool.cirrusPNGHandler(base64String);}\x3c/script\x3e'),
!0,function(){function a(c){if("undefined"!==typeof swfobject){var d=c.getLayout().getRenderTarget(),h=d.getWidth(),d=d.getHeight(),k=c.getApplication().getBaseUrl()+"resources/cirrus/flash/Cirrus.swf";c.add({xtype:"flash",id:b.id,url:k,width:h,height:d,flashVars:b,flashParams:{menu:"false",scale:"showall",allowScriptAccess:"always",bgcolor:"#222222",wmode:"opaque"}});c.cirrusFlashApp=Ext.get(b.id).first().dom}else setTimeout(a,50,c)}a(this.component)},this)}else d=this.getLayout().getRenderTarget(),
a=d.getWidth(),c=d.getHeight(),this.setVisLayout(d3.layout.cloud().size([a,c]).padding(1).rotate(function(){return 90*~~(2*Math.random())}).spiral("archimedean").font("Impact").fontSize(function(a){return a.fontSize}.bind(this)).text(function(a){return a.text}).on("end",this.draw.bind(this))),d=d3.select(d.dom).append("svg").attr("id","cirrusGraph").attr("width",a).attr("height",c),this.setVis(d.append("g").attr("transform","translate("+a/2+","+c/2+")")),Ext.create("Ext.tip.ToolTip",{target:d.node(),
delegate:"text",trackMouse:!0,listeners:{beforeshow:function(a){var b=a.triggerElement.getAttribute("data-freq");a.update(b)}}})},buildFromTerms:function(){var a=this.getTerms();if(this.rendered&&a)if(!0===this.getApiParam("cirrusForceFlash"))if(void 0!==this.cirrusFlashApp&&void 0!==this.cirrusFlashApp.clearAll){for(var b=[],c=0;c<a.length;c++){var d=a[c];b.push({word:d.text,size:d.rawFreq,label:d.rawFreq})}this.cirrusFlashApp.clearAll();this.cirrusFlashApp.addWords(b);this.cirrusFlashApp.arrangeWords()}else Ext.defer(this.buildFromTerms,
50,this);else{b=1E3;d=-1;for(c=0;c<a.length;c++){var e=a[c].rawFreq;e<b&&(b=e);e>d&&(d=e)}this.setSmallestWordSize(b);this.setLargestWordSize(d);this.setRelativeSizes();this.setAdjustedSizes();this.getVisLayout().words(a).start()}else Ext.defer(this.buildFromTerms,50,this)},draw:function(a,b){var c=this;this.getLayout().getRenderTarget();var d=this.getVisLayout().size()[0],e=this.getVisLayout().size()[1],f=b?Math.min(d/Math.abs(b[1].x-d/2),d/Math.abs(b[0].x-d/2),e/Math.abs(b[1].y-e/2),e/Math.abs(b[0].y-
e/2))/2:1,g=this.getVis().selectAll("text").data(a,function(a){return a.text});g.transition().duration(1E3).attr("transform",function(a){return"translate("+[a.x,a.y]+")rotate("+a.rotate+")"}).style("font-size",function(a){return a.fontSize+"px"});g.enter().append("text").attr("text-anchor","middle").attr("data-freq",function(a){return a.rawFreq}).attr("transform",function(a){return"translate("+[a.x,a.y]+")rotate("+a.rotate+")"}).style("font-size","1px").transition().duration(1E3).style("font-size",
function(a){return a.fontSize+"px"});g.style("font-family",function(a){return a.font}).style("fill",function(a){return c.getApplication().getColorForTerm(a.text,!0)}).text(function(a){return a.text}).on("click",function(a){c.dispatchEvent("termsClicked",c,[a.text])});g.exit().remove();this.getVis().transition().duration(1E3).attr("transform","translate("+d/2+","+e/2+")scale("+f+")")},map:function(a,b,c,d,e){return d+(a-b)/(c-b)*(e-d)},calculateSizeAdjustment:function(){var a=this.getTerms();if(void 0!==
a){var b=this.getLayout().getRenderTarget(),b=b.getWidth()*b.getHeight();1E5>b?this.setMinFontSize(8):this.setMinFontSize(12);for(var c=0,d=0;d<a.length;d++)var e=this.calculateWordArea(a[d]),c=c+e;this.setSizeAdjustment(b/c)}},calculateWordArea:function(a){for(var b=Math.log(10*a.relativeSize)*Math.LOG10E,c=(b+a.relativeSize)/2,d=0,e=0;e<a.text.length;e++)var f=a.text.charAt(e),d="f"==f||"i"==f||"j"==f||"l"==f||"r"==f||"t"==f?d+b/3:"m"==f||"w"==f?d+b/(4/3):d+b/1.9;return c*d},setAdjustedSizes:function(){this.calculateSizeAdjustment();
var a=this.getTerms();if(void 0!==a)for(var b=0;b<a.length;b++){var c=a[b],d=this.findNewRelativeSize(c);c.fontSize=d>this.getMinFontSize()?d:this.getMinFontSize()}},setRelativeSizes:function(){var a=this.getTerms();if(void 0!==a)for(var b=0;b<a.length;b++){var c=a[b];c.relativeSize=this.map(c.rawFreq,this.getSmallestWordSize(),this.getLargestWordSize(),.1,1)}},findNewRelativeSize:function(a){var b=this.getSizeAdjustment(),b=this.calculateWordArea(a)*b;return(Math.sqrt(6)*Math.sqrt(6*Math.pow(a.text.length,
2)+b*a.text.length)-6*a.text.length)/(2*a.text.length)}});Ext.define("Voyant.panel.CollocatesGraph",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.collocatesgraph",statics:{i18n:{},api:{query:void 0,mode:void 0,limit:5,stopList:"auto",terms:void 0,context:5},glyph:"xf1e0@FontAwesome"},config:{corpus:void 0,node:void 0,link:void 0,nodeDataSet:new vis.DataSet,edgeDataSet:new vis.DataSet,network:void 0,contextMenu:void 0,force:void 0,graphHeight:void 0,graphWidth:void 0,corpusColours:d3.scale.category10()},nodeOptions:{shape:"box",color:{border:"rgba(0,0,0,0.1)",
background:"rgba(255,255,255,1)"},scaling:{label:{min:10,max:30}}},edgeOptions:{color:{color:"rgba(0,0,0,0.1)",highlight:"black",hover:"red"},labelHighlightBold:!1},highlightOptions:{font:{color:"white"},color:{background:"black",hover:{border:"#CB157F",background:"#EB42A5"}}},keywordColor:"green",contextColor:"maroon",constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){var a=this;Ext.apply(a,{title:this.localize("title"),
dockedItems:[{dock:"bottom",xtype:"toolbar",enableOverflow:!0,items:[{xtype:"querysearchfield"},{text:a.localize("clearTerms"),glyph:"xf014@FontAwesome",handler:function(){this.getNodeDataSet().clear();this.getEdgeDataSet().clear()},scope:a},this.localize("context"),{xtype:"slider",minValue:3,value:5,maxValue:30,increment:2,width:50,listeners:{render:function(b){b.setValue(a.getApiParam("context"))},changecomplete:{fn:function(a,c){this.setApiParam("context",a.getValue());var d=this.getNodeDataSet().map(function(a){return a.label});
0<d.length&&(this.getNodeDataSet().clear(),this.loadFromQuery(d))},scope:a}}}]}]});this.setContextMenu(Ext.create("Ext.menu.Menu",{renderTo:Ext.getBody(),items:[{text:"",itemId:"label",disabled:!0},{xtype:"menuseparator"},{xtype:"menucheckitem",text:"Fixed",itemId:"fixed",listeners:{checkchange:function(a,c,d){a=this.getNetwork().getSelectedNodes();null!=a[0]&&this.getNodeDataSet().update({id:a[0],fixed:c})},scope:this}},{xtype:"button",text:"Remove",style:"margin: 5px;",handler:function(a,c){var d=
this.getNetwork().getSelectedNodes();null!=d[0]&&(this.getNodeDataSet().remove(d[0]),a.up("menu").hide(),this.forceUpdate())},scope:this}]}));this.on("loadedCorpus",function(a,c){this.setCorpus(c);this.isVisible()&&this.initLoad()},this);this.on("activate",function(){this.getCorpus()&&Ext.Function.defer(this.initLoad,100,this)},this);this.on("query",function(a,c){this.loadFromQuery(c)},this);this.on("resize",function(a,c,d){a=this.getLayout().getRenderTarget();c=this.getDockedItems();for(var e=0,
f=0;f<c.length;f++)e+=c[f].getHeight();a.setHeight(d-e);a.setWidth(a.getWidth());this.setGraphHeight(a.getHeight());this.setGraphWidth(a.getWidth());void 0!==this.getNetwork()&&this.getNetwork().fit()},this);a.callParent(arguments)},initLoad:function(){this.getCorpus()&&(this.initGraph(),this.getCorpus().getCorpusTerms({leadingBufferZone:0,autoLoad:!1}).load({callback:function(a,b,c){c&&this.loadFromCorpusTermRecords(a)},scope:this,params:{limit:3,stopList:this.getApiParam("stopList")}}))},loadFromQuery:function(a){this.setApiParams({mode:"corpus"});
var b=this.getApiParams();(Ext.isString(a)?[a]:a).forEach(function(a){this.getCorpus().getCorpusCollocates({autoLoad:!1}).load({params:Ext.apply(Ext.clone(b),{query:a}),callback:function(a,b,c){c&&this.loadFromCorpusCollocateRecords(a)},scope:this})},this)},loadFromCorpusTermRecords:function(a){if(Ext.isArray(a)&&0<a.length){var b=[];a.forEach(function(a){b.push(a.getTerm())});this.loadFromQuery(b)}},loadFromCorpusCollocateRecords:function(a,b){if(Ext.isArray(a)){var c=this.getApiParam("limit"),d=
this.getNodeDataSet(),e=this.getEdgeDataSet(),f={};d.forEach(function(a){f[a.id]=!0});var g=[],h=[];a.forEach(function(a,m){var l=a.getTerm(),n=a.getContextTerm(),q=a.getKeywordRawFreq(),s=a.getContextTermRawFreq();0==m&&(void 0===b&&(b=l),void 0!==f[b]?d.update({id:b,value:q,title:l+" ("+q+")",type:"keyword",font:{color:this.keywordColor}}):(f[b]=!0,g.push({id:l,label:l,title:l+" ("+q+")",type:"keyword",value:q,start:c,font:{color:this.keywordColor}})));if(l!=n){void 0===f[n]&&(f[n]=!0,g.push({id:n,
label:n,title:n+" ("+s+")",type:"context",value:s,start:0,font:{color:this.contextColor}}));var p=null;e.forEach(function(a){if(a.from==b&&a.to==n||a.from==n&&a.to==b)p=a});l=a.getContextTermRawFreq();null===p?h.push({from:b,to:n,value:l}):p.value<l&&e.update({id:p.id,value:l})}},this);d.add(g);e.add(h);this.forceUpdate();this.getNetwork().fit()}},initGraph:function(){var a=this.getLayout().getRenderTarget();a.setWidth(a.getWidth());a.setHeight(a.getHeight());this.setGraphHeight(a.getHeight());this.setGraphWidth(a.getWidth());
if(void 0===this.getNetwork()){var b={autoResize:!0,interaction:{hover:!0,hoverConnectedEdges:!0,multiselect:!1},physics:{barnesHut:{gravitationalConstant:-1500,centralGravity:6,damping:.5,avoidOverlap:.5}},nodes:this.nodeOptions,edges:this.edgeOptions},a=new vis.Network(a.dom,{nodes:this.getNodeDataSet(),edges:this.getEdgeDataSet()},b);this.setNetwork(a);this.getNodeDataSet().on("remove",function(a,b,e){var f=b.items[0];a=this.getEdgeDataSet().get({filter:function(a){return a.from==f||a.to==f}});
this.getEdgeDataSet().remove(a);var g=[];this.getNodeDataSet().forEach(function(a){0==this.getEdgeDataSet().get({filter:function(b){return b.from==a.id||b.to==a.id}}).length&&g.push(a.id)}.bind(this));this.getNodeDataSet().remove(g)}.bind(this));a.on("dragStart",function(a){a=a.nodes[0];null!=a&&this.getNodeDataSet().update({id:a,fixed:!1})}.bind(this));a.on("dragging",function(a){null!=a.nodes[0]&&(this.isMasked()?this.isOffCanvas(a.pointer.DOM)||this.unmask():this.isOffCanvas(a.pointer.DOM)&&this.mask(this.localize("releaseToRemove")))}.bind(this));
a.on("dragEnd",function(a){var b=a.nodes[0];null!=b&&(this.isOffCanvas(a.pointer.DOM)?(this.unmask(),this.mask("cleaning"),this.getNodeDataSet().remove(b),this.forceUpdate(),this.unmask()):this.getNodeDataSet().update({id:b,fixed:!0}))}.bind(this));a.on("click",function(a){this.getContextMenu().hide();if(a){var b=this.getNodeDataSet();a.nodes&&0<a.nodes.length?this.dispatchEvent("termsClicked",this,[b.get(a.nodes[0]).label]):a.edges&&0<a.edges.length&&(a=this.getEdgeDataSet().get(a.edges[0]),this.dispatchEvent("termsClicked",
this,['"'+b.get(a.from).label+" "+b.get(a.to).label+'"~'+this.getApiParam("context")]))}}.bind(this));a.on("doubleClick",function(a){a=a.nodes[0];null!=a&&(a=this.getNodeDataSet().get(a),this.itemdblclick(a))}.bind(this));a.on("oncontext",function(a){a.event.preventDefault();var b=this.getNetwork().getNodeAt(a.pointer.DOM);if(null!=b){this.getNetwork().selectNodes([b]);var b=this.getNodeDataSet().get(b),e=this.getContextMenu();e.queryById("label").setText(b.label);e.queryById("fixed").setChecked(b.fixed);
e.showAt(a.event.pageX,a.event.pageY)}}.bind(this))}},forceUpdate:function(){var a=this.getNodeDataSet().map(function(a){return{id:a.id}});this.getNodeDataSet().update(a);a=this.getEdgeDataSet().map(function(a){return{id:a.id}});this.getEdgeDataSet().update(a)},isOffCanvas:function(a){return 0>a.x||0>a.y||a.x>this.getGraphWidth()||a.y>this.getGraphHeight()},itemdblclick:function(a){var b=this.getApiParam("limit");this.getCorpus().getCorpusCollocates({autoLoad:!1}).load({params:Ext.apply(this.getApiParams(),
{query:a.id,start:a.start,limit:b}),callback:function(c,d,e){e&&(this.getNodeDataSet().update({id:a.id,start:a.start+b}),this.loadFromCorpusCollocateRecords(c,a.id))},scope:this})}});Ext.define("Voyant.panel.Contexts",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],requires:["Voyant.data.store.Contexts"],alias:"widget.contexts",isConsumptive:!0,statics:{i18n:{},api:{query:void 0,docId:void 0,docIndex:void 0,stopList:"auto",context:5,expand:50},glyph:"xf0ce@FontAwesome"},constructor:function(){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){var a=this;Ext.apply(a,{title:this.localize("title"),emptyText:this.localize("emptyText"),
store:Ext.create("Voyant.data.store.ContextsBuffered",{parentPanel:this,proxy:{extraParams:{stripTags:"all"}}}),selModel:Ext.create("Ext.selection.RowModel",{listeners:{selectionchange:{fn:function(a,c){this.getApplication().dispatchEvent("termLocationClicked",this,c)},scope:this}}}),plugins:[{ptype:"rowexpander",rowBodyTpl:new Ext.XTemplate("")}],dockedItems:[{dock:"bottom",xtype:"toolbar",enableOverflow:!0,items:[{xtype:"querysearchfield"},{xtype:"totalpropertystatus"},this.localize("context"),
{xtype:"slider",minValue:5,value:5,maxValue:50,increment:5,width:50,listeners:{render:function(b){b.setValue(a.getApiParam("context"))},changecomplete:function(b,c){a.setApiParam("context",b.getValue());a.getStore().loadPage(1,{params:a.getApiParams()})}}},this.localize("expand"),{xtype:"slider",minValue:5,value:5,maxValue:500,increment:10,width:50,listeners:{render:function(b){b.setValue(a.getApiParam("expand"))},changecomplete:function(b,c){a.setApiParam("expand",c);var d=a.getView(),e=a.plugins[0].recordsExpanded,
f=d.getStore(),g;for(g in e){var h=f.getByInternalId(g),k=d.getRow(h),m=k.parentNode.childNodes[1];e[g]?d.fireEvent("expandbody",k,h,m,{force:!0}):Ext.fly(m).down(".x-grid-rowbody").setHtml("")}}}},{xtype:"corpusdocumentselector"}]}],columns:[{text:this.localize("document"),toolTip:this.localize("documentTip"),width:"autoSize",dataIndex:"docIndex",sortable:!0,renderer:function(a,c,d,e,f,g){return g.getCorpus().getDocument(a).getTinyLabel()}},{text:this.localize("left"),tooltip:this.localize("leftTip"),
align:"right",dataIndex:"left",sortable:!0,flex:1},{text:this.localize("term"),tooltip:this.localize("termTip"),dataIndex:"term",sortable:!0,width:"autoSize"},{text:this.localize("right"),tooltip:this.localize("rightTip"),dataIndex:"right",sortable:!0,flex:1},{text:this.localize("position"),tooltip:this.localize("positionTip"),dataIndex:"position",sortable:!0,hidden:!0,flex:1}],listeners:{scope:this,corpusSelected:function(){this.getStore().getCorpus()&&(this.setApiParams({docId:void 0,docIndex:void 0}),
this.getStore().loadPage(1))},documentsSelected:function(a,c){var d=[],e=this.getStore().getCorpus();c.forEach(function(a){d.push(e.getDocument(a).getId())},this);this.setApiParams({docId:d,docIndex:void 0});this.getStore().loadPage(1)},documentSegmentTermClicked:{fn:function(a,c){c.term&&(params={query:c.term},c.docId?params.docId=c.docId:params.docIndex=c.docIndex?c.docIndex:0,this.setApiParams(params),this.isVisible()&&this.getStore().loadPage(1))},scope:this},documentIndexTermsClicked:{fn:function(a,
c){var d={},e=[],f={},g=[];c.forEach(function(a){d[a.term]||(e.push(a.term),d[a.term]=!0);f[a.docIndex]||(g.push(a.docIndex),f[a.docIndex]=!0)});this.setApiParams({docId:void 0,docIndex:g,query:e});this.isVisible()&&this.getStore().loadPage(1,{params:this.getApiParams()})},scope:this},afterrender:function(a){a.getView().on("expandbody",function(c,d,e,f){if(""===e.innerText||f&&f.force){c=Ext.create("Voyant.data.store.Contexts",{stripTags:"all",corpus:a.getStore().getCorpus()});var g=d.getData();c.load({params:{query:g.query,
docIndex:g.docIndex,position:g.position,limit:1,context:a.getApiParam("expand")},callback:function(a,b,c){c&&1==a.length&&(g=a[0].getData(),b.expandRow.firstElementChild.firstElementChild.innerHTML=g.left+" \x3cspan class\x3d'word keyword'\x3e"+g.middle+"\x3c/span\x3e "+g.right)},expandRow:e})}})}}});a.on("loadedCorpus",function(b,c){"NONCONSUMPTIVE"==c.getNoPasswordAccess()?this.mask(this.localize("limitedAccess"),"mask-no-spinner"):c.getCorpusTerms({autoLoad:!1}).load({callback:function(a,b,c){c&&
0<a.length&&(this.setApiParam("query",a[0].getTerm()),this.getStore().load({params:this.getApiParams()}))},scope:a,params:{limit:1,query:this.getApiParam("query"),stopList:this.getApiParam("stopList")}})});a.on("query",function(a,c){this.setApiParam("query",c);this.getStore().loadPage(1,{params:this.getApiParams()})},a);a.on("documentTermsClicked",function(a,c){var d=[];c.forEach(function(a){d.push({term:a.getTerm(),docIndex:a.getDocIndex()})});this.fireEvent("documentIndexTermsClicked",this,d)});
a.on("termsClicked",function(a,c){var d=[];Ext.isString(c)&&(c=[c]);c.forEach(function(a){void 0!==a.docIndex&&d.push({term:a.term,docIndex:a.docIndex})});0<d.length&&this.fireEvent("documentIndexTermsClicked",this,d)});a.callParent(arguments)}});Ext.define("Voyant.panel.CorpusCollocates",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.corpuscollocates",config:{corpus:void 0},statics:{i18n:{},api:{stopList:"auto",context:5,query:void 0,docId:void 0,docIndex:void 0,sort:"contextTermRawFreq"},glyph:"xf0ce@FontAwesome"},config:{options:{xtype:"stoplistoption"}},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,c){this.isVisible()&&
this.loadFromApis()});a.embedded||a.corpus&&this.fireEvent("loadedCorpus",this,a.corpus);this.on("corpusTermsClicked",function(a,c){if(this.getStore().getCorpus()){var d=[];c.forEach(function(a){d.push(a.get("term"))});this.setApiParams({query:d,docId:void 0,docIndex:void 0});this.isVisible()&&this.getStore().loadPage(1,{params:this.getApiParams()})}});this.on("documentsClicked",function(a,c){var d=[];c.forEach(function(a){d.push(a.get("id"))});this.setApiParams({docId:d,docid:void 0,query:void 0});
this.isVisible()&&this.getStore().loadPage(1,{params:this.getApiParams()})});this.on("activate",function(){this.getStore().getCorpus()&&this.loadFromApis()},this);this.on("query",function(a,c){this.setApiParam("query",c);this.getStore().getProxy().setExtraParam("query",c);this.loadFromApis()},this)},loadFromApis:function(){this.getStore().getCorpus()&&(this.getApiParam("query")?this.getStore().loadPage(1,{params:this.getApiParams()}):this.getStore().getCorpus().getCorpusTerms({leadingBufferZone:0,
autoLoad:!1}).load({callback:function(a,b,c){if(c){var d=[];a.forEach(function(a){d.push(a.getTerm())});this.getStore().getProxy().setExtraParam("query",d);this.setApiParam("query",d);this.loadFromApis()}},scope:this,params:{limit:10,stopList:this.getApiParam("stopList")}}))},initComponent:function(){var a=this,b=Ext.create("Voyant.data.store.CorpusCollocatesBuffered",{parentPanel:this});Ext.apply(a,{title:this.localize("title"),emptyText:this.localize("emptyText"),store:b,selModel:Ext.create("Ext.selection.CheckboxModel",
{listeners:{selectionchange:{fn:function(a,b){var e=[],f=this.getApiParam("context");b.forEach(function(a){e.push('"'+a.getKeyword()+" "+a.getContextTerm()+'"~'+f)});this.getApplication().dispatchEvent("termsClicked",this,e)},scope:this}}}),dockedItems:[{dock:"bottom",xtype:"toolbar",enableOverflow:!0,items:[{xtype:"querysearchfield"},{xtype:"totalpropertystatus"},this.localize("context"),{xtype:"slider",minValue:1,value:5,maxValue:30,increment:2,width:50,listeners:{render:function(b){b.setValue(a.getApiParam("context"))},
changecomplete:function(b,d){a.setApiParam("context",b.getValue());a.getStore().loadPage(1,{params:a.getApiParams()})}}}]}],columns:[{text:this.localize("term"),dataIndex:"term",tooltip:this.localize("termTip"),sortable:!0,flex:1},{text:this.localize("rawFreq"),dataIndex:"rawFreq",tooltip:this.localize("termRawFreqTip"),sortable:!0,width:"autoSize",hidden:!0},{text:this.localize("contextTerm"),dataIndex:"contextTerm",tooltip:this.localize("contextTermTip"),flex:1,sortable:!0},{text:this.localize("contextTermRawFreq"),
tooltip:this.localize("contextTermRawFreqTip"),dataIndex:"contextTermRawFreq",width:"autoSize",sortable:!0}],listeners:{termsClicked:{fn:function(a,b){if(this.getStore().getCorpus()){var e=[];b.forEach(function(a){Ext.isString(a)?e.push(a):a.term?e.push(a.term):a.getTerm&&e.push(a.getTerm())});0<e.length&&(this.setApiParams({docIndex:void 0,docId:void 0,query:e}),this.isVisible()&&this.isVisible()&&this.getStore().loadPage(1,{params:this.getApiParams()}))}},scope:this}}});a.callParent(arguments);
a.getStore().getProxy().setExtraParam("withDistributions",!0)}});Ext.define("Voyant.panel.CorpusCreator",{extend:"Ext.form.Panel",requires:["Ext.form.field.File"],requires:["Voyant.data.model.Corpus"],mixins:["Voyant.panel.Panel"],alias:"widget.corpuscreator",isConsumptive:!0,statics:{i18n:{},api:{inputFormat:void 0,xmlDocumentsXpath:void 0,xmlContentXpath:void 0,xmlTitleXpath:void 0,xmlAuthorXpath:void 0,tokenization:void 0,adminPassword:void 0,accessPassword:void 0,accessModeWithoutPassword:void 0,tableDocuments:void 0,tableContent:void 0,tableTitle:void 0,tableAuthor:void 0}},
config:{corpus:void 0},constructor:function(a){this.callParent(arguments);a=a||{};this.mixins["Voyant.panel.Panel"].constructor.call(this,Ext.apply(a,{includeTools:{gear:!0,help:!0}}))},initComponent:function(){var a=this;Ext.apply(a,{title:this.localize("title"),width:800,frame:!0,padding:10,style:{borderColor:"#aaa",borderStyle:"solid"},frameHeader:!0,layout:{type:"vbox",align:"middle"},dockedItems:[{xtype:"toolbar",enableOverflow:!0,dock:"bottom",buttonAlign:"right",items:[{text:a.localize("Open"),
glyph:"xf115@FontAwesome",tooltip:a.localize("SelectExisting"),hidden:void 0!=this.getCorpus(),handler:function(){Ext.create("Ext.window.Window",{title:a.localize("Open"),layout:"fit",modal:!0,items:{xtype:"form",submitEmptyText:!1,margin:"5,5,5,5",items:{xtype:"corpusselector"},buttons:[{text:a.localize("Open"),glyph:"xf00c@FontAwesome",handler:function(b){b.up("form").getForm();var c=b.up("form").getForm().getValues().corpus;""!=c?(a.loadCorpus({corpus:c}),b.up("window").close()):Ext.Msg.show({title:a.localize("SelectExisting"),
message:a.localize("PleaseSelectExisting"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})},flex:1},{text:a.localize("cancel"),glyph:"xf00d@FontAwesome",flex:1,handler:function(a){a.up("window").close()}}]}}).show()}},{xtype:"fileuploadfield",glyph:"xf093@FontAwesome",name:"upload",buttonOnly:!0,hideLabel:!0,ui:"default-toolbar",buttonText:a.localize("Upload"),listeners:{render:function(b){b.fileInputEl.dom.setAttribute("multiple",!0);Ext.tip.QuickTipManager.register({target:b.getEl(),text:a.localize("UploadLocal")})},
change:function(b,c){if(c){var d=b.up("form").getForm();if(d.isValid()){for(var e=b.fileInputEl.dom.files,f=/\.(png|gif|jpe?g|xls|mp[234a]|mpeg|exe|wmv|avi|ppt|mpg|tif|wav|mov|psd|wma|ai|bmp|pps|aif|pub|dwg|indd|swf|asf|mbd|dmg|flv)$/i,g=/\.(txt|pdf|html?|xml|docx?|rtf|pages|odt|zip|jar|tar|gz|ar|cpio|bzip2|bz2|gzip|xlsx?)$/i,h=[],k=[],m=0,l=e.length;m<l;m++){var n=e[m].name;f.test(n)?h.push(n.split("/").pop()):g.test(n)||k.push(n.split("/").pop())}0<h.length||0<k.length?Ext.Msg.show({title:a.localize("fileTypesWarning"),
icon:Ext.MessageBox.ERROR,message:a.localize("fileTypesMessage")+"\x3cul\x3e"+(0<h.length?"\x3cli\x3e"+a.localize("badFiles")+h.slice(0,5).join(", ")+(5<h.length?"\u2026":"")+"\x3c/li\x3e":"")+(0<k.length?"\x3cli\x3e"+a.localize("unknownFiles")+k.slice(0,5).join(", ")+(5<k.length?"\u2026":"")+"\x3c/li\x3e":"")+"\x3c/ul\x3e"+a.localize("sureContinue"),buttons:Ext.Msg.YESNO,fn:function(c){"yes"===c?a.loadForm(d):(b.reset(),b.fileInputEl.dom.setAttribute("multiple",!0))},scope:d}):a.loadForm(d)}}}}},
"-\x3e",{xtype:"button",scale:"large",glyph:"xf00d@FontAwesome",text:this.localize("cancel"),hidden:void 0==this.getCorpus(),handler:function(a){(a=this.up("window"))&&a.isFloating()&&a.close()}},{xtype:"button",scale:"large",glyph:"xf00c@FontAwesome",text:this.localize("reveal"),ui:"default",width:200,handler:function(b){var c=b.up("form").down("#input").getValue();if(""!==c){var d=a.getApiParams();delete d.view;delete d.stopList;d.inputFormat&&0!==c.trim().indexOf("\x3c")?Ext.Msg.confirm(a.localize("error"),
a.localize("errorNotXmlContinue"),function(b){"yes"==b&&a.loadCorpus(Ext.apply(d,{input:c}))},a):a.loadCorpus(Ext.apply(d,{input:c}))}else Ext.Msg.show({title:a.localize("noTextProvided"),message:a.localize("pleaseProvideText"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}}]}],items:{xtype:"textareafield",width:800,height:100,itemId:"input",emptyText:this.localize("emptyInput")}});a.callParent(arguments)},loadForm:function(a){var b={tool:this.getCorpus()?"corpus.CorpusMetadata":"corpus.CorpusCreator"};
this.getCorpus()&&Ext.apply(b,{corpus:this.getCorpus().getId(),addDocuments:!0});var c=this.getApiParams();delete c.view;delete c.stopList;Ext.apply(b,c);var d=this.getApplication().getViewport();d.mask(this.localize("uploadingCorpus"));a.submit({url:this.getTromboneUrl(),params:b,failure:function(a,b){d.unmask();b.result&&(this.setCorpus(void 0),this.loadCorpus({corpus:b.result.corpus?b.result.corpus.metadata.id:b.result.stepEnabledCorpusCreator.storedId}))},scope:this})},loadCorpus:function(a){this.getCorpus()&&
Ext.apply(a,{corpus:this.getCorpus().getId(),addDocuments:!0});var b=this.up("window");b&&b.isFloating()&&b.close();this.getApplication().loadCorpusFromParams(a)},showOptionsClick:function(a){void 0===a.optionsWin&&(a.optionsWin=Ext.create("Ext.window.Window",{title:a.localize("gearWinTitle"),closeAction:"hide",layout:"fit",bodyPadding:10,items:[{xtype:"form",defaultType:"textfield",maxHeight:a.up("viewport").getHeight()-300,scrollable:!0,fieldDefaults:{labelAlign:"right",labelWidth:110,width:350},
items:[{xtype:"combo",fieldLabel:a.localize("inputFormat"),labelWidth:90,name:"inputFormat",queryMode:"local",store:[["",a.localize("inputFormatAuto")],["dtoc","DToC: Dynamic Table of Contexts"],["TEI","TEI: Text Encoding Initative"],["TEI","TEI Corpus"],["RSS","Really Simple Syndication: RSS"]],value:""},{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+(new Ext.Template(a.localize("advancedOptionsText"))).applyTemplate([a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-xml"])+"\x3c/i\x3e\x3c/p\x3e",
width:375},{xtype:"fieldset",title:"\x3ca href\x3d'"+a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-xml' target\x3d'voyantdocs'\x3e"+a.localize("xmlOptions")+"\x3c/a\x3e",collapsible:!0,collapsed:!0,defaultType:"textfield",items:[{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+a.localize("xmlOptionsText")+"\x3c/i\x3e\x3c/p\x3e",width:375},{fieldLabel:a.localize("xpathContent"),name:"xmlContentXpath"},{fieldLabel:a.localize("xpathTitle"),name:"xmlTitleXpath"},{fieldLabel:a.localize("xpathAuthor"),
name:"xmlAuthorXpath"},{fieldLabel:a.localize("xpathDocuments"),name:"xmlDocumentsXpath"},{fieldLabel:a.localize("xpathGroupBy"),name:"xmlGroupByXpath"}]},{xtype:"fieldset",title:"\x3ca href\x3d'"+a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-tables' target\x3d'voyantdocs'\x3e"+a.localize("tableOptions")+"\x3c/a\x3e",collapsible:!0,collapsed:!0,defaultType:"textfield",items:[{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+(new Ext.Template(a.localize("tableOptionsText"))).applyTemplate([a.getBaseUrl()+
"docs/#!/guide/corpuscreator-section-tables"])+"\x3c/i\x3e\x3c/p\x3e",width:375},{xtype:"combo",fieldLabel:a.localize("tableDocuments"),name:"tableDocuments",queryMode:"local",store:[["",a.localize("tableDocumentsTable")],["rows",a.localize("tableDocumentsRows")],["columns",a.localize("tableDocumentsColumns")]],forceSelection:!0,value:""},{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+a.localize("tableNoHeadersRowText")+"\x3c/i\x3e\x3c/p\x3e",width:375},{fieldLabel:a.localize("tableNoHeadersRow"),xtype:"checkboxfield",
name:"tableNoHeadersRow",inputValue:"true"},{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+a.localize("tableContentText")+"\x3c/i\x3e\x3c/p\x3e",width:375},{fieldLabel:a.localize("tableContent"),validator:function(b){return a.validatePositiveNumbersCsv.call(a,b)},name:"tableContent"},{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+a.localize("tableMetadataText")+"\x3c/i\x3e\x3c/p\x3e",width:375},{fieldLabel:a.localize("tableAuthor"),validator:function(b){return a.validatePositiveNumbersCsv.call(a,b)},
name:"tableAuthor"},{fieldLabel:a.localize("tableTitle"),validator:function(b){return a.validatePositiveNumbersCsv.call(a,b)},name:"tableTitle"}]},{xtype:"fieldset",title:"\x3ca href\x3d'"+a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-tokenization' target\x3d'voyantdocs'\x3e"+a.localize("tokenizationOptions")+"\x3c/a\x3e",collapsible:!0,collapsed:!0,items:[{xtype:"combo",fieldLabel:a.localize("tokenization"),name:"tokenization",queryMode:"local",store:[["",a.localize("tokenizationAuto")],["wordBoundaries",
a.localize("tokenizationWordBoundaries")]],forceSelection:!0,value:""}]},{xtype:"fieldset",title:"\x3ca href\x3d'"+a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-access-management' target\x3d'voyantdocs'\x3e"+a.localize("accessOptions")+"\x3c/a\x3e",collapsible:!0,collapsed:!0,defaultType:"textfield",items:[{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+a.localize("accessOptionsText")+"\x3c/i\x3e\x3c/p\x3e",width:375},{fieldLabel:a.localize("adminPassword"),name:"adminPassword"},{fieldLabel:a.localize("accessPassword"),
name:"accessPassword"},{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+a.localize("accessModeWithoutPasswordText")+"\x3c/i\x3e\x3c/p\x3e",width:375},{xtype:"combo",fieldLabel:a.localize("accessModeWithoutPassword"),name:"noPassordAccess",queryMode:"local",store:[["",a.localize("accessModeNonConsumptive")],["none",a.localize("accessModeNone")]],forceSelection:!0,value:""}]}]}],buttons:[{text:a.localize("ok"),handler:function(b,c){var d=b.findParentByType("window"),e=d.down("form");e.isValid()?(e=e.getValues(),
a.setApiParams(e),d.hide()):a.showError({message:a.localize("invalidForm")})}},{text:a.localize("cancel"),handler:function(a,c){a.findParentByType("window").hide()}}]}));a.optionsWin.show()},validatePositiveNumbersCsv:function(a){a=a.trim();if(0<a.length){if(/[^\d,+ ]/.test(a))return this.localize("numbersCommasOnly");if(/\d\s+\d/.test(a))return this.localize("numbersNeedCommas");a=a.split(/\s*[,+]\s*/);for(var b,c=0,d=a.length;c<d;c++){b=a[c];if(0==b.length)return this.localize("numberEmpty");if(0==
parseInt(b))return this.localize("numberZero")}}return!0}});Ext.define("Voyant.panel.Knots",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.knots",statics:{i18n:{},api:{query:null,stopList:"auto",docId:void 0,audio:!1},glyph:"xf06e@FontAwesome"},config:{corpus:void 0,docTermStore:void 0,tokensStore:void 0,options:{xtype:"stoplistoption"},refreshInterval:100,startAngle:315,angleIncrement:15,currentTerm:void 0},knots:null,termTpl:new Ext.XTemplate('\x3ctpl for\x3d"."\x3e','\x3cdiv class\x3d"term" style\x3d"color: rgb({color});float: left;padding: 3px;margin: 2px;"\x3e{term}\x3c/div\x3e',
"\x3c/tpl\x3e"),termStore:new Ext.data.ArrayStore({fields:["term","color"]}),constructor:function(){var a=this.getBaseUrl()+"resources/knots/";Ext.apply(this,{title:this.localize("title"),html:"\x3caudio src\x3d'"+a+"bone-crack.m4a' preload\x3d'auto'\x3e\x3c/audio\x3e"});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,c){this.setCorpus(c);var d=c.getDocument(0),e=this.processDocument(d);this.knots.setCurrentDoc(e);this.setApiParams({docId:d.getId()});
this.getDocTermStore().getProxy().setExtraParam("corpus",c.getId());this.getTokensStore().setCorpus(c);this.getDocTermStore().load({params:{limit:5,stopList:this.getApiParams("stopList")}})},this);this.on("activate",function(){this.getCorpus()&&Ext.Function.defer(function(){this.getDocTermStore().load({params:{limit:5,stopList:this.getApiParams("stopList")}})},100,this)},this);this.on("query",function(a,c){void 0!==c&&""!=c&&this.getDocTermsFromQuery(c)},this);this.on("documentSelected",function(a,
c){var d=this.getCorpus().getDocument(c);this.setApiParam("docId",d.getId());var e=this.knots.currentDoc.terms,f=[],g;for(g in e)f.push(g);this.setApiParams({query:f});e=f.length;0===e&&(e=5);this.knots.setCurrentDoc(this.processDocument(d));this.getDocTermStore().load({params:{query:f,limit:e,stopList:this.getApiParams("stopList")}})},this);this.on("termsClicked",function(a,c){var d=[];c.forEach(function(a){Ext.isString(a)?d.push(a):a.term?d.push(a.term):a.getTerm&&d.push(a.getTerm())});0<d.length&&
this.getDocTermsFromQuery(d)},this);this.on("corpusTermsClicked",function(a,c){var d=[];c.forEach(function(a){a.getTerm()&&d.push(a.getTerm())});this.getDocTermsFromQuery(d)},this);this.on("documentTermsClicked",function(a,c){var d=[];c.forEach(function(a){a.getTerm()&&d.push(a.getTerm())});this.getDocTermsFromQuery(d)},this)},initComponent:function(){this.setDocTermStore(Ext.create("Ext.data.Store",{model:"Voyant.data.model.DocumentTerm",autoLoad:!1,remoteSort:!1,proxy:{type:"ajax",url:Voyant.application.getTromboneUrl(),
extraParams:{tool:"corpus.DocumentTerms",withDistributions:"raw",withPositions:!0},reader:{type:"json",rootProperty:"documentTerms.terms",totalProperty:"documentTerms.total"},simpleSortMode:!0},listeners:{beforeload:function(a){a.getProxy().setExtraParam("docId",this.getApiParam("docId"))},load:function(a,b,c,d){var e={};b&&0<b.length?(b.forEach(function(a){var b=this.processTerms(a);a.get("docId");a=a.get("term");e[a]=b},this),this.knots.addTerms(e),this.knots.buildGraph()):this.toastInfo({html:this.localize("noTermsFound"),
align:"bl"})},scope:this}}));this.setTokensStore(Ext.create("Voyant.data.store.Tokens",{stripTags:"all",listeners:{beforeload:function(a){a.getProxy().setExtraParam("docId",this.getApiParam("docId"))},load:function(a,b,c,d){var e="",f=this.getCurrentTerm();b.forEach(function(a){e=a.getPosition()==f.tokenId?e+("\x3cstrong\x3e"+a.getTerm()+"\x3c/strong\x3e"):e+a.getTerm()});Ext.Msg.show({title:this.localize("context"),message:e,buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})},scope:this}}));Ext.apply(this,{dockedItems:[{dock:"bottom",
xtype:"toolbar",enableOverflow:!0,items:[{xtype:"querysearchfield"},{text:this.localize("clearTerms"),glyph:"xf00d@FontAwesome",handler:function(){this.down("#termsView").getSelectionModel().deselectAll(!0);this.termStore.removeAll();this.setApiParams({query:null});this.knots.removeAllTerms();this.knots.drawGraph()},scope:this},{xtype:"documentselectorbutton",singleSelect:!0},{xtype:"slider",itemId:"speed",fieldLabel:this.localize("speed"),labelAlign:"right",labelWidth:50,width:100,increment:50,minValue:0,
maxValue:500,value:500-this.getRefreshInterval(),listeners:{changecomplete:function(a,b){this.setRefreshInterval(500-b);this.knots&&this.knots.buildGraph()},scope:this}},{xtype:"slider",itemId:"startAngle",fieldLabel:this.localize("startAngle"),labelAlign:"right",labelWidth:35,width:85,increment:15,minValue:0,maxValue:360,value:this.getStartAngle(),listeners:{changecomplete:function(a,b){this.setStartAngle(b);this.knots&&this.knots.buildGraph()},scope:this}},{xtype:"slider",itemId:"tangles",fieldLabel:this.localize("tangles"),
labelAlign:"right",labelWidth:30,width:80,increment:5,minValue:5,maxValue:90,value:this.getAngleIncrement(),listeners:{changecomplete:function(a,b){this.setAngleIncrement(b);this.knots&&this.knots.buildGraph()},scope:this}},{xtype:"checkbox",boxLabel:this.localize("sound"),listeners:{render:function(a){a.setValue(!0===this.getApiParam("audio")||"true"==this.getApiParam("audio"));Ext.tip.QuickTipManager.register({target:a.getEl(),text:this.localize("soundTip")})},change:function(a,b){this.knots&&this.knots.setAudio(b)},
scope:this}}]}],border:!1,layout:"fit",items:{layout:{type:"vbox",align:"stretch"},defaults:{border:!1},items:[{height:30,itemId:"termsView",xtype:"dataview",store:this.termStore,tpl:this.termTpl,itemSelector:"div.term",overItemCls:"over",selectedItemCls:"selected",selectionModel:{mode:"SIMPLE"},focusCls:"",listeners:{beforeitemclick:function(a,b,c,d,e,f){e.preventDefault();e.stopPropagation();a.fireEvent("itemcontextmenu",a,b,c,d,e,f);return!1},beforecontainerclick:function(){event.preventDefault();
event.stopPropagation();return!1},selectionchange:function(a,b){var c=this.down("#termsView"),d=[];c.getStore().each(function(a){-1!==b.indexOf(a)?(d.push(a.get("term")),Ext.fly(c.getNodeByRecord(a)).removeCls("unselected").addCls("selected")):Ext.fly(c.getNodeByRecord(a)).removeCls("selected").addCls("unselected")});this.knots.termsFilter=d;this.knots.drawGraph()},itemcontextmenu:function(a,b,c,d,e){e.preventDefault();e.stopPropagation();var f=a.isSelected(c);(new Ext.menu.Menu({floating:!0,items:[{text:f?
this.localize("hideTerm"):this.localize("showTerm"),handler:function(){f?a.deselect(d):a.select(d,!0)},scope:this},{text:this.localize("removeTerm"),handler:function(){a.deselect(d);var b=this.termStore.getAt(d).get("term");this.termStore.removeAt(d);a.refresh();this.knots.removeTerm(b);this.knots.drawGraph()},scope:this}]})).showAt(e.getXY())},scope:this}},{flex:1,xtype:"container",autoEl:"div",itemId:"canvasParent",layout:"fit",overflowY:"auto",overflowX:"hidden"}],listeners:{render:function(a){a=
this.down("#canvasParent");this.knots=new Knots({container:a,clickHandler:this.knotClickHandler.bind(this),audio:!0===this.getApiParam("audio")||"true"==this.getApiParam("audio")})},afterlayout:function(a){!1===this.knots.initialized&&this.knots.initializeCanvas()},resize:function(a,b,c){this.knots.doLayout()},scope:this}}});this.callParent(arguments)},updateRefreshInterval:function(a){this.knots&&(50>a?(a=50,this.knots.progressiveDraw=!1):this.knots.progressiveDraw=!0,this.knots.refreshInterval=
a,this.knots.buildGraph(this.knots.drawStep))},updateStartAngle:function(a){this.knots&&(this.knots.startAngle=a,this.knots.recache(),this.knots.buildGraph())},updateAngleIncrement:function(a){this.knots&&(this.knots.angleIncrement=a,this.knots.recache(),this.knots.buildGraph())},loadFromCorpusTerms:function(a){this.knots&&(this.knots.removeAllTerms(),this.termStore.removeAll(!0));a.load({callback:function(a,c,d){var e=[];"string"==typeof e&&(e=[e]);a.forEach(function(a,b){e.push(a.get("term"))},
this);this.getDocTermsFromQuery(e)},scope:this,params:{limit:5,stopList:this.getApiParams("stopList")}})},getDocTermsFromQuery:function(a){a&&this.setApiParam("query",a);this.getCorpus()&&this.isVisible()&&(this.setApiParams({query:a}),this.getDocTermStore().load({params:this.getApiParams()}))},reloadTermsData:function(){var a=[],b;for(b in this.bubblelines.currentTerms)a.push(b);this.getDocTermsFromQuery(a)},filterDocuments:function(){var a=this.getApiParam("docId");""==a&&(a=[],this.getCorpus().getDocuments().each(function(b,
c){a.push(b.getId())}),this.setApiParams({docId:a}));"string"==typeof a&&(a=[a]);if(null==a){this.selectedDocs=this.getCorpus().getDocuments().clone();var b=this.selectedDocs.getCount();if(10<b)for(var c=10;c<b;c++)this.selectedDocs.removeAt(10);a=[];this.selectedDocs.eachKey(function(b,c){a.push(b)},this);this.setApiParams({docId:a})}else this.selectedDocs=this.getCorpus().getDocuments().filterBy(function(b,c){return-1!=a.indexOf(c)},this)},processDocument:function(a){var b=a.getShortTitle(),b=b.replace("\x26hellip;",
"...");return{id:a.getId(),index:a.get("index"),title:b,totalTokens:a.get("tokensCount-lexical"),terms:{},lineLength:void 0}},processTerms:function(a){var b;b=a.get("term");var c=a.get("rawFreq"),d=a.get("positions");if(0<c){var e=this.getApplication().getColorForTerm(b);if(-1===this.termStore.find("term",b)){this.termStore.loadData([[b,e]],!0);var f=this.termStore.find("term",b);this.down("#termsView").select(f,!0)}a=a.get("distributions");b={term:b,positions:d,distributions:a,rawFreq:c,color:e}}else b=
!1;return b},knotClickHandler:function(a){this.setCurrentTerm(a);var b=a.tokenId-10;0>b&&(b=0);this.getTokensStore().load({start:b,limit:21});a=[a].map(function(a){return a.term});this.getApplication().dispatchEvent("termsClicked",this,a)}});Ext.define("Voyant.panel.Phrases",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.phrases",statics:{i18n:{},api:{stopList:"auto",query:void 0,docId:void 0,docIndex:void 0,sort:"length",dir:"desc",minLength:2,maxLength:50,overlapFilter:"length"},glyph:"xf0ce@FontAwesome"},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,c){this.isVisible()&&this.loadFromApis()});a.embedded||
a.corpus&&this.fireEvent("loadedCorpus",this,a.corpus);this.on("corpusTermsClicked",function(a,c){if(this.getStore().getCorpus()){var d=[];c.forEach(function(a){d.push(a.get("term"))});this.setApiParams({query:d,docId:void 0,docIndex:void 0});this.isVisible()&&this.getStore().load({params:this.getApiParams()})}});this.on("activate",function(){this.getStore().getCorpus()&&this.loadFromApis()},this);this.on("query",function(a,c){this.setApiParam("query",c);this.getStore().getProxy().setExtraParam("query",
c);this.loadFromApis()},this)},loadFromApis:function(){this.getStore().getCorpus()&&this.getStore().load({params:this.getApiParams()})},initComponent:function(){var a=Ext.create("Voyant.data.store.CorpusNgramsBuffered",{parentPanel:this});this.on("sortchange",function(a,c,d,e){this.setApiParam("sort",c.dataIndex);this.setApiParam("dir",d);a=this.getApiParams("stopList query docId docIndex sort dir minLength maxLength overlapFilter".split(" "));c=this.getStore().getProxy();for(var f in a)c.setExtraParam(f,
a[f])},this);Ext.apply(this,{title:this.localize("title"),emptyText:this.localize("emptyText"),store:a,selModel:Ext.create("Ext.selection.CheckboxModel",{listeners:{selectionchange:{fn:function(a,c){var d=[];this.getApiParam("context");c.forEach(function(a){d.push('"'+a.getTerm()+'"')});this.getApplication().dispatchEvent("termsClicked",this,d)},scope:this}}}),dockedItems:[{dock:"bottom",xtype:"toolbar",enableOverflow:!0,items:[{xtype:"querysearchfield"},{xtype:"totalpropertystatus"},"-",{text:this.localize("length"),
tooltip:"test",xtype:"label"},{xtype:"slider",minValue:2,values:[2,30],maxValue:30,increment:1,width:75,tooltip:this.localize("lengthTip"),listeners:{render:{fn:function(a){var c=a.getValues();a.setValue(0,parseInt(this.getApiParam("minLength",c[0])));a.setValue(1,parseInt(this.getApiParam("maxLength",c[1])))},scope:this},changecomplete:{fn:function(a,c){var d=a.getValues();this.setApiParam("minLength",parseInt(d[0]));this.setApiParam("maxLength",parseInt(d[1]));this.getStore().load({params:this.getApiParams()})},
scope:this}}},"-",{xtype:"button",text:this.localize("overlap"),tooltip:this.localize("overlapTip"),menu:{items:[{xtype:"menucheckitem",text:this.localize("overlapNone"),group:"overlap",inputValue:"none",checkHandler:function(){this.setApiParam("overlapFilter","none");this.getStore().load({params:this.getApiParams()})},scope:this},{xtype:"menucheckitem",text:this.localize("overlapLength"),group:"overlap",inputValue:"length",checkHandler:function(){this.setApiParam("overlapFilter","length");this.getStore().load({params:this.getApiParams()})},
scope:this},{xtype:"menucheckitem",text:this.localize("overlapFreq"),group:"overlap",inputValue:"rawFreq",checkHandler:function(){this.setApiParam("overlapFilter","rawfreq");this.getStore().load({params:this.getApiParams()})},scope:this}],listeners:{afterrender:{fn:function(a){var c=this.getApiParam("overlapFilter");a.items.each(function(a){a.group&&a.setChecked(a.inputValue==c)},this)},scope:this}}}}]}],columns:[{text:this.localize("term"),dataIndex:"term",tooltip:this.localize("termTip"),sortable:!0,
flex:1},{text:this.localize("rawFreq"),dataIndex:"rawFreq",tooltip:this.localize("termRawFreqTip"),sortable:!0,width:"autoSize"},{text:this.localize("length"),dataIndex:"length",tooltip:this.localize("lengthTip"),sortable:!0,width:"autoSize"},{xtype:"widgetcolumn",text:this.localize("trend"),tooltip:this.localize("trendTip"),width:120,dataIndex:"distributions",widget:{xtype:"sparklineline"}}],listeners:{termsClicked:{fn:function(a,c){if(this.getStore().getCorpus()){var d=[];c.forEach(function(a){Ext.isString(a)?
d.push(a):a.term?d.push(a.term):a.getTerm&&d.push(a.getTerm())});0<d.length&&(this.setApiParams({docIndex:void 0,docId:void 0,query:d}),this.isVisible()&&this.isVisible()&&this.getStore().loadPage(1,{params:this.getApiParams()}))}},scope:this}}});this.callParent(arguments);this.getStore().getProxy().setExtraParam("withDistributions",!0)}});Ext.define("Voyant.panel.CorpusTerms",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.corpusterms",statics:{i18n:{},api:{stopList:"auto",query:void 0,maxBins:100,comparisonCorpus:void 0},glyph:"xf0ce@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"corpusselector",name:"comparisonCorpus",fieldLabel:"comparison corpus"}]},constructor:function(a){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,
arguments)},initComponent:function(){var a=this,b=Ext.create("Voyant.data.store.CorpusTermsBuffered",{parentPanel:this,proxy:{extraParams:{withDistributions:"relative"}}});Ext.apply(a,{title:this.localize("title"),emptyText:this.localize("emptyText"),store:b,selModel:Ext.create("Ext.selection.CheckboxModel",{pruneRemoved:!1,listeners:{selectionchange:{fn:function(a,b){b&&0<b.length&&this.getApplication().dispatchEvent("corpusTermsClicked",this,b)},scope:this}},mode:"SIMPLE"}),dockedItems:[{dock:"bottom",
xtype:"toolbar",enableOverflow:!0,items:[{xtype:"querysearchfield"},{xtype:"totalpropertystatus"}]}],columns:[{xtype:"rownumberer",width:"autoSize",sortable:!1},{text:this.localize("term"),tooltip:this.localize("termTip"),dataIndex:"term",flex:1,sortable:!0},{text:this.localize("rawFreq"),tooltip:this.localize("rawFreqTip"),dataIndex:"rawFreq",width:"autoSize",sortable:!0},{text:this.localize("relativeFreq"),tooltip:this.localize("relativeFreqTip"),dataIndex:"relativeFreq",renderer:function(a){return Ext.util.Format.number(1E6*
a,"0,000")},width:"autoSize",hidden:!0,sortable:!0},{text:this.localize("relativePeakedness"),tooltip:this.localize("relativePeakednessTip"),dataIndex:"relativePeakedness",renderer:Ext.util.Format.numberRenderer("0,000.0"),width:"autoSize",hidden:!0,sortable:!0},{text:this.localize("relativeSkewness"),tooltip:this.localize("relativeSkewnessTip"),dataIndex:"relativeSkewness",renderer:Ext.util.Format.numberRenderer("0,000.0"),width:"autoSize",hidden:!0,sortable:!0},{text:this.localize("corpusComparisonDifference"),
tooltip:this.localize("corpusComparisonDifferenceTip"),dataIndex:"relativeSkewness",renderer:Ext.util.Format.numberRenderer("0,000.0"),width:"autoSize",hidden:!this.getApiParam("comparisonCorpus"),sortable:!0,listeners:{show:function(b,d,e){a.getApiParam("comparisonCorpus")||a.showError(a.localize("noCorpusComparison"))}}},{xtype:"widgetcolumn",text:this.localize("trend"),tooltip:this.localize("trendTip"),flex:1,dataIndex:"distributions",widget:{xtype:"sparklineline",tipTpl:new Ext.XTemplate("{[this.getDocumentTitle(values.x,values.y)]}",
{getDocumentTitle:function(a,b){return this.panel.store.getCorpus().getDocument(a).getTitle()+"\x3cbr\x3erelative frequency: "+Ext.util.Format.number(1E6*b,"0,000")},panel:a})}}]});a.on("loadedCorpus",function(a,b){100<b.getDocumentsCount()&&this.getStore().getProxy().setExtraParam("bins",this.getApiParam("maxBins"));this.getStore().load()},a);a.on("query",function(a,b){this.setApiParam("query",b);this.getStore().removeAll();this.getStore().load()},a);a.callParent(arguments)}});Ext.define("Voyant.panel.DocumentTerms",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],requires:["Voyant.data.store.DocumentTerms"],alias:"widget.documentterms",config:{corpus:void 0,options:{xtype:"stoplistoption"}},statics:{i18n:{},api:{stopList:"auto",query:void 0,docId:void 0,docIndex:void 0,bins:10},glyph:"xf0ce@FontAwesome"},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,b){var e=
this.getStore();e.setCorpus(b);e.load()});if(a.embedded){window.console&&console.warn(a.embedded.then);var b=Ext.getClass(a.embedded).getName();"Voyant.data.store.DocumentTerms"!=b&&"Voyant.data.model.Document"!=b||this.fireEvent("loadedCorpus",this,a.embedded.getCorpus())}else a.corpus&&this.fireEvent("loadedCorpus",this,a.corpus);this.on("query",function(a,b){this.fireEvent("corpusTermsClicked",a,b)},this);this.on("corpusTermsClicked",function(a,b){if(this.getStore().getCorpus()){var e=[];b.forEach(function(a){e.push(Ext.isString(a)?
a:a.get("term"))});this.setApiParams({query:e,docId:void 0,docIndex:void 0});this.isVisible()&&this.getStore().load({params:this.getApiParams()})}});this.on("documentsClicked",function(a,b){var e=[];b.forEach(function(a){e.push(a.get("id"))});this.setApiParams({docId:e,query:void 0});this.isVisible()&&this.getStore().load({params:this.getApiParams()})});this.on("activate",function(){this.getStore().getCorpus()&&this.getStore().load({params:this.getApiParams()})},this)},initComponent:function(){var a=
Ext.create("Voyant.data.store.DocumentTermsBuffered",{parentPanel:this});Ext.apply(this,{title:this.localize("title"),emptyText:this.localize("emptyText"),store:a,selModel:Ext.create("Ext.selection.CheckboxModel",{listeners:{selectionchange:{fn:function(a,c){this.getApplication().dispatchEvent("documentTermsClicked",this,c)},scope:this}},pruneRemoved:!1,mode:"SIMPLE"}),dockedItems:[{dock:"bottom",xtype:"toolbar",enableOverflow:!0,items:[{xtype:"querysearchfield"},{xtype:"totalpropertystatus"}]}],
columns:[{text:"#",width:30,dataIndex:"docIndex",sortable:!0,renderer:function(a){return a+1}},{text:this.localize("term"),dataIndex:"term",tooltip:this.localize("termTip"),sortable:!0,flex:1},{text:this.localize("rawFreq"),dataIndex:"rawFreq",tooltip:this.localize("rawFreqTip"),width:"autoSize",sortable:!0},{text:this.localize("relativeFreq"),tooltip:this.localize("relativeFreqTip"),dataIndex:"relativeFreq",width:"autoSize",sortable:!0,renderer:Ext.util.Format.numberRenderer("0,000")},{text:this.localize("tfidf"),
tooltip:this.localize("tfidfTip"),dataIndex:"tfidf",width:"autoSize",sortable:!0,hidden:!0,renderer:Ext.util.Format.numberRenderer("0,000.000")},{text:this.localize("zscore"),tooltip:this.localize("zscoreTip"),dataIndex:"zscore",width:"autoSize",sortable:!0,hidden:!0,renderer:Ext.util.Format.numberRenderer("0,000.000")},{xtype:"widgetcolumn",text:this.localize("trend"),tooltip:this.localize("trendTip"),flex:1,dataIndex:"distributions",widget:{xtype:"sparklineline"}}],listeners:{termsClicked:{fn:function(a,
c){if(this.getStore().getCorpus()){var d=[];c.forEach(function(a){Ext.isString(a)?d.push(a):a.term?d.push(a.term):a.getTerm&&d.push(a.getTerm())});0<d.length&&(this.setApiParams({docIndex:void 0,docId:void 0,query:d}),this.isVisible()&&this.isVisible()&&this.getStore().load({params:this.getApiParams()}))}},scope:this}}});this.callParent(arguments);this.getStore().getProxy().setExtraParam("withDistributions",!0)}});Ext.define("Voyant.panel.Documents",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.documents",isConsumptive:!0,statics:{i18n:{},api:{query:void 0,docIndex:void 0,docId:void 0},glyph:"xf0ce@FontAwesome"},MODE_EDITING:"editing",MODE_NORMAL:"normal",config:{mode:this.MODE_NORMAL},constructor:function(a){var b=Ext.create("Voyant.data.store.Documents",{selModel:{pruneRemoved:!1}}),c=[{xtype:"querysearchfield"},{xtype:"totalpropertystatus"}];a&&a.mode==this.MODE_EDITING||c.push({text:this.localize("modify"),
tooltip:this.localize("modifyTip"),glyph:"xf044@FontAwesome",scope:this,itemId:"modifyButton",handler:function(a){Ext.create("Ext.window.Window",{title:this.localize("title"),modal:!0,width:"80%",minWidth:300,minHeight:200,height:"80%",layout:"fit",frame:!0,border:!0,items:{xtype:"documents",mode:this.MODE_EDITING,corpus:this.getStore().getCorpus(),header:!1,viewConfig:{plugins:{ptype:"gridviewdragdrop"},listeners:{beforedrop:function(a,b,c,d,k){return this.getStore().getCount()<this.getStore().getCorpus().getDocumentsCount()?
(a=this.up("panel"),Ext.Msg.show({title:a.localize("error"),message:a.localize("reorderFilteredError"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR}),!1):!0}}}},buttons:[{text:this.localize("add"),tooltip:this.localize("addTip"),glyph:"xf067@FontAwesome",handler:function(a){a.up("window").close();Ext.create("Ext.window.Window",{header:!1,modal:!0,layout:"fit",items:{xtype:"corpuscreator",corpus:this.getStore().getCorpus()}}).show()},scope:this},{text:this.localize("remove"),tooltip:this.localize("removeTip"),
glyph:"xf05e@FontAwesome",hidden:1==this.getStore().getCorpus().getDocumentsCount(),handler:this.keepRemoveReorderHandler,itemId:"remove",scope:this},{text:this.localize("keep"),tooltip:this.localize("keepTip"),glyph:"xf00c@FontAwesome",hidden:1==this.getStore().getCorpus().getDocumentsCount(),handler:this.keepRemoveReorderHandler,itemId:"keep",scope:this},{text:this.localize("reorder"),tooltip:this.localize("reorderTip"),glyph:"xf0dc@FontAwesome",hidden:1==this.getStore().getCorpus().getDocumentsCount(),
handler:this.keepRemoveReorderHandler,itemId:"reorder",scope:this},{text:"Cancel",glyph:"xf00d@FontAwesome",handler:function(a){a.up("window").close()}}]}).show()}});Ext.apply(this,{title:this.localize("title"),emptyText:this.localize("emptyText"),columns:[{xtype:"rownumberer",renderer:function(a,b,c){return c.getIndex()+1},sortable:!1},{text:this.localize("documentTitle"),dataIndex:"title",sortable:!0,renderer:function(a,b,c){return c.getTitle()},flex:3},{text:this.localize("documentAuthor"),dataIndex:"author",
sortable:!0,hidden:!0,renderer:function(a,b,c){return c.getAuthor()},flex:2},{text:this.localize("tokensCountLexical"),dataIndex:"tokensCount-lexical",renderer:Ext.util.Format.numberRenderer("0,000"),sortable:!0,width:"autoSize"},{text:this.localize("typesCountLexical"),dataIndex:"typesCount-lexical",renderer:Ext.util.Format.numberRenderer("0,000"),width:"autoSize"},{text:this.localize("typeTokenRatioLexical"),dataIndex:"typeTokenRatio-lexical",renderer:function(a){return Ext.util.Format.percent(a)},
width:"autoSize"},{text:this.localize("language"),dataIndex:"language",hidden:!0,renderer:function(a,b,c,g,h,k,m){return m.ownerCt.getLanguage(a)},width:"autoSize"}],store:b,selModel:Ext.create("Ext.selection.RowModel",{mode:"MULTI",listeners:{selectionchange:{fn:function(a,b){this.getApplication().dispatchEvent("documentsClicked",this,b,this.getStore().getCorpus())},scope:this}}}),dockedItems:[{dock:"bottom",xtype:"toolbar",enableOverflow:!0,items:c}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,
arguments);this.on("loadedCorpus",function(a,b){this.store.setCorpus(b);this.store.load({params:this.getApiParams()});"NONCONSUMPTIVE"==b.getNoPasswordAccess()&&this.queryById("modifyButton").hide()});this.on("query",function(a,b){this.setApiParam("query",b);this.store.load({params:this.getApiParams()})});a.embedded&&("Voyant.data.model.Corpus"==Ext.getClass(a.embedded).getName()?a.corpus=a.embedded:"Voyant.data.store.Documents"==Ext.getClass(a.embedded).getName()&&(this.store.setRecords(a.embedded.getData()),
a.corpus=a.embedded.getCorpus()));a.corpus&&this.fireEvent("loadedCorpus",this,a.corpus)},keepRemoveReorderHandler:function(a){var b=a.up("window").down("documents"),c=b.getSelection(),d=b.getStore().getCorpus().getDocumentsCount(),e=a.getItemId();if("reorder"==e){if(b.getStore().getCount()<d)return Ext.Msg.show({title:this.localize("error"),message:this.localize("reorderFilteredError"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR});docIndex=[];b.getStore().each(function(a){docIndex.push(a.getIndex())},
this);for(a=1;a<docIndex.length;a++)if(docIndex[a-1]>docIndex[a])return Ext.Msg.confirm(b.localize("newCorpus"),(new Ext.Template(b.localize(e+"Documents"))).applyTemplate([c.length]),function(a){"yes"===a&&(docIndex=[],this.getStore().each(function(a){docIndex.push(a.getIndex())},this),a={docIndex:docIndex},a[e+"Documents"]=!0,this.editCorpus(a))},b);return Ext.Msg.show({title:this.localize("error"),message:this.localize("reorderOriginalError"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}return 0<c.length?
c.length==d?1==d?Ext.Msg.show({title:this.localize("error"),message:this.localize("onlyOneError"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR}):Ext.Msg.show({title:this.localize("error"),message:this.localize("allSelectedError"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR}):Ext.Msg.confirm(this.localize("newCorpus"),(new Ext.Template(this.localize(e+"SelectedDocuments"))).applyTemplate([c.length]),function(a){"yes"===a&&(docIndex=[],c.forEach(function(a){docIndex.push(a.getIndex())}),a={docIndex:docIndex},a[e+
"Documents"]=!0,this.editCorpus(a))},b):b.getApiParam("query")&&b.getStore().getCount()<d?Ext.Msg.confirm(this.localize("newCorpus"),(new Ext.Template(this.localize(e+"FilteredDocuments"))).applyTemplate([c.length]),function(a){"yes"===a&&(docIndex=[],this.getStore().each(function(a){docIndex.push(a.getIndex())},this),a={docIndex:docIndex},a[e+"Documents"]=!0,this.editCorpus(a))},b):Ext.Msg.show({title:this.localize("error"),message:this.localize("selectOrFilterError"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})},
editCorpus:function(a){Ext.apply(a,{tool:"corpus.CorpusManager",corpus:this.getStore().getCorpus().getId()});var b=this.getApplication(),c=b.getViewport();c.mask(this.localize("Creating new corpus\u2026"));Ext.Ajax.request({url:this.getApplication().getTromboneUrl(),method:"POST",params:a,success:function(a){c.unmask();a=Ext.decode(a.responseText);b.openUrl(b.getBaseUrl()+"?corpus\x3d"+a.corpus.id)}});(a=this.up("window"))&&a.isFloating()&&a.close()}});Ext.define("Voyant.panel.DocumentsFinder",{extend:"Ext.grid.Panel",require:["Voyant.data.store.DocumentQueryMatches","Ext.grid.plugin.CellEditing"],mixins:["Voyant.panel.Panel"],alias:"widget.documentsfinder",statics:{i18n:{}},config:{corpus:void 0},constructor:function(a){this.cellEditing=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1});this.cellEditing.on("edit",this.onEditComplete,this);var b=this;Ext.apply(this,{title:this.localize("title"),emptyText:this.localize("emptyText"),plugins:[this.cellEditing],
bbar:[{text:this.localize("addRow"),glyph:"xf055@FontAwesome",handler:this.addRow,scope:this},{text:this.localize("exportNewCorpus"),disabled:!0,glyph:"xf08e@FontAwesome",tooltip:this.localize("exportNewCorpusTip"),handler:function(){var a=this.getQueryFromStore();a?(this.setLoading(!0),this.getCorpus().getDocumentQueryMatches().load({params:{query:a,createNewCorpus:!0},callback:function(a,b,c){this.setLoading(!1);c?(a=b.getProxy().getReader().rawData.documentsFinder.corpus,a=this.getBaseUrl()+"?corpus\x3d"+
a,Ext.Msg.alert({title:this.localize("title"),message:"\x3ca href\x3d'"+a+"' target\x3d'_blank'\x3eNew Corpus\x3c/a\x3e"})):Ext.create("Voyant.util.ResponseError",{msg:this.localize("unsuccessfulQuery"),response:b.getError().response}).show()},scope:this})):Ext.Msg.alert({title:this.localize("title"),message:this.localize("noMatches")})},scope:this,cls:"exportBtn"},{xtype:"tbtext",name:"status",cls:"status"}],columns:[{text:this.localize("query"),dataIndex:"query",renderer:function(a){return Ext.isEmpty(a)?
'\x3cspan class\x3d"placeholder"\x3e'+b.localize("emptyQuery")+"\x3c/span\x3e":a},editor:!0,minWidth:150,maxWidth:300},{text:this.localize("field"),dataIndex:"field",editor:{xtype:"combo",typeAhead:!0,triggerAction:"all",forceSelection:!0,value:"",valueField:"value",listeners:{change:function(){Ext.isEmpty(this.getValue())&&this.reset()}},store:new Ext.data.Store({fields:["text","value"],data:[[this.localize("textField"),"text"],[this.localize("advancedField"),"advanced"]]})},width:150,renderer:function(a){return Ext.isEmpty(a)?
"":b.localize(a+"Field")}},{text:this.localize("operator"),dataIndex:"operator",editor:{xtype:"combo",forceSelection:!0,store:new Ext.data.Store({autoDestroy:!0,fields:["text","value"],displayField:"text",valueField:"value",data:[{text:"AND",value:"+"},{text:"OR",value:""}]})},minWidth:75,maxWidth:75},{text:this.localize("count"),dataIndex:"count",renderer:function(a,b,e){return Ext.isEmpty(e.get("query"))?"":Ext.util.Format.number(a,"0,000")},minWidth:100,maxWidth:100},{xtype:"actioncolumn",width:25,
sortable:!1,menuDisabled:!0,width:25,getGlyph:"xf014@FontAwesome",tooltip:this.localize("deleteQueryTip"),menuDisabled:!0,sortable:!1,handler:this.removeRow,scope:this}],store:new Ext.data.Store({autoDestroy:!0,fields:["id","operator","field","query","count"],data:[["","","","",0]]})});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,b){this.setCorpus(b);var e=b.getDocuments();if(e&&0<e.getCount()){var f=e.getDocument(0),
g=[];["title","author","pubDate","publisher","pubPlace"].forEach(function(a){Ext.isEmpty(f.get(a))||g.push([this.localize(a+"Field"),a])},this);g&&(e=this.getColumnManager().getHeaderByDataIndex("field").getEditor(),e.getStore().each(function(a){g.push([a.get("text"),a.get("value")])},this),e.setStore(Ext.create("Ext.data.Store",{fields:["text","value"],data:g})));this.updateStatus(0);this.setLoading(!1)}})},removeRow:function(a,b){this.getStore().removeAt(b);0==this.getStore().getCount()&&this.addRow();
this.updateAggregate()},addRow:function(){this.store.loadData([["","","","",0]],!0)},onEditComplete:function(a,b){var c=this.getQueryFromRecord(b.record);if(Ext.isEmpty(c))b.record.set("count",""),this.updateAggregate();else{var d=b.view.getCell(b.record,this.getColumnManager().getHeaderByDataIndex("count"));d.mask("loading");this.getCorpus().getDocumentQueryMatches().load({params:{query:c},callback:function(a,c,g){d.unmask();g?b.record.set("count",0==a.length?0:a[0].get("count")):(Ext.create("Voyant.util.ResponseError",
{msg:this.localize("unsuccessfulQuery"),response:c.getError().response}).show(),b.record.set("count",0));this.updateAggregate()},scope:this})}},getQueryFromRecord:function(a){if(Ext.isEmpty(a)||Ext.isEmpty(a.get("query")))return"";var b=a.get("query").trim();if(Ext.isEmpty(b))return"";a=a.get("field");return Ext.isEmpty(a?a.trim():a)?b:a+":"+b},getQueryFromStore:function(){var a="";this.getStore().each(function(b){var c=this.getQueryFromRecord(b);Ext.isEmpty(c)||(Ext.isEmpty(a)||(b=b.get("operator"),
a+="AND"==b?" + ":" | "),a+=c)},this);console.warn(a);return a},updateAggregate:function(){var a=this.getStore().sum("count");a&&"string"!=typeof a?1==a?(a=this.getStore().getAt(0).get("count"),this.updateStatus(this.getStore().getAt(0).get("count"))):(a=this.getQueryFromStore(),Ext.isEmpty(a)||(this.status||(this.status=this.down("[cls~\x3dstatus]")),this.status.mask(this.localize("loading")),this.getCorpus().getDocumentQueryMatches().load({params:{query:a},callback:function(a,c,d){this.status.unmask();
d?this.updateStatus(a[0].get("count")):(Ext.create("Voyant.util.ResponseError",{msg:this.localize("unsuccessfulQuery"),response:c.getError().response}).show(),this.updateStatus(0))},scope:this}))):this.updateStatus(0)},updateStatus:function(a){this.status||(this.status=this.down("[cls~\x3dstatus]"));this.exportBtn||(this.exportBtn=this.down("[cls~\x3dexportBtn]"));0==a?this.status.update((new Ext.XTemplate(this.localize("noMatches"))).apply([this.getCorpus().getDocumentsCount()])):this.status.update((new Ext.XTemplate(this.localize("queryMatches"))).apply([a,
this.getCorpus().getDocumentsCount()]));this.exportBtn.setDisabled(0==a)}});Ext.define("Voyant.panel.Dummy",{extend:"Ext.Panel",xtype:"dummy",autoScroll:!0,initComponent:function(){Ext.apply(this,{layout:{type:"table",columns:3,tableAttrs:{style:{width:"100%",height:"100%"}},tdAttrs:{style:{padding:"0px",verticalAlign:"top"}}},defaults:{width:10,height:10,border:!0},items:[{colspan:2,xtype:"summary"},{xtype:"reader",rowspan:2},{xtype:"documentterms"},{xtype:"corpusterms"}]});this.on("boxready",function(){this.body.setStyle("overflow","hidden");for(var a={},b=this.getTargetEl().down(".x-table-layout").dom.rows,
c=0;c<b.length;c++)for(var d=b[c].cells,e=0;e<d.length;e++){var f=Ext.get(d[e]),g=f.getSize(!1),f=f.down(".x-panel").id;a[f]=g}for(var h in a)g=a[h],Ext.getCmp(h).setSize(g);this.updateLayout()});this.on("resize",function(a,b,c,d,e){if(void 0!==d&&void 0!==e){a=b/d;c/=e;e={};b=this.getTargetEl().down(".x-table-layout").dom.rows;for(d=0;d<b.length;d++)for(var f=b[d].cells,g=0;g<f.length;g++){var h=Ext.get(f[g]).down(".x-panel"),k=h.getSize(!1);e[h.id]={width:Math.floor(k.width*a),height:Math.floor(k.height*
c)}}for(var m in e)k=e[m],Ext.getCmp(m).setSize(k);this.updateLayout()}});this.callParent()}});Ext.define("Voyant.panel.RezoViz",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.rezoviz",statics:{i18n:{},api:{query:void 0,limit:25,stopList:"auto",type:["organization","location","person"],minEdgeCount:2},glyph:"xf1cb@FontAwesome"},config:{corpus:void 0,network:void 0,nodesStore:void 0,nodesDataSet:void 0,edgesDataSet:void 0,isNetworkBounded:!0},categorizedNodeOptions:{location:{font:{color:"green"}},person:{font:{color:"maroon"}},organization:{font:{color:"purple"}}},nodeOptions:{shape:"box",
color:{border:"rgba(0,0,0,0.1)",background:"rgba(255,255,255,1)"},scaling:{label:{min:8,max:20}}},edgeOptions:{color:{color:"rgba(0,0,0,0.1)",highlight:"black",hover:"red"},labelHighlightBold:!1},highlightOptions:{font:{color:"white"},color:{background:"black"}},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){this.setNodesStore(Ext.create("Ext.data.Store",{fields:["id","term","type","rawFreq"],sortOnLoad:!0,
sorters:"term"}));Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",enableOverflow:!0,items:[{xtype:"combo",queryMode:"local",valueField:"term",displayField:"term",store:this.getNodesStore(),listeners:{select:function(a,b){this.getNetwork().selectNodes([b.get("id")])},scope:this}},{xtype:"button",text:this.localize("categories"),menu:{items:[{xtype:"menucheckitem",text:this.localize("people"),itemId:"person",checked:!0},{xtype:"menucheckitem",text:this.localize("locations"),
itemId:"location",checked:!0},{xtype:"menucheckitem",text:this.localize("organizations"),itemId:"organization",checked:!0},{xtype:"button",text:this.localize("reload"),style:"margin: 5px;",handler:this.categoriesHandler,scope:this}]}},{xtype:"numberfield",itemId:"minEdgeCount",fieldLabel:this.localize("minEdgeCount"),labelAlign:"right",labelWidth:120,width:170,maxValue:10,minValue:1,allowDecimals:!1,allowExponential:!1,allowOnlyWhitespace:!1,listeners:{render:function(a){a.setRawValue(this.getApiParam("minEdgeCount"))},
change:function(a,b){a.isValid()&&(this.setApiParam("minEdgeCount",b),this.getEntities())},scope:this}},{xtype:"tbseparator"},{xtype:"slider",fieldLabel:this.localize("repulsion"),labelAlign:"right",labelWidth:70,width:150,value:100,increment:10,minValue:0,maxValue:500,listeners:{changecomplete:function(a,b){this.getNetwork().physics.options.repulsion.nodeDistance=b;this.getNetwork().startSimulation()},scope:this}},{xtype:"slider",fieldLabel:this.localize("stiffness"),labelAlign:"right",labelWidth:70,
width:150,value:4,increment:1,minValue:0,maxValue:10,listeners:{changecomplete:function(a,b){b/=100;this.getNetwork().physics.options.repulsion.springConstant=b;this.getNetwork().startSimulation()},scope:this}},{xtype:"slider",fieldLabel:this.localize("friction"),labelAlign:"right",labelWidth:55,width:150,value:9,increment:10,minValue:0,maxValue:100,listeners:{changecomplete:function(a,b){b/=100;this.getNetwork().physics.options.repulsion.damping=b;this.getNetwork().startSimulation()},scope:this}}]}]});
this.on("loadedCorpus",function(a,b){this.setCorpus(b);1==b.getDocumentsCount()&&this.setApiParam("minEdgeCount",1);this.getEntities()},this);this.on("resize",function(a,b,c){},this);this.callParent(arguments)},getEntities:function(){var a=this.getCorpus().getId(),b=this.getLayout().getRenderTarget();b.mask(this.localize("loadingEntities"));Ext.Ajax.request({url:this.getApplication().getTromboneUrl(),method:"POST",params:{tool:"corpus.EntityCollocationsGraph",type:this.getApiParam("type"),limit:this.getApiParam("limit"),
minEdgeCount:this.getApiParam("minEdgeCount"),corpus:a},success:function(a){b.unmask();a=Ext.decode(a.responseText);0==a.entityCollocationsGraph.edges.length?(this.showError({msg:this.localize("noEntities")}),Ext.Msg.confirm(this.localize("error"),this.localize("noEntitiesForEdgeCount"),function(a){"yes"===a&&(a=Math.max(1,this.getApiParam("minEdgeCount")-1),this.queryById("minEdgeCount").setRawValue(a),this.setApiParam("minEdgeCount",a),this.getEntities())},this)):(this.processEntities(a.entityCollocationsGraph),
this.initGraph())},scope:this})},processEntities:function(a){var b=a.nodes;a=a.edges;for(var c=d3.extent(b,function(a){return a.rawFreq}),d=c[0],c=c[1],e=d3.scale.linear().domain([d,c]).range([10,24]),d=[],c=0;c<b.length;c++){var f=b[c];f.id=c;d.push({id:c,label:f.term,value:b[c].rawFreq,font:{size:e(f.rawFreq),color:this.categorizedNodeOptions[f.type].font.color},type:f.type,rawFreq:f.rawFreq,title:f.term+(f.rawFreq?" ("+f.rawFreq+")":"")})}this.getNodesStore().loadData(b);b=[];for(c=0;c<a.length;c++)e=
a[c].nodes,b.push({from:e[0],to:e[1],title:a[c].count,value:200*a[c].count});this.setNodesDataSet(new vis.DataSet(d));this.setEdgesDataSet(new vis.DataSet(b))},initGraph:function(){var a=this.getLayout().getRenderTarget();a.update("");a.setWidth(a.getWidth());a.setHeight(a.getHeight());var b={interaction:{hover:!0,hoverConnectedEdges:!0,multiselect:!1},physics:{solver:"repulsion",repulsion:{centralGravity:.1}},nodes:this.nodeOptions,edges:this.edgeOptions},c=new vis.Network(a.dom,{nodes:this.getNodesDataSet(),
edges:this.getEdgesDataSet()},b);if(this.getIsNetworkBounded())c.on("beforeDrawing",function(a){var b=this.getLayout().getRenderTarget();a=b.getWidth();var b=b.getHeight(),f=c.getPositions(),g;for(g in f){var h=c.canvasToDOM(f[g]),k=Math.max(0,Math.min(a,h.x)),h=Math.max(0,Math.min(b,h.y)),k=c.DOMtoCanvas({x:k,y:h});c.body.nodes[g].x=k.x;c.body.nodes[g].y=k.y}}.bind(this));c.on("selectNode",function(a){this.doNodeSelect(a.nodes[0])}.bind(this));c.on("deselectNode",function(a){c.unselectAll();a=a.nodes[0];
void 0!==a&&setTimeout(this.doNodeSelect.bind(this),5,a)}.bind(this));c.on("selectEdge",function(a){c.unselectAll()});this.setNetwork(c)},doNodeSelect:function(a){var b=this.getNodesDataSet().get(a).label;this.dispatchEvent("termsClicked",this,[b]);var b=this.getNetwork(),c=b.getConnectedNodes(a);c.push(a);a=b.getConnectedEdges(a);b.unselectAll();for(var d=0;d<c.length;d++)b.selectionHandler.selectObject(b.body.nodes[c[d]],!1);for(d=0;d<a.length;d++)b.selectionHandler.selectObject(b.body.edges[a[d]],
!1);b.redraw()},categoriesHandler:function(a){var b=[];a.up("menu").items.each(function(a){a.checked&&b.push(a.itemId)});this.setApiParam("type",b);this.getEntities()},map:function(a,b,c,d,e){return d+(a-b)/(c-b)*(e-d)}});Ext.define("Voyant.panel.MicroSearch",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.microsearch",statics:{i18n:{},api:{stopList:"auto",query:void 0},glyph:"xf1ea@FontAwesome"},config:{corpus:void 0,options:{xtype:"stoplistoption"},maxTokens:0,tokensPerSegment:0,maxVerticalLines:0,maxSegments:0},constructor:function(a){Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",enableOverflow:!0,items:[{xtype:"querysearchfield"}]}]});this.callParent(arguments);
this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,c){this.setCorpus(c);if(this.rendered)this.initialize();else this.on("afterrender",function(){this.initialize()},this)});this.on("query",function(a,c){this.setApiParam("query",c);this.updateSearchResults()})},initialize:function(){var a=this.getTargetEl(),b=this.getCorpus();this.setMaxVerticalLines(Math.floor((a.getHeight()-10)/5));var c=b.getDocumentsCount(),d=10*c,e=Math.floor((a.getWidth()-d-10)/
c);200<e&&(e=200);d=Math.floor(e/3);1>d&&(d=1);this.setMaxSegments(d*this.getMaxVerticalLines());b=b.getDocuments();this.setMaxTokens(b.max("tokensCount-lexical"));this.setTokensPerSegment(this.getMaxTokens()<this.getMaxSegments()?1:Math.ceil(this.getMaxTokens()/this.getMaxSegments()));var f="\x3ctable cellpadding\x3d'0' cellspacing\x3d'0' style\x3d'height: 100%'\x3e\x3ctr\x3e";this.segments=[];b.each(function(b){docIndex=b.getIndex();f+='\x3ctd style\x3d"overflow: hidden; vertical-align: top; width: '+
e+'px;"\x3e\x3cdiv class\x3d"docLabel" style\x3d"white-space: nowrap; width: '+e+'px;" data-qtip\x3d"'+b.getFullLabel()+'"\x3e'+b.getFullLabel()+'\x3c/div\x3e\x3ccanvas style\x3d"display: block;" width\x3d"'+e+'" height\x3d"'+a.getHeight()+'" id\x3d"'+this.body.id+"-"+docIndex+'"\x3e\x3c/td\x3e';docIndex+1<c&&(f+='\x3ctd style\x3d"width: 10px;"\x3e\x26nbsp;\x3c/td\x3e')},this);f+="\x3c/tr\x3e\x3c/table\x3e";a.update(f);this.updateSearchResults();if(!this.getApiParam("query")){var g=this;return this.getCorpus().loadCorpusTerms({limit:1,
stopList:this.getApiParam("stopList")}).then(function(a){a=a.getAt(0).getTerm();g.down("querysearchfield").addValue(new Voyant.data.model.CorpusTerm({term:a}));g.fireEvent("query",g,[a])})}},updateSearchResults:function(){query=this.getApiParam("query");0==Ext.Array.from(query).length?this.getCorpus().getDocuments().each(function(a){var b=this.redistributeDistributions(a,Array(this.getMaxSegments()));this.drawDocumentDistributions(a,b)},this):(this.mask(this.localize("loading")),this.getCorpus().getDocumentTerms().load({params:{query:Ext.Array.from(query).join("|"),
withDistributions:"relative",bins:this.getMaxSegments()},callback:function(a,b,c){this.unmask();var d=0,e=Number.MAX_VALUE,f=[],g;a.forEach(function(a){var b=this.getCorpus().getDocument(a.getDocIndex()),c=this.redistributeDistributions(b,a.getDistributions());g=Ext.Array.max(c);g>d&&(d=g);c.forEach(function(a){a&&a<e&&(e=a)});f[a.getDocIndex()]=this.redistributeDistributions(b,a.getDistributions())},this);f.forEach(function(a,b){this.drawDocumentDistributions(this.getCorpus().getDocument(b),a,e||
Ext.Array.min(a),d||Ext.Array.max(a))},this)},scope:this}))},redistributeDistributions:function(a,b){var c=Math.ceil(a.getLexicalTokensCount()/this.getTokensPerSegment());if(b.length>c){for(var d=[],e=0;e<b.length;e++){var f=parseInt(e*c/b.length);d[f]?d[f].push(b[e]):d[f]=[b[e]]}b=d;for(e=0;e<b.length;e++)b[e]=Ext.Array.mean(b[e])}return b},drawDocumentDistributions:function(a,b,c,d){var e=this.getTargetEl().dom.querySelector("#"+this.body.id+"-"+a.getIndex());a=e.getContext("2d");for(var f=0,e=
e.clientWidth,g=0,h=0;h<b.length;h++)a.fillStyle=b[h]?"rgba(250,0,0,"+(.8*(b[h]-c)/(d-c)+.2)+")":"rgb(230,230,230)",a.fillRect(f,g,3,3),f+=3,f>=e&&(f=0,g+=5)}});Ext.define("Voyant.panel.Mandala",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.mandala",statics:{i18n:{},api:{stopList:"auto",query:void 0,labels:!0},glyph:"xf1db@FontAwesome"},gutter:5,textFont:"12px sans-serif",config:{corpus:void 0,options:[{xtype:"stoplistoption"}]},constructor:function(){this.mixins["Voyant.util.Localization"].constructor.apply(this,arguments);Ext.apply(this,{title:this.localize("title"),html:'\x3cdiv style\x3d"text-align: center"\x3e\x3ccanvas width\x3d"800" height\x3d"600"\x3e\x3c/canvas\x3e\x3c/div\x3e',
dockedItems:[{dock:"bottom",xtype:"toolbar",enableOverflow:!0,items:[{text:this.localize("add"),glyph:"xf067@FontAwesome",handler:function(){this.editMagnet()},scope:this},{text:this.localize("clear"),glyph:"xf014@FontAwesome",handler:function(){this.setApiParam("query",void 0);this.updateFromQueries(!0);this.editMagnet()},scope:this},{xtype:"checkbox",boxLabel:this.localize("labels"),listeners:{render:function(a){a.setValue(!0===this.getApiParam("labels"));Ext.tip.QuickTipManager.register({target:a.getEl(),
text:this.localize("labelsTip")})},change:function(a,b){this.setApiParam("labels",b);this.draw()},scope:this}}]}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("boxready",function(a){var b=this.getTargetEl().dom.querySelector("canvas"),c=this;b.addEventListener("mousemove",function(a){var e=b.getBoundingClientRect(),f=a.clientX-e.left,g=a.clientY-e.top,h=!1,k=parseInt(c.textFont)/2;c.documents&&c.documents.forEach(function(a){var b=f>a.x-
k&&f<a.x+k&&g>a.y-k&&g<a.y+k;b!=a.isHovering&&(h=!0);a.isHovering=b});radius=parseInt(c.textFont)/2;for(term in c.magnets)a=f>c.magnets[term].x-radius&&f<c.magnets[term].x+radius&&g>c.magnets[term].y-radius&&g<c.magnets[term].y+radius,a!=c.magnets[term].isHovering&&(h=!0),c.magnets[term].isHovering=a;h&&c.draw()},!1);b.addEventListener("click",function(a){var e=b.getBoundingClientRect(),f=a.clientX-e.left;a=a.clientY-e.top;parseInt(c.textFont);for(term in c.magnets)f>c.magnets[term].x-radius&&f<c.magnets[term].x+
radius&&a>c.magnets[term].y-radius&&a<c.magnets[term].y+radius&&c.editMagnet(term)},!1)});this.on("loadedCorpus",function(a,b){this.setCorpus(b);this.documents=[];var c=this.getTargetEl().dom.querySelector("canvas"),d=c.getContext("2d"),e=c.width/2;d.font=this.textFont;b.getDocuments().each(function(a){var b=a.getTinyTitle();this.documents.push({doc:a,label:b,width:d.measureText(b).width,x:e,y:e,matches:[],isHovering:!1})},this);this.updateDocs(c);this.draw();this.updateFromQueries()},this);this.on("resize",
function(){var a=this.getTargetEl().dom.querySelector("canvas"),b=Math.min(this.getTargetEl().getWidth(),this.getTargetEl().getHeight());a.width=b;a.height=b;this.updateMagnets();this.updateDocs();this.draw(a)})},editMagnet:function(a){var b=this;Ext.create("Ext.window.Window",{title:this.localize("EditMagnet"),modal:!0,items:{xtype:"form",width:300,items:{xtype:"querysearchfield",corpus:this.getCorpus(),store:this.getCorpus().getCorpusTerms({proxy:{extraParams:{stopList:this.getApiParam("stopList")}}}),
stopList:this.getApiParam("stopList")},buttons:[{text:this.localize("remove"),glyph:"xf0e2@FontAwesome",flex:1,ui:"default-toolbar",handler:function(c){var d=Ext.Array.filter(Ext.Array.from(b.getApiParam("query")),function(b){return b!=a});b.setApiParam("query",d);b.updateFromQueries(0==d.length);c.up("window").close()},scope:this},{xtype:"tbfill"},{text:this.localize("cancel"),ui:"default-toolbar",glyph:"xf00d@FontAwesome",flex:1,handler:function(a){a.up("window").close()}},{text:this.localize("update"),
glyph:"xf00c@FontAwesome",flex:1,handler:function(c){var d=Ext.Array.filter(Ext.Array.from(b.getApiParam("query")),function(b){return b!=a}),e=c.up("window").down("querysearchfield").getValue();0<e.length&&d.push(e.join("|"));b.setApiParam("query",d);b.updateFromQueries(0==d.length);c.up("window").close()},scope:this}]},bodyPadding:5}).show()},updateFromQueries:function(a){this.magnets=void 0;this.documents.forEach(function(a){a.matches=[]});this.updateDocs();this.draw();if(this.documents){var b=
this.getApiParams();b.query||(b.limit=10);var c=Ext.Array.from(this.getApiParam("query"));(!a||0<c.length)&&this.getCorpus().getCorpusTerms().load({params:Ext.apply(b,{withDistributions:!0}),callback:function(a){var b=this.getTargetEl().dom.querySelector("canvas"),c=b.getContext("2d");diam=b.width;rad=diam/2;c.font=this.textFont;this.magnets={};for(var b=0,g=a.length;b<g;b++){var h=a[b].getTerm();a[b].getDistributions().forEach(function(a,b){0<a&&this.documents[b].matches.push(h)},this);this.magnets[h]=
{record:a[b],colour:this.getApplication().getColor(b),width:c.measureText(h).width,isHovering:!1}}this.setApiParam("query",Object.keys(this.magnets));this.updateMagnets();this.updateDocs();this.draw()},scope:this})}},updateMagnets:function(a){a=this.getTargetEl().dom.querySelector("canvas");a=a.width/2;var b=Object.keys(this.magnets||{}).length,c=0,d;for(d in this.magnets)Ext.apply(this.magnets[d],{x:a+(a-this.gutter-50)*Math.cos(2*Math.PI*c/b),y:a+(a-this.gutter-50)*Math.sin(2*Math.PI*c/b)}),c++},
updateDocs:function(a){a=a||this.getTargetEl().dom.querySelector("canvas");diam=a.width;rad=diam/2;var b=[];if(this.documents){this.documents.forEach(function(a,c){if(0==Ext.Array.from(a.matches).length)b.push(c);else if(1==Ext.Array.from(a.matches).length){var f=15*Math.random()+15,g=15*Math.random()+15;a.targetX=this.magnets[a.matches[0]].x+(0==Math.round(Math.random())?f:-f);a.targetY=this.magnets[a.matches[0]].y+(0==Math.round(Math.random())?g:-g)}else{var g=f=0,h=a.matches.map(function(a){return this.magnets[a].record.getDistributions()[c]},
this),k=Ext.Array.min(h),m=Ext.Array.max(h),l=0;a.matches.forEach(function(a,b){weight=m==k?1:(h[b]-k+k)/(m-k+k);l+=weight;f+=this.magnets[a].x*weight;g+=this.magnets[a].y*weight},this);a.targetX=f/l;a.targetY=g/l}},this);a=0;for(var c=b.length;a<c;a++)Ext.apply(this.documents[a],{targetX:rad+(rad-this.gutter)*Math.cos(2*Math.PI*a/c),targetY:rad+(rad-this.gutter)*Math.sin(2*Math.PI*a/c)})}},draw:function(a,b){a=a||this.getTargetEl().dom.querySelector("canvas");b=b||a.getContext("2d");b.font=this.textFont;
var c=a.width/2;b.clearRect(0,0,a.width,a.height);var d=this.getApiParam("labels");b.beginPath();b.strokeStyle="rgba(0,0,0,.1)";b.fillStyle="rgba(0,0,0,.02)";b.arc(c,c,c-this.gutter,0,2*Math.PI,!1);b.fill();b.lineWidth=2;b.stroke();var e=!1;if(this.documents&&0<this.documents.length){var f=Ext.Array.each(this.documents,function(a){return!a.isHovering},this);!0===f&&(f=Ext.Array.each(Object.keys(this.magnets||{}),function(a){return!this.magnets[a].isHovering},this));var g={};hoveringDocs=[];this.documents.forEach(function(a,
c){a.matches.forEach(function(d,e){b.beginPath();b.moveTo(a.x,a.y);b.lineTo(this.magnets[d].x,this.magnets[d].y);!0===f?b.strokeStyle="rgba("+this.magnets[d].colour.join(",")+",.1)":a.isHovering||this.magnets[d].isHovering?(hoveringDocs[c]=!0,g[d]=!0,b.strokeStyle="rgba("+this.magnets[d].colour.join(",")+",.5)"):b.strokeStyle="rgba(0,0,0,.02)";b.stroke()},this)},this);var h=parseInt(this.textFont)/2,k=parseInt(this.textFont)+4;this.documents.forEach(function(a,c){if(d||a.isHovering||1==hoveringDocs[c]){var g=
a.width+4;b.fillStyle=a.isHovering||1==hoveringDocs[c]||!0===f?"white":"rgba(255,255,255,.05)";b.fillRect(a.x-g/2,a.y-k/2,g,k);b.strokeStyle=a.isHovering||1==hoveringDocs[c]||!0===f?"rgba(0,0,0,.2)":"rgba(0,0,0,.05)";b.strokeRect(a.x-g/2,a.y-k/2,g,k);b.textAlign="center";b.fillStyle=a.isHovering||1==hoveringDocs[c]||!0===f?"rgba(0,0,0,.8)":"rgba(0,0,0,.05)";b.fillText(a.label,a.x,a.y)}else b.beginPath(),b.fillStyle="rgba(0,0,0,.8)",b.arc(a.x,a.y,h,0,2*Math.PI),b.fill(),b.stroke();var g=Math.abs(a.x-
a.targetX),l=Math.abs(a.y-a.targetY);if(0!=g||0!=l)1>g?a.x=a.targetX:(g/=2,a.x=a.x>a.targetX?a.x-g:a.x+g),1>l?a.y=a.targetY:(l/=2,a.y=a.y>a.targetY?a.y-l:a.y+l),e=!0},this);var m=0,k=parseInt(this.textFont)+4;b.textAlign="center";b.textBaseline="middle";for(var l in this.magnets)d||l in g||this.magnets[l].isHovering?(m=this.magnets[l].width+4,b.fillStyle=l in g||this.magnets[l].isHovering||!0===f?"white":"rgba(255,255,255,.05)",b.fillRect(this.magnets[l].x-m/2,this.magnets[l].y-k/2,m,k),b.strokeStyle=
l in g||this.magnets[l].isHovering||!0===f?"rgb("+this.magnets[l].colour.join(",")+")":"rgba(0,0,0,.05)",b.strokeRect(this.magnets[l].x-m/2,this.magnets[l].y-k/2,m,k),b.textAlign="center",b.fillStyle=l in g||this.magnets[l].isHovering||!0===f?"rgba(0,0,0,.8)":"rgba(0,0,0,.05)",b.fillText(l,this.magnets[l].x,this.magnets[l].y)):(b.beginPath(),b.fillStyle="rgb("+this.magnets[l].colour.join(",")+")",b.strokeStyle="rgb("+this.magnets[l].colour.join(",")+")",b.arc(this.magnets[l].x,this.magnets[l].y,12,
0,2*Math.PI),b.fill(),b.stroke())}if(e){var n=this;setTimeout(function(){n.draw()},100)}else if(this.documents){c=Math.max(c/this.documents.length,50);m=0;for(l=this.documents.length;m<l;m++)for(var q=0;q<l;q++)if(m<q){var s=this.documents[m].x-this.documents[q].x,p=this.documents[m].y-this.documents[q].y;Math.sqrt(s*s+p*p)<c&&(s*=.1,p*=.1,this.documents[m].targetX+=s,this.documents[q].targetX-=s,this.documents[m].targetY+=p,this.documents[q].targetY-=p,e=!0)}e&&(n=this,setTimeout(function(){n.draw()},
100))}}});Ext.define("Voyant.panel.Reader",{extend:"Ext.panel.Panel",requires:["Voyant.data.store.Tokens"],mixins:["Voyant.panel.Panel"],alias:"widget.reader",isConsumptive:!0,statics:{i18n:{},api:{start:0,limit:1E3,skipToDocId:void 0,query:void 0},glyph:"xf0f6@FontAwesome"},config:{corpus:void 0,tokensStore:void 0,documentsStore:void 0,documentTermsStore:void 0,exportVisualization:!1,lastScrollTop:0,scrollIntoView:!1,insertWhere:"beforeEnd",locationMarker:void 0,lastLocationUpdate:new Date},INITIAL_LIMIT:1E3,
innerContainer:null,cls:"voyant-reader",layout:"fit",items:{layout:"border",items:[{bodyPadding:10,region:"center",border:!1,autoScroll:!0,html:'\x3cdiv class\x3d"readerContainer"\x3e\x3c/div\x3e'},{region:"south",height:40,split:{size:2},splitterResize:!0,border:!1,layout:{type:"hbox"}}]},constructor:function(){Ext.apply(this,{title:this.localize("title")});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){var a=Ext.create("Voyant.data.store.Tokens");
a.on("beforeload",function(a){return"NONCONSUMPTIVE"!=a.getCorpus().getNoPasswordAccess()});a.on("load",function(a,c,d){if(d){var e="",f=this.localize("documentFrequency"),g=!1,h=-1,k=!1;c.forEach(function(a){0==a.getPosition()&&(e+="\x3ch3\x3e"+this.getDocumentsStore().getById(a.getDocId()).getFullLabel()+"\x3c/h3\x3e");a.getDocIndex()!=h&&(g=this.getDocumentsStore().getById(a.getDocId()).isPlainText(),h=a.getDocIndex());if(a.isWord())k=!1,e+="\x3cspan class\x3d'word' id\x3d'"+a.getId()+"' data-qtip\x3d'"+
f+" "+a.getDocumentRawFreq()+"'\x3e"+a.getTerm()+"\x3c/span\x3e";else{a=a.getTermWithLineSpacing(g);var b=0==a.indexOf("\x3cbr /\x3e");if(!k||!b&&0!=a.trim().length)e+=a,k=b}},this);this.updateText(e,!0);this.down("querysearchfield").getValue()}},this);this.setTokensStore(a);this.on("query",function(a,c){this.loadQueryTerms(c)},this);this.setDocumentTermsStore(Ext.create("Ext.data.Store",{model:"Voyant.data.model.DocumentTerm",autoLoad:!1,remoteSort:!1,proxy:{type:"ajax",url:Voyant.application.getTromboneUrl(),
extraParams:{tool:"corpus.DocumentTerms",withDistributions:!0,withPositions:!0,bins:25},reader:{type:"json",rootProperty:"documentTerms.terms",totalProperty:"documentTerms.total"},simpleSortMode:!0},listeners:{load:function(a,c,d,e){a.sort("docIndex","ASC");var f={},g=0,h;a.each(function(a){var b=[],c=a.get("distributions"),d=a.get("docId"),e=a.get("docIndex");h=a.get("term");for(a=0;a<c.length;a++){var s=a,p=c[a];p>g&&(g=p);b.push([d,e,s,p,h])}f[e]=b},this);this.highlightKeywords(h);a=this.query("cartesian");
for(c=0;c<a.length;c++)d=a[c],e=f[c],void 0!==e?(d.getAxes()[0].setMaximum(g),d.getStore().loadData(e)):d.getStore().removeAll()},scope:this}}));this.on("afterrender",function(){var a=this.down('panel[region\x3d"center"]');this.innerContainer=a.getLayout().getRenderTarget();a.body.on("scroll",function(a,b){this.innerContainer.first();var e=this.getLastScrollTop()<b.scrollTop;!e&&1>b.scrollTop?this.fetchPrevious(!0):e&&b.scrollHeight-b.scrollTop<1.5*b.offsetHeight?this.fetchNext(!1):250<new Date-this.getLastLocationUpdate()&&
this.updateLocationMarker(b);this.setLastScrollTop(b.scrollTop)},this);a.body.on("click",function(a,b){b=Ext.get(b);if(b.hasCls("word")){var e=Voyant.data.model.Token.getInfoFromElement(b),f=b.getHtml(),e=[{term:f,docIndex:e.docIndex}];this.loadQueryTerms([f]);this.getApplication().dispatchEvent("termsClicked",this,e)}},this);this.getCorpus()&&(this.load(),(a=this.getApiParam("query"))&&this.loadQueryTerms(Ext.isString(a)?[a]:a))},this);Ext.apply(this,{dockedItems:[{dock:"bottom",xtype:"toolbar",
enableOverflow:!0,items:[{glyph:"xf060@FontAwesome",handler:function(){this.fetchPrevious(!0)},scope:this},{glyph:"xf061@FontAwesome",handler:function(){this.fetchNext(!0)},scope:this},{xtype:"tbseparator"},{xtype:"querysearchfield"}]}],listeners:{loadedCorpus:function(a,c){this.setCorpus(c);this.getTokensStore().setCorpus(c);this.getDocumentTermsStore().getProxy().setExtraParam("corpus",c.getId());var d=c.getDocuments();this.setDocumentsStore(d);d=this.down('panel[region\x3d"south"]');this.setLocationMarker(Ext.DomHelper.append(d.el,
{tag:"div",style:"background-color: #157fcc; height: 100%; width: 2px; position: absolute; top: 0; left: 0;"}));this.generateChart(c,d);this.rendered&&(this.load(),"NONCONSUMPTIVE"==c.getNoPasswordAccess()&&this.mask(this.localize("limitedAccess"),"mask-no-spinner"),(d=this.getApiParam("query"))&&this.loadQueryTerms(Ext.isString(d)?[d]:d))},termsClicked:function(a,c){var d=[];c.forEach(function(a){Ext.isString(a)?d.push(a):a.term?d.push(a.term):a.getTerm&&d.push(a.getTerm())});0<d.length&&this.loadQueryTerms(d)},
corpusTermsClicked:function(a,c){var d=[];c.forEach(function(a){a.getTerm()&&d.push(a.getTerm())});this.loadQueryTerms(d)},documentTermsClicked:function(a,c){var d=[];c.forEach(function(a){a.getTerm()&&d.push(a.getTerm())});this.loadQueryTerms(d)},documentsClicked:function(a,c,d){0<c.length&&(this.setApiParams({skipToDocId:c[0].getId(),start:0}),this.load(!0))},termLocationClicked:function(a,c){if(void 0!==c[0]){var d=c[0],e=d.get("docIndex"),f=d.get("position"),g=f-this.getApiParam("limit")/2,h=
this.getCorpus().getDocument(e);this.setApiParams({skipToDocId:h.getId(),start:0>g?0:g});this.load(!0,{callback:function(){var a=this.body.dom.querySelector("#_"+e+"_"+f);a&&a.scrollIntoView();this.highlightKeywords(d.get("term"),!1)},scope:this})}},documentIndexTermsClicked:function(a,c){if(void 0!==c[0]){var d=Ext.create("Voyant.data.model.Token",c[0]);this.fireEvent("termLocationClicked",this,[d])}},scope:this}});this.callParent(arguments)},loadQueryTerms:function(a){a&&0<a.length&&this.getDocumentTermsStore().load({params:{query:a}})},
updateLocationMarker:function(a){var b;b=0==a.scrollTop?0:a.scrollHeight-a.scrollTop==a.clientHeight?1:(a.scrollTop+.5*a.clientHeight)/a.scrollHeight;a=$(a).find(".readerContainer").find(".word");var c=a.first()[0],d=a.last()[0];if(void 0!==c&&void 0!==d){a=this.getCorpus();var e=!1,c=Voyant.data.model.Token.getInfoFromElement(Ext.get(c)),d=Voyant.data.model.Token.getInfoFromElement(Ext.get(d));0!==c.position&&(e=!0);for(var f={},g=0,h=c.docIndex;h<=d.docIndex;){var k=a.getDocument(h).get("tokensCount-lexical");
h===d.docIndex&&(k=d.position);h===c.docIndex&&(k-=c.position);g+=k;f[h]=k;h++}g=Math.round(g*b);h=b=0;for(k=c.docIndex;k<=d.docIndex&&!(b=k,h+=f[k],h>=g);k++);d=f[b]-(h-g);e&&b===c.docIndex&&(d+=c.position);a=d/a.getDocument(b).get("tokensCount-lexical");e=this.query("cartesian")[b];a=e.getX()+e.getWidth()*a;Ext.get(this.getLocationMarker()).setX(a)}this.setLastLocationUpdate(new Date)},generateChart:function(a,b){function c(a,b){var c=[[116,116,181],[139,163,83],[189,157,60],[171,75,75],[174,61,
155]],c=c[a%c.length];return"rgba("+c[0]+","+c[1]+","+c[2]+","+b+")"}function d(d,e){var f=d.index,g=d.fraction,h=d.relativeHeight,k=c(f,.3),f=c(f,1);b.add({xtype:"cartesian",plugins:{ptype:"chartitemevents"},flex:g,height:"100%",insetPadding:0,background:{type:"linear",degrees:90,stops:[{offset:0,color:k},{offset:h,color:k},{offset:h,color:"white"},{offset:1,color:"white"}]},axes:[{type:"numeric",position:"left",fields:"distribution",hidden:!0},{type:"category",position:"bottom",fields:"bin",hidden:!0}],
series:[{type:"line",xField:"bin",yField:"distribution",style:{lineWidth:2,strokeStyle:f},tooltip:{corpus:a,trackMouse:!0,style:"background: #fff",showDelay:0,dismissDelay:500,hideDelay:5,renderer:function(b,c,d){b.setHtml(a.getDocument(c.get("docIndex")).getTitle()+"\x3cbr\x3e"+c.get("term")+": "+c.get("distribution"))}}}],store:Ext.create("Ext.data.ArrayStore",{fields:["docId","docIndex","bin","distribution","term"],data:[]}),listeners:{itemclick:function(a,b,c){a=b.record.data;a=this.getDocumentsStore().getAt(a.docIndex);
this.getApplication().dispatchEvent("documentsClicked",this,[a])},scope:e}}).body.on("click",function(a,b){var c=Ext.get(b),d=a.getX(),e=c.getBox(),d=(d-e.x)/e.width,c=c.parent(".x-panel"),e=c.parent(),c=Ext.toArray(e.dom.children).indexOf(c.dom),c=this.getDocumentsStore().getAt(c),e=c.get("tokensCount-lexical"),d=Math.floor(e*d)-this.getApiParam("limit")/2;this.setApiParams({skipToDocId:c.getId(),start:0>d?0:d});this.load(!0)},e)}b.removeAll();var e=a.getDocuments();if(50>e.getTotalCount()){for(var f=
a.getWordTokensCount(),g=[],h=Number.MAX_VALUE,k=-1,m=0;m<e.getCount();m++){var l=e.getAt(m),n=l.get("index"),l=l.get("tokensCount-lexical");l<h&&(h=l);l>k&&(k=l);g.push({index:n,count:l,fraction:l/f})}for(m=0;m<g.length;m++)l=g[m],l.relativeHeight=l.count==k?1:.25+(l.count-h)/(k-h)*.75,d(l,this)}},highlightKeywords:function(a,b){Ext.isArray(a)||(a=[a]);this.innerContainer.first().select("span[class*\x3dkeyword]").removeCls("keyword");var c=[],d=new RegExp("^"+a[0]+"$","i");this.innerContainer.first().select("span.word").each(function(a,
b,g){a.dom.firstChild&&a.dom.firstChild.nodeValue.match(d)&&(a.addCls("keyword"),c.push(a.dom))})},fetchPrevious:function(a){var b=this.innerContainer.first(),c=b.first(".word");if(null!=c&&!1===c.hasCls("loading"))for(;c;){if(c.hasCls("word")){var b=Voyant.data.model.Token.getInfoFromElement(c),d=b.docIndex,b=b.position,e=this.getDocumentsStore().getAt(d),f=this.getApiParam("limit"),g=!1;if(0===d&&0===b){c.dom.scrollIntoView();c.frame("red");break}0<d&&0===b?(g=!0,d--,e=this.getDocumentsStore().getAt(d),
d=e.get("tokensCount-lexical"),b=d-f,0>b&&(b=0,this.setApiParam("limit",d))):(f--,b-=f);0>b&&(b=0);c.insertSibling("\x3cdiv class\x3d'loading'\x3e"+this.localize("loading")+"\x3c/div\x3e","before",!1).mask();g||c.destroy();c=e.getId();this.setApiParams({skipToDocId:c,start:b});this.setInsertWhere("afterBegin");this.setScrollIntoView(a);this.load();this.setApiParam("limit",this.INITIAL_LIMIT);break}c.destroy();c=b.first()}},fetchNext:function(a){var b=this.innerContainer.first(),c=b.last();if(!1===
c.hasCls("loading"))for(var d=$(b.dom).contents().filter(function(){return 3===this.nodeType}).last();c;){if(c.hasCls("word")){var b=Voyant.data.model.Token.getInfoFromElement(c),e=b.docIndex,f=b.position,g=this.getDocumentsStore().getAt(b.docIndex),h=g.getId(),g=g.get("tokensCount-lexical");if(f+this.getApiParam("limit")>=g&&e==this.getCorpus().getDocumentsCount()-1)if(e=g-f,1>=e){c.dom.scrollIntoView();c.frame("red");break}else this.setApiParam("limit",e);c.el.dom.nextSibling===d[0]&&d.remove();
c.insertSibling("\x3cdiv class\x3d'loading'\x3e"+this.localize("loading")+"\x3c/div\x3e","after",!1).mask();c.destroy();this.setApiParams({skipToDocId:h,start:b.position});this.setInsertWhere("beforeEnd");this.setScrollIntoView(a);this.load();this.setApiParam("limit",this.INITIAL_LIMIT);break}c.destroy();c=b.last()}},load:function(a,b){a&&(this.innerContainer.first().destroy(),this.innerContainer.setHtml('\x3cdiv class\x3d"readerContainer"\x3e\x3cdiv class\x3d"loading"\x3e'+this.localize("loading")+
"\x3c/div\x3e\x3c/div\x3e"),this.innerContainer.first().first().mask());this.getTokensStore().load(Ext.apply(b||{},{params:Ext.apply(this.getApiParams(),{stripTags:"blocksOnly"})}))},updateText:function(a){var b=this.innerContainer.down(".loading");b&&b.destroy();var c=this.innerContainer.first().insertHtml(this.getInsertWhere(),a,!0);c&&this.getScrollIntoView()&&(c.dom.scrollIntoView(),Ext.Function.defer(function(){var a=Ext.get(c.id);a&&a.frame("red")},100));a=this.down('panel[region\x3d"center"]').body.dom;
this.updateLocationMarker(a)},updateChart:function(){}});Ext.define("Voyant.panel.ScatterPlot",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],requires:["Ext.chart.CartesianChart"],alias:"widget.scatterplot",config:{corpus:void 0,options:{xtype:"stoplistoption"}},statics:{i18n:{},api:{docId:void 0,analysis:"ca",limit:50,dimensions:3,bins:10,clusters:3,comparisonType:"relative",stopList:"auto",target:void 0,term:void 0,query:void 0,label:["summary","docs","terms"]},glyph:"xf06e@FontAwesome"},tokenFreqTipTemplate:null,docFreqTipTemplate:null,caStore:null,
pcaStore:null,docSimStore:null,termStore:Ext.create("Ext.data.JsonStore",{fields:[{name:"term"},{name:"rawFreq",type:"int"},{name:"relativeFreq",type:"number"},{name:"coordinates",mapping:"vector"}],sorters:[{property:"rawFreq",direction:"DESC"}]}),newTerm:null,termsTimeout:null,chartMenu:null,labelsMode:0,highlightData:{x:0,y:0,r:0},highlightTask:null,constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){Ext.apply(this,
{title:this.localize("title"),caStore:Ext.create("Voyant.data.store.CAAnalysis"),pcaStore:Ext.create("Voyant.data.store.PCAAnalysis"),docSimStore:Ext.create("Voyant.data.store.DocSimAnalysis"),termStore:this.termStore,chartMenu:Ext.create("Ext.menu.Menu",{items:[{text:this.localize("remove"),itemId:"remove",glyph:"xf068@FontAwesome"},{text:this.localize("nearby"),itemId:"nearby",glyph:"xf0b2@FontAwesome"}],listeners:{hide:function(){var a=this.down("#chart").getSeries();a[0].enableToolTips();a[1].enableToolTips()},
scope:this}}),layout:"border",autoDestroy:!0,items:[{itemId:"chartParent",region:"center",layout:"fit",tbar:{enableOverflow:!0,items:[{xtype:"documentselectorbutton",flex:1},{text:this.localize("analysis"),itemId:"analysis",glyph:"xf1ec@FontAwesome",enableOverflow:!0,flex:1,menu:{items:[{text:this.localize("pca"),itemId:"analysis_pca",group:"analysis",xtype:"menucheckitem"},{text:this.localize("ca"),itemId:"analysis_ca",group:"analysis",xtype:"menucheckitem"},{text:this.localize("docSim"),itemId:"analysis_docSim",
group:"analysis",xtype:"menucheckitem"}],listeners:{click:function(a,b){void 0!==b&&(b.text===this.localize("pca")?this.setApiParam("analysis","pca"):b.text===this.localize("docSim")?this.setApiParam("analysis","docSim"):(this.setApiParam("analysis","ca"),this.getCorpus().getDocumentsCount()),this.loadFromApis(!0))},scope:this}}},{text:this.localize("freqsMode"),glyph:"xf201@FontAwesome",tooltip:this.localize("freqsModeTip"),flex:1,menu:{items:[{text:this.localize("rawFrequencies"),checked:!1,itemId:"raw",
group:"freqsMode",checkHandler:function(a,b){b&&(this.setApiParam("comparisonType","raw"),this.loadFromApis())},scope:this},{text:this.localize("relativeFrequencies"),checked:!0,itemId:"relative",group:"freqsMode",checkHandler:function(a,b){b&&(this.setApiParam("comparisonType","relative"),this.loadFromApis())},scope:this},{text:this.localize("tfidf"),checked:!1,itemId:"tfidf",group:"freqsMode",checkHandler:function(a,b){b&&(this.setApiParam("comparisonType","tfidf"),this.loadFromApis())},scope:this}]}},
{text:this.localize("clusters"),itemId:"clusters",glyph:"xf192@FontAwesome",flex:1,menu:{items:[{text:"1",itemId:"clusters_1",group:"clusters",xtype:"menucheckitem"},{text:"2",itemId:"clusters_2",group:"clusters",xtype:"menucheckitem"},{text:"3",itemId:"clusters_3",group:"clusters",xtype:"menucheckitem"},{text:"4",itemId:"clusters_4",group:"clusters",xtype:"menucheckitem"},{text:"5",itemId:"clusters_5",group:"clusters",xtype:"menucheckitem"}],listeners:{click:function(a,b){void 0!==b&&(this.setApiParam("clusters",
parseInt(b.text)),this.loadFromApis(!0))},scope:this}}},{text:this.localize("dimensions"),itemId:"dimensions",glyph:"xf1b2@FontAwesome",flex:1,menu:{items:[{text:"2",itemId:"dimensions_2",group:"dimensions",xtype:"menucheckitem"},{text:"3",itemId:"dimensions_3",group:"dimensions",xtype:"menucheckitem"}],listeners:{click:function(a,b){void 0!==b&&(this.setApiParam("dimensions",parseInt(b.text)),this.loadFromApis(!0))},scope:this}}},{text:this.localize("labels"),itemId:"labels",glyph:"xf02b@FontAwesome",
flex:1,menu:{items:[{text:this.localize("summaryLabel"),itemId:"summary",xtype:"menucheckitem"},{text:this.localize("docsLabel"),itemId:"docs",xtype:"menucheckitem"},{text:this.localize("termsLabel"),itemId:"terms",xtype:"menucheckitem"}],listeners:{afterrender:function(a){var b=this.getApiParam("label");a.items.each(function(a){a.setChecked(-1<b.indexOf(a.getItemId()))})},click:function(a,b){var c=this.getApiParam("label"),d=b.getItemId();Ext.isString(c)&&(c=[c]);b.checked&&-1==c.indexOf(d)?c.push(d):
!b.checked&&-1<c.indexOf(d)&&(c=c.filter(function(a){return a!=d}));this.setApiParam("label",c);this.doLabels();this.queryById("chart").redraw()},scope:this}}}]}},{itemId:"terms",xtype:"grid",region:"east",width:250,split:!0,forceFit:!0,bbar:{enableOverflow:!0,items:[{xtype:"button",text:this.localize("nearby"),glyph:"xf0b2@FontAwesome",flex:1,handler:function(a){var b=a.up("panel").getSelection()[0];void 0===b?this.toastError({html:this.localize("noTermSelected"),anchor:a.up("panel").getTargetEl()}):
(a=b.get("term"),this.getNearbyForTerm(a))},scope:this},{xtype:"button",text:this.localize("remove"),glyph:"xf068@FontAwesome",flex:1,handler:function(a){var b=a.up("panel").getSelection()[0];void 0===b?this.toastError({html:this.localize("noTermSelected"),anchor:a.up("panel").getTargetEl()}):(a=b.get("term"),this.removeTerm(a))},scope:this}]},tbar:{enableOverflow:!0,items:[{fieldLabel:this.localize("numTerms"),labelAlign:"right",labelWidth:40,itemId:"limit",xtype:"combo",width:100,store:Ext.create("Ext.data.ArrayStore",
{fields:["count"],data:[[10],[20],[30],[40],[50],[60],[70],[80],[90],[100]]}),displayField:"count",valueField:"count",queryMode:"local",editable:!0,allowBlank:!1,validator:function(a){return null===a.match(/\D/)},listeners:{change:function(a,b,c){function d(){var a=Math.min(parseInt(b),1E4);this.setApiParam("limit",a);this.loadFromApis()}a.isValid()&&null!==c&&(null!==this.termsTimeout&&clearTimeout(this.termsTimeout),this.termsTimeout=setTimeout(d.bind(this),500))},scope:this}},{xtype:"querysearchfield",
flex:1}]},columns:[{text:this.localize("term"),dataIndex:"term",flex:1,sortable:!0},{text:this.localize("rawFreq"),dataIndex:"rawFreq",sortable:!0},{text:this.localize("relFreq"),dataIndex:"relativeFreq",sortable:!0,hidden:!0}],selModel:Ext.create("Ext.selection.RowModel",{listeners:{selectionchange:{fn:function(a,b){var c=b[0];void 0!==c&&(c=c.get("term"),this.selectTerm(c))},scope:this}},mode:"SINGLE"}),store:this.termStore,listeners:{query:function(a,b){void 0!==b&&-1===this.termStore.findExact("term",
b)?(this.newTerm=b,this.loadFromApis()):this.newTerm=null},scope:this}}]});this.on("loadedCorpus",function(a,b){var c=function(a){var b=this.getApiParam(a);this.queryById("chartParent").getDockedItems("toolbar")[0].down("#"+a).down("#"+a+"_"+b).setChecked(!0)}.bind(this);c("analysis");c("clusters");c("dimensions");this.setCorpus(b);this.caStore.setCorpus(b);this.pcaStore.setCorpus(b);this.docSimStore.setCorpus(b);this.loadFromApis()},this);this.on("documentsSelected",function(a,b){this.setApiParam("docId",
b);this.loadFromApis()},this);this.caStore.on("load",function(a,b){this.buildChart(a)},this);this.pcaStore.on("load",function(a,b){this.buildChart(a)},this);this.docSimStore.on("load",function(a,b){this.buildChart(a)},this);this.tokenFreqTipTemplate=new Ext.Template(this.localize("tokenFreqTip"));this.docFreqTipTemplate=new Ext.Template(this.localize("docFreqTip"));this.callParent(arguments)},buildChart:function(a){var b=this,c=this.queryById("chart");null!==c&&this.queryById("chartParent").remove(c);
var c=a.getAt(0),d=this.getApiParam("dimensions");a="";if("pca"===this.getApiParam("analysis")){for(var e=c.getPrincipalComponents(),f=0,g=0;g<e.length;g++)var h=e[g],f=f+parseFloat(h.get("eigenValue"));a=this.localize("pcTitle")+"\n";for(var k=["xAxis","yAxis","fill"],g=0;g<e.length&&!(g>=d);g++)h=e[g],h=parseFloat(h.get("eigenValue"))/f*100,a+=this.localize("pc")+" "+(g+1)+" ("+this.localize(k[g])+"): "+Math.round(100*h)/100+"%\n"}else for(a=this.localize("caTitle")+"\n",k=["xAxis","yAxis","fill"],
e=c.getDimensions(),g=0;g<e.length&&!(g>=d);g++)h=parseFloat(e[g].data),a+=this.localize("dimension")+" "+(g+1)+" ("+this.localize(k[g])+"): "+Math.round(100*h)/100+"%\n";var m=0,l=Number.MAX_VALUE,n=0,q=Number.MAX_VALUE;"docSim"!==this.getApiParam("analysis")&&this.termStore.removeAll();var s=[],p=[];c.getTokens().forEach(function(a){var b=a.get("rawFreq"),c=a.get("category");void 0===c&&(c="term");var e="term"===c;e&&(b>m&&(m=b),b<l&&(l=b),this.termStore.findExact("term",-1===a.get("term"))&&this.termStore.addSorted(a));
if(3===d){var f=a.get("vector")[2];f<q&&(q=f);f>n&&(n=f)}b={x:a.get("vector")[0],y:a.get("vector")[1],z:a.get("vector")[2],term:a.get("term"),rawFreq:b,relativeFreq:a.get("relativeFreq"),cluster:a.get("cluster"),category:c};e?s.push(b):("bin"===a.get("category")?b.term=b.title="Bin "+a.get("docIndex"):(b.docIndex=a.get("docIndex"),a=this.getCorpus().getDocument(b.docIndex),null!==a&&(b.term=a.getShortTitle(),b.title=a.getTitle())),p.push(b))},this);c=this.termStore.getCount();this.queryById("limit").setRawValue(c);
this.setApiParam("limit",c);c=Ext.create("Ext.data.JsonStore",{fields:"term x y z rawFreq relativeFreq cluster category docIndex".split(" "),data:s});g=Ext.create("Ext.data.JsonStore",{fields:"term x y z rawFreq relativeFreq cluster category docIndex".split(" "),data:p});a={itemId:"chart",xtype:"cartesian",interactions:["crosszoom","panzoom","itemhighlight"],plugins:{ptype:"chartitemevents"},axes:[{type:"numeric",position:"bottom",fields:["x"]},{type:"numeric",position:"left",fields:["y"]}],sprites:[{type:"text",
text:a,hidden:0<this.labelsMode,x:70,y:70}],innerPadding:{top:25,right:25,bottom:25,left:25},series:[{type:"customScatter",xField:"x",yField:"y",store:c,tooltip:{trackMouse:!0,style:"background: #fff",renderer:function(a,c,d){a.setHtml(b.tokenFreqTipTemplate.apply([c.get("term"),c.get("rawFreq"),c.get("relativeFreq")]))}},marker:{type:"circle"},highlight:{fillStyle:"yellow",strokeStyle:"black"},renderer:function(a,c,e,f){a=e.store.getAt(f);null!==a&&(f=a.get("cluster"),-1===f&&(f=0),e=.65,3===d&&
(e=b.interpolate(a.get("z"),q,n,0,1)),f=b.getApplication().getColor(f),c.fillStyle="rgba("+f.join(",")+","+e+")",c.strokeStyle="rgba("+f.join(",")+",1)",a=a.get("rawFreq"),a=b.interpolate(a,l,m,2,20),c.radius=a)},scope:this},{type:"customScatter",xField:"x",yField:"y",store:g,tooltip:{trackMouse:!0,style:"background: #fff",renderer:function(a,c,d){a.setHtml(b.docFreqTipTemplate.apply([c.get("title"),c.get("rawFreq")]))}},marker:{type:"diamond"},highlight:{fillStyle:"yellow",strokeStyle:"black"},renderer:function(a,
c,e,f){e=e.store.getAt(f);if(null!==e){f=e.get("cluster");if(-1===f||"docSim"!==b.getApiParam("analysis"))f=6;a=.65;3===d&&(a=b.interpolate(e.get("z"),q,n,0,1));e=b.getApplication().getColor(f);c.fillStyle="rgba("+e.join(",")+","+a+")";c.strokeStyle="rgba("+e.join(",")+",1)";c.radius=5}},scope:this}],listeners:{itemclick:function(a,b,c){a=b.record.data;"doc"===a.category?(a=this.getCorpus().getDocument(a.docIndex),this.getApplication().dispatchEvent("documentsClicked",this,[a])):"term"===a.category&&
(a=Ext.create("Voyant.data.model.CorpusTerm",a),this.getApplication().dispatchEvent("corpusTermsClicked",this,[a]))},render:function(a){a.body.on("contextmenu",function(a,b){a.preventDefault();var c=a.getXY(),d=Ext.fly(b).getXY(),e=c[0]-d[0],d=c[1]-d[1],f=this.down("#chart").getItemForPoint(e,d);null!=f&&"term"===f.record.get("category")&&(e=this.down("#chart").getSeries(),e[0].disableToolTips(),e[1].disableToolTips(),e=f.record.get("term"),d=(new Ext.Template(this.localize("removeTerm"))).apply([e]),
this.chartMenu.queryById("remove").setText(d),d=(new Ext.Template(this.localize("nearbyTerm"))).apply([e]),this.chartMenu.queryById("nearby").setText(d),this.chartMenu.on("click",function(a,b){if(void 0!==b){var c=f.record.get("term");b.text===this.localize("remove")?this.removeTerm(c):this.getNearbyForTerm(c)}},this,{single:!0}),this.chartMenu.showAt(c))},this)},scope:this}};a.series[0].label={field:"term",display:"over"};a.series[1].label={field:"term",display:"over"};a=Ext.create("Ext.chart.CartesianChart",
a);this.queryById("chartParent").insert(0,a);this.doLabels();null!==this.newTerm&&(this.selectTerm(this.newTerm),this.newTerm=null)},doLabels:function(){var a=this.queryById("chart"),b=a.getSeries(),a=a.getSurface("chart").getItems()[0],c=this.getApiParam("label");-1<c.indexOf("summary")?a.show():a.hide();-1<c.indexOf("terms")?b[0].getLabel().show():b[0].getLabel().hide();-1<c.indexOf("docs")?b[1].getLabel().show():b[1].getLabel().hide()},selectTerm:function(a){var b=this.down("#chart").getSeries()[0];
a=b.getStore().findExact("term",a);if(-1!==a){var c=b.getStore().getAt(a),d=b.getSprites()[0],c={series:b,category:b.getItemInstancing()?"items":"markers",index:a,record:c,field:b.getYField(),sprite:d};b.setHighlightItem(c);b=this.getPointFromIndex(b,a);this.highlightData={x:b[0],y:b[1],r:50};null==this.highlightTask&&(this.highlightTask=Ext.TaskManager.newTask({run:this.doHighlight,scope:this,interval:25,repeat:this.highlightData.r}));this.highlightTask.restart()}},getPointFromIndex:function(a,b){var c=
a.getSprites()[0];return c.attr.matrix.clone().prependMatrix(c.surfaceMatrix).transformPoint([c.attr.dataX[b],c.attr.dataY[b]])},doHighlight:function(){var a=this.down("#chart");if(0<this.highlightData.r){for(var b=a.getSurface(),c=null,d=b.getItems(),e=0;e<d.length;e++){var f=d[e];if("customHighlight"==f.id){c=f;break}}null==c?b.add({id:"customHighlight",type:"circle",strokeStyle:"red",fillStyle:"none",radius:this.highlightData.r,x:this.highlightData.x,y:this.highlightData.y}):(c.setAttributes({x:this.highlightData.x,
y:this.highlightData.y,radius:this.highlightData.r}),this.highlightData.r-=1.5,0>=this.highlightData.r&&(this.highlightData.r=0,b.remove(c,!0)));a.redraw()}},getCurrentTerms:function(){var a=[];this.termStore.each(function(b){"term"===b.get("category")&&a.push(b.get("term"))});return a},getNearbyForTerm:function(a){var b=Math.max(2E3,Math.round(this.getCorpus().getWordTokensCount()/100));this.setApiParams({limit:b,target:a});this.loadFromApis();this.setApiParam("target",void 0)},removeTerm:function(a){var b=
this.down("#chart").getSeries()[0],c=b.getStore().findExact("term",a);b.getStore().removeAt(c);c=this.termStore.findExact("term",a);this.termStore.removeAt(c);a=this.termStore.getCount();this.queryById("limit").setRawValue(a)},loadFromApis:function(a){var b=this.down("#chart");null!==b&&b.mask(this.localize("loading"));var b={},c=this.getCurrentTerms();null!==this.newTerm&&(c.push(this.newTerm),this.setApiParam("limit",c.length));0<c.length&&(null!==this.newTerm||a)&&(b.query=c.join(","));Ext.apply(b,
this.getApiParams());null!=b.target&&(b.term=c);"pca"===b.analysis?this.pcaStore.load({params:b}):"docSim"===b.analysis?this.docSimStore.load({params:b}):this.caStore.load({params:b})},interpolate:function(a,b,c,d,e){return d+(e-d)*Math.max(0,Math.min(1,(a-b)/(c-b)))}});
Ext.define("Ext.chart.series.CustomScatter",{extend:"Ext.chart.series.Scatter",alias:"series.customScatter",type:"customScatter",seriesType:"scatterSeries",tipsDisabled:!1,enableToolTips:function(){this.tipsDisabled=!1},disableToolTips:function(){this.tipsDisabled=!0},showTip:function(a,b){this.tipsDisabled||this.callParent(arguments)}});Ext.define("Voyant.panel.StreamGraph",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.streamgraph",statics:{i18n:{},api:{limit:5,stopList:"auto",query:void 0,withDistributions:"relative",bins:50,docIndex:void 0,docId:void 0},glyph:"xf1fe@FontAwesome"},config:{corpus:void 0,visLayout:void 0,vis:void 0,mode:"corpus"},graphMargin:{top:20,right:60,bottom:110,left:80},MODE_CORPUS:"corpus",MODE_DOCUMENT:"document",constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,
arguments)},initComponent:function(){Ext.apply(this,{title:this.localize("title"),tbar:new Ext.Toolbar({enableOverflow:!0,items:["-\x3e",{xtype:"legend",store:new Ext.data.JsonStore({fields:["name","mark","active"]}),listeners:{itemclick:function(a,b,c,d){a=Ext.fly(c.firstElementChild).hasCls("x-legend-inactive");b.set("active",a);b=this.getCurrentTerms();this.setApiParams({query:b,limit:b.length,stopList:void 0});this.loadFromCorpus()},scope:this}},"-\x3e"]}),bbar:{enableOverflow:!0,items:[{xtype:"querysearchfield"},
{xtype:"button",text:this.localize("clearTerms"),handler:function(){this.setApiParams({query:void 0});this.loadFromRecords([])},scope:this},{xtype:"corpusdocumentselector",singleSelect:!0},{text:this.localize("freqsMode"),glyph:"xf201@FontAwesome",tooltip:this.localize("freqsModeTip"),menu:{items:[{text:this.localize("relativeFrequencies"),checked:!0,itemId:"relative",group:"freqsMode",checkHandler:function(a,b){b&&(this.setApiParam("withDistributions","relative"),this.loadFromCorpus())},scope:this},
{text:this.localize("rawFrequencies"),checked:!1,itemId:"raw",group:"freqsMode",checkHandler:function(a,b){b&&(this.setApiParam("withDistributions","raw"),this.loadFromCorpus())},scope:this}]}},{xtype:"slider",itemId:"segmentsSlider",fieldLabel:this.localize("segments"),labelAlign:"right",labelWidth:70,width:150,increment:10,minValue:10,maxValue:300,listeners:{afterrender:function(a){a.setValue(this.getApiParam("bins"))},changecomplete:function(a,b){this.setApiParams({bins:b});this.loadFromCorpus()},
scope:this}}]}});this.on("loadedCorpus",function(a,b){this.setCorpus(b);1==this.getCorpus().getDocumentsCount()&&this.getMode()!=this.MODE_DOCUMENT&&this.setMode(this.MODE_DOCUMENT);if(!("bins"in this.getModifiedApiParams())&&this.getMode()==this.MODE_CORPUS){var c=b.getDocumentsCount();this.setApiParam("bins",100<c?100:c)}this.isVisible()&&this.loadFromCorpus()},this);this.on("corpusSelected",function(a,b){a.isXType("corpusdocumentselector")&&(this.setMode(this.MODE_CORPUS),this.setApiParams({docId:void 0,
docIndex:void 0}),this.setCorpus(b),this.loadFromCorpus())});this.on("documentSelected",function(a,b){var c=b.getId();this.setApiParam("docId",c);this.loadFromDocumentTerms()},this);this.on("query",function(a,b){var c=this.getCurrentTerms();c.push(b);this.setApiParams({query:c,limit:c.length,stopList:void 0});this.getMode()===this.MODE_DOCUMENT?this.loadFromDocumentTerms():this.loadFromCorpusTerms(this.getCorpus().getCorpusTerms())},this);this.on("resize",function(a,b,c){},this);this.on("boxready",
this.initGraph,this);this.callParent(arguments)},loadFromCorpus:function(){var a=this.getCorpus();this.getApiParam("docId")||this.getApiParam("docIndex")?this.loadFromDocumentTerms():1==a.getDocumentsCount()?this.loadFromDocument(a.getDocument(0)):this.loadFromCorpusTerms(a.getCorpusTerms())},loadFromCorpusTerms:function(a){var b=this.getApiParams(["limit","stopList","query","withDistributions","bins"]);b.bins&&b.bins>this.getCorpus().getDocumentsCount()&&(b.bins=this.getCorpus().getDocumentsCount());
a.load({callback:function(a,b,e){e?(this.setMode(this.MODE_CORPUS),this.loadFromRecords(a)):Voyant.application.showResponseError(this.localize("failedGetCorpusTerms"),b)},scope:this,params:b})},loadFromDocument:function(a){if(a.then){var b=this;a.then(function(a){b.loadFromDocument(a)})}else"Voyant.data.model.Document"==Ext.getClassName(a)&&(this.setApiParams({docIndex:void 0,query:void 0,docId:a.getId()}),this.isVisible()&&this.loadFromDocumentTerms())},loadFromDocumentTerms:function(a){this.getCorpus()&&
(a=a||this.getCorpus().getDocumentTerms({autoLoad:!1}),a.load({callback:function(a,c,d){d?(this.setMode(this.MODE_DOCUMENT),this.loadFromRecords(a)):Voyant.application.showResponseError(this.localize("failedGetDocumentTerms"),c)},scope:this,params:this.getApiParams("docId docIndex limit stopList query withDistributions bins".split(" "))}))},loadFromRecords:function(a){var b=d3.scale.category10(),c=this.down("[xtype\x3dlegend]").getStore(),d=[],e=[];a.forEach(function(a,c){var f=[],g=a.getTerm();a.get("distributions").forEach(function(a,
b){f.push({x:b,y:a})},this);e.push({name:g,values:f});d.push({id:g,name:g,mark:b(c),active:!0})},this);c.loadData(d);var c=this.getVisLayout()(e),f;if(this.getMode()===this.MODE_DOCUMENT)f=this.getApiParam("bins");else{a=this.getApiParam("bins");var g=this.getCorpus().getDocumentsCount();f=a<g?a:g}f--;var g=this.body.down("svg").getWidth()-this.graphMargin.left-this.graphMargin.right,h=d3.scale.linear().domain([0,f]).range([0,g]),k=d3.max(c,function(a){return d3.max(a.values,function(a){return a.y0+
a.y})});a=this.body.down("svg").getHeight()-this.graphMargin.top-this.graphMargin.bottom;var m=d3.scale.linear().domain([0,k]).range([a,0]),l=d3.svg.area().x(function(a){return h(a.x)}).y0(function(a){return m(a.y0)}).y1(function(a){return m(a.y0+a.y)}),k=d3.svg.axis().scale(h).orient("bottom");if(this.getMode()===this.MODE_CORPUS){for(var n=[],q=0;q<=f;q++)n.push(q);k.tickValues(n);k.tickFormat("")}n=d3.svg.axis().scale(m).orient("left");c=this.getVis().selectAll("path").data(c,function(a){return a.name});
c.attr("d",function(a){return l(a.values)}).style("fill",function(a,c){return b(c)});c.enter().append("path").attr("d",function(a){return l(a.values)}).style("fill",function(a,c){return b(c)}).append("title").text(function(a){return a.name});c.exit().remove();this.getVis().selectAll("g.axis").remove();this.getVis().append("g").attr("class","axis x").attr("transform","translate(0,"+a+")").call(k);if(this.getMode()===this.MODE_CORPUS){var s=g/f,p=0;this.getCorpus().getDocuments().each(function(a){this.getVis().select("g.x").append("text").attr("text-anchor",
"end").attr("transform","translate("+p+", 10) rotate(-45)").text(a.getTinyTitle());p+=s},this);c=this.localize("documents")}else c=this.localize("documentSegments");this.getVis().select("g.x").append("text").attr("text-anchor","middle").attr("transform","translate("+g/2+", "+(this.graphMargin.bottom-20)+")").text(c);this.getVis().append("g").attr("class","axis y").attr("transform","translate(0,0)").call(n);c="raw"===this.getApiParam("withDistributions")?this.localize("rawFrequencies"):this.localize("relativeFrequencies");
this.getVis().select("g.y").append("text").attr("text-anchor","middle").attr("transform","translate(-"+(this.graphMargin.left-20)+", "+a/2+") rotate(-90)").text(c)},getCurrentTerms:function(){var a=[];this.down("[xtype\x3dlegend]").getStore().each(function(b){b.get("active")&&a.push(b.get("name"))},this);return a},initGraph:function(){if(void 0===this.getVisLayout()){var a=this.getLayout().getRenderTarget(),b=this.graphMargin.left+this.graphMargin.right,c=this.graphMargin.top+this.graphMargin.bottom,
d=a.getWidth()-b,e=a.getHeight()-c;this.setVisLayout(d3.layout.stack().offset("silhouette").values(function(a){return a.values}));this.setVis(d3.select(a.dom).append("svg").attr("id","streamGraph").attr("width",d+b).attr("height",e+c).append("g").attr("transform","translate("+this.graphMargin.left+","+this.graphMargin.top+")"))}}});Ext.define("Voyant.panel.Summary",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel","Voyant.util.SparkLine"],alias:"widget.summary",statics:{i18n:{},api:{stopList:"auto",start:0,limit:5,numberOfDocumentsForDistinctiveWords:10},glyph:"xf1ea@FontAwesome"},config:{corpus:void 0,options:{xtype:"stoplistoption"}},autoScroll:!0,cls:"corpus-summary",constructor:function(a){Ext.apply(this,{title:this.localize("title"),items:{itemId:"main",cls:"main",margin:10},dockedItems:[{dock:"bottom",xtype:"toolbar",
enableOverflow:!0,items:[{fieldLabel:this.localize("items"),labelWidth:40,width:120,xtype:"slider",increment:5,minValue:5,maxValue:59,listeners:{afterrender:function(a){a.setValue(this.getApiParam("visible"))},changecomplete:function(a,c){this.setApiParams({limit:c});this.loadSummary()},scope:this}}]}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("afterrender",function(){this.body.addListener("click",function(a){(a=a.getTarget(null,null,
!0))&&"A"==a.dom.tagName&&(a.hasCls("document-id")?(a=a.getAttribute("val","voyant"),a=this.getCorpus().getDocuments().getById(a),this.dispatchEvent("documentsClicked",this,[a])):a.hasCls("corpus-type")?this.dispatchEvent("termsClicked",this,[a.getHtml()]):a.hasCls("document-type")&&this.dispatchEvent("documentIndexTermsClicked",this,[{term:a.getHtml(),docIndex:a.getAttribute("docIndex","voyant")}]))},this)});this.on("loadedCorpus",function(a,c){this.setCorpus(c);if(this.rendered)this.loadSummary();
else this.on("afterrender",function(){this.loadSummary()},this)});a&&a.corpus&&this.fireEvent("loadedCorpus",this,a.corpus);this.on("resize",function(){var a=this.getWidth()-200;this.query("sparklineline").forEach(function(c){c.getWidth()>a&&c.setWidth(a)})},this)},loadSummary:function(){var a=this,b=this.queryById("main");b.removeAll();b.add({html:this.getCorpus().getString()});var c=this.getCorpus().getDocuments().getRange(),d=this.getApiParam("limit");if(1<c.length){c.sort(function(a,b){return b.getLexicalTokensCount()-
a.getLexicalTokensCount()});var e=new Ext.XTemplate('\x3ctpl for\x3d"." between\x3d"; "\x3e\x3ca href\x3d"#" onclick\x3d"return false" class\x3d"document-id" voyant:val\x3d"{id}" data-qtip\x3d"{title}"\x3e{shortTitle}\x3c/a\x3e\x3cspan style\x3d"font-size: smaller"\x3e (\x3cspan class\x3d"info-tip" data-qtip\x3d"{valTip}"\x3e{val}\x3c/span\x3e)\x3c/span\x3e\x3c/a\x3e\x3c/tpl\x3e'),f;25>c.length?f=4*c.length:50>c.length?f=2*c.length:100<c.length&&(f=b.getWidth()-200,f=f<c.length?c.length:f);var g=
this.localize("numberOfTerms");b.add({cls:"section",items:[{layout:"hbox",align:"bottom",items:[{html:this.localize("docsLength"),cls:"header"},{xtype:"sparklineline",values:this.getCorpus().getDocuments().getRange().map(function(a){return a.getLexicalTokensCount()}),tipTpl:new Ext.XTemplate("{[this.getDocumentTitle(values.x,values.y)]}",{getDocumentTitle:function(a,b){return"("+b+") "+this.panel.getCorpus().getDocument(a).getTitle()},panel:a}),height:16,width:f}]},{html:"\x3cul\x3e\x3cli\x3e"+this.localize("longest")+
e.apply(c.slice(0,c.length>d?d:parseInt(c.length/2)).map(function(a){return{id:a.getId(),shortTitle:a.getShortTitle(),title:a.getTitle(),val:a.getLexicalTokensCount(),valTip:g}}))+"\x3c/li\x3e\x3cli\x3e"+this.localize("shortest")+e.apply(c.slice(-(c.length>d?d:parseInt(c.length/2))).reverse().map(function(a){return{id:a.getId(),shortTitle:a.getShortTitle(),title:a.getTitle(),val:a.getLexicalTokensCount(),valTip:g}}))+"\x3c/li\x3e"}]});c.sort(function(a,b){return b.getLexicalTypeTokenRatio()-a.getLexicalTypeTokenRatio()});
b.add({cls:"section",items:[{layout:"hbox",align:"bottom",cls:"section",items:[{html:this.localize("docsDensity"),cls:"header"},{xtype:"sparklineline",values:this.getCorpus().getDocuments().getRange().map(function(a){return Ext.util.Format.number(a.getLexicalTypeTokenRatio(),"0.000")}),tipTpl:new Ext.XTemplate("{[this.getDocumentTitle(values.x,values.y)]}",{getDocumentTitle:function(a,b){return"("+b+") "+this.panel.getCorpus().getDocument(a).getTitle()},panel:a}),height:16,width:f}]},{html:"\x3cul\x3e\x3cli\x3e"+
this.localize("highest")+e.apply(c.slice(0,c.length>d?d:parseInt(c.length/2)).map(function(a){return{id:a.getId(),shortTitle:a.getShortTitle(),title:a.getTitle(),val:Ext.util.Format.number(a.getLexicalTypeTokenRatio(),"0.000"),valTip:g}}))+"\x3c/li\x3e\x3cli\x3e"+this.localize("lowest")+e.apply(c.slice(-(c.length>d?d:parseInt(c.length/2))).reverse().map(function(a){return{id:a.getId(),shortTitle:a.getShortTitle(),title:a.getTitle(),val:Ext.util.Format.number(a.getLexicalTypeTokenRatio(),"0.000"),
valTip:g}}))+"\x3c/li\x3e"}]})}b.add({html:this.localize("mostFrequentWords"),cls:"section",listeners:{afterrender:function(b){b.mask(a.localize("loading"));a.getCorpus().getCorpusTerms().load({params:{limit:a.getApiParam("limit"),stopList:a.getApiParam("stopList"),forTool:this.xtype},callback:function(a,c,d){d&&a&&0<a.length&&(b.unmask(),Ext.dom.Helper.append(b.getTargetEl().first().first(),(new Ext.XTemplate('\x3ctpl for\x3d"." between\x3d"; "\x3e\x3ca href\x3d"#" onclick\x3d"return false" class\x3d"corpus-type keyword" voyant:recordId\x3d"{id}"\x3e{term}\x3c/a\x3e\x3cspan style\x3d"font-size: smaller"\x3e ({val})\x3c/span\x3e\x3c/tpl\x3e')).apply(a.map(function(a){return{id:a.getId(),
term:a.getTerm(),val:a.getRawFreq()}}))))}})}},scope:this});1<c.length&&b.add({html:this.localize("mostFrequentWords")+"\x3col\x3e\x3c/ol\x3e",cls:"section",itemId:"distinctiveWords",listeners:{afterrender:function(b){a.showMoreDistinctiveWords()}},scope:this})},showMoreDistinctiveWords:function(){var a=this.queryById("distinctiveWords"),b=a.getTargetEl().selectNode("ol"),c=Ext.dom.Query.select("li:not(.more)",b).length,d=parseInt(this.getApiParam("numberOfDocumentsForDistinctiveWords")),e=this.getCorpus().getDocuments().getRange(c,
c+d-1);if(e&&Ext.isArray(e)){var f=[];e.forEach(function(a){f.push(a.getIndex())});0<f.length&&this.getCorpus().getDocumentTerms().load({addRecords:!0,params:{docIndex:f,perDocLimit:parseInt(this.getApiParam("limit")),limit:d*parseInt(this.getApiParam("limit")),stopList:this.getApiParam("stopList"),sort:"TFIDF",dir:"DESC",forTool:this.xtype},scope:this,callback:function(e,h,k){var m={};if(k&&e&&Ext.isArray(e)){e.forEach(function(a,b,c){b=a.getDocIndex();b in m||(m[b]=[]);m[b].push({id:a.getId(),docIndex:a.getDocIndex(),
type:a.getTerm(),val:Ext.util.Format.number(a.get("rawFreq"),"0,000"),docId:a.get("docId")})});var l;f.forEach(function(a){var c=this.getCorpus().getDocument(a);l=m[a].length;Ext.dom.Helper.append(b,{tag:"li","voyant:index":String(a),html:'\x3ca href\x3d"#" onclick\x3d"return false" class\x3d"document-id document-id-distinctive" voyant:val\x3d"'+c.get("id")+'"\x3e'+c.getShortTitle()+"\x3c/a\x3e"+this.localize("colon")+(new Ext.XTemplate(this.localize("documentType"))).apply({types:m[a]})+"."})},this);
a.updateLayout();l=d;remaining=this.getCorpus().getDocuments().getTotalCount()-c-f.length;if(0<remaining){e=new Ext.Template(this.localize("moreDistinctiveWords"));var n=Ext.dom.Helper.append(b,{tag:"li",cls:"more",html:e.apply([l>remaining?remaining:l,remaining])},!0);n.on("click",function(){n.remove();this.showMoreDistinctiveWords()},this)}}}})}}});Ext.define("Voyant.panel.TextualArc",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.textualarc",statics:{i18n:{},api:{stopList:"auto",docIndex:0,speed:50,minRawFreq:2},glyph:"xf06e@FontAwesome"},config:{corpus:void 0,options:[{xtype:"stoplistoption"},{xtype:"container",items:{xtype:"numberfield",name:"minRawFreq",minValue:1,maxValue:10,value:2,labelWidth:150,labelAlign:"right",initComponent:function(){var a=this.up("window").panel;this.fieldLabel=a.localize(this.fieldLabel);
this.on("afterrender",function(b){Ext.tip.QuickTipManager.register({target:b.getEl(),text:a.localize("minRawFreqTip")})});this.callParent(arguments)},fieldLabel:"minRawFreq"}}]},tokensFetch:500,constructor:function(){this.mixins["Voyant.util.Localization"].constructor.apply(this,arguments);this.config.options[1].fieldLabel=this.localize(this.config.options[1].fieldLabel);Ext.apply(this,{title:this.localize("title"),html:'\x3ccanvas width\x3d"800" height\x3d"600"\x3e\x3c/canvas\x3e',dockedItems:[{dock:"bottom",
xtype:"toolbar",enableOverflow:!0,items:[{xtype:"combo",itemId:"search",queryMode:"local",displayField:"term",valueField:"term",width:90,emptyText:this.localize("search"),forceSelection:!0,disabled:!0},{xtype:"documentselectorbutton",singleSelect:!0},{xtype:"slider",fieldLabel:this.localize("speed"),labelAlign:"right",labelWidth:40,width:100,increment:1,minValue:0,maxValue:100,value:30,listeners:{render:function(a){a.setValue(parseInt(this.getApiParam("speed")));Ext.tip.QuickTipManager.register({target:a.getEl(),
text:this.localize("speedTip")})},changecomplete:function(a,b){this.setApiParam("speed",b);this.isReading=0!==b;this.draw()},scope:this}},{xtype:"tbfill"},{xtype:"tbtext",html:this.localize("adaptation")}]}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("boxready",function(a){var b=this.getTargetEl().getWidth()-20-20,c=this.getTargetEl().getHeight()-20-20,d=Math.max(b,c),e=d/2,f=Math.min(b,c)/d,g=this.getTargetEl().dom.querySelector("canvas");
g.getContext("2d");g.width=this.getTargetEl().getWidth();g.height=this.getTargetEl().getHeight();this.diam=d;this.perim=[];for(var h=parseInt(.75*d);this.perim.length<d;)this.perim.push({x:20+b/2+e*(b>c?1:f)*Math.cos(2*Math.PI*h/d),y:20+c/2+e*(c>b?1:f)*Math.sin(2*Math.PI*h/d)}),h++==d&&(h=0);this.draw(g);g.addEventListener("mousemove",function(b){if(a.documentTerms){var c=g.getBoundingClientRect(),d=b.clientX-c.left,e=b.clientY-c.top,f={};a.documentTerms.each(function(a){var b=a.get("x"),c=a.get("y");
if(b>d-15&&b<d+15&&c>e-15&&c<e+15)return f[a.getTerm()]=!0,!1});if(0!=Object.keys(a.currentTerms||{}).length||0!=Object.keys(f).length)a.currentTerms=f,a.draw(g)}},!1)});this.on("loadedCorpus",function(a,b){this.setCorpus(b);this.loadDocument()},this);this.on("documentselected",function(a,b){this.setApiParam("docIndex",this.getCorpus().getDocument(b).getIndex());this.loadDocument()});this.on("resize",function(){})},draw:function(a,b){a=a||this.getTargetEl().dom.querySelector("canvas");b=b||a.getContext("2d");
b.clearRect(0,0,a.width,a.height);b.fillStyle="rgba(0,0,0,.1)";this.perim.forEach(function(a,c){0==c%3&&b.fillRect(a.x-5,a.y,10,1)});if(this.documentTerms&&(this.drawTerms(a,b),this.drawReading(a,b),this.isReading)){var c=this;setTimeout(function(){c.draw()},10)}},drawReading:function(a,b){b=b||this.getTargetEl().dom.querySelector("canvas").getContext("2d");var c=2E3-1999*parseInt(this.getApiParam("speed"))/100;if(this.isReading&&this.documentTerms){var d=parseInt(this.readingIndex*this.perim.length/
this.lastToken);b.fillStyle="purple";b.fillRect(this.perim[d].x,this.perim[d].y,5,5);var e=void 0==this.readingStartTime;this.readingStartTime=this.readingStartTime||(new Date).getTime();d=this.readingStartTime+c-(new Date).getTime();if(this.sourceTerm&&this.targetTerm){if(e||0>=d){this.previousBeziers=this.previousBeziers||[];var e=this.sourceTerm.get("x"),f=this.sourceTerm.get("y"),g=this.targetTerm.get("x"),h=this.targetTerm.get("y");this.previousTerm&&this.previousTerm.get("x");this.previousTerm&&
this.previousTerm.get("y");var k=Math.max(100,.5*Math.abs(e-g)),m=Math.max(100,.5*Math.abs(f-h));this.previousBeziers.unshift([e,f,e>g?e-k:e+k,h>f?f+m:f-m,g,h]);10<this.previousBeziers.length&&this.previousBeziers.pop()}for(e=0;e<this.previousBeziers.length;e++)b.strokeStyle="rgba(0,0,255,"+(1-.1*e)+")",this.drawBezierSplit.apply(this,Ext.Array.merge([b],this.previousBeziers[e],[e+1==this.previousBeziers.length?1-d/c:0],[0==e?1-d/c:1]));0>=d&&(this.readingStartTime=void 0,this.read())}e=this.readingIndex+
1;for(f=this.tokens.getCount();e<f&&this.tokens.getAt(e).getTerm().toLowerCase()!=this.targetTerm.getTerm();e++);c=e-parseInt(d*(e-this.readingIndex)/c);for(d=this.tokens.getCount();c<e&&!(c<d&&this.tokens.getAt(c).isWord());c++);c=this.tokens.getRange(c,f=Math.min(this.readingIndex+50,this.tokens.getCount())).map(function(a){return a.getTerm()});b.font="14px sans-serif";b.fillStyle="rgba(0,0,0,.5)";b.textAlign="left";b.fillText(c.join(""),a.width/4,a.height-5);b.clearRect(.75*a.width,a.height-20,
a.width,30)}else this.documentTerms&&this.documentTerms.getCount()<this.documentTerms.getTotalCount()&&(c=a.width/4,b.strokeStyle="rgba(0,0,0,.5)",b.fillStyle="rgba(0,0,0,.2)",b.strokeRect(c,a.height-12,2*c,10),b.fillRect(c,a.height-12,this.documentTerms.getCount()*c*2/this.documentTerms.getTotalCount(),10))},drawTerms:function(a,b){a=a||this.getTargetEl().dom.querySelector("canvas");b=b||a.getContext("2d");b.textAlign="center";this.documentTerms&&this.perim&&this.documentTerms.each(function(c){var d=
c.getRawFreq(),e=c.getTerm(),f=c.get("x"),g=c.get("y");isCurrentTerm=this.currentTerms&&e in this.currentTerms;isReadingTerm=this.sourceTerm&&this.sourceTerm.getTerm()==e;b.font=Math.log(d)*(10*a.width/800)/Math.log(this.maxRawFreq)+(isCurrentTerm||isReadingTerm?10:5)+"px sans-serif";b.fillStyle=isCurrentTerm?"red":isReadingTerm?"blue":"rgba(0,0,0,"+(.9*d/this.maxRawFreq+.1)+")";if(isCurrentTerm||isReadingTerm)b.strokeStyle=isCurrentTerm?"rgba(255,0,0,.2)":"rgba(0,255,0,.4)",c.getDistributions().forEach(function(a,
c){0<a&&this.perim[c]&&(b.beginPath(),b.moveTo(f,g),b.lineTo(this.perim[c].x,this.perim[c].y),b.stroke())},this);b.fillText(e,f,g)},this)},read:function(a){Ext.isNumber(a)?this.readingIndex=a:this.readingIndex++;this.sourceTerm&&(this.previousTerm=this.sourceTerm);a=this.readingIndex;for(var b=this.tokens.getCount();a<b;a++){var c=this.tokens.getAt(a),c=c.getTerm().toLowerCase();if(c in this.termsMap&&(this.sourceTerm=this.termsMap[c],1<=this.sourceTerm.getRawFreq())){this.readingIndex=a;break}}a=
this.readingIndex+1;for(b=this.tokens.getCount();a<b&&!(c=this.tokens.getAt(a),c=c.getTerm().toLowerCase(),c in this.termsMap&&(this.targetTerm=this.termsMap[c],1<=this.targetTerm.getRawFreq()));a++);!this.tokensLoading&&this.tokens.getCount()-this.readingIndex<this.tokensFetch&&this.fetchMoreTokens();this.draw()},loadDocument:function(){this.documentTerms&&(this.documentTerms.destroy(),this.documentTerms=void 0);this.termsMap={};this.draw();var a=this.getCorpus().getDocument(parseInt(this.getApiParam("docIndex")));
this.setTitle(this.localize("title")+" \x3cspan class\x3d'subtitle'\x3e"+a.getFullLabel()+"\x3c/span\x3e");this.lastToken=parseInt(a.get("lastTokenStartOffset-lexical"));this.documentTerms=a.getDocumentTerms({proxy:{extraParams:{stopList:this.getApiParam("stopList"),bins:this.diam,withDistributions:"raw",minRawFreq:parseInt(this.getApiParam("minRawFreq"))}}});a=this.queryById("search");a.setDisabled(!0);a.setStore(this.documentTerms);this.fetchMoreDocumentTerms()},fetchMoreDocumentTerms:function(){this.documentTerms?
this.documentTerms.load({params:{start:this.documentTerms.getCount(),limit:0==this.documentTerms.getCount()?10:250},callback:function(a){0<a.length?(this.maxRawFreq=this.documentTerms.max("rawFreq"),a.forEach(function(a){var c=y=0;a.get("distributions").forEach(function(a,b){c+=this.perim[b].x*a;y+=this.perim[b].y*a},this);a.set("x",c/a.getRawFreq());a.set("y",y/a.getRawFreq())},this),Ext.Function.defer(this.fetchMoreDocumentTerms,0,this),this.draw()):(this.queryById("search").setDisabled(!1),this.termsMap=
{},this.documentTerms.each(function(a){this.termsMap[a.getTerm()]=a},this),this.tokens&&this.tokens.removeAll(!0),this.fetchMoreTokens())},addRecords:!0,scope:this}):this.loadDocument()},fetchMoreTokens:function(){if(!this.tokens)this.tokens=this.getCorpus().getDocument(parseInt(this.getApiParam("docIndex"))).getTokens({proxy:{extraParams:{stripTags:"all"}}}),this.noMoreTokens=!1;else if(this.noMoreTokens)return;var a=0==this.tokens.getCount();this.tokensLoading=!0;var b=parseInt(this.getApiParam("speed"));
this.tokens.load({params:{start:this.tokens.getCount(),limit:50==b&&a?200:Math.pow(110-b,2)},callback:function(b){this.tokensLoading=!1;0<b.length?(b.forEach(function(a){"other"==a.getTokenType()&&a.set("term",a.getTerm().replace(/\s+/g," "))}),a&&(this.previousBeziers=[],this.isReading=!0,this.read(0))):this.noMoreTokens=!0},addRecords:!0,scope:this})},animatePathDrawing:function(a,b,c,d,e,f,g,h){var k=null,m=function(l){null===k&&(k=l);l=Math.min((l-k)/h,1);a.clearRect(0,0,a.canvas.width,a.canvas.height);
drawBezierSplit(a,b,c,d,e,f,g,0,l);1>l&&window.requestAnimationFrame(m)};window.requestAnimationFrame(m)},drawBezierSplit:function(a,b,c,d,e,f,g,h,k){a.beginPath();if(0==h&&1==k)a.moveTo(b,c),a.quadraticCurveTo(d,e,f,g);else if(h!=k){var m=h*h,l=1-h,n=l*l,q=2*h*l,s=n*b+q*d+m*f,p=n*c+q*e+m*g,m=k*k,l=1-k,n=l*l,q=2*k*l,l=n*b+q*d+m*f,m=n*c+q*e+m*g;b=this.lerp(this.lerp(b,d,h),this.lerp(d,f,h),k);c=this.lerp(this.lerp(c,e,h),this.lerp(e,g,h),k);a.moveTo(s,p);a.quadraticCurveTo(b,c,l,m)}a.stroke();a.closePath()},
lerp:function(a,b,c){return(1-c)*a+c*b}});Ext.define("Voyant.panel.TopicContexts",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.topiccontexts",statics:{i18n:{},api:{},glyph:"xf06e@FontAwesome"},constructor:function(a){Ext.apply(this,{title:this.localize("title"),cls:"twic_body"});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},listeners:{loadedCorpus:function(a,b){this.loadFromCorpus(b)}},loadFromCorpus:function(a){a=Ext.Loader.getPath("resources")+"/twic/current/data/input/json";
var b=TWiC.Level.prototype.Instance();b.LoadJSON(a+"/twic_corpusinfo.json",a+"/twic_corpusmap.json");var c=this;b.m_queue.await(function(){var a=[],e=[],f=new TWiC.TopicBar({x:0,y:635},{width:1280,height:165},"dickinson",b,[]);e.push(f);var g=new TWiC.DocumentBar({x:1055,y:0},{width:225,height:635},"dickinson",b,[]);e.push(g);g=new TWiC.CorpusClusterView({x:0,y:0},{width:1055,height:635},"dickinson",b,[f,g]);a.push(g);f.m_linkedViews.push(g);f=c.getLayout().getRenderTarget();b.Initialize([0,0],{width:f.getWidth(),
height:f.getHeight()},"dickinson",a,e,"#"+f.getId());b.Start()}.bind(b))}});Ext.define("Voyant.panel.TermsRadio",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.termsradio",config:{corpus:void 0,options:[{xtype:"stoplistoption"}],speed:50},statics:{i18n:{},api:{withDistributions:!0,bins:5,visibleBins:5,docIdType:null,limit:50,mode:null,position:0,selectedWords:[],stopList:"auto",query:null,yAxisScale:"log",speed:50},glyph:"xf201@FontAwesome"},absMaxFreq:0,absMinFreq:0,allData:[],chart:null,theme:Ext.create("Ext.chart.theme.Base"),colorIndex:[],colorMasterList:[],
continueTransition:!0,counterSeries:[],displayData:[],dragged:!1,isTransitioning:!1,lastSlippery:null,lastSticky:null,maxFont:30,minFreq:0,numDataPoints:0,numVisPoints:5,overlayQueue:[],records:0,recordsLength:0,reselectTop:!1,shiftCount:0,sliderDragSum:0,titlesArray:[],transitionCall:"draw",valFraction:1,win:0,bPadding:25,lPadding:40,rPadding:20,tPadding:20,navigationHeight:100,largestW:0,largestH:0,constructor:function(a){this.colorMasterList=this.theme.getColors();for(var b=0;b<this.colorMasterList.length;b++)this.colorIndex.push(this.colorMasterList[b]);
b=function(a,b,e,f,g){this.setApiParams({mode:a});if(a=this.getApiParam("query"))0==e.length||1==e.length&&0==e[0].getRawFreq()?this.toastInfo({html:this.localize("termNotFound"),align:"bl"}):(e=null,"document"===this.getApiParam("mode")&&(e=this.getCorpus().getDocument(0).getId()),e=this.buildParamsBundle({wordString:a,docId:e}),this.manageOverlaySticky(e));else{this.initData(e);this.prepareData();for(e=this.shiftCount;0<e--;)this.displayData.shift();null!=this.chart?this.redraw():this.initializeChart();
this.redrawSliderOverlay()}};this.corpusStore=Ext.create("Voyant.data.store.CorpusTerms",{listeners:{load:{fn:b.bind(this,"corpus"),scope:this}}});this.documentStore=Ext.create("Voyant.data.store.DocumentTerms",{listeners:{load:{fn:b.bind(this,"document"),scope:this}}});Ext.apply(a,{title:this.localize("title"),legendMenu:Ext.create("Ext.menu.Menu",{items:[{text:"",itemId:"remove",glyph:"xf068@FontAwesome"}]}),tbar:new Ext.Toolbar({enableOverflow:!0,items:{xtype:"legend",store:new Ext.data.JsonStore({fields:["name",
"mark"]}),listeners:{itemclick:function(a,b,e,f){a=b.get("name");this.isTermSelected(a)?this.doTermDeselect(a):this.doTermSelect(a)},itemcontextmenu:function(a,b,e,f,g){g.preventDefault();a=g.getXY();var h=b.get("name");b=(new Ext.Template(this.localize("removeTerm"))).apply([h]);this.legendMenu.queryById("remove").setText(b);this.legendMenu.on("click",function(a,b){void 0!==b&&this.doTermDeselect(h,!0)},this,{single:!0});this.legendMenu.showAt(a)},scope:this}}}),bbar:{enableOverflow:!0,items:[{xtype:"querysearchfield"},
{glyph:"xf04b@FontAwesome",itemId:"play",handler:function(a){"xf04c@FontAwesome"==a.glyph?(this.continueTransition=!1,this.mask(this.localize("completingTransition")),a.setPlaying(!1)):(this.toggleRightCheck(),a.setPlaying(!0))},scope:this,setPlaying:function(a){this.setGlyph(a?"xf04c@FontAwesome":"xf04b@FontAwesome")}},{glyph:"xf0e2@FontAwesome",tooltip:this.localize("resetTip"),listeners:{click:{fn:function(){this.queryById("play").setPlaying(!1);this.shiftCount=0;this.prepareData();this.redraw()},
scope:this}}},{xtype:"label",forId:"terms",text:this.localize("terms")},{xtype:"slider",itemId:"terms",hideLabel:!0,width:60,increment:5,minValue:5,maxValue:100,listeners:{afterrender:function(a){a.setValue(parseInt(this.getApiParam("limit")))},changecomplete:function(a,b){this.setApiParams({limit:b});this.loadStore()},scope:this}},{xtype:"label",forId:"speed",text:this.localize("speed")},{xtype:"slider",itemId:"speed",hideLabel:!0,width:60,increment:5,minValue:5,maxValue:100,listeners:{afterrender:function(a){a.setValue(parseInt(this.getApiParam("speed")));
this.setSpeed(a.getValue())},changecomplete:function(a,b){this.setApiParams({speed:b});this.setSpeed(b)},scope:this}},{xtype:"label",itemId:"visibleSegmentsLabel",forId:"visibleBins",text:this.localize("visibleSegments")},{xtype:"slider",itemId:"visibleBins",hideLabel:!0,width:60,increment:1,minValue:1,maxValue:100,listeners:{afterrender:function(a){a.setValue(parseInt(this.getApiParam("visibleBins")))},changecomplete:function(a,b){this.setApiParams({visibleBins:b});this.numVisPoints=b;this.loadStore()},
scope:this}},{xtype:"label",itemId:"segmentsLabel",forId:"segments",text:this.localize("segments")},{xtype:"slider",itemId:"segments",hideLabel:!0,width:60,increment:1,minValue:1,maxValue:100,listeners:{afterrender:function(a){a.setValue(parseInt(this.getApiParam("bins")))},changecomplete:function(a,b){this.setApiParams({bins:b});this.numDataPoints=b;this.loadStore();this.queryById("visibleBins").setMaxValue(b)},scope:this}}]}});this.config.options.push({xtype:"combo",queryMode:"local",triggerAction:"all",
forceSelection:!0,editable:!1,fieldLabel:this.localize("yScale"),labelAlign:"right",name:"yAxisScale",valueField:"value",displayField:"name",store:new Ext.data.JsonStore({fields:["name","value"],data:[{name:this.localize("linear"),value:"linear"},{name:this.localize("log"),value:"log"}]}),listeners:{render:function(a){a.setValue(this.getApiParam("yAxisScale"))},scope:this}});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.addListener("corpusTermsClicked",
function(a,b){1<this.getCorpus().getDocumentsCount()&&b.forEach(function(a){a=a.getTerm();this.setApiParams({query:a});this.loadStore()})});this.addListener("documentTermsClicked",function(a,b){if(a&&a.xtype==this.xtype)return!1;b.forEach(function(a){a=a.getTerm();this.setApiParams({query:a});this.loadStore()})});this.on("query",function(a,b){Ext.isString(b)&&this.fireEvent("termsClicked",a,[b])});this.on("termsClicked",function(a,b){b.forEach(function(a){var b;Ext.isString(a)?b=a:a.term?b=a.term:
a.getTerm&&(b=a.getTerm());this.setApiParams({query:b});this.loadStore()},this)});this.on("loadedCorpus",function(a,b){this.setCorpus(b);this.documentStore.setCorpus(b);this.corpusStore.setCorpus(b);var e=this.getApiParams();e.type&&delete e.limit;var f,g=this.getCorpus().getDocumentsCount(),h=this.queryById("segments"),k=this.queryById("visibleBins");"document"==e.mode||1==g?(this.setApiParam("mode","document"),f=this.documentStore,k.setMaxValue(h.getValue())):(this.setApiParam("mode","corpus"),
delete e.bins,f=this.corpusStore,h.hide(),this.queryById("segmentsLabel").hide(),k=this.queryById("visibleBins"),k.setMaxValue(g),parseInt(this.getApiParam("visibleBins")>g)&&k.setValue(g));f.on("load",function(a,b){for(var c=0;3>c;c++){var d=b[c],d={wordString:d.get("term"),docId:d.get("docId")},d=this.buildParamsBundle(d);this.manageOverlaySticky(d)}},this,{single:!0});f.load({params:e})},this);this.addListener("resize",function(){if(this.chart){var a=this.body.getHeight(),b=this.body.getWidth();
this.chart.attr("height",a).attr("width",b);this.setTitleLength();this.largestH<a&&this.largestW<b&&(this.chart.select("rect[class\x3dclipping-rectangle]").attr("x",0).attr("y",this.navigationHeight+2*this.tPadding).attr("width",b).attr("height",a-this.navigationHeight),this.largestH=a,this.largestW=b);this.redraw();this.redrawSliderOverlay()}},this)},loadStore:function(){this.queryById("play").setPlaying(!1);var a=this.getApiParams();"document"===this.getApiParam("mode")&&this.documentStore.load({params:a});
"corpus"===this.getApiParam("mode")&&(delete a.bins,this.corpusStore.load({params:a}))},initData:function(a){this.records=a;this.recordsLength=this.records.length;this.numVisPoints=parseInt(this.getApiParam("visibleBins"));this.shiftCount=parseInt(this.getApiParam("position"));"document"===this.getApiParam("mode")?(this.numDataPoints=this.records[0].get("distributions").length,this.numDataPoints!==this.getApiParam("bins")&&(this.numDataPoints=parseInt(this.getApiParam("bins")),this.loadStore())):
this.numDataPoints=this.records[0].get("distributions").length;this.counterSeries=[];a=[];for(var b=this.absMaxFreq=0;b<this.numDataPoints;b++)for(var c=0;c<this.recordsLength;c++)this.records[c].get("distributions")[b]>this.absMaxFreq&&(this.absMaxFreq=this.records[c].get("distributions")[b]);this.absMinFreq=this.absMaxFreq;for(b=0;b<this.numDataPoints;b++)for(c=0;c<this.recordsLength;c++)this.records[c].get("distributions")[b]<=this.absMinFreq&&0!==this.records[c].get("distributions")[b]&&(this.absMinFreq=
this.records[c].get("distributions")[b]);0>this.absMinFreq&&(this.absMinFreq=0);this.minFreq=1.01*this.absMinFreq;for(b=0;b<this.numDataPoints;b++){for(c=0;c<this.recordsLength;c++){var d=this.records[c],e=d.get("distributions")[b];0<e&&a.push({freq:e,wordString:d.get("term"),counter:b,posInSeries:0,numInSeries:0,docId:d.get("docId")})}this.counterSeries.push(a);a=[]}},prepareData:function(){var a=[],b=[],c=[],d=[];this.allData=[];this.displayData=[];this.numDataPoints<this.numVisPoints&&(this.numVisPoints=
this.numDataPoints);this.shiftCount+this.numVisPoints>this.numDataPoints&&(this.shiftCount=this.numDataPoints-this.numVisPoints);for(var e=0;e<this.numDataPoints;e++){for(var f=0,g=0;g<this.counterSeries[e].length;g++){var h=0;0===f&&(b.push(this.counterSeries[e][g]),c.push({freq:this.counterSeries[e][g].freq,frequencyArray:b,numInSeries:0}),a.push(c),b=[],c=[],h=f=1);for(var k=0;k<a[e].length&&0===h;k++)this.counterSeries[e][g].freq===a[e][k].freq&&(h=0,h=a[e][k].numInSeries,this.counterSeries[e][g].posInSeries=
++h,a[e][k].numInSeries=h,a[e][k].frequencyArray.push(this.counterSeries[e][g]),h=1);0===h&&(d.push(this.counterSeries[e][g]),a[e].push({freq:this.counterSeries[e][g].freq,frequencyArray:d,numInSeries:0}),d=[])}(1>this.counterSeries[e].length||0===f)&&a.push([])}for(e=0;e<this.numDataPoints;e++)for(g=0;g<a[e].length;g++)for(++a[e][g].numInSeries,k=0;k<a[e][g].frequencyArray.length;k++)a[e][g].frequencyArray[k].numInSeries=a[e][g].numInSeries;for(e=0;e<this.numDataPoints;e++)this.allData.push({allDataInternal:a[e],
outerCounter:e});a=[];b=[];for(e=0;e<this.numVisPoints+this.shiftCount;e++){for(g=0;g<this.recordsLength;g++)this.allData[e].allDataInternal[g]&&b.push({freq:this.allData[e].allDataInternal[g].freq,inSeries:this.allData[e].allDataInternal[g].numInSeries,frequencyArray:this.allData[e].allDataInternal[g].frequencyArray,dotObject:[{counter:e,freq:this.allData[e].allDataInternal[g].freq}]});a.push(b);b=[]}for(e=0;e<this.numVisPoints+this.shiftCount;e++)this.displayData.push({displayInternal:a[e],outerCounter:e})},
manageMvtButtons:function(){this.queryById("play").setPlaying(this.isTransitioning)},nextR:function(){for(var a=[],b=0;b<this.recordsLength;b++)this.allData[this.numVisPoints+this.shiftCount].allDataInternal[b]&&a.push({freq:this.allData[this.numVisPoints+this.shiftCount].allDataInternal[b].freq,inSeries:this.allData[this.numVisPoints+this.shiftCount].allDataInternal[b].numInSeries,frequencyArray:this.allData[this.numVisPoints+this.shiftCount].allDataInternal[b].frequencyArray,dotObject:[{counter:this.numVisPoints+
this.shiftCount,freq:this.allData[this.numVisPoints+this.shiftCount].allDataInternal[b].freq}]});this.displayData.push({displayInternal:a,outerCounter:this.numVisPoints+this.shiftCount})},toggleRightCheck:function(){this.numVisPoints+this.shiftCount<this.numDataPoints?(this.continueTransition=this.isTransitioning=!0,this.manageMvtButtons(),this.nextR(),this.shiftCount=++this.shiftCount,this.manageXScale(),this.setApiParams({position:this.shiftCount}),this.transitionCall="right",this.animateVis(),
this.displayData.shift()):(this.continueTransition=this.isTransitioning=!1,this.manageMvtButtons())},nextL:function(){for(var a=[],b=0;b<this.recordsLength;b++)this.allData[this.shiftCount].allDataInternal[b]&&a.push({freq:this.allData[this.shiftCount].allDataInternal[b].freq,inSeries:this.allData[this.shiftCount].allDataInternal[b].numInSeries,frequencyArray:this.allData[this.shiftCount].allDataInternal[b].frequencyArray,dotObject:[{counter:this.shiftCount,freq:this.allData[this.shiftCount].allDataInternal[b].freq}]});
this.displayData.unshift({displayInternal:a,outerCounter:this.shiftCount})},startScroll:function(){var a=this;a.numDataPoints>a.numVisPoints&&0===a.shiftCount&&(a.isTransitioning=!0,this.manageMvtButtons(),setTimeout(function(){a.toggleRightCheck()},3E3))},initializeChart:function(){this.initChart();this.drawXAxis();this.drawYAxis();this.drawChart();this.drawSlider();this.drawVerticalSlider();this.transitionCall="draw"},redraw:function(){this.transitionCall="redraw";this.updateFullPath();this.redrawXAxis();
this.redrawYAxis();this.redrawChart();this.redrawSlider();this.redrawVerticalSlider();this.redrawChartOverlay()},initChart:function(){var a=this.body.query("div[class$\x3dinnerCt]",!1)[0],b=a.getHeight(),c=a.getWidth(),a=a.appendChild(Ext.DomHelper.createDom('\x3csvg class\x3d"chart" width\x3d"'+c+'" height\x3d"'+b+'"\x3e\x3c/svg\x3e'),!0);this.chart=d3.select(a);this.largestW=c;this.largestH=b-this.navigationHeight;this.chart.append("clipPath").attr("id","clip1").append("rect").attr("class","clipping-rectangle").attr("x",
0).attr("y",this.navigationHeight+2*this.tPadding).attr("width",c).attr("height",b-this.navigationHeight);this.chart.append("g").attr("class","overlay").attr("clip-path","url(#clip1)");this.setTitleLength()},xAxis:{},xAxisScale:d3.svg.axis(),drawXAxis:function(){var a=this,b=this.body.getHeight();this.body.getWidth();this.manageAllXScales();this.xAxisScale.scale(a.xScale).orient("bottom").ticks(Math.round(a.numVisPoints)).tickFormat(function(b){var d;"document"===a.getApiParam("mode")&&(d="Segment "+
(parseInt(b)+1));"corpus"===a.getApiParam("mode")&&(d=b+1+". "+a.titlesArray[b]);return d});this.xAxis=this.chart.append("g").attr("class","axisX").attr("transform","translate(0,"+(b-this.bPadding)+")").call(this.xAxisScale);this.styleXAxis()},styleXAxis:function(){this.xAxis.selectAll("text").style("font-family","sans-serif").style("font-size","11px");this.xAxis.selectAll("line").style("fill","none").style("stroke","black").style("shape-rendering","crispEdges");this.xAxis.selectAll("path").style("fill",
"none").style("stroke","black").style("shape-rendering","crispEdges")},redrawXAxis:function(){this.chart.selectAll("g[class\x3daxisX]").remove();this.drawXAxis()},yAxis:{},yAxisScale:d3.svg.axis(),drawYAxis:function(){this.body.getHeight();var a=this.body.getWidth();this.manageAllYScales();var b=d3.scale.linear().domain([200,700]).range([5,15]),c=d3.format(".2r");this.yAxisScale.scale(this.yScale).orient("left").ticks(b(this.body.getHeight())).tickFormat(function(a){var b=Math.log(a)/Math.log(10)+
1E-6;return.7>Math.abs(b-Math.floor(b))?c(a):""}).tickSize(-a+this.rPadding+this.lPadding);this.yAxis=this.chart.append("g").attr("class","axisY").attr("transform","translate("+this.lPadding+",0)").call(this.yAxisScale);this.yAxis.selectAll("text").style("font-family","sans-serif").style("font-size","11px");this.yAxis.selectAll("line").style("fill","none").style("stroke","black").style("shape-rendering","crispEdges").style("stroke-opacity",.05);this.yAxis.selectAll("path").style("fill","none").style("stroke",
"black").style("shape-rendering","crispEdges")},redrawYAxis:function(){this.chart.selectAll("g[class\x3daxisY]").remove();this.drawYAxis()},drawChart:function(){var a=this;this.chart.selectAll("g[class\x3dsection]").data(a.displayData,function(a){return a.outerCounter}).enter().append("g").attr("class","section").attr("clip-path","url(#clip1)").selectAll("g").data(function(a){return a.displayInternal}).enter().append("g").attr("class","frequencies").on("mouseover",function(){d3.select(this).style("fill",
"red")}).on("mouseout",function(){d3.select(this).style("fill","black")}).selectAll("text").data(function(a){return a.frequencyArray}).enter().append("text").attr("class",function(b){return a.removeFilteredCharacters(b.wordString)}).attr("x",function(b){var c=.5/b.numInSeries-.5,d=b.posInSeries/b.numInSeries*.8;b=b.counter+a.callOffset()+c+d;return a.xScale(b)}).attr("y",function(b){return a.yScale(b.freq)}).attr("text-anchor","middle").attr("transform",function(b){var c=.5/b.numInSeries-.5,d=b.posInSeries/
b.numInSeries*.8,c=b.counter+a.callOffset()+c+d;b=b.freq;return"translate(0, 0) rotate(-20 "+a.xScale(c)+" "+a.yScale(b)+")"}).style("font-size",function(b){return a.fontScale(b.freq)+"px"}).style("fill-opacity",function(b){return a.opacityScale(b.freq)}).text(function(a){return a.wordString}).on("mouseover",function(b){d3.select(this).style("cursor","pointer").style("font-size",function(b){return a.fontScale(b.freq)*a.maxFont/a.fontScale(b.freq)+"px"});b=a.buildParamsBundle(b);a.manageOverlaySlippery(b)}).on("mouseout",
function(b){d3.select(this).style("cursor","auto").style("font-size",function(b){return a.fontScale(b.freq)+"px"});b=a.buildParamsBundle(b);a.manageOverlaySlippery(b)}).on("click",function(b){b=a.buildParamsBundle(b);a.manageOverlaySticky(b)}).append("title").text(function(a){return a.wordString})},redrawChart:function(){this.chart.selectAll("g[class\x3dsection]").remove();this.drawChart()},drawVerticalSlider:function(){},redrawVerticalSlider:function(){this.chart.selectAll("rect[class\x3dminimap]").remove();
this.drawVerticalSlider()},drawSlider:function(){this.body.getHeight();var a=this.body.getWidth()-(this.rPadding+this.lPadding),b=this.lPadding,c=this.lPadding+(this.numVisPoints-1)/(this.numDataPoints-1)*a;this.chart.append("line").attr("class","sliderAxis").attr("x1",this.lPadding).attr("x2",this.body.getWidth()-this.rPadding).attr("y1",this.tPadding+this.navigationHeight).attr("y2",this.tPadding+this.navigationHeight).style("shape-rendering","crispEdges").style("stroke","black").style("stroke-width",
"1");this.chart.append("line").attr("class","sliderAxis").attr("x1",this.lPadding).attr("x2",this.lPadding).attr("y1",this.tPadding+this.navigationHeight).attr("y2",this.tPadding).style("shape-rendering","crispEdges").style("stroke","black").style("stroke-width","1");this.chart.append("line").attr("class","slider").attr("id","before").attr("x1",a*(this.shiftCount-this.callOffset())/(this.numDataPoints-1)+b).attr("x2",a*(this.shiftCount-this.callOffset())/(this.numDataPoints-1)+b).attr("y1",this.tPadding+
this.navigationHeight).attr("y2",this.tPadding).style("stroke","black").style("stroke-width","1");this.chart.append("line").attr("class","slider").attr("id","after").attr("x1",a*(this.shiftCount-this.callOffset())/(this.numDataPoints-1)+c).attr("x2",a*(this.shiftCount-this.callOffset())/(this.numDataPoints-1)+c).attr("y1",this.tPadding+this.navigationHeight).attr("y2",this.tPadding).style("stroke","black").style("stroke-width","1");var b=this.chart.append("rect").attr("class","slider").attr("id",
"boxBefore").attr("x",this.lPadding).attr("y",this.tPadding).attr("height",this.navigationHeight).attr("width",a*(this.shiftCount-this.callOffset())/(this.numDataPoints-1)).style("fill","silver").style("fill-opacity",.25).style("cursor","move"),a=this.chart.append("rect").attr("class","slider").attr("id","boxAfter").attr("x",a*(this.shiftCount-this.callOffset())/(this.numDataPoints-1)+c).attr("y",this.tPadding).attr("height",this.navigationHeight).attr("width",a*(this.numDataPoints-this.numVisPoints-
this.shiftCount+this.callOffset())/(this.numDataPoints-1)).style("fill","silver").style("fill-opacity",.25).style("cursor","move"),d=this,c=d3.behavior.drag().origin(Object).on("drag",function(a){if(!d.isTransitioning){this.drag=!0;a=d.getWidth();var b=parseInt(d3.event.dx),c,h;d.sliderDragSum+=d3.event.dx;d.chart.selectAll("#before").attr("x1",function(){c=parseInt(this.getAttribute("x1"));parseInt(this.getAttribute("x1"));return parseInt(this.getAttribute("x1"))});d.chart.selectAll("#after").attr("x1",
function(){h=parseInt(this.getAttribute("x1"));return parseInt(this.getAttribute("x1"))});if(c+b<d.lPadding||h+b>a-d.rPadding)b=0;d.chart.select("#boxBefore").attr("width",function(){return parseInt(this.getAttribute("width"))+b});d.chart.select("#boxAfter").attr("x",function(){return parseInt(this.getAttribute("x"))+b}).attr("width",function(){return parseInt(this.getAttribute("width"))-b});d.chart.selectAll("#before").attr("x1",function(){return parseInt(this.getAttribute("x1"))+b}).attr("x2",function(){return parseInt(this.getAttribute("x2"))+
b});d.chart.selectAll("#after").attr("x1",function(){return parseInt(this.getAttribute("x1"))+b}).attr("x2",function(){return parseInt(this.getAttribute("x2"))+b})}}).on("dragend",function(a){if(this.drag){this.drag=!1;a=d3.scale.linear().domain([0,d.body.getWidth()-(d.lPadding+d.rPadding)]).range([0,d.numDataPoints])(d.sliderDragSum);var b,c=d.shiftCount;0<a&&(b=Math.floor(a));0>a&&(b=Math.ceil(a));d.shiftCount+=b;0>d.shiftCount&&(d.shiftCount=0);d.shiftCount>d.numDataPoints-1&&(d.shiftCount=d.numDataPoints-
1);d.shiftCount!==c&&(d.sliderDragSum=0,d.setApiParams({position:d.shiftCount}),d.prepareData(),d.redraw())}});b.call(c);a.call(c)},redrawSlider:function(){this.chart.selectAll("rect[class\x3dslider]").remove();this.chart.selectAll("line[class\x3dslider]").remove();this.chart.selectAll("line[class\x3dsliderAxis]").remove();this.drawSlider()},animateVis:function(){var a=this;this.getApiParam("mode");this.body.getHeight();var b=this.body.getWidth(),c=this.getDuration();if("left"===this.transitionCall||
"right"===this.transitionCall){this.xAxis.transition().duration(c).ease("linear").call(this.xAxisScale);this.styleXAxis();this.drawChart();this.chart.selectAll(".frequencies").transition().duration(c).ease("linear").selectAll("text").attr("x",function(b){return a.xScale(b.counter+(.5/b.numInSeries-.5)+b.posInSeries/b.numInSeries*.8)}).attr("transform",function(b){var c=b.freq;return"translate(0, 0) rotate(-20 "+a.xScale(b.counter+(.5/b.numInSeries-.5)+b.posInSeries/b.numInSeries*.8)+" "+a.yScale(c)+
")"});var b=b-(this.rPadding+this.lPadding),d=this.lPadding,e=this.lPadding+(this.numVisPoints-1)/(this.numDataPoints-1)*b;this.chart.select("#before").transition().duration(c).ease("linear").attr("x1",b*this.shiftCount/(this.numDataPoints-1)+d).attr("x2",b*this.shiftCount/(this.numDataPoints-1)+d).attr("y1",this.tPadding+this.navigationHeight).attr("y2",this.tPadding).each("end",function(){a.isMasked()&&a.unmask();a.continueTransition?setTimeout(function(){a.callTransition()},50):(a.isTransitioning=
!1,a.manageMvtButtons())});this.chart.select("#after").transition().duration(c).ease("linear").attr("x1",b*this.shiftCount/(this.numDataPoints-1)+e).attr("x2",b*this.shiftCount/(this.numDataPoints-1)+e).attr("y1",this.tPadding+this.navigationHeight).attr("y2",this.tPadding);this.chart.select("#boxBefore").transition().duration(c).ease("linear").attr("x",this.lPadding).attr("y",this.tPadding).attr("height",this.navigationHeight).attr("width",b*this.shiftCount/(this.numDataPoints-1));this.chart.select("#boxAfter").transition().duration(c).ease("linear").attr("x",
b*this.shiftCount/(this.numDataPoints-1)+e).attr("y",this.tPadding).attr("height",this.navigationHeight).attr("width",b*(this.numDataPoints-this.numVisPoints-this.shiftCount)/(this.numDataPoints-1))}this.redrawChartOverlay()},callTransition:function(){"left"===this.transitionCall&&this.toggleLeftCheck();"right"===this.transitionCall&&this.toggleRightCheck()},buildParamsBundle:function(a){var b=a.wordString,c={},d={};"document"===this.getApiParam("mode")&&(a=a.docId,d=this.getCorpus().getDocument(a).get("totalTokens")-
1,c.tokenIdStart=parseInt(this.category*d/this.numDataPoints),c.docIdType=a+":"+b);return d={params:c,type:b}},manageOverlaySlippery:function(a){for(var b=a.type,c=this.removeFilteredCharacters(a.type),d="on",e=this.overlayQueue.length;0<=--e;)c===this.overlayQueue[e].selector&&(d="off");c===this.lastSticky&&(d="off",this.lastSticky=null);"on"===d&&(c!==this.lastSlippery?(d=this.prepareFullPath(b),a={word:b,selector:c,params:a,fullPath:d.path,pathMin:d.min,pathMax:d.max,colour:"red"},null!==this.lastSlippery&&
(this.chartOverlayOff(this.lastSlippery),this.sliderOverlayOff(this.lastSlippery),this.lastSlippery=null),this.chartOverlayOn(a),this.sliderOverlayOn(a),this.lastSlippery=c):(this.chartOverlayOff(c),this.sliderOverlayOff(this.lastSlippery),this.lastSlippery=null))},manageOverlaySticky:function(a){a=a.type;this.transitionCall="draw";this.isTermSelected(a)?this.doTermDeselect(a,!0):this.doTermSelect(a,!0)},getTermIndex:function(a){var b=-1;a=a=this.removeFilteredCharacters(a);for(var c=this.overlayQueue.length;0<=
--c;)a===this.overlayQueue[c].selector&&(b=c);return b},isTermSelected:function(a){return-1!==this.getTermIndex(a)},doTermSelect:function(a,b){var c=c=this.removeFilteredCharacters(a),d=this.getApiParam("selectedWords");d.push(a);this.setApiParams({selectedWords:d});d=this.colorIndex[0];this.colorIndex.shift();if(!0===b){var e=this.query("[xtype\x3dlegend]")[0];e.getStore().add({name:a,mark:d})}else{var e=this.query("[xtype\x3dlegend]")[0],f=e.getStore().findRecord("name",a);null!==f&&(f.set("mark",
d),e.refresh())}if(0===this.colorIndex.length)for(e=0;e<this.colorMasterList.length;e++)this.colorIndex.push(this.colorMasterList[e]);e=this.prepareFullPath(a);d={word:a,selector:c,params:{params:{},type:a},fullPath:e.path,pathMin:e.min,pathMax:e.max,colour:d};c===this.lastSlippery&&(this.sliderOverlayOff(c),this.lastSlippery=null);this.chart.select("g[class\x3dfrequency-line-"+c+"]").remove();this.overlayQueue.push(d);this.chartOverlayOn(d);this.sliderOverlayOn(d)},doTermDeselect:function(a,b){var c=
this.removeFilteredCharacters(a),d=this.getTermIndex(a);if(!0===b){var e=this.query("[xtype\x3dlegend]")[0],d=e.getStore().findExact("name",a);e.getStore().removeAt(d)}for(var e=this.getApiParam("selectedWords"),f=0,g=e.length;f<g;f++)e[f]===c&&(e.splice(f,1),this.setApiParams({selectedWords:e}));this.chartOverlayOff(c);this.colorIndex.push(this.overlayQueue[d].colour);this.overlayQueue.splice(d,1);this.sliderOverlayOff(c);this.lastSticky=c},prepareFullPath:function(a){for(var b=[],c=this.absMaxFreq,
d=this.absMinFreq,e=0,f=this.allData.length;e<f;e++){for(var g=foundB=0,h=this.allData[e].allDataInternal.length;g<h;g++)for(var k=0,m=this.allData[e].allDataInternal[g].frequencyArray.length;k<m;k++)if(this.allData[e].allDataInternal[g].frequencyArray[k].wordString===a){var l=this.allData[e].allDataInternal[g].frequencyArray[k].freq;b.push({x:e,y:l});l<c&&(c=l);l>d&&(d=l);foundB=1}0===foundB&&(g=this.minFreq,b.push({x:e,y:g}),g<c&&(c=g),g>d&&(d=g))}return{path:b,min:c,max:d}},updateFullPath:function(){for(var a=
this.overlayQueue.length;0<a--;){var b=this.prepareFullPath(this.overlayQueue[a].word);this.overlayQueue[a].fullPath=b.path;this.overlayQueue[a].pathMin=b.min;this.overlayQueue[a].pathMax=b.max}},buildSliderPath:function(a){var b=this;return d3.svg.line().x(function(a){return b.xSliderScale(a.x)}).y(function(a){return b.ySliderScale(a.y)}).interpolate("monotone")(a)},sliderOverlayOn:function(a){this.transitionSliderOverlay(a);this.chart.append("g").attr("id","slider-line-"+a.word).append("path").attr("d",
this.buildSliderPath(a.fullPath)).style("stroke",a.colour).style("stroke-width",2).style("fill","none");this.redrawSlider()},sliderOverlayOff:function(a){this.chart.selectAll("g[id\x3dslider-line-"+a+"]").remove();this.transitionSliderOverlay()},redrawSliderOverlay:function(){for(var a=0;a<this.overlayQueue.length;a++)this.sliderOverlayOff(this.overlayQueue[a].selector),this.sliderOverlayOn(this.overlayQueue[a])},transitionSliderOverlay:function(a){this.updateYSliderScale(a||0);for(a=this.overlayQueue.length;0<
a--;)this.chart.selectAll("g#slider-line-"+this.overlayQueue[a].selector).select("path").transition().duration(300).ease("linear").attr("d",this.buildSliderPath(this.overlayQueue[a].fullPath))},preparePath:function(a){for(var b=[],c,d,e=0;3>e&&0<this.shiftCount-e;e++){for(var f=c=0;f<this.allData[this.shiftCount-(1+e)].allDataInternal.length;f++)for(var g=0;g<this.allData[this.shiftCount-(1+e)].allDataInternal[f].frequencyArray.length;g++)this.allData[this.shiftCount-(1+e)].allDataInternal[f].frequencyArray[g].wordString===
a&&(c=this.yScale(this.allData[this.shiftCount-(1+e)].allDataInternal[f].frequencyArray[g].freq),b.unshift({x:this.shiftCount-(1+e),y:c}),c=1);0===c&&(f=this.yScale(this.minFreq),b.unshift({x:this.shiftCount-(1+e),y:f}))}e=this.shiftCount;for(c=this.numVisPoints+this.shiftCount;e<c;e++){for(var f=d=0,h=this.allData[e].allDataInternal.length;f<h;f++)for(var g=0,k=this.allData[e].allDataInternal[f].frequencyArray.length;g<k;g++)this.allData[e].allDataInternal[f].frequencyArray[g].wordString===a&&(d=
this.yScale(this.allData[e].allDataInternal[f].frequencyArray[g].freq),b.push({x:e,y:d}),d=1);0===d&&(f=this.yScale(this.minFreq),b.push({x:e,y:f}))}for(e=0;3>e&&this.numVisPoints+this.shiftCount+e<this.numDataPoints;e++){for(f=c=0;f<this.allData[this.numVisPoints+this.shiftCount+e].allDataInternal.length;f++)for(g=0;g<this.allData[this.numVisPoints+this.shiftCount+e].allDataInternal[f].frequencyArray.length;g++)this.allData[this.numVisPoints+this.shiftCount+e].allDataInternal[f].frequencyArray[g].wordString===
a&&(d=this.yScale(this.allData[this.numVisPoints+this.shiftCount+e].allDataInternal[f].frequencyArray[g].freq),b.push({x:this.numVisPoints+this.shiftCount+e,y:d}),c=1);0===c&&(f=this.yScale(this.minFreq),b.push({x:this.numVisPoints+this.shiftCount+e,y:f}))}return b},chartOverlayOn:function(a){var b=this;this.chart.selectAll("g[class\x3dsection]").selectAll("g[class\x3dfrequencies]").selectAll("text[class\x3d"+a.selector+"]").style("fill",a.colour).style("fill-opacity",1);var c=this.preparePath(a.word),
d,e=d3.svg.line().x(function(a){d=a.x;return b.xScale(a.x+b.callOffset())}).y(function(a){return a.y}).interpolate("monotone");a=this.chart.select(".overlay").append("g").attr("class","frequency-line-"+a.selector).append("path").attr("d",e(c)).style("stroke",a.colour).style("stroke-width",2).style("fill","none");c=this.xScale(d)-this.xScale(d+this.callOffset());"left"!==this.transitionCall&&"right"!==this.transitionCall||a.transition().duration(b.getDuration()).ease("linear").attr("transform","translate("+
c+")")},chartOverlayOff:function(a){var b=this;this.chart.selectAll("text."+a).style("fill","black").style("fill-opacity",function(a){return b.opacityScale(a.freq)});this.chart.select("g.frequency-line-"+a).remove()},redrawChartOverlay:function(){for(var a=0;a<this.overlayQueue.length;a++)this.chartOverlayOff(this.overlayQueue[a].selector),this.chartOverlayOn(this.overlayQueue[a])},manageAllYScales:function(){this.manageFontScale();this.manageOpacityScale();this.manageYScale();this.manageYSliderScale()},
fontScale:d3.scale.linear(),manageFontScale:function(){this.fontScale.domain([this.minFreq,this.absMaxFreq*this.valFraction]).range([10,this.maxFont])},opacityScale:d3.scale.linear(),manageOpacityScale:function(){this.opacityScale.domain([0,this.absMaxFreq*this.valFraction]).range([.4,.8])},yScale:null,manageYScale:function(){"linear"==this.getApiParam("yAxisScale")&&(this.yScale=d3.scale.linear());"log"==this.getApiParam("yAxisScale")&&(this.yScale=d3.scale.log());this.yScale.domain([this.minFreq,
this.absMaxFreq*this.valFraction*1.25]).rangeRound([this.body.getHeight()-this.bPadding,2*this.tPadding+this.navigationHeight])},ySliderScale:null,manageYSliderScale:function(){var a=this.tPadding,b=this.tPadding+this.navigationHeight;"linear"==this.getApiParam("yAxisScale")&&(this.ySliderScale=d3.scale.linear());"log"==this.getApiParam("yAxisScale")&&(this.ySliderScale=d3.scale.log());this.ySliderScale.domain([this.minFreq,this.absMaxFreq]).rangeRound([b,a])},updateYSliderScale:function(a){a=a||
0;for(var b=this.minFreq,c=0,d=this.overlayQueue.length;0<d--;)this.overlayQueue[d].pathMin<b&&(b=this.overlayQueue[d].pathMin),this.overlayQueue[d].pathMax>c&&(c=this.overlayQueue[d].pathMax);0!=a&&a.pathMin<b&&(b=a.pathMin);0!=a&&a.pathMax>c&&(c=a.pathMax);this.ySliderScale.domain([b,c])},manageAllXScales:function(){this.manageXScale();this.manageXSliderScale()},xScale:d3.scale.linear(),manageXScale:function(){this.xScale.domain([this.shiftCount-.5,this.numVisPoints+this.shiftCount-.5]).range([this.lPadding,
this.body.getWidth()-this.rPadding])},xSliderScale:d3.scale.linear(),manageXSliderScale:function(){this.xSliderScale.domain([0,this.numDataPoints-1]).range([this.lPadding,this.body.getWidth()-this.rPadding])},setTitleLength:function(){var a;this.titlesArray=[];for(var b=d3.scale.linear().domain([350,1250]).range([10,40]),c=this.getCorpus(),d=0,e=c.getDocumentsCount();d<e;d++)a=c.getDocument(d),a=a.getShortTitle(),a.length<=b(this.body.getWidth())?this.titlesArray.push(a):(a=a.substring(0,b(this.body.getWidth())-
3),this.titlesArray.push(a+"..."))},callOffset:function(){var a;if("draw"===this.transitionCall||"redraw"===this.transitionCall)a=0;"left"===this.transitionCall&&(a=-1);"right"===this.transitionCall&&(a=1);return a},removeFilteredCharacters:function(a){return a||""},getDuration:function(){return this.numDataPoints*(100-this.getSpeed())}});Ext.define("Voyant.panel.Trends",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],requires:["Ext.chart.CartesianChart","Voyant.data.store.Documents"],alias:"widget.trends",config:{options:{xtype:"stoplistoption"},corpus:void 0},statics:{i18n:{},api:{limit:5,stopList:"auto",query:void 0,withDistributions:"relative",bins:10,docIndex:void 0,docId:void 0,mode:"corpus"},glyph:"xf201@FontAwesome"},MODE_CORPUS:"corpus",MODE_DOCUMENT:"document",layout:"fit",constructor:function(a){this.callParent(arguments);
this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);if(a.embedded){var b=Ext.getClass(a.embedded).getName();"Voyant.data.store.CorpusTerms"==b&&this.loadFromCorpusTerms(a.embedded);"Voyant.data.model.Corpus"==b&&this.loadFromCorpusTerms(a.embedded.getCorpusTerms())}this.on("loadedCorpus",function(a,b){this.setCorpus(b);1==b.getDocumentsCount()&&this.getApiParam("mode")!=this.MODE_DOCUMENT&&(this.setMode(this.MODE_DOCUMENT),this.setApiParams({withDistributions:"raw"}),this.down("#raw").setChecked(!0));
if(!("bins"in this.getModifiedApiParams())&&this.getApiParam("mode")==this.MODE_CORPUS){var e=b.getDocumentsCount();this.setApiParam("bins",100<e?100:e)}this.isVisible()&&(this.getApiParam("query")?this.loadFromCorpusTerms():this.loadFromCorpus())});this.on("corpusSelected",function(a,b){a.isXType("corpusdocumentselector")&&(this.setMode(this.MODE_CORPUS),this.setApiParams({docId:void 0,docIndex:void 0}),this.loadFromCorpus())});this.on("documentSelected",function(a,b){this.getCorpus()&&this.loadFromDocuments([b])});
this.on("documentsClicked",function(a,b){this.getCorpus()&&this.loadFromDocuments(b)});this.on("query",function(a,b){this.getApiParam("mode")==this.MODE_DOCUMENT?(this.setApiParam("query",b),this.loadFromDocumentTerms()):this.fireEvent("termsClicked",a,b)},this);this.on("termsClicked",function(a,b){if(this.getCorpus()){var e=[];b.forEach(function(a){Ext.isString(a)?e.push(a):a.term?e.push(a.term):a.getTerm&&e.push(a.getTerm())});e&&(this.setApiParams({query:e}),this.isVisible()&&(0<e.length?this.loadFromCorpusTerms():
this.loadFromCorpus()))}});this.on("documentTermsClicked",function(a,b){this.getCorpus()&&(this.setMode(this.MODE_DOCUMENT),b[0]&&void 0!==b[0].get("distributions")?this.loadFromRecords(b):this.fireEvent("termsClicked",a,b))});this.on("corpusTermsClicked",function(a,b){this.getCorpus()&&(b[0]&&void 0!==b[0].get("distributions")&&1<this.getCorpus().getDocumentsCount()?this.loadFromRecords(b):this.fireEvent("termsClicked",a,b))});this.on("activate",function(){this.getCorpus()&&this.loadFromCorpus()},
this);this.on("ensureCorpusView",function(a,b){this.getApiParam("mode")!=this.MODE_CORPUS&&1<b.getDocumentsCount()&&(this.setApiParam("docId",void 0),this.loadFromCorpus())},this)},initComponent:function(){Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",enableOverflow:!0,items:[{xtype:"querysearchfield"},{xtype:"corpusdocumentselector",singleSelect:!0},{text:this.localize("freqsMode"),glyph:"xf201@FontAwesome",tooltip:this.localize("freqsModeTip"),menu:{items:[{text:this.localize("relativeFrequencies"),
checked:!0,itemId:"relative",group:"freqsMode",checkHandler:function(a,b){b&&(this.setApiParam("withDistributions","relative"),this.reloadFromChart())},scope:this},{text:this.localize("rawFrequencies"),checked:!1,itemId:"raw",group:"freqsMode",checkHandler:function(a,b){b&&(this.setApiParam("withDistributions","raw"),this.reloadFromChart())},scope:this}]}},{itemId:"segmentsSlider",xtype:"slider",fieldLabel:this.localize("segmentsSlider"),fieldAlign:"right",labelWidth:70,width:150,minValue:2,maxValue:100,
listeners:{afterrender:function(a){a.setValue(parseInt(this.getApiParam("bins")))},changecomplete:function(a,b){this.setApiParams({bins:b});this.getApiParam("docId")||this.getApiParam("docIndex")?this.loadFromDocumentTerms():this.loadFromCorpusTerms()},scope:this}}]}]});this.callParent(arguments)},loadFromDocuments:function(a){this.setApiParams({docId:void 0,docIndex:Ext.Array.from(a).map(function(a){return this.getCorpus().getDocument(a).getIndex()},this)});this.isVisible()&&this.loadFromDocumentTerms(this.getApiParam("query")?
void 0:this.getCorpus().getDocumentTerms({proxy:{extraParams:{limit:this.getApiParam("limit")}}}))},loadFromDocumentTerms:function(a){this.getCorpus()&&(a=a||this.getCorpus().getDocumentTerms({}),a.load({callback:function(a,c,d){d?(this.setMode(this.MODE_DOCUMENT),this.loadFromRecords(a)):Voyant.application.showResponseError(this.localize("failedGetDocumentTerms"),c)},scope:this,params:this.getApiParams(["stopList","query","docIndex","withDistributions","bins"])}))},loadFromCorpus:function(a){a=a||
this.getCorpus();this.setCorpus(a);this.getApiParam("docId")?this.loadFromDocumentTerms():1==a.getDocumentsCount()?this.loadFromDocuments([a.getDocument(0)]):this.loadFromCorpusTerms(a.getCorpusTerms({proxy:{extraParams:{limit:this.getApiParam("limit")}}}))},loadFromCorpusTerms:function(a){if(this.getCorpus())if(1==this.getCorpus().getDocumentsCount())this.loadFromDocumentTerms();else{a=a||this.getCorpus().getCorpusTerms({autoLoad:!1});var b=this.getApiParams(["stopList","query","withDistributions",
"bins"]);b.bins&&b.bins>this.getCorpus().getDocumentsCount()&&(b.bins=this.getCorpus().getDocumentsCount());a.load({callback:function(a,b,e){e?(this.setMode(this.MODE_CORPUS),this.loadFromRecords(a)):Voyant.application.showResponseError(this.localize("failedGetCorpusTerms"),b)},scope:this,params:b})}},loadFromRecords:function(a){var b=this.getApiParam("mode"),c=[],d=["index"],e=[],f=0;a.forEach(function(a,g){var m=a.get("term");a.get("distributions").forEach(function(a,b){c[b]||(c[b]={index:b});c[b]["_"+
g]=a;a>f&&(f=a)},this);d.push("_"+g);e.push({type:"line",title:m,xField:"index",yField:"_"+g,style:{lineWidth:2},marker:{radius:3},highlight:!0,smooth:!1,tooltip:{trackMouse:!0,style:"background: #fff",renderer:function(a,c,d){var e="\x3ci\x3e"+d.series.getTitle()+"\x3c/i\x3e: "+c.get(d.series.getYField());if(b==a.panel.MODE_CORPUS){var f=a.panel.getCorpus();f&&f.getDocumentsCount()==c.store.getCount()&&(e+="\x3cbr/\x3e\x3ci\x3e"+a.panel.getCorpus().getDocument(d.index).getShortTitle()+"\x3c/i\x3e")}a.setHtml(e)},
panel:this},listeners:{itemclick:{fn:this.handleClickedItem,scope:this}}})},this);a=Ext.create("Ext.data.JsonStore",{fields:d,data:c});d.shift();var g=this;this.buildChart({store:a,series:e,axes:[{type:"numeric",position:"left",majorTickSteps:"raw"==this.getApiParam("withDistributions")&&20>f?f:void 0,increment:1,title:{text:this.localize("raw"==this.getApiParam("withDistributions")?"rawFrequencies":"relativeFrequencies")}},{type:"category",position:"bottom",fields:["index"],title:{text:this.localize(b==
this.MODE_DOCUMENT?"segments":"documents")},label:{rotate:{degrees:-30},textAlign:"end"},renderer:function(a,c){if(b==g.MODE_DOCUMENT)return parseInt(c)+1;var d=g.getCorpus().getDocument(c);return d?d.getTinyLabel():"?"}}]})},reloadFromChart:function(){var a=this.down("chart");if(a){var b=[];a.series.forEach(function(a){b.push(a.getTitle())});this.fireEvent("termsClicked",this,b)}},buildChart:function(a){a.axes.forEach(function(a){Ext.applyIf(a,{style:{opacity:.2},label:{opacity:.5}});Ext.applyIf(a.title,
{fontSize:12})});Ext.applyIf(a,{plugins:{ptype:"chartitemevents",moveEvents:!0},legend:{docked:"top"},interactions:["itemhighlight","panzoom"],innerPadding:{top:5,right:5,bottom:5,left:5},border:!1,bodyBorder:!1});this.query("chart").forEach(function(a){this.remove(a)},this);a=Ext.create("Ext.chart.CartesianChart",a);this.add(a)},clearChart:function(){this.query("chart").forEach(function(a){this.remove(a)},this)},handleClickedItem:function(a,b){var c=this.getApiParam("mode");if(c===this.MODE_DOCUMENT){if(c=
this.getApiParam("docId")){var d=this.getCorpus().getDocument(c),d=d.get("tokensCount-lexical"),e=this.getApiParam("bins"),d=b.index/e*d;this.dispatchEvent("documentIndexTermsClicked",this,[{term:b.series.getTitle(),docId:c,position:d}])}}else c==this.MODE_CORPUS&&(d=this.getCorpus().getDocument(b.index),this.dispatchEvent("documentIndexTermsClicked",this,[{term:b.series.getTitle(),docIndex:b.index,docId:d.getId()}]))},isLastClickedItem:function(a){return this.lastClickedItem&&this.lastClickedItem.term==
a.term&&this.lastClickedItem.index==a.index},setMode:function(a){this.setApiParams({mode:a});this.getApiParam("mode")}});Ext.define("Voyant.panel.NoTool",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.notool",statics:{i18n:{},api:{tool:void 0}},config:{html:void 0,notYetImplemented:"Centroid DocumentInputAdd DocumentTypeCollocateFrequenciesGrid EntitiesBrowser Equalizer FeatureClusters Flowerbed KwicsTagger Lava Mandala MicroSearch NetVizApplet PaperDrill RezoViz Sunburst Termometer Ticker TokensViz ToolBrowser ToolBrowserLarge VoyeurTagline WordCloud VoyeurTagline WordCountFountain".split(" ")},
constructor:function(){Ext.apply(this,{title:this.localize("title")});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},listeners:{boxready:function(a,b,c){var d=this.getApiParam("notool");if(d){Ext.isArray(d)&&(d=d[0]);a=this.getNotYetImplemented();b=0;for(c=a.length;b<c;b++)if(d==a[b])return Ext.Msg.show({title:this.localize("error"),message:(new Ext.Template(this.localize("notImplemented"))).applyTemplate([d]),buttons:Ext.Msg.YESNO,buttonText:{yes:this.localize("currentButton"),
no:this.localize("oldButton")},icon:Ext.Msg.ERROR,scope:this,fn:function(a){if("yes"==a)a=this.getNewUrl();else{a="http://voyant-tools.org/tool/"+d+"/";var b=Ext.Object.fromQueryString(document.location.search);delete b.tool;(queryString=Ext.Object.toQueryString(b))&&(a+="?"+queryString)}window.location.replace(a)}});Ext.Msg.show({title:this.localize("error"),message:(new Ext.Template(this.localize("badToolSpecified"))).applyTemplate([d]),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR,scope:this,fn:function(a){window.location.replace(this.getNewUrl())}})}else this.config.html||
Ext.Msg.show({title:this.localize("error"),message:this.localize("noToolSpecified"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR,scope:this,fn:function(a){window.location.replace(this.getNewUrl())}})}},getNewUrl:function(){var a=Ext.Object.fromQueryString(document.location.search);delete a.tool;queryString=Ext.Object.toQueryString(a);return this.getApplication().getBaseUrl()+(queryString?"?"+queryString:"")}});Ext.define("Voyant.panel.VoyantFooter",{extend:"Ext.container.Container",mixins:["Voyant.panel.Panel"],alias:"widget.voyantfooter",statics:{i18n:{}},height:18,cls:"x-tab-bar-default voyant-footer",listeners:{boxready:function(a,b,c){c=["\x3ca href\x3d'"+a.getBaseUrl()+"docs/' target\x3d'voyantdocs'\x3e"+a.localize("voyantTools")+"\x3c/a\x3e ",", \x3ca href\x3d'http://stefansinclair.name/'\x3eSt\x26eacute;fan Sinclair\x3c/a\x3e \x26amp; \x3ca href\x3d'http://geoffreyrockwell.com'\x3eGeoffrey Rockwell\x3c/a\x3e",
" (\x3ca href\x3d'http://creativecommons.org/licenses/by/4.0/' target\x3d'_blank'\x3e\x3cspan class\x3d'cc'\x3ec\x3c/span\x3e\x3c/a\x3e "+(new Date).getFullYear()+")"," \x3ca class\x3d'privacy' href\x3d'"+this.getBaseUrl()+"docs/#!/guide/about-section-privacy-statement' target\x3d'top'\x3e"+a.localize("privacy")+"\x3c/a\x3e"," v. "+Voyant.application.getVersion()+(Voyant.application.getBuild()?" ("+Voyant.application.getBuild()+")":"")];for(var d="",e=0,f,g=a.getEl(),h=0;h<c.length;h++)f=g.getTextWidth(c[h].replace(/data-qtip.+?--\x3e/,
"\x3e").replace(/<.+?>/g,"")),console.warn(c[h]),e+f<b&&(d+=c[h],e+=f);a.update(d);Ext.tip.QuickTipManager.register({target:a.getTargetEl().dom.querySelector(".privacy"),text:this.localize("privacyMsg")})}}});Ext.define("Voyant.panel.VoyantHeader",{extend:"Ext.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.voyantheader",statics:{i18n:{}},constructor:function(a){Ext.apply(this,{id:"voyantheader",title:"",layout:"fit",html:'\x3cdiv id\x3d"logo-container"\x3e\x3c/div\x3e',collapseMode:void 0,collapsible:!0,animCollapse:!1,titleCollapse:!1,floatable:!1,header:!0,hideCollapseTool:!0,listeners:{collapse:this.onCollapse},titleAlign:"center"});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.call(this,
Ext.apply(a,{moreTools:["corpusset","scatterplot","termsradio"],includeTools:{save:!0,plus:!0,help:!0,home:{type:"home",tooltip:this.localize("homeTip"),xtype:"toolmenu",glyph:"xf015@FontAwesome",handler:function(a){var c=this.up("panel");Ext.Msg.confirm(c.localize("home"),c.localize("homeConfirm"),function(a){"yes"==a&&(document.location.href=c.getBaseUrl())},this)}}}}))},onCollapse:function(a){Ext.defer(function(){this.setTitle("\x3cimg src\x3d'"+this.getBaseUrl()+"resources/images/voyant-logo-tiny.png' style\x3d'vertical-align: middle' alt\x3d'Voyant Tools' /\x3e "+
this.localize("title"))},10,a)}});Ext.define("Voyant.panel.CorpusSet",{extend:"Ext.panel.Panel",requires:"Voyant.panel.VoyantTabPanel Voyant.panel.Cirrus Voyant.panel.Summary Voyant.panel.CorpusTerms Voyant.panel.Reader Voyant.panel.Documents Voyant.panel.Trends Voyant.panel.Contexts Voyant.panel.Phrases Voyant.panel.DocumentTerms Voyant.panel.CorpusCollocates Voyant.panel.CollocatesGraph Voyant.panel.StreamGraph".split(" "),mixins:["Voyant.panel.Panel"],alias:"widget.corpusset",isConsumptive:!0,statics:{i18n:{},api:{panels:void 0},
glyph:"xf17a@FontAwesome"},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},layout:"border",header:!1,items:[{region:"west",flex:3,layout:"fit",moreTools:["cirrus","corpusterms"],xtype:"voyanttabpanel",split:{width:5},tabBarHeaderPosition:0,items:[{xtype:"cirrus"},{xtype:"corpusterms"},{xtype:"collocatesgraph"}]},{region:"center",flex:3,layout:"fit",xtype:"voyanttabpanel",tabBarHeaderPosition:0,items:[{xtype:"reader"}]},{region:"east",
flex:3,layout:"fit",xtype:"voyanttabpanel",split:{width:5},tabBarHeaderPosition:0,moreTools:["trends","collocatesgraph","corpuscollocates"],items:[{xtype:"trends"},{xtype:"documentterms"}]},{region:"south",flex:2,split:{width:5},layout:"border",items:[{layout:"fit",region:"center",flex:1,xtype:"voyanttabpanel",split:{width:5},tabBarHeaderPosition:0,moreTools:["summary","documents","phrases"],items:[{xtype:"summary"},{xtype:"documents"},{xtype:"phrases"}]},{layout:"fit",region:"east",flex:1,xtype:"voyanttabpanel",
split:{width:5},tabBarHeaderPosition:0,moreTools:["contexts","documentterms"],items:[{xtype:"contexts"},{xtype:"bubblelines"}]}]}],listeners:{boxready:function(){var a=this.getApiParam("panels");if(a)for(var a=a.toLowerCase().split(","),b=this.query("voyanttabpanel"),c=0,d=a.length;c<d;c++){var e=a[c];if(e&&Ext.ClassManager.getByAlias("widget."+e)&&b[c]){var f=b[c];f.getActiveTab().isXType(e)||(f.items.each(function(a,b){if(a.isXType(e))return this.setActiveTab(b),!1},f),f.getActiveTab().isXType(e)||
f.getActiveTab().replacePanel(e))}}var a=this.down("cirrus"),g=this;a&&(a=a.down("toolbar"),a.add({xtype:"tbfill"}),a.add({text:" ",handler:function(){g.add({region:"north",width:"100%",html:'\x3cdiv align\x3d"center"\x3e\x3ctable\x3e\x3ctr\x3e\x3ctd\x3e\x3cimg src\x3d"http://stefansinclair.name/wordpress/wp-content/uploads/2011/07/Sinclair_Stefan_small.jpg" style\x3d"height: 60px"\x3e\x3c/td\x3e\x3ctd style\x3d"text-align: center; padding-left: 2em; padding-right: 2em;"\x3eBy Athena, you found us hidden\x3cbr\x3eup here between the panels!\x3c/td\x3e\x3ctd\x3e\x3cimg src\x3d"http://geoffreyrockwell.com/images/home_09.jpg" style\x3d"height: 60px"\x3e\x3c/td\x3e\x3c/tr\x3e\x3c/table\x3e\x3c/div\x3e'})}}).getTargetEl().dom.className=
"")},loadedCorpus:function(a,b){if("NONCONSUMPTIVE"==b.getNoPasswordAccess()&&!this.getApiParam("panels")){var c=this.query("voyanttabpanel");c[1].add({xtype:"termsradio"});c[1].setActiveTab(1);c[1].getActiveTab().fireEvent("loadedCorpus",a,b);c[4].setActiveTab(1)}30<b.getDocumentsCount()&&(c=this.down("bubblelines"))&&c.up("voyanttabpanel").remove(c)},panelChange:function(a){var b=[];this.query("voyanttabpanel").forEach(function(a){b.push(a.getActiveTab().xtype)});this.getApplication().setApiParam("panels",
b.join(","))}}});Ext.define("Voyant.panel.ScatterSet",{extend:"Ext.panel.Panel",requires:["Voyant.panel.ScatterPlot","Voyant.panel.Documents","Voyant.panel.Trends","Voyant.panel.Contexts"],mixins:["Voyant.panel.Panel"],alias:"widget.scatterset",statics:{i18n:{},glyph:"xf17a@FontAwesome"},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},layout:"hbox",header:!1,items:[{flex:3,height:"100%",xtype:"scatterplot"},{split:{width:5},flex:1,height:"100%",
layout:"vbox",defaults:{width:"100%",flex:1},items:[{xtype:"documents",collapsible:!0},{xtype:"trends",collapsible:!0},{xtype:"contexts",collapsible:!0}]}]});Ext.define("Voyant.panel.Subset",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel","Voyant.util.Downloadable"],alias:"widget.subset",isConsumptive:!0,statics:{i18n:{},api:{stopList:"auto",documentFilename:["pubDate","title"],documentFormat:"SOURCE"},glyph:"xf0ce@FontAwesome"},config:{options:{xtype:"stoplistoption"},inDocumentsCountOnly:!1,stopList:"auto",store:void 0},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(a){var b=
this;Ext.applyIf(b,{introHtml:"",fieldItems:[{xtype:"querysearchfield",fieldLabel:this.localize("titleLabel"),tokenType:"title"},{xtype:"querysearchfield",fieldLabel:this.localize("authorLabel"),tokenType:"author"},{xtype:"querysearchfield",fieldLabel:this.localize("termsLabel")}],fieldColumns:2});Ext.applyIf(b,{intro:{margin:"5 0 5 0",layout:"center",items:{itemId:"intro",html:b.introHtml}},fields:{xtype:"container",layout:"center",items:{xtype:"container",maxWidth:1200,layout:{type:"table",columns:b.fieldColumns},
items:b.fieldItems.map(function(a){return{xtype:"container",defaults:{margin:"5 10 5 10",inDocumentsCountOnly:b.getInDocumentsCountOnly(),stopList:b.getStopList(),showAggregateInDocumentsCount:!0,isDocsMode:!0,flex:1,maxWidth:800,labelAlign:"right"},items:Ext.applyIf(a,{fieldLabel:b.localize((a.tokenType?a.tokenType:"lexical")+"Label")})}},this)}},foot:{layout:"center",margin:"20 0 0 0",items:{xtype:"container",layout:{type:"hbox",align:"middle"},defaults:{margin:"0 5 0 5",width:200},items:[{xtype:"button",
itemId:"export",glyph:"xf08e@FontAwesome",text:this.localize("sendToVoyantButton"),handler:b.handleSendToVoyant,scope:b},{xtype:"button",glyph:"xf019@FontAwesome",itemId:"download",text:this.localize("downloadButton"),handler:b.handleExport,scope:b},{xtype:"container",hidden:!0,itemId:"statuscontainer",layout:"vbox",items:[{itemId:"status",bodyStyle:"text-align: center",width:200},{xtype:"container",width:200,items:{xtype:"sparklineline",chartRangeMin:0,itemId:"sparkline",margin:"0 0 0 10",values:[1,
1],height:20,width:200}}]}]}}});Ext.applyIf(b,{items:[b.intro,b.fields,b.foot]});b.on("loadedCorpus",function(a,d){b.getStore().setCorpus(d);void 0==b.getInitialConfig("introHtml")&&void 0==b.getInitialConfig("intro")&&b.queryById("intro").setHtml(d.getString())},b);b.on("query",function(a,b){this.performAggregateQuery(this.getAggregateQuery())});b.setStore(Ext.create("Voyant.data.store.DocumentQueryMatches"));b.callParent([a])},handleSendToVoyant:function(){if(this.getStore().lastOptions&&this.getStore().lastOptions.params.query){var a=
this;this.mask("Creating corpus\u2026");this.getStore().load({params:{query:this.getStore().lastOptions.params.query,createNewCorpus:!0},callback:function(b,c,d){a.unmask();d&&b&&1==b.length&&(b=c.getProxy().getReader().metaData,b=a.getBaseUrl()+"?corpus\x3d"+b,a.openUrl(b))}})}else Ext.Msg.alert(this.localize("sendToVoyantButton"),(new Ext.XTemplate(this.localize("sendToVoyantNoQuery"))).apply([this.getBaseUrl()+"?corpus\x3d"+this.getStore().getCorpus().getId()]))},handleExport:function(){if(this.getStore().lastOptions&&
this.getStore().lastOptions.params.query){var a=this.getStore().getAt(0);this.getStore().lastOptions.params.query&&a&&0==a.getCount()?this.showMsg({message:this.localize("noMatches")}):this.getStore().load({params:{query:this.getStore().lastOptions.params.query,createNewCorpus:!0,temporaryCorpus:!0},callback:function(a,c,d){d&&a&&1==a.length&&this.downloadFromCorpusId(c.getProxy().getReader().metaData)},scope:this})}else this.downloadFromCorpusId(this.getStore().getCorpus().getId())},openDownloadCorpus:function(a){a=
this.getTromboneUrl()+"?corpus\x3d"+a+"\x26tool\x3dcorpus.CorpusExporter\x26outputFormat\x3dzip\x26zipFilename\x3dDownloadedVoyantCorpus-"+a+".zip"+(this.getApiParam("documentFormat")?"\x26documentFormat\x3d"+this.getApiParam("documentFormat"):"")+(this.getApiParam("documentFilename")?"\x26documentFilename\x3d"+this.getApiParam("documentFilename"):"");this.openUrl(a)},performAggregateQuery:function(a){var b=this,c=b.queryById("statuscontainer"),d=b.queryById("status"),e=b.queryById("sparkline");c&&
c.show();d&&d.setHtml((new Ext.XTemplate('{0:plural("documents")} matching.')).apply([0]));e&&e.setValues([0,0]);a?(c=this.getStore().getCorpus().getDocumentsCount(),this.getStore().load({params:{query:a,withDistributions:!0,bins:100<c?100:c},callback:function(a,c,e){b.queryById("export");c=b.queryById("sparkline");e&&a&&1==a.length&&(d&&d.setHtml((new Ext.XTemplate('{0:plural("document")} matching.')).apply([a[0].getCount()])),c&&c.setValues(a[0].getDistributions()))}})):this.getStore().lastOptions&&
(this.getStore().lastOptions.params.query=void 0)},getAggregateQuery:function(){var a=[];Ext.ComponentQuery.query("field",this).forEach(function(b){if(b.getTokenType&&b.getValue){var c=b.getTokenType();b=Ext.Array.from(b.getValue());0<b.length&&0<b.length&&a.push("+("+b.map(function(a){return c+":"+a}).join("|")+")")}});return a.join(" ")}});Ext.define("Voyant.panel.CollocatesSet",{extend:"Ext.panel.Panel",requires:["Voyant.panel.ScatterPlot","Voyant.panel.Documents","Voyant.panel.Trends","Voyant.panel.Contexts"],mixins:["Voyant.panel.Panel"],alias:"widget.collocatesset",statics:{i18n:{},glyph:"xf17a@FontAwesome"},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},layout:"vbox",header:!1,items:[{layout:"hbox",align:"stretch",width:"100%",height:"100%",flex:2,defaults:{width:"100%",
height:"100%",flex:1,frame:!0,border:!0},items:[{xtype:"corpusterms"},{xtype:"documentterms"},{xtype:"corpuscollocates"}]},{width:"100%",height:"100%",split:{width:5},layout:"hbox",flex:3,defaults:{width:"100%",height:"100%",flex:1,frame:!0,border:!0},items:[{xtype:"contexts"},{xtype:"collocatesgraph"}]}]});Ext.define("Voyant.panel.BubblelinesSet",{extend:"Ext.panel.Panel",requires:["Voyant.panel.Bubblelines","Voyant.panel.Contexts","Voyant.panel.Reader"],mixins:["Voyant.panel.Panel"],alias:"widget.bubblelinesset",statics:{i18n:{},glyph:"xf17a@FontAwesome"},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},layout:"vbox",header:!1,items:[{width:"100%",height:"100%",xtype:"bubblelines",flex:5},{width:"100%",height:"100%",split:{width:5},
layout:"hbox",flex:4,defaults:{width:"100%",height:"100%",flex:1,frame:!0,border:!0},items:[{xtype:"contexts"},{xtype:"reader"}]}]});Ext.define("Voyant.panel.CustomSet",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.customset",statics:{i18n:{},api:{layout:void 0,tableLayout:void 0},glyph:"xf17a@FontAwesome"},header:!1,height:"100%",width:"100%",constructor:function(){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){this.getApiParam("layout")?Ext.apply(this,{layout:"border",
items:[]}):this.getApiParam("tableLayout")&&this.initTableLayout();this.callParent()},listeners:{loadedCorpus:function(a,b){this.getApiParam("layout")&&this.query("panel").forEach(function(c){c.fireEvent("loadedCorpus",a,b)})},boxready:function(a){this.getApiParam("layout")?this.initBorderLayoutComponents():this.getApiParam("tableLayout")?(this.doTableSizing(),this.on("resize",function(a,c,d,e,f){void 0!==e&&void 0!==f&&this.doTableSizing(c/e,d/f)},this)):this.showError(this.localize("noLayoutSpecified"))}},
initBorderLayoutComponents:function(){var a=decodeURI(this.getApiParam("layout")).replace(/r1/g,"region").replace(/i1/g,"items").replace(/s1/g,"split").replace(/c1/g,"collapsible").replace(/c2/g,"collapsed").replace(/w1/g,"width").replace(/h1/g,"height").replace(/p1/g,"%").replace(/"x1":"/g,'"xtype":"').replace(/c3/g,"center").replace(/n1/g,"north").replace(/e1/g,"east").replace(/s2/g,"south").replace(/w2/g,"west").replace(/"xtype":"(\w+)"/g,function(a,b){Ext.ClassManager.getByAlias("widget."+b.toLowerCase())||
(b="Links"==b?"CollocatesGraph":"CorpusGrid"==b?"Documents":"CorpusSummary"==b?"Summary":"CorpusTypeFrequenciesGrid"==b?"CorpusTerms":"DocumentInputAdd"==b?"CorpusTerms":"DocumentTypeCollocateFrequenciesGrid"==b?"CorpusTerms":"DocumentTypeFrequenciesGrid"==b?"DocumentTerms":"DocumentTypeKwicsGrid"==b?"Contexts":"TypeFrequenciesChart"==b?"Trends":"VisualCollocator"==b?"CollocatesGraph":"NoTool");return'"xtype":"'+b.toLowerCase()+'"'+("NoTool"==b?',"html":"'+(new Ext.Template(panel.localize("noSuchTool"))).applyTemplate([b])+
'"':"")}),b;try{b=Ext.decode(a)}catch(c){b={region:"center",html:"\x3cdiv\x3eError constructing layout:"+c+"\x3c/div\x3e"}}null==b&&(b={region:"center",html:"\x3cdiv\x3eError: no layout information found.\x3c/div\x3e"});this.addBorderLayouts(b);this.on("add",function(a,b){b.on("boxready",function(a){})});this.add(b)},addBorderLayouts:function(a){for(var b=Ext.getBody().getSize(),c=0;c<a.length;c++){var d=a[c];Ext.isString(d.width)?d.width=Math.round(b.width*parseInt(d.width)/100):Ext.isString(d.height)&&
(d.height=Math.round(b.height*parseInt(d.height)/100));d.items&&1<d.items.length?(d.layout="border",this.addBorderLayouts(d.items)):d.layout="fit"}},initTableLayout:function(){Ext.suspendLayouts();var a=this.getApiParam("tableLayout");if(a&&"{"!=a.charAt(0)&&"["!=a.charAt(0)){var b=[];a.split(/,\s*/).forEach(function(a){b.push(/^"'/.test(a)?a:'"'+a+'"')});a="["+b.join(",")+"]"}a=Ext.decode(a);Ext.isArray(a)&&(a={cells:a});!a.numCols&&a.cells&&Ext.isArray(a.cells)&&(a.numCols=3>a.cells.length?a.cells.length:
5>a.cells.length?Math.ceil(a.cells.length/2):Math.ceil(a.cells.length/3));if(null!=a.numCols&&a.cells&&Ext.isArray(a.cells)){for(var c=[],d=0;d<a.cells.length;d++){var e=a.cells[d];if(Ext.isObject(e))c.push(e);else if(Ext.isArray(e)){var f=1,g=1;xtype=void 0;e[0]&&Ext.isNumber(e[0])&&(f=e[0],e.shift());e[0]&&Ext.isString(e[0])&&(xtype=e[0],e.shift());e[0]&&Ext.isNumber(e[0])&&(g=e[0]);xtype&&c.push({colspan:f,rowspan:g,xtype:xtype})}else Ext.isString(e)&&c.push({xtype:e,colspan:1,rowspan:1})}Ext.apply(this,
{layout:{type:"table",width:"100%",height:"100%",columns:a.numCols,tableAttrs:{style:{width:"100%",height:"100%"}},tdAttrs:{style:{padding:"0px",verticalAlign:"top"}}},defaults:{width:10,height:10,border:!0},items:c})}else this.showError("badTableLayoutDefinition");Ext.resumeLayouts()},doTableSizing:function(a,b){for(var c={},d=this.getTargetEl().down(".x-table-layout").dom.rows,e=0;e<d.length;e++)for(var f=d[e].cells,g=0;g<f.length;g++){var h=Ext.get(f[g]),k=h.down(".x-panel"),m=k.id;void 0!==a&&
void 0!==b?(h=k.getSize(!1),h.width*=a,h.height*=b):h=h.getSize(!1);c[m]=h}for(var l in c)h=c[l],Ext.getCmp(l).setSize(h);this.updateLayout()}});Ext.define("Voyant.panel.WordTree",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.wordtree",statics:{i18n:{},api:{query:void 0,docId:void 0,docIndex:void 0,stopList:"auto",context:10,limit:5},glyph:"xf0e8@FontAwesome"},config:{corpus:void 0,tree:void 0,kwicStore:void 0,options:{xtype:"stoplistoption"}},doubleClickDelay:300,lastClick:1,constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){Ext.apply(this,
{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",enableOverflow:!0,items:[{xtype:"querysearchfield"}]}]});this.setKwicStore(Ext.create("Voyant.data.store.Contexts",{parentPanel:this,proxy:{extraParams:{stripTags:"all"}},listeners:{load:function(a,b,c,d){if(c){a=[];c=[];d=[];for(var e=[],f=0;f<b.length;f++){var g=b[f];a.push(g.getLeft().trim().split(/\s+/));c.push(g.getMiddle());d.push(g.getRight().trim().split(/\s+/));e.push(f)}this.getTree().setupFromArrays(a,c,d,e,!1,["token",
"POS"],"/",["token","POS"]);this.getTree().succeeded()||this.toastInfo({html:this.localize("emptyText"),align:"bl"})}},scope:this}}));this.on("loadedCorpus",function(a,b){this.setCorpus(b);b.getCorpusTerms({autoLoad:!1}).load({callback:function(a,b,e){e&&0<a.length&&(a=a[0].getTerm(),this.setRoot(a))},scope:this,params:{limit:1,query:this.getApiParam("query"),stopList:this.getApiParam("stopList")}})},this);this.on("query",function(a,b){void 0!==b&&""!=b&&this.setRoot(b)},this);this.on("termsClicked",
function(a,b){var c=[];b.forEach(function(a){Ext.isString(a)?c.push(a):a.term?c.push(a.term):a.getTerm&&c.push(a.getTerm())});this.setRoot(c)},this);this.on("documentTermsClicked",function(a,b){var c=[];b.forEach(function(a){a.getTerm()&&c.push(a.getTerm())});this.setRoot(c)},this);this.on("resize",function(a,b,c){},this);this.on("boxready",this.initGraph,this);this.callParent(arguments)},initGraph:function(){var a=this.getLayout().getRenderTarget(),b=a.getWidth(),c=a.getHeight(),d=new doubletree.DoubleTree;
d.init("#"+a.getId()).visWidth(b).visHeight(c).handlers({click:this.clickHandler.bind(this)});this.setTree(d)},clickHandler:function(a){var b=(new Date).getTime();if(this.lastClick&&b-this.lastClick<this.doubleClickDelay){this.lastClick=1;for(b=[];null!=a;)b.push(a.name),a=a.parent;this.getApplication().dispatchEvent("termsClicked",this,[b.reverse().join(" ")])}else this.lastClick=b},setRoot:function(a){this.setApiParam("query",this.stripPunctuation(a));this.getKwicStore().load({params:this.getApiParams()})},
stripPunctuation:function(a){if(Ext.isString(a))return a.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");var b=[];a.forEach(function(a){b.push(a.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,""))});return b}});Ext.define("Voyant.VoyantApp",{extend:"Ext.app.Application",mixins:["Voyant.util.Deferrable","Voyant.util.Localization","Voyant.util.Api"],requires:["Voyant.util.ResponseError"],name:"VoyantApp",statics:{i18n:{}},config:{baseUrl:void 0,tromboneUrl:void 0},constructor:function(a){this.setBaseUrl(this.config.baseUrl);this.setTromboneUrl(this.config.baseUrl+"trombone");Voyant.application=this;this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments)},getTools:function(){return[{type:"maximize"},
{type:"help"}]},launch:function(){Ext.tip.QuickTipManager.init();Ext.apply(Ext.tip.QuickTipManager.getQuickTip(),{showDelay:50});this.callParent(arguments)},tromboneCall:function(a){a=a?a:{};Ext.applyIf(a,{url:this.getTromboneUrl()});a.success||a.failure||a.callback||Ext.applyIf(a,{url:this.getTromboneUrl(),scope:this,callback:function(b,c,d){this.dispatchEvent(a.tool+"Loaded",b,c,d)}});Ext.Ajax.request(a)},getViewport:function(){return Ext.ComponentQuery.query("viewport")[0]},dispatchEvent:function(a,
b){var c=this.getViewport().query("panel,chart"),d=!1;this.hasListener&&this.hasListener(a)&&(this.fireEvent.apply(this,arguments),d=!0);for(var e=0;e<c.length;e++)!c[e].hasListener||!c[e].hasListener(a)||b&&b.getId&&c[e].getId&&b.getId()==c[e].getId()||(d=!0,c[e].fireEvent.apply(c[e],arguments));if(!d){c=["unhandledEvent",b,a];for(e=2;e<arguments.length;e++)c.push(arguments[e]);this.fireEvent.apply(this,c)}},showResponseError:function(a,b){this.showError(Ext.create("Voyant.util.ResponseError",{msg:Ext.isString(a)?
a:a.msg,response:b}))},showError:function(a){if(a instanceof Voyant.util.ResponseError){var b=a.getResponse();Ext.apply(a,{message:a.getMsg()+" "+this.localize("serverResponseError")+"\x3cpre class\x3d'error'\x3e\n"+b.responseText.substring(0,b.responseText.indexOf("\n\t"))+"\u2026 \x3ca href\x3d'#' onclick\x3d\"window.open('').document.write(unescape('\x3cpre\x3e"+escape(b.responseText)+"\x3c/pre\x3e')); return false;\"\x3emore\x3c/a\x3e\x3c/pre\x3e"})}Ext.isString(a)&&(a={message:a});Ext.applyIf(a,
{title:this.localize("error"),buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR,autoScroll:!0});Ext.Msg.show(a)},getToolConfigFromToolXtype:function(a){cls=Ext.ClassManager.getByAlias("widget."+a);return{xtype:a,title:this._localizeClass(cls,"title"),tooltip:{text:this._localizeClass(cls,"helpTip")},glyph:cls&&cls.glyph?cls.glyph:"xf12e@FontAwesome"}},colors:[[0,0,255],[51,197,51],[255,0,255],[121,51,255],[28,255,255],[255,174,0],[30,177,255],[182,242,58],[255,0,164],[51,102,153],[34,111,52],[155,20,104],
[109,43,157],[128,130,33],[111,76,10],[119,115,165],[61,177,169],[202,135,115],[194,169,204],[181,212,228],[182,197,174],[255,197,197],[228,200,124],[197,179,159]],rgbToHex:function(a){return"#"+(16777216+(a[0]<<16)+(a[1]<<8)+a[2]).toString(16).slice(1)},getColorPalette:function(a){if(a){a=[];for(var b=0;b<this.colors.length;b++)a.push(this.rgbToHex(this.colors[b]));return a}return this.colors},getColor:function(a,b){return b?this.rgbToHex(this.colors[a]):this.colors[a]},colorTermAssociations:new Ext.util.MixedCollection,
getColorForTerm:function(a,b){-1!=a.indexOf(":")&&(a=a.split(":")[1]);var c=this.colorTermAssociations.get(a);null==c&&(c=this.colorTermAssociations.getCount()%this.colors.length,c=this.colors[c],this.colorTermAssociations.add(a,c));b&&(c=this.rgbToHex(c));return c},openUrl:function(a){window.open(a)||Ext.Msg.show({title:"Popup Blocked",buttonText:{ok:"Close"},icon:Ext.MessageBox.INFO,message:"A popup window was blocked. \x3ca href\x3d'"+a+"' target\x3d'_blank' class\x3d'link'\x3eClick here\x3c/a\x3e to open the new window.",
buttons:Ext.Msg.OK})}});Ext.define("Voyant.VoyantCorpusApp",{extend:"Voyant.VoyantApp",name:"VoyantCorpusApp",requires:"Voyant.panel.CorpusSet Voyant.data.model.Corpus Voyant.panel.VoyantHeader Voyant.panel.VoyantFooter Voyant.panel.CorpusCreator Voyant.panel.Cirrus Voyant.panel.Summary Voyant.panel.CorpusTerms Voyant.panel.Reader Voyant.panel.Documents Voyant.panel.Trends Voyant.panel.Contexts Voyant.panel.DocumentTerms Voyant.panel.CorpusCollocates Voyant.panel.CollocatesGraph Voyant.panel.Phrases Voyant.panel.ScatterPlot Voyant.panel.TopicContexts Voyant.panel.TermsRadio".split(" "),
statics:{i18n:{}},constructor:function(){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments)},config:{corpus:void 0,moreTools:[{i18n:"moreToolsScaleCorpus",glyph:"xf065@FontAwesome",items:"cirrus corpusterms bubblelines corpuscollocates microsearch streamgraph phrases documents summary trends scatterplot termsradio wordtree".split(" ")},{i18n:"moreToolsScaleDocument",glyph:"xf066@FontAwesome",items:"bubbles cirrus contexts documentterms reader textualarc trends knots".split(" ")},
{i18n:"moreToolsTypeViz",glyph:"xf06e@FontAwesome",items:"cirrus bubblelines bubbles collocatesgraph knots microsearch streamgraph scatterplot textualarc trends termsradio wordtree".split(" ")},{i18n:"moreToolsTypeGrid",glyph:"xf0ce@FontAwesome",items:"corpusterms corpuscollocates phrases contexts documentterms documents".split(" ")},{i18n:"moreToolsTypeOther",glyph:"xf035@FontAwesome",items:["reader","summary"]}]},launch:function(){this.callParent(arguments);if(this.hasQueryToLoad()){var a=Ext.Object.fromQueryString(document.location.search);
!a.corpus&&this.getCorpusId&&this.getCorpusId()&&(a.corpus=this.getCorpusId());this.loadCorpusFromParams(a)}},loadCorpusFromParams:function(a){var b=this,c=b.getViewport();c.mask(this.localize("fetchingCorpus"));a.archive&&(Ext.isString(a.archive)&&(a.archive=[a.archive]),a.archive=a.archive.map(function(a){return a.replace("/blogs.sub.uni-hamburg.de/hup/lhn/","/wikis.sub.uni-hamburg.de/lhn/index.php/").replace("/hup.sub.uni-hamburg.de/","/wikis.sub.uni-hamburg.de/")}));this.validateCorpusLoadParams(a);
(new Voyant.data.model.Corpus(a)).then(function(a){c.unmask();b.setCorpus(a);b.validateCorpusAccess()&&b.dispatchEvent("loadedCorpus",this,a)}).otherwise(function(){c.unmask()})},validateCorpusLoadParams:function(a){},validateCorpusAccess:function(){var a=this,b=a.getViewport(),c=this.getCorpus();if(c&&c.requiresPassword()&&!a.getViewport().query("panel").every(function(a){return!a.isConsumptive})){var d=c.getNoPasswordAccess(),e=[{text:"Validate"}];"NONCONSUMPTIVE"==d&&e.push({text:"Limited"});var f=
Ext.create("Ext.window.Window",{title:a.localize("passwordRequiredTitle"),layout:"fit",items:{padding:10,flex:1,width:300,layout:{type:"vbox",align:"stretch"},items:[{html:"\x3cp\x3e"+a.localize("passwordRequiredMessage")+"\x3c/p\x3e"+("NONCONSUMPTIVE"==d?"\x3cp\x3e"+a.localize("nonConsumptiveMessage")+"\x3c/p\x3e":"")+"\x3c/p\x3e"},{xtype:"textfield",fieldLabel:a.localize("password")}],bbar:{layout:{pack:"center"},items:[{text:a.localize("passwordValidateButton"),ui:"default",handler:function(){var d=
f.query("textfield")[0].getValue().trim();0==d.length?a.showError({message:a.localize("noPasswordGiven")}):(f.mask(),Ext.Ajax.request({url:a.getTromboneUrl(),params:{corpus:c.getId(),passwordForSession:d},method:"POST",success:function(d,e){f.unmask();var g=d.responseText;"ADMIN"==g||"ACCESS"==g?(f.close(),b.unmask(),a.dispatchEvent("loadedCorpus",this,c)):a.showError({message:a.localize("badPassword")})},failure:function(b,c){f.unmask();a.showError({message:a.localize("passwordValidationError")})}}))}},
{text:a.localize("nonConsumptiveButton"),handler:function(){f.mask();Ext.Ajax.request({url:a.getTromboneUrl(),params:{corpus:c.getId(),passwordForSessionRemove:!0},method:"POST",callback:function(d,e){f.unmask();f.close();b.unmask();a.dispatchEvent("loadedCorpus",a,c)}})}}]}}}).show();return!1}return!0},hasQueryToLoad:function(a){a||(a=Ext.Object.fromQueryString(document.location.search));return a.corpus||a.input||this.getCorpusId&&this.getCorpusId()},listeners:{loadedCorpus:function(a,b){this.setCorpus(b);
this.on("unhandledEvent",function(a,d,e){a=this.getBaseUrl()+"?corpus\x3d"+b.getId();var f=this.getModifiedApiParams()||{};delete f.view;if("termsClicked"==d)f.query=e;else if("documentsClicked"==d){var g=[];e.forEach&&e.forEach(function(a){g.push(a.getIndex())});f.docIndex=g}else if("corpusTermsClicked"==d)e.map&&(f.query=e.map(function(a){return a.getTerm()}));else if("documentTermsClicked"==d)e.map&&(f.query=e.map(function(a){return a.getTerm()}),f.docIndex=e.map(function(a){return a.getDocIndex()}));
else{console&&console.warn("Unhandled event: "+d,e);return}a+="\x26"+Ext.Object.toQueryString(f);this.openUrl(a)})}}});Ext.define("Voyant.VoyantDefaultApp",{extend:"Voyant.VoyantCorpusApp",mixins:["Voyant.util.Api"],name:"VoyantDefaultApp",constructor:function(){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments)},statics:{i18n:{},api:{view:"corpusset",stopList:"auto",panels:void 0,rtl:void 0}},listeners:{loadedCorpus:function(a,b){this.viewport.down("voyantheader").collapse();this.viewport.down("#toolsContainer").setActiveItem(1);var c=this.getCorpusId&&this.getCorpusId()?
this.getCorpusId():void 0;if(window.history.pushState&&!c){var c=b.getAliasOrId(),d=Ext.Object.fromQueryString(document.location.search),e=this.getBaseUrl()+"?corpus\x3d"+c,f;for(f in d)if("corpus"!==f){var g=Ext.isString(d[f])?[d[f]]:d[f];Ext.isArray(g)&&g.forEach(function(a){e+="\x26"+f+"\x3d"+a})}window.history.pushState({corpus:c},"Corpus: "+c,e)}}},getViewComponent:function(){return this.viewport.down("#toolsContainer-main")},launch:function(){var a=Ext.Object.fromQueryString(document.location.search)||
{},b=this.getApiParam("view","CorpusSet"),c=b.toLowerCase();if(!Ext.ClassManager.getByAlias("widget."+c)||a.noskin)Ext.Msg.show({title:this.localize("noViewErrorTitle"),message:(new Ext.Template(this.localize(a.noskin?"noViewKnownErrorTpl":"noViewErrorTpl"))).apply({view:a.noskin?a.noskin:b,additional:a.noskin&&"convert"==a.noskin?this.localize(a.noskin+"SkinMsg"):""}),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR}),c="corpusset";this.viewport=Ext.create("Ext.container.Viewport",{layout:"border",rtl:void 0!==
this.getApiParam("rtl"),items:[{xtype:"voyantheader",region:"north"},{region:"south",xtype:"voyantfooter"},{region:"center",layout:"card",itemId:"toolsContainer",activeItem:0,items:[{xtype:"container",layout:{type:"vbox",pack:"center",align:"center"},items:[{xtype:"corpuscreator"},{xtype:"container",html:"\x3cdiv style\x3d'font-style: italic; text-align: center; margin-top: 10px;'\x3e\x3cdiv\x3e"+this.localize("voyantIs")+"\x3c/div\x3e"+(-1==this.localize("translatedBy").indexOf("English")?"\x3cdiv\x3e"+
this.localize("translatedBy")+"\x3c/div\x3e":"")}]},{layout:"fit",itemId:"toolsContainer-main",items:{xtype:c}}]}]});this.callParent(arguments)}});